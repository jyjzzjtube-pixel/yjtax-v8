<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YJ Tax Master v7 Ultimate</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
:root{--bg:#F4F6F9;--nv:#1a2b4b;--nvl:#2a3f6b;--gd:#FFD700;--gdb:#FFFDF0;--bl:#2E86C1;--gn:#27AE60;--rd:#E74C3C;--or:#F39C12;--pr:#8E44AD;--tx:#1C1C1C;--sub:#888;--r:16px;--rs:10px;--sh:0 2px 12px rgba(0,0,0,.06)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,sans-serif;background:var(--bg);color:var(--tx)}
.hdr{background:linear-gradient(135deg,var(--nv),var(--nvl));color:#fff;padding:24px 0 56px;position:relative}
.hdr::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:28px;background:var(--bg);border-radius:24px 24px 0 0}
.hi{max-width:960px;margin:0 auto;padding:0 28px}
.hdr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.logo{font-size:22px;font-weight:800}.logo i{color:var(--gd);margin-right:8px}
.av{width:36px;height:36px;background:var(--gd);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;color:var(--nv)}
.nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:center;border-top:1px solid #eee;z-index:100;box-shadow:0 -2px 12px rgba(0,0,0,.05)}
.ni{display:flex;max-width:960px;width:100%}
.nb{flex:1;padding:10px 0 16px;text-align:center;border:none;background:none;cursor:pointer;font-family:inherit;position:relative}
.nb i{font-size:20px;display:block;margin-bottom:3px;color:#bbb}.nb span{font-size:11px;font-weight:600;color:#bbb}
.nb.on i{color:var(--nv)}.nb.on span{color:var(--nv)}
.nb.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:32px;height:3px;background:var(--gd);border-radius:0 0 4px 4px}
.nb.mn.on i{color:var(--gd)}
.ct{max-width:960px;margin:0 auto;padding:0 28px 100px;margin-top:-18px;position:relative;z-index:1}
.tc{display:none}.tc.on{display:block}
.mu-wrap{position:sticky;top:0;z-index:90;padding-top:8px;background:var(--bg);margin-bottom:6px}
.mu{background:linear-gradient(135deg,var(--nv),var(--nvl));border:2px dashed rgba(255,215,0,.5);border-radius:var(--r);padding:20px 24px;text-align:center;color:#fff;cursor:pointer;position:relative;overflow:hidden;transition:all .2s}
.mu.mu-compact{padding:14px 20px}
.mu.mu-compact .mu-tags{display:none}
.mu-status{display:none;align-items:center;gap:8px;background:#E8F8E8;padding:10px 14px;border-radius:var(--rs);font-size:13px;font-weight:600;color:var(--gn);margin-top:6px}
.mu-status.on{display:flex}
.mu-status .mu-add{margin-left:auto;background:var(--gn);color:#fff;border:none;padding:4px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.mu-progress{display:none;background:rgba(255,255,255,.15);border-radius:8px;height:4px;margin-top:10px;overflow:hidden}.mu-progress.on{display:block}
.mu-progress-bar{height:100%;background:var(--gd);border-radius:8px;width:0%;transition:width .3s}
.mu:hover{border-color:var(--gd);box-shadow:0 8px 32px rgba(26,43,75,.3)}
.mu::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 50%,rgba(255,215,0,.08),transparent 60%);pointer-events:none}
.mu input{display:none}
.mu-tags{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:14px;position:relative}
.mu-tag{padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,255,255,.12);color:rgba(255,255,255,.8)}
.kg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:18px}
.kp{background:#fff;padding:22px 16px;border-radius:var(--r);box-shadow:var(--sh);text-align:center;transition:transform .15s}.kp:hover{transform:translateY(-2px)}
.kp-l{font-size:13px;color:var(--sub);margin-bottom:8px}.kp-v{font-size:26px;font-weight:800}.kp-s{font-size:11px;color:#aaa;margin-top:4px}
.vat{background:var(--gdb);border:3px solid var(--gd);border-radius:var(--r);padding:28px;text-align:center;margin:18px 0;position:relative;overflow:hidden}
.vat::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:rgba(255,215,0,.15);border-radius:50%}
.vat-t{font-size:14px;color:#666;font-weight:600;position:relative}.vat-a{font-size:40px;font-weight:800;margin:8px 0;position:relative}.vat-d{font-size:12px;color:#999;position:relative}
.dg{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;margin-bottom:20px}
.dd{background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:16px 18px;display:flex;align-items:center;gap:14px;transition:transform .15s}.dd:hover{transform:translateY(-2px)}
.dd-ic{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.dd-nm{font-size:13px;font-weight:600;margin-bottom:2px}.dd-dt{font-size:11px;color:var(--sub)}
.dd-ct{font-size:22px;font-weight:800;text-align:right;white-space:nowrap;margin-left:auto}
.dd-u{border-left:4px solid var(--rd)}.dd-s{border-left:4px solid var(--or)}.dd-ok{border-left:4px solid var(--gn)}.dd-p{border-left:4px solid #ccc;opacity:.5}
.cg{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:18px}
.ci{background:#fff;padding:16px 8px;border-radius:var(--r);box-shadow:var(--sh);text-align:center}.ci-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:18px}.ci-n{font-size:22px;font-weight:800}.ci-l{font-size:10px;color:var(--sub)}
.cd{background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:20px;margin-bottom:16px;overflow:hidden}
.badge{display:inline-block;padding:2px 8px;border-radius:14px;font-size:10px;font-weight:700}
.b-bl{background:#EBF5FB;color:var(--bl)}.b-rd{background:#FDE8E8;color:var(--rd)}.b-gn{background:#E8F8E8;color:var(--gn)}.b-gy{background:#f0f0f0;color:#888}.b-or{background:#FFF3E0;color:var(--or)}.b-pr{background:#F3E5F5;color:var(--pr)}
.dm{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}.dm-d{background:#FFE082;color:#8B6914}.dm-l{background:#E8F8E8;color:var(--gn)}
.us{background:#fff;border:2px dashed #d0d5dd;border-radius:var(--r);padding:24px;text-align:center;margin-bottom:16px;cursor:pointer;transition:all .2s}.us:hover{border-color:var(--gd);background:var(--gdb)}.us input{display:none}
.lg{display:flex;align-items:center;gap:12px;background:#fff;padding:14px 18px;border-radius:var(--rs);box-shadow:var(--sh);margin-bottom:8px;font-size:13px}
.lg-ic{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.lg-rm{background:none;border:none;cursor:pointer;color:#ccc;font-size:14px;padding:4px 8px}.lg-rm:hover{color:var(--rd)}
.xb{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.xbtn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--rs);border:none;font-family:inherit;font-weight:600;font-size:13px;cursor:pointer;transition:all .15s}.xbtn:hover{transform:translateY(-1px)}
.x-xl{background:#217346;color:#fff}.x-pdf{background:#C62828;color:#fff}.x-csv{background:var(--or);color:#fff}
.it{display:flex;margin-bottom:16px}.ib{flex:1;padding:10px;border:none;background:#e9ecef;font-family:inherit;font-weight:600;font-size:13px;color:#888;cursor:pointer}
.ib:first-child{border-radius:var(--rs) 0 0 var(--rs)}.ib:last-child{border-radius:0 var(--rs) var(--rs) 0}.ib.on{background:var(--nv);color:#fff}
.ip{display:none}.ip.on{display:block}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
table th{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
table td{padding:8px 6px;vertical-align:middle;border-bottom:1px solid #f0f0f0}
table tr:hover{background:#f8f9fa}
.am{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
.am.pos{color:#1565C0}.am.neg{color:#C62828}
th{text-align:left;padding:10px 8px;font-weight:600;color:var(--sub);border-bottom:2px solid #f0f0f0;font-size:12px;white-space:nowrap}
td{padding:12px 8px;border-bottom:1px solid #f5f5f5;white-space:nowrap}tr:hover td{background:#fafbfc}
.am{text-align:right;font-weight:700;font-variant-numeric:tabular-nums}.pos{color:var(--bl)}.neg{color:var(--rd)}
.cw{max-width:300px;margin:0 auto}
.empty{text-align:center;padding:40px;color:#bbb;font-size:14px}.empty i{font-size:40px;margin-bottom:12px;display:block;color:#ddd}
.rb{display:none;align-items:center;gap:6px;background:#f5f5f5;border:1px solid #ddd;color:#888;padding:8px 14px;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}.rb:hover{background:#fee;color:var(--rd);border-color:var(--rd)}
.mh{background:linear-gradient(135deg,#FFD700,#FFA500);border-radius:var(--r);padding:28px 24px;color:#111;margin-bottom:20px;position:relative;overflow:hidden}
.mh::after{content:'â‚©';position:absolute;right:20px;top:10px;font-size:80px;font-weight:900;opacity:.1}
.mh h2{font-size:22px;font-weight:800;margin-bottom:6px;position:relative}.mh p{font-size:13px;opacity:.8;position:relative}
.mu-bar{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:14px 18px;margin-bottom:16px;font-size:12px}
.mu-bar .ub{background:var(--nv);color:#fff;border:none;padding:8px 14px;border-radius:var(--rs);font-family:inherit;font-weight:600;font-size:12px;cursor:pointer}.mu-bar .ub:hover{background:var(--nvl)}
.bc{background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:20px;margin-bottom:14px;border-left:4px solid var(--gd);transition:transform .15s}.bc:hover{transform:translateX(4px)}
.bc-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}.bc-t{font-size:15px;font-weight:700;flex:1;line-height:1.4}
.bc-st{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;margin-left:8px}
.st-a{background:#E8F8E8;color:var(--gn)}.st-v{background:#E3F2FD;color:var(--bl)}.st-c{background:#FFF3E0;color:#F57C00}
.bc-tg{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}.mt{font-size:10px;padding:2px 8px;background:#f5f6f8;border-radius:14px;color:#666}
.bc-d{font-size:13px;color:#555;line-height:1.6;margin-bottom:12px}
.bc-bt{display:flex;justify-content:space-between;align-items:center}.bc-am{font-size:13px;font-weight:700;color:var(--nv)}.bc-am i{color:var(--gd);margin-right:4px}
.bc-lk{display:inline-flex;align-items:center;gap:5px;background:var(--nv);color:#fff;padding:8px 16px;border-radius:var(--rs);text-decoration:none;font-size:12px;font-weight:600;transition:all .15s}.bc-lk:hover{background:var(--nvl)}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:20px}.mo.show{display:flex}
.ml{background:#fff;border-radius:var(--r);padding:28px;max-width:420px;width:100%;text-align:center}
.ml h3{font-size:18px;font-weight:700;margin-bottom:8px}.ml-fn{font-size:13px;color:#888;margin-bottom:20px}
.ml-g{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.ml-b{padding:18px;border-radius:var(--rs);border:2px solid #eee;background:#fff;cursor:pointer;font-family:inherit;font-weight:600;font-size:14px;transition:all .15s}.ml-b:hover{transform:translateY(-2px)}
.ml-b i{display:block;font-size:24px;margin-bottom:6px}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}.fi{animation:fadeUp .35s ease-out both}.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}.d4{animation-delay:.2s}
@media(max-width:768px){.kp-v{font-size:20px}.vat-a{font-size:32px}.dg{grid-template-columns:1fr 1fr}.cg{grid-template-columns:1fr 1fr}}
@media(max-width:400px){.nb span{font-size:9px}.nb i{font-size:16px}}
@media print{.nav,.mu,.hdr::after,.us,.private-section{display:none!important}.hdr{padding-bottom:20px}.ct{padding-bottom:20px;margin-top:0}.cd{break-inside:avoid;box-shadow:none;border:1px solid #ddd}}
.private-section{background:#1a1a2e;border-radius:var(--r);padding:0;margin-top:20px;overflow:hidden}
.private-section .prv-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;cursor:pointer;user-select:none}
.private-section .prv-header h3{color:#FFD700;font-size:15px;font-weight:800;margin:0}
.private-section .prv-header .prv-toggle{background:none;border:1px solid rgba(255,215,0,.4);color:#FFD700;padding:6px 14px;border-radius:var(--rs);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.private-section .prv-body{padding:0 20px 20px;display:none}
.private-section .prv-body.open{display:block}
.private-section .prv-notice{font-size:11px;color:#ef5350;background:rgba(239,83,80,.1);padding:8px 12px;border-radius:var(--rs);margin-bottom:14px;text-align:center}
.private-section table{background:rgba(255,255,255,.05);border-radius:var(--rs);overflow:hidden;table-layout:auto}
.private-section th{color:#aaa;border-bottom:1px solid rgba(255,255,255,.1);font-size:11px;padding:10px 8px}
.private-section td{color:#ddd;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px;padding:10px 8px}
.private-section tr:hover td{background:rgba(255,255,255,.04)}
.private-section .prv-memo{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;padding:5px 8px;border-radius:6px;font-size:11px;width:100%;font-family:inherit}
.private-section .prv-summary{margin-top:16px;padding:16px;background:rgba(255,255,255,.06);border-radius:var(--rs);font-size:13px;line-height:1.8;color:#ccc}
.private-section .prv-refund{color:#ef5350;font-weight:800}
.private-section .prv-net{color:#66bb6a;font-weight:800}
.sub-mgr-form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.sub-mgr-form input,.sub-mgr-form select{padding:9px 12px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;width:100%}
.sub-mgr-form select{appearance:auto}
.sub-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#fff;border:1px solid #f0f0f0;border-radius:var(--rs);margin-bottom:8px;font-size:13px}
.sub-item .sub-warn{font-size:10px;color:#F57C00;font-weight:600;margin-top:3px}
.sub-summary{background:var(--gdb);border:2px solid var(--gd);border-radius:var(--r);padding:20px;margin-top:16px;font-size:13px;line-height:2}
.sub-summary .s-val{font-weight:800;font-size:15px}
.sub-summary .s-good{color:var(--gn)}.sub-summary .s-bad{color:var(--rd)}.sub-summary .s-warn{color:var(--or)}
</style>
</head>
<body>
<div class="hdr"><div class="hi">
  <div class="hdr-top"><div class="logo"><i class="fas fa-landmark"></i>YJ Tax Master</div><div style="display:flex;align-items:center;gap:8px;font-size:14px;opacity:.85"><button onclick="openShareMenu()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s" title="ë‚´ë³´ë‚´ê¸°"><i class="fas fa-share-from-square"></i></button><button onclick="openAI()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s" title="AI ì–´ì‹œìŠ¤í„´íŠ¸"><i class="fas fa-comment-dots"></i></button><button onclick="openSettings()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s" title="API ì„¤ì •" id="settings-btn"><i class="fas fa-gear"></i></button>ì™€ì´ì œì´íŒŒíŠ¸ë„ˆìŠ¤ <div class="av">ì§€</div></div></div>
  <div style="font-size:15px;opacity:.7;margin-bottom:4px" id="gr"></div>
  <div style="font-size:24px;font-weight:800" id="ht">2ì›” ì„¸ë¬´ ë¦¬í¬íŠ¸</div>
</div></div>
<div class="ct">

<!-- TAB1: ëŒ€ì‹œë³´ë“œ -->
<div class="tc on" id="t1">
  <div class="mu-wrap" id="muWrap">
    <div class="mu fi" id="mu1"><div style="font-size:36px;margin-bottom:8px;position:relative"><i class="fas fa-wand-magic-sparkles"></i></div><div style="font-size:16px;font-weight:700;margin-bottom:4px;position:relative">ë§ˆìŠ¤í„° ì—…ë¡œë“œ</div><div style="font-size:12px;opacity:.65;position:relative">ì•„ë¬´ íŒŒì¼ì´ë‚˜ ë˜ì§€ì„¸ìš” â€” ìë™ ì¸ì‹ & ì •ë¦¬</div><div class="mu-tags"><span class="mu-tag">Excel</span><span class="mu-tag">PDF</span><span class="mu-tag">Word</span><span class="mu-tag">CSV</span><span class="mu-tag">TXT</span><span class="mu-tag">Image</span><span class="mu-tag" style="background:rgba(255,215,0,.25);color:#FFD700">ALL</span></div><div class="mu-progress" id="muProgress"><div class="mu-progress-bar" id="muProgressBar"></div></div><input type="file" id="fi1" multiple></div>
    <div class="mu-status" id="us1"><i class="fas fa-check-circle"></i><span id="um1"></span><button class="mu-add" onclick="document.getElementById('fi1').click()">+ íŒŒì¼ ì¶”ê°€</button></div>
  </div>
  <div style="font-size:16px;font-weight:700;margin-bottom:14px"><i class="fas fa-calendar-alt" style="color:var(--rd);margin-right:8px"></i>ì„¸ë¬´ ìº˜ë¦°ë”</div>
  <!-- ë‹¬ë ¥í˜• ìº˜ë¦°ë” -->
  <div class="cd fi d1" style="padding:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <button onclick="calNav(-1)" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--nv);padding:4px 10px"><i class="fas fa-chevron-left"></i></button>
      <div style="font-size:16px;font-weight:700;color:var(--nv)" id="cal-title">2026ë…„ 2ì›”</div>
      <button onclick="calNav(1)" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--nv);padding:4px 10px"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:11px;font-weight:600;color:var(--sub);margin-bottom:6px"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
    <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px"></div>
    <div id="cal-events" style="margin-top:12px"></div>
  </div>
  <!-- D-Day ì¹´ë“œ (ìº˜ë¦°ë” ì•„ë˜) -->
  <div class="dg fi d1" id="ddg"></div>
  <div class="kg"><div class="kp fi d2"><div class="kp-l">ğŸ’° ìˆœìˆ˜ìµ</div><div class="kp-v" id="k-pr" style="color:var(--gn)">0ì›</div><div class="kp-s">ë§¤ì¶œ-ë§¤ì…</div></div><div class="kp fi d2"><div class="kp-l">ğŸ“ˆ ë§¤ì¶œ</div><div class="kp-v" id="k-sl" style="color:var(--bl)">0ì›</div><div class="kp-s">ì„¸ê¸ˆê³„ì‚°ì„œ(VATí¬í•¨)</div></div><div class="kp fi d2"><div class="kp-l">ğŸ“‰ ë§¤ì…</div><div class="kp-v" id="k-ex" style="color:var(--rd)">0ì›</div><div class="kp-s">í†µì¥ì¶œê¸ˆ+ì¹´ë“œê²°ì œ</div></div></div>
  <!-- ê¸‰ì—¬ / ì›ì²œì§•ìˆ˜ / ë°°ë‹¹ -->
  <div class="kg" style="margin-top:-4px"><div class="kp fi d2" style="cursor:pointer;border-left:3px solid var(--bl)" onclick="switchTab(4)"><div class="kp-l">ğŸ’¼ ê¸‰ì—¬(ì‹¤ìˆ˜ë ¹)</div><div class="kp-v" id="k-salary" style="color:var(--bl);font-size:20px">0ì›</div><div class="kp-s" id="k-salary-sub">ë‚´ì¼ì‚¬ì¥ ê¸‰ì—¬</div></div><div class="kp fi d2" style="cursor:pointer;border-left:3px solid var(--or)" onclick="switchTab(4)"><div class="kp-l">ğŸ›ï¸ ì›ì²œì§•ìˆ˜</div><div class="kp-v" id="k-withhold" style="color:var(--or);font-size:20px">0ì›</div><div class="kp-s" id="k-withhold-sub">ì†Œë“ì„¸+ì§€ë°©ì„¸+4ëŒ€ë³´í—˜</div></div><div class="kp fi d2" style="cursor:pointer;border-left:3px solid var(--pr)" onclick="switchTab(4)"><div class="kp-l">ğŸ’ ë°°ë‹¹ì†Œë“</div><div class="kp-v" id="k-dividend" style="color:var(--pr);font-size:20px">0ì›</div><div class="kp-s" id="k-dividend-sub">ì›ìœŒì•¤ì½” ë°°ë‹¹</div></div></div>
  <!-- ì¢…í•© ê²½ë¹„ í˜„í™© -->
  <div class="fi d2" style="background:#FAFAFA;border:2px solid #E0E0E0;border-radius:var(--r);padding:16px;margin-bottom:14px">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px"><i class="fas fa-chart-pie" style="color:var(--pr);margin-right:6px"></i>ê²½ë¹„ í˜„í™© (í˜¼ìš©ì¹´ë“œ ì£¼ì˜)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:11px;text-align:center">
      <div style="background:#E8F5E9;padding:10px;border-radius:var(--rs)"><div style="color:#2E7D32;font-weight:600">ê³µì œ ë§¤ì…</div><div style="font-size:15px;font-weight:800;color:#1B5E20" id="kpi-ded-amt">0ì›</div><div style="color:#66BB6A;font-size:9px" id="kpi-ded-cnt">0ê±´</div></div>
      <div style="background:#FFEBEE;padding:10px;border-radius:var(--rs)"><div style="color:#C62828;font-weight:600">ë¶ˆê³µì œ(ê°œì¸)</div><div style="font-size:15px;font-weight:800;color:#B71C1C" id="kpi-nded-amt">0ì›</div><div style="color:#EF5350;font-size:9px" id="kpi-nded-cnt">0ê±´</div></div>
      <div style="background:#FFF8E1;padding:10px;border-radius:var(--rs)"><div style="color:#F57F17;font-weight:600">ì ‘ëŒ€ë¹„</div><div style="font-size:15px;font-weight:800;color:#E65100" id="kpi-ent-amt">0ì›</div><div style="color:#FFA726;font-size:9px" id="kpi-ent-limit">í•œë„: 0ì›</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:11px;text-align:center">
      <div style="background:#E3F2FD;padding:10px;border-radius:var(--rs);cursor:pointer" onclick="switchTab(4)"><div style="color:#1565C0;font-weight:600">ì‹¤ì œ ë²ˆ ëˆ</div><div style="font-size:15px;font-weight:800;color:#0D47A1" id="kpi-real-income">0ì›</div><div style="color:#42A5F5;font-size:9px">ë§¤ì¶œ-ë§¤ì…-ì„¸ê¸ˆ â–¶</div></div>
      <div style="background:#F3E5F5;padding:10px;border-radius:var(--rs);cursor:pointer" onclick="switchTab(3)"><div style="color:#6A1B9A;font-weight:600">ì ˆì„¸í•œ ê¸ˆì•¡</div><div style="font-size:15px;font-weight:800;color:#4A148C" id="kpi-saved">0ì›</div><div style="color:#AB47BC;font-size:9px">ê°ë©´+ê³µì œ í•©ê³„ â–¶</div></div>
    </div>
  </div>
  <div class="vat fi d3"><div class="vat-t">ğŸš© ì˜ˆì • ë¶€ê°€ê°€ì¹˜ì„¸</div><div style="font-size:11px;color:#C62828;margin-bottom:4px" id="vat-period">2026ë…„ 1ì›”~6ì›” â†’ 7ì›” 25ì¼ ë‚©ë¶€</div><div class="vat-a" id="v-a">0 ì›</div><div class="vat-d" id="v-d">íŒŒì¼ ì—…ë¡œë“œ ì‹œ ìë™ ê³„ì‚°</div></div>
  <div class="fi d3" id="inc-box" style="background:linear-gradient(135deg,#EBF5FB,#D6EAF8);border:3px solid var(--bl);border-radius:var(--r);padding:28px;text-align:center;margin:0 0 18px;position:relative;overflow:hidden"><div style="position:absolute;top:-30px;left:-30px;width:100px;height:100px;background:rgba(46,134,193,.1);border-radius:50%"></div><div style="font-size:14px;color:#456;font-weight:600;position:relative">ğŸ“‹ ì˜ˆì • ì¢…í•©ì†Œë“ì„¸ (ì „ì²´ ì†Œë“ í•©ì‚°)</div><div style="font-size:11px;color:#1565C0;margin:4px 0" id="inc-period">2025ë…„ 1ì›”~12ì›” â†’ 2026ë…„ 5ì›” 31ì¼ ì‹ ê³ </div><div style="font-size:40px;font-weight:800;margin:8px 0;position:relative;color:var(--nv)" id="inc-a">0 ì›</div><div style="font-size:12px;color:#789;position:relative" id="inc-d">3ê°œ ì†Œë“ í•©ì‚° Â· ê¸°ë‚©ë¶€ì„¸ì•¡ ì°¨ê°</div><div style="display:flex;justify-content:center;gap:12px;margin-top:12px;position:relative;flex-wrap:wrap"><div style="background:#fff;padding:8px 14px;border-radius:var(--rs);font-size:11px;cursor:pointer" onclick="switchTab(3)"><span style="color:var(--sub)">ê³¼ì„¸í‘œì¤€</span><br><strong id="inc-base">0ì›</strong></div><div style="background:#fff;padding:8px 14px;border-radius:var(--rs);font-size:11px;cursor:pointer" onclick="switchTab(3)"><span style="color:var(--sub)">ì‚°ì¶œì„¸ì•¡</span><br><strong id="inc-calc">0ì›</strong></div><div style="background:#fff;padding:8px 14px;border-radius:var(--rs);font-size:11px;cursor:pointer" onclick="switchTab(3)"><span style="color:var(--sub)">ê¸°ë‚©ë¶€ì„¸ì•¡</span><br><strong id="inc-prepaid" style="color:var(--bl)">-0ì›</strong></div></div></div>

  <!-- ì†Œë“ í†µí•© ê´€ë¦¬ -->
  <div class="cd fi d3" style="border-left:4px solid var(--pr)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#F3E5F5;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--pr)"><i class="fas fa-layer-group"></i></div><div><div style="font-size:15px;font-weight:700">ì†Œë“ í†µí•© ê´€ë¦¬</div><div style="font-size:11px;color:var(--sub)">ì¢…í•©ì†Œë“ì„¸ëŠ” ëª¨ë“  ì†Œë“ í•©ì‚° ì‹ ê³ </div></div></div>
    <div style="display:flex;flex-direction:column;gap:10px" id="income-sources">
      <!-- â‘  ê·¼ë¡œì†Œë“: ë‚´ì¼ì‚¬ì¥ -->
      <div style="background:#f8f9fa;border-radius:var(--rs);padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-size:13px;font-weight:700"><i class="fas fa-building" style="color:var(--bl);margin-right:6px"></i><input type="text" id="income-name-1" value="ë‚´ì¼ì‚¬ì¥" style="border:none;background:transparent;font-size:13px;font-weight:700;font-family:inherit;width:100px;padding:0" onchange="saveBonusData()"> <span style="font-size:11px;color:var(--sub)">(ê·¼ë¡œì†Œë“)</span></div><div class="badge b-bl">4ëŒ€ë³´í—˜ Â· ë§¤ì›” 10ì¼</div></div>
        <!-- ì„¸ì „ ì›”ê¸‰ -->
        <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:14px">
          <div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì„¸ì „ ì›”ê¸‰(ë§Œì›)</div><input type="number" id="salary-monthly" value="200" min="0" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:14px;text-align:right" oninput="calcTotalIncome()"></div>
          <div style="padding:10px 14px;background:#e8eaed;border-radius:var(--rs);font-size:13px;font-weight:600;color:var(--nv);white-space:nowrap">ë§¤ì›” 10ì¼</div>
        </div>
        <!-- ê¸‰ì—¬ ìˆ˜ë ¹ ì…ë ¥ -->
        <div style="background:#fff;border:2px solid var(--bl);border-radius:var(--rs);padding:14px;margin-bottom:12px">
          <div style="font-size:12px;font-weight:700;color:var(--bl);margin-bottom:10px"><i class="fas fa-plus-circle" style="margin-right:4px"></i>ê¸‰ì—¬ ìˆ˜ë ¹ ê¸°ë¡</div>
          <div style="display:flex;gap:6px;align-items:flex-end">
            <div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì§€ê¸‰ì¼</div><input type="date" id="sal-input-date" style="width:100%;padding:9px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
            <div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì‹¤ìˆ˜ë ¹ì•¡(ì›)</div><input type="text" id="sal-input-net" placeholder="1,814,110" style="width:100%;padding:9px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right"></div>
            <button onclick="addSalaryRecord()" style="padding:9px 16px;background:var(--bl);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save" style="margin-right:3px"></i>ì €ì¥</button>
          </div>
        </div>
        <!-- ìˆ˜ë ¹ ë‚´ì—­ ëª©ë¡ -->
        <div id="salary-records"></div>
        <!-- í•©ê³„ -->
        <div style="background:linear-gradient(135deg,#EBF5FB,#D6EAF8);border-radius:var(--rs);padding:14px;margin-top:8px">
          <div style="font-size:12px;font-weight:700;color:var(--bl);margin-bottom:8px"><i class="fas fa-calculator" style="margin-right:4px"></i>ê¸‰ì—¬ í•©ê³„</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px">
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ìˆ˜ë ¹ íšŸìˆ˜</span><span style="font-weight:700" id="sal-count">0íšŒ / 12íšŒ</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ì‹¤ìˆ˜ë ¹ í•©ê³„</span><span style="font-weight:700;color:var(--bl)" id="sal-net-total">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ì„¸ì „ ì´ê¸‰ì—¬(ì—°)</span><span style="font-weight:700" id="salary-annual">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ê³µì œ ì´ì•¡(ì¶”ì •)</span><span style="font-weight:700;color:var(--rd)" id="sal-deduct-total">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">4ëŒ€ë³´í—˜(ì›” ì¶”ì •)</span><span style="font-weight:700;color:var(--or)" id="ins-total">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ì†Œë“ì„¸(ì›” ì¶”ì •)</span><span style="font-weight:700" id="ins-tax">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ê·¼ë¡œì†Œë“ê³µì œ í›„</span><span style="font-weight:700" id="salary-deducted">0ì›</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--sub)">ì›ì²œì§•ìˆ˜ì„¸ì•¡(ì—°)</span><span style="font-weight:700;color:var(--gn)" id="salary-withheld">0ì›</span></div>
          </div>
        </div>
      </div>

      <!-- â‘¡ ì„±ê³¼ê¸ˆ: ì›ìœŒì•¤ì½” -->
      <div style="background:#f8f9fa;border-radius:var(--rs);padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:13px;font-weight:700"><i class="fas fa-crown" style="color:var(--gd);margin-right:6px"></i><input type="text" id="income-name-2" value="ì›ìœŒì•¤ì½”" style="border:none;background:transparent;font-size:13px;font-weight:700;font-family:inherit;width:100px;padding:0" onchange="saveBonusData()"> <span style="font-size:11px;color:var(--sub)">(ì£¼ì£¼ì´ì‚¬)</span></div><div class="badge b-gn">ì›”ë³„ ì…ë ¥</div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px">
          <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì›”</div><select id="bonus-month" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="1">1ì›”</option><option value="2">2ì›”</option><option value="3">3ì›”</option><option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option><option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option></select></div>
          <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ìœ í˜•</div><select id="bonus-type" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="salary">ê¸‰ì—¬/ìƒì—¬</option><option value="dividend">ë°°ë‹¹ì†Œë“</option></select></div>
          <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ê¸ˆì•¡(ë§Œì›)</div><input type="number" id="bonus-amt" value="0" min="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;text-align:right"></div>
        </div>
        <button onclick="addBonusEntry()" style="width:100%;padding:8px;border:none;border-radius:var(--rs);background:var(--gd);color:#fff;font-weight:700;font-size:12px;cursor:pointer;font-family:inherit">+ ì €ì¥</button>
        <div id="bonus-list" style="margin-top:8px;max-height:180px;overflow-y:auto"></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;padding-top:6px;border-top:1px solid #e0e0e0"><span style="font-weight:700;color:var(--nv)">ì—°ê°„ í•©ê³„</span><span style="font-weight:800;color:var(--nv)" id="bonus-total">0ì›</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:var(--sub)">ì›ì²œì§•ìˆ˜ì„¸ì•¡(ì¶”ì •)</span><span style="font-weight:700;color:var(--gn)" id="bonus-withheld">0ì›</span></div>
      </div>
      <!-- â‘¢ ì‚¬ì—…ì†Œë“: ì™€ì´ì œì´íŒŒíŠ¸ë„ˆìŠ¤ -->
      <div style="background:linear-gradient(135deg,var(--gdb),#fff);border:2px solid var(--gd);border-radius:var(--rs);padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:13px;font-weight:700"><i class="fas fa-store" style="color:var(--nv);margin-right:6px"></i><input type="text" id="income-name-3" value="ì™€ì´ì œì´íŒŒíŠ¸ë„ˆìŠ¤" style="border:none;background:transparent;font-size:13px;font-weight:700;font-family:inherit;width:130px;padding:0" onchange="saveBonusData()"> <span style="font-size:11px;color:var(--sub)">(ì‚¬ì—…ì†Œë“)</span></div><div class="badge" style="background:var(--gdb);color:#8B6914">ì¥ë¶€ ìë™ + ìˆ˜ë™</div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
          <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ë§¤ì¶œ(ë§Œì›) â€” ìˆ˜ë™ ë³´ì •</div><input type="number" id="biz-manual-revenue" value="0" min="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcTotalIncome()"></div>
          <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ë§¤ì…(ë§Œì›) â€” ìˆ˜ë™ ë³´ì •</div><input type="number" id="biz-manual-expense" value="0" min="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcTotalIncome()"></div>
        </div>
        <div style="font-size:10px;color:var(--sub);margin-bottom:6px">â€» ì¥ë¶€(ì„¸ê¸ˆê³„ì‚°ì„œ) ìë™ + ìˆ˜ë™ ë³´ì • í•©ì‚°</div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:var(--sub)">ë§¤ì¶œ (ì¥ë¶€+ìˆ˜ë™)</span><span style="font-weight:700" id="biz-revenue">0ì›</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:var(--sub)">ë§¤ì… (ì¥ë¶€+ìˆ˜ë™)</span><span style="font-weight:700" id="biz-expense">0ì›</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;padding-top:4px;border-top:1px solid #e0e0e0"><span style="font-weight:700;color:var(--nv)">ì‚¬ì—…ì†Œë“ê¸ˆì•¡</span><span style="font-weight:800;color:var(--nv)" id="biz-income">0ì›</span></div>
      </div>
    </div>
    <!-- í•©ì‚° ìš”ì•½ -->
    <div style="background:linear-gradient(135deg,var(--nv),var(--nvl));border-radius:var(--rs);padding:16px;margin-top:14px;color:#fff">
      <div style="font-size:12px;opacity:.8;margin-bottom:6px">ğŸ“Š ì¢…í•©ì†Œë“ í•©ì‚° ê²°ê³¼</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center">
        <div><div style="font-size:9px;opacity:.7">ì´ì†Œë“ê¸ˆì•¡</div><div style="font-size:16px;font-weight:800" id="total-income-display">0ì›</div></div>
        <div><div style="font-size:9px;opacity:.7">ê¸°ë‚©ë¶€ì„¸ì•¡</div><div style="font-size:16px;font-weight:800" id="total-prepaid-display">0ì›</div></div>
        <div><div style="font-size:9px;opacity:.7">ì¶”ê°€ë‚©ë¶€/í™˜ê¸‰</div><div style="font-size:16px;font-weight:800" id="total-final-display">0ì›</div></div>
      </div>
    </div>
  </div>


  <!-- ì¦ë¹™ ëˆ„ë½ ê°ì§€ -->
  <div class="cd fi d4" id="mismatch-box" style="display:none;border-left:4px solid var(--rd)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <div style="width:36px;height:36px;border-radius:10px;background:#FFEBEE;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--rd)"><i class="fas fa-triangle-exclamation"></i></div>
      <div style="flex:1"><div style="font-size:15px;font-weight:700;color:var(--rd)" id="mismatch-title">ì¦ë¹™ ëˆ„ë½ ê°ì§€</div></div>
      <button id="mismatch-detail-btn" onclick="toggleMismatchDetail()" style="padding:5px 12px;background:#f5f5f5;border:1px solid #ddd;border-radius:var(--rs);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;color:#888;display:none"><i class="fas fa-eye" style="margin-right:4px"></i>ìì„¸íˆ ë³´ê¸°</button>
    </div>
    <div id="mismatch-list" style="font-size:12px;color:#555;line-height:1.8"></div>
  </div>

  <div class="cg fi d4" id="cg" style="display:none;grid-template-columns:1fr 1fr 1fr 1fr 1fr"><div class="ci" onclick="switchTab(2);setTimeout(function(){swI(document.querySelectorAll('.ib')[0],'bank')},100)" style="cursor:pointer"><div class="ci-ic" style="background:#E3F2FD"><i class="fas fa-building-columns"></i></div><div class="ci-n" id="c-bk">0</div><div class="ci-l">í†µì¥</div></div><div class="ci" onclick="switchTab(2);setTimeout(function(){swI(document.querySelectorAll('.ib')[1],'tax')},100)" style="cursor:pointer"><div class="ci-ic" style="background:#FFF3E0"><i class="fas fa-file-invoice"></i></div><div class="ci-n" id="c-tx">0</div><div class="ci-l">ì„¸ê¸ˆê³„ì‚°ì„œ</div></div><div class="ci" onclick="switchTab(2);setTimeout(function(){swI(document.querySelectorAll('.ib')[2],'card')},100)" style="cursor:pointer"><div class="ci-ic" style="background:#F3E5F5"><i class="fas fa-credit-card"></i></div><div class="ci-n" id="c-cd">0</div><div class="ci-l">ì¹´ë“œ</div></div><div class="ci" onclick="switchTab(2);setTimeout(function(){swI(document.querySelectorAll('.ib')[3],'proof')},100)" style="cursor:pointer"><div class="ci-ic" style="background:#FFF8E1"><i class="fas fa-receipt"></i></div><div class="ci-n" id="c-pf">0</div><div class="ci-l">ì§€ì¶œì¦ë¹™</div></div><div class="ci" onclick="switchTab(2);setTimeout(function(){swI(document.querySelectorAll('.ib')[4],'all')},100)" style="cursor:pointer"><div class="ci-ic" style="background:#ECEFF1"><i class="fas fa-folder"></i></div><div class="ci-n" id="c-et">0</div><div class="ci-l">ì „ì²´</div></div></div>
  <div class="cd fi d4"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:14px">ğŸ“‹ ìš”ì•½</span><span class="dm dm-d" id="dm">ğŸ”¶ ë°ëª¨</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px"><div style="background:#E3F2FD;padding:10px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#1565C0">ë§¤ì¶œ</div><div style="font-size:18px;font-weight:800;color:#0D47A1" id="s-sc">0</div><div style="font-size:9px;color:#64B5F6">ê±´</div></div><div style="background:#FFEBEE;padding:10px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C62828">ë§¤ì…</div><div style="font-size:18px;font-weight:800;color:#B71C1C" id="s-ec">0</div><div style="font-size:9px;color:#EF9A9A">ê±´</div></div></div><div style="font-size:12px;color:#555;line-height:2"><div>â–¸ ë¶ˆê³µì œ <strong style="color:var(--rd)" id="s-nd">0ì›</strong></div><div>â–¸ ì£¼ë§¤ì¶œì²˜: <strong id="s-tp">-</strong></div><div>â–¸ ì´ë§¤ì¶œì•¡: <strong style="color:#1565C0" id="s-sales-total">0ì›</strong> / ì´ë§¤ì…ì•¡: <strong style="color:#C62828" id="s-exp-total">0ì›</strong></div></div></div>

  <!-- ë°ì´í„° ë³´í˜¸ ìƒíƒœ ë°” -->
  <div class="fi d4" style="background:#F1F8E9;border:2px solid #C5E1A5;border-radius:var(--r);padding:14px;margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:12px;font-weight:700;color:#33691E"><i class="fas fa-shield-halved" style="margin-right:4px"></i>ë°ì´í„° ë³´í˜¸</div>
        <div style="font-size:10px;color:#689F38;margin-top:2px" id="backup-status">ìë™ ë°±ì—… í™œì„± Â· ìŠ¤ëƒ…ìƒ· 0ê°œ</div>
      </div>
      <div style="display:flex;gap:6px">
        <button onclick="exportBackup()" style="padding:6px 12px;background:#33691E;color:#fff;border:none;border-radius:var(--rs);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit"><i class="fas fa-download" style="margin-right:3px"></i>ë°±ì—…</button>
        <button onclick="document.getElementById('imp-file2').click()" style="padding:6px 12px;background:#fff;color:#33691E;border:2px solid #33691E;border-radius:var(--rs);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit"><i class="fas fa-upload" style="margin-right:3px"></i>ë³µì›</button>
        <input type="file" id="imp-file2" accept=".json" style="display:none" onchange="importBackup(this)">
      </div>
    </div>
  </div>

  <!-- ì›”ë³„ ì¶”ì„¸ ì°¨íŠ¸ -->
  <div style="font-size:16px;font-weight:700;margin:20px 0 14px"><i class="fas fa-chart-area" style="color:var(--bl);margin-right:8px"></i>ì›”ë³„ ì¶”ì„¸ ë¶„ì„</div>
  <div class="cd fi d4">
    <canvas id="trend-chart" height="200"></canvas>
    <div id="trend-analysis" style="margin-top:12px;font-size:12px;color:#555;line-height:1.7"></div>
  </div>

  <!-- ë¹„ê³µê°œ ì‹¤ìˆ˜ìµ ì¶”ì ê¸° -->
  <div class="private-section" id="private-tracker">
    <div class="prv-header" onclick="togglePrivateSection()">
      <h3>ğŸ”’ ë¹„ê³µê°œ ì‹¤ìˆ˜ìµ ì¶”ì ê¸°</h3>
      <button class="prv-toggle" id="prv-toggle-btn">í¼ì¹˜ê¸° â–¼</button>
    </div>
    <div class="prv-body" id="prv-body">
      <div class="prv-notice">ğŸ”’ ì´ ì˜ì—­ì€ ì¸ì‡„Â·ë¦¬í¬íŠ¸ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
      <div class="tw">
        <table id="prv-table">
          <thead>
            <tr><th style="width:80px">ì‘ì„±ì¼</th><th style="width:70px">êµ¬ë¶„</th><th>ìƒí˜¸ëª…</th><th style="width:100px;text-align:right">ì´ì•¡(VATí¬í•¨)</th><th style="width:100px;text-align:right">ëŒ€ë¦¬ë§¤ì¶œì•¡</th><th style="min-width:140px">ë©”ëª¨</th></tr>
          </thead>
          <tbody id="prv-tbody"></tbody>
        </table>
      </div>
      <div class="prv-summary" id="prv-summary"></div>
    </div>
  </div>

</div>

<!-- TAB2: ì¥ë¶€ -->
<div class="tc" id="t2">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:18px;font-weight:700"><i class="fas fa-book" style="margin-right:8px"></i>ëˆ ë²„ëŠ” ì¥ë¶€</div><div style="display:flex;gap:6px"><button class="rb" style="display:inline-flex" onclick="exportBackup()" title="ë°±ì—…"><i class="fas fa-cloud-arrow-down"></i></button><button class="rb" style="display:inline-flex" onclick="document.getElementById('imp-file').click()" title="ë³µì›"><i class="fas fa-cloud-arrow-up"></i></button><input type="file" id="imp-file" accept=".json" style="display:none" onchange="importBackup(this)"><button class="rb" id="rb" onclick="resetAll()"><i class="fas fa-trash-alt"></i> ì´ˆê¸°í™”</button></div></div>
  <!-- ê²€ìƒ‰ë°” -->
  <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
  <button onclick="triggerReceiptScan()" style="flex:1;min-width:120px;padding:10px;background:linear-gradient(135deg,#4285F4,#34A853);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer"><i class="fas fa-camera" style="margin-right:4px"></i>AI ì˜ìˆ˜ì¦ ìŠ¤ìº”</button>
  <input type="file" id="receipt-file" accept="image/*" style="display:none" onchange="scanReceipt(this)">
  <button onclick="openSmartPurchase()" style="flex:1;min-width:120px;padding:10px;background:var(--pr);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer"><i class="fas fa-search-dollar" style="margin-right:4px"></i>ìŠ¤ë§ˆíŠ¸ ë§¤ì…</button>
  <button onclick="exportAllCSV()" style="flex:1;min-width:120px;padding:10px;background:var(--nv);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer"><i class="fas fa-file-csv" style="margin-right:4px"></i>CSV ë°±ì—…</button>
  <button onclick="generateTaxReport()" style="flex:1;min-width:120px;padding:10px;background:linear-gradient(135deg,#E74C3C,#C0392B);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer"><i class="fas fa-file-invoice-dollar" style="margin-right:4px"></i>ì„¸ê¸ˆì‹ ê³  ë¦¬í¬íŠ¸</button>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
  <button onclick="driveImportCSV('card')" style="flex:1;min-width:100px;padding:10px;background:linear-gradient(135deg,#4285F4,#3367D6);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:11px;cursor:pointer"><i class="fab fa-google-drive" style="margin-right:4px"></i>Drive ì¹´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="driveImportCSV('bank')" style="flex:1;min-width:100px;padding:10px;background:linear-gradient(135deg,#4285F4,#3367D6);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:11px;cursor:pointer"><i class="fab fa-google-drive" style="margin-right:4px"></i>Drive í†µì¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="driveBatchScan()" style="flex:1;min-width:100px;padding:10px;background:linear-gradient(135deg,#EA4335,#C5221F);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:11px;cursor:pointer"><i class="fas fa-wand-magic-sparkles" style="margin-right:4px"></i>Drive ì¼ê´„ ìŠ¤ìº”</button>
  <button onclick="var ck=localStorage.getItem('yjtax_claude_key');if(ck){claudeDeductAnalysis()}else{geminiDeductCheck()}" style="flex:1;min-width:100px;padding:10px;background:linear-gradient(135deg,#AB47BC,#7B1FA2);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:11px;cursor:pointer"><i class="fas fa-robot" style="margin-right:4px"></i>AI ë¶ˆê³µì œ íŒë‹¨</button>
  <button onclick="ntsBatchCheck()" style="flex:1;min-width:100px;padding:10px;background:linear-gradient(135deg,#1565C0,#0D47A1);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:11px;cursor:pointer"><i class="fas fa-landmark" style="margin-right:4px"></i>êµ­ì„¸ì²­ ê±°ë˜ì²˜ ê²€ì¦</button>
</div>
<div style="margin-bottom:12px">
  <input type="text" id="search-input" placeholder="ğŸ” ê±°ë˜ì²˜Â·ì ìš”Â·ê¸ˆì•¡Â·ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰..." style="width:100%;padding:12px 16px;border:2px solid #e0e0e0;border-radius:var(--r);font-family:inherit;font-size:13px;outline:none;transition:border .2s" onfocus="this.style.borderColor='var(--gd)'" onblur="this.style.borderColor='#e0e0e0'" oninput="searchLedger(this.value)">
  <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
    <select id="filter-cat" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 10px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px;background:#fff"><option value="">ì „ì²´ ë¶„ë¥˜</option><option value="ë§¤ì¶œ">ë§¤ì¶œ</option><option value="ë§¤ì…">ë§¤ì…</option></select>
    <select id="filter-deduct" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 10px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px;background:#fff"><option value="">ê³µì œì—¬ë¶€</option><option value="ê³µì œ">ê³µì œ</option><option value="ë¶ˆê³µì œ">ë¶ˆê³µì œ</option></select>
    <input type="date" id="filter-from" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 8px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px">
    <input type="date" id="filter-to" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 8px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px">
    <input type="number" id="filter-min" placeholder="ìµœì†Œê¸ˆì•¡" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 8px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px;width:90px">
    <input type="number" id="filter-max" placeholder="ìµœëŒ€ê¸ˆì•¡" onchange="searchLedger(document.getElementById('search-input').value)" style="padding:6px 8px;border:1.5px solid #e0e0e0;border-radius:8px;font-family:inherit;font-size:11px;width:90px">
    <button onclick="clearFilters()" style="padding:6px 10px;border:1.5px solid #e0e0e0;border-radius:8px;background:#f5f5f5;font-family:inherit;font-size:11px;cursor:pointer;font-weight:600">âœ• ì´ˆê¸°í™”</button>
  </div>
  <div id="filter-summary" style="display:none;margin-top:6px;padding:8px 12px;background:#FFF8E1;border-radius:8px;font-size:11px;color:#F57F17;font-weight:600"></div>
</div>
  <div class="us fi" id="mu2" style="transition:all .2s" ondragover="event.preventDefault();this.style.borderColor='var(--gd)';this.style.background='var(--gdb)'" ondragleave="event.preventDefault();this.style.borderColor='';this.style.background=''" ondrop="event.preventDefault();this.style.borderColor='';this.style.background='';handleMu2Drop(event)"><div style="font-size:28px;color:var(--gd);margin-bottom:6px"><i class="fas fa-file-circle-plus"></i></div><div style="font-size:14px;font-weight:600;color:#555">íŒŒì¼ ì¶”ê°€</div><div style="font-size:12px;color:#aaa">í´ë¦­ ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸ (ì—‘ì…€Â·ì´ë¯¸ì§€Â·PDF)</div><input type="file" id="fi2" multiple></div>
  <div class="xb" id="xb" style="display:none"><button class="xbtn x-xl" onclick="exXL()"><i class="fas fa-file-excel"></i> ì—‘ì…€</button><button class="xbtn x-pdf" onclick="exPDF()"><i class="fas fa-file-pdf"></i> PDF</button><button class="xbtn x-csv" onclick="exCSV()"><i class="fas fa-file-csv"></i> CSV</button><button class="xbtn" style="background:var(--pr);color:#fff" onclick="exClientReport()"><i class="fas fa-file-circle-check"></i> ê³ ê°ë¦¬í¬íŠ¸</button></div>
  <div id="fl-wrap" style="display:none;margin-bottom:12px">
    <div id="fl-header" onclick="toggleFileList()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#fff;border-radius:var(--rs);box-shadow:var(--sh);font-size:13px;font-weight:700;color:var(--nv);user-select:none;transition:all .2s">
      <span><i class="fas fa-folder-open" style="color:var(--gd);margin-right:8px"></i><span id="fl-title">ì—…ë¡œë“œ íŒŒì¼</span></span>
      <i class="fas fa-chevron-down" id="fl-chevron" style="transition:transform .3s;font-size:12px;color:var(--sub)"></i>
    </div>
    <div id="fl" style="display:none;padding-top:8px;transition:all .3s"></div>
  </div>
  <div class="it fi d2"><button class="ib on" onclick="swI(this,'bank')">í†µì¥</button><button class="ib" onclick="swI(this,'tax')">ì„¸ê¸ˆê³„ì‚°ì„œ</button><button class="ib" onclick="swI(this,'card')">ì¹´ë“œ</button><button class="ib" onclick="swI(this,'proof')">ì§€ì¶œì¦ë¹™</button><button class="ib" onclick="swI(this,'all')">ì „ì²´</button></div>
  <div class="ip on" id="p-bank"><div class="cd"><div class="tw"><table id="tb-bk" style="table-layout:auto"><thead><tr><th style="width:80px">ê±°ë˜ì¼</th><th>ê±°ë˜ë‚´ìš©</th><th>ê±°ë˜ê¸°ë¡ì‚¬í•­</th><th style="width:95px;text-align:right">ì…ê¸ˆ</th><th style="width:95px;text-align:right">ì¶œê¸ˆ</th><th style="width:95px;text-align:right">ì”ì•¡</th></tr></thead><tbody></tbody></table></div><div class="empty" id="em-bk"><i class="fas fa-building-columns"></i>í†µì¥ ì—…ë¡œë“œ (NHë†í˜‘Â·ì‹ í•œÂ·í† ìŠ¤Â·ì¹´ì¹´ì˜¤)</div></div></div>
  <div class="ip" id="p-tax"><div class="cd"><div class="tw"><table id="tb-tx" style="table-layout:auto"><thead><tr><th style="width:65px">ì‘ì„±ì¼</th><th style="width:42px">êµ¬ë¶„</th><th>ë°œí–‰ ìƒí˜¸ëª…</th><th>í’ˆëª©ëª…</th><th style="width:105px">ì‚¬ì—…ìë²ˆí˜¸</th><th style="width:95px;text-align:right">ê³µê¸‰ê°€ì•¡</th><th style="width:70px;text-align:right">ì„¸ì•¡</th><th style="width:45px">ê³µì œ</th></tr></thead><tbody></tbody></table></div><div class="empty" id="em-tx"><i class="fas fa-file-invoice"></i>ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ (í™ˆíƒìŠ¤ XLS)</div></div></div>
  <div class="ip" id="p-card"><div class="cd"><div class="tw"><table id="tb-cd" style="table-layout:auto"><thead><tr><th style="width:70px">ê±°ë˜ì¼</th><th>ê°€ë§¹ì (ìƒí˜¸ëª…)</th><th>ë‚´ìš©</th><th style="width:100px;text-align:right">ê²°ì œê¸ˆì•¡</th><th style="width:60px">ë§¤ì¶œ/ë§¤ì…</th></tr></thead><tbody></tbody></table></div><div class="empty" id="em-cd"><i class="fas fa-credit-card"></i>ì¹´ë“œ ì—…ë¡œë“œ (ì¹´ì¹´ì˜¤ë±…í¬ ë‚´ì—­)</div></div></div>
  <div class="ip" id="p-proof"><div class="cd">
    <!-- ì§€ì¶œì¦ë¹™ AI ìë™ ìŠ¤ìº” + ë“œë˜ê·¸ì•¤ë“œë¡­ -->
    <div id="proof-drop-zone" style="background:linear-gradient(135deg,#FFF8E1,#FFF3E0);border:2px solid #FF9800;border-radius:var(--rs);padding:16px;margin-bottom:16px;transition:all .3s" ondragover="event.preventDefault();event.stopPropagation();this.style.borderColor='#E65100';this.style.background='#FFE0B2'" ondragleave="event.preventDefault();this.style.borderColor='#FF9800';this.style.background=''" ondrop="event.preventDefault();this.style.borderColor='#FF9800';this.style.background='';handleProofDrop(event)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div style="width:40px;height:40px;border-radius:10px;background:#FF9800;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff"><i class="fas fa-wand-magic-sparkles"></i></div>
        <div><div style="font-size:14px;font-weight:800;color:#E65100">AI ìë™ ìŠ¤ìº”</div><div style="font-size:10px;color:#BF360C">ì´ë¯¸ì§€/PDF ì—…ë¡œë“œ Â· ë“œë˜ê·¸&ë“œë¡­ Â· í´ë”ì§¸ ì—…ë¡œë“œ â†’ Gemini AI ìë™ ë¶„ë¥˜</div></div>
      </div>
      <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì•ˆë‚´ -->
      <div id="proof-drag-hint" style="padding:18px;background:rgba(255,255,255,.7);border:3px dashed #FFB74D;border-radius:var(--rs);text-align:center;margin-bottom:10px;transition:all .3s">
        <i class="fas fa-hand-pointer" style="font-size:28px;color:#FF9800;margin-bottom:6px;display:block"></i>
        <div style="font-size:13px;font-weight:700;color:#E65100;margin-bottom:2px">íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
        <div style="font-size:10px;color:#BF360C">PNG Â· JPG Â· PDF (ëŒ€ë¦¬ìš´ì „ ì˜ìˆ˜ì¦, íƒì‹œ ì´ìš©ë‚´ì—­, ì¹´ì¹´ì˜¤í˜ì´ ê±°ë˜í™•ì¸ì¦ ë“±)</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <label style="flex:1;min-width:140px;padding:14px;background:#fff;border:2px dashed #FF9800;border-radius:var(--rs);text-align:center;cursor:pointer;transition:all .15s;font-size:12px;font-weight:600;color:#E65100" onmouseover="this.style.background='#FFF3E0'" onmouseout="this.style.background='#fff'">
          <i class="fas fa-images" style="font-size:20px;display:block;margin-bottom:4px;color:#FF9800"></i>ì´ë¯¸ì§€/PDF ì„ íƒ
          <input type="file" id="proof-scan-files" accept="image/*,.pdf" multiple style="display:none" onchange="scanProofFiles(this)">
          <div style="font-size:9px;color:#999;margin-top:2px">ëŒ€ë¦¬ìš´ì „Â·íƒì‹œÂ·ì˜ìˆ˜ì¦Â·ê±°ë˜í™•ì¸ì¦</div>
        </label>
        <label style="flex:1;min-width:140px;padding:14px;background:#fff;border:2px dashed #FF9800;border-radius:var(--rs);text-align:center;cursor:pointer;transition:all .15s;font-size:12px;font-weight:600;color:#E65100" onmouseover="this.style.background='#FFF3E0'" onmouseout="this.style.background='#fff'">
          <i class="fas fa-folder-open" style="font-size:20px;display:block;margin-bottom:4px;color:#FF9800"></i>í´ë” ì „ì²´ ìŠ¤ìº”
          <input type="file" id="proof-scan-folder" webkitdirectory multiple style="display:none" onchange="scanProofFolder(this)">
          <div style="font-size:9px;color:#999;margin-top:2px">ì§€ì¶œì¦ë¹™ í´ë” í†µì§¸ë¡œ ì—…ë¡œë“œ</div>
        </label>
      </div>
      <div id="proof-scan-progress" style="display:none;margin-top:10px;padding:10px;background:#fff;border-radius:var(--rs);font-size:11px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><i class="fas fa-spinner fa-spin" style="color:#FF9800"></i><span id="proof-scan-status">ìŠ¤ìº” ì¤‘...</span></div>
        <div style="background:#f0f0f0;border-radius:4px;height:6px;overflow:hidden"><div id="proof-scan-bar" style="background:linear-gradient(90deg,#FF9800,#F57C00);height:100%;width:0%;transition:width .3s"></div></div>
        <div id="proof-scan-log" style="margin-top:6px;max-height:150px;overflow-y:auto;font-size:10px;color:var(--sub)"></div>
      </div>
    </div>
    <div style="background:#FFF8E1;border:2px solid #FFD54F;border-radius:var(--rs);padding:14px;margin-bottom:16px">
      <div style="font-size:13px;font-weight:700;color:#F57F17;margin-bottom:10px"><i class="fas fa-plus-circle" style="margin-right:4px"></i>ì§€ì¶œì¦ë¹™ ìˆ˜ë™ ì…ë ¥</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ê±°ë˜ì¼</div><input type="date" id="pf-date" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ìƒí˜¸ëª…/ë‚´ìš©</div><input type="text" id="pf-desc" placeholder="ìŒë‘¥ì´ëŒ€ë¦¬ìš´ì „" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ì¦ë¹™ìœ í˜•</div><select id="pf-type" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="í˜„ê¸ˆì˜ìˆ˜ì¦">í˜„ê¸ˆì˜ìˆ˜ì¦</option><option value="ê°„ì´ì˜ìˆ˜ì¦">ê°„ì´ì˜ìˆ˜ì¦</option><option value="ê±°ë˜í™•ì¸ì¦">ê±°ë˜í™•ì¸ì¦</option><option value="ì¹´ë“œì „í‘œ">ì¹´ë“œì „í‘œ</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ì§€ì¶œë¶„ë¥˜</div><select id="pf-cat" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="êµí†µë¹„">êµí†µë¹„</option><option value="ì‹ëŒ€">ì‹ëŒ€</option><option value="ì‚¬ë¬´ìš©í’ˆ">ì‚¬ë¬´ìš©í’ˆ</option><option value="ì ‘ëŒ€ë¹„">ì ‘ëŒ€ë¹„</option><option value="ì†Œëª¨í’ˆë¹„">ì†Œëª¨í’ˆë¹„</option><option value="í†µì‹ ë¹„">í†µì‹ ë¹„</option><option value="ìˆ˜ì„ ë¹„">ìˆ˜ì„ ë¹„</option><option value="ë³´í—˜ë£Œ">ë³´í—˜ë£Œ</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ê²°ì œë°©ë²•</div><select id="pf-pay" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="ì¹´ë“œ">ì¹´ë“œ</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="ì¹´ì¹´ì˜¤í˜ì´">ì¹´ì¹´ì˜¤í˜ì´</option><option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ê³¼ì„¸ê¸ˆì•¡</div><input type="text" id="pf-supply" placeholder="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcProofTotal()"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ë¶€ê°€ì„¸</div><input type="text" id="pf-tax" placeholder="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcProofTotal()"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ë´‰ì‚¬ë£Œ/ë©´ì„¸</div><input type="text" id="pf-tip" placeholder="0" style="width:100%;padding:7px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcProofTotal()"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:2px">ì´ê²°ì œê¸ˆì•¡</div><input type="text" id="pf-total" placeholder="0" style="width:100%;padding:7px;border:2px solid #FFD54F;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right;font-weight:700;background:#FFFDE7"></div>
      </div>
      <div style="display:flex;gap:6px">
        <button onclick="addProofEntry()" style="flex:1;padding:8px;border:none;border-radius:var(--rs);background:#F57F17;color:#fff;font-weight:700;font-size:12px;cursor:pointer;font-family:inherit"><i class="fas fa-plus" style="margin-right:4px"></i>ì¶”ê°€</button>
        <select id="pf-deduct" style="padding:7px 10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:11px"><option value="ê³µì œ">ê³µì œ</option><option value="ë¶ˆê³µì œ">ë¶ˆê³µì œ</option><option value="-">ë¯¸ì •</option></select>
      </div>
    </div>
    <div class="tw"><table id="tb-pf" style="table-layout:auto"><thead><tr><th style="width:75px">ê±°ë˜ì¼</th><th>ìƒí˜¸ëª…/ë‚´ìš©</th><th style="width:65px">ì¦ë¹™ìœ í˜•</th><th style="width:55px">ë¶„ë¥˜</th><th style="width:75px;text-align:right">ê³¼ì„¸ê¸ˆì•¡</th><th style="width:60px;text-align:right">ë¶€ê°€ì„¸</th><th style="width:65px;text-align:right">ë´‰ì‚¬ë£Œ</th><th style="width:85px;text-align:right;color:#E65100;font-weight:700">ì´ê²°ì œê¸ˆì•¡</th><th style="width:55px">ê²°ì œ</th><th style="width:42px">ê³µì œ</th></tr></thead><tbody></tbody></table></div><div class="empty" id="em-pf"><i class="fas fa-receipt"></i>ì§€ì¶œì¦ë¹™ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”<br><span style="font-size:11px;color:#aaa;margin-top:4px;display:block">ëŒ€ë¦¬ìš´ì „ ì˜ìˆ˜ì¦ Â· íƒì‹œ ì´ìš©ë‚´ì—­ Â· ì¹´ì¹´ì˜¤í˜ì´ ê±°ë˜í™•ì¸ì¦ ë“±</span></div></div></div>
  <div class="ip" id="p-all"><div class="cd"><div class="tw"><table id="tb-al"><thead><tr><th style="width:70px">ë¶„ë¥˜</th><th style="width:50px">ìœ í˜•</th><th style="width:85px">ë‚ ì§œ</th><th>ë‚´ìš©</th><th>í’ˆëª©ëª…</th><th style="width:100px;text-align:right">ì…ê¸ˆ(ë§¤ì¶œ)</th><th style="width:100px;text-align:right">ì¶œê¸ˆ(ë§¤ì…)</th></tr></thead><tbody></tbody></table></div><div class="empty" id="em-al"><i class="fas fa-inbox"></i>ë°ì´í„° ì—…ë¡œë“œ</div></div></div>
  <div style="font-size:16px;font-weight:700;margin:28px 0 14px"><i class="fas fa-chart-pie" style="margin-right:8px"></i>ë§¤ì¶œì²˜ë³„ ë¹„ì¤‘</div>
  <div class="cd"><div class="cw"><canvas id="donut"></canvas></div><div class="empty" id="em-ch" style="display:none"><i class="fas fa-chart-pie"></i>ë§¤ì¶œ ë°ì´í„° í•„ìš”</div></div>

  <!-- ê±°ë˜ì²˜ ê´€ë¦¬ + ë¯¸ìˆ˜ê¸ˆ ì¶”ì  -->
  <div style="font-size:16px;font-weight:700;margin:28px 0 14px"><i class="fas fa-handshake" style="color:var(--nv);margin-right:8px"></i>ê±°ë˜ì²˜ ê´€ë¦¬</div>
  <div id="client-mgmt"></div>
  <div class="cd" style="border-left:4px solid var(--or)" id="receivable-box" style="display:none">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:36px;height:36px;border-radius:10px;background:#FFF3E0;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--or)"><i class="fas fa-clock"></i></div><div><div style="font-size:14px;font-weight:700">ë¯¸ìˆ˜ê¸ˆÂ·ë¯¸ì§€ê¸‰ ì¶”ì </div><div style="font-size:11px;color:var(--sub)">í†µì¥ ì…ê¸ˆ vs ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œ ìë™ ëŒ€ì‚¬</div></div></div>
    <div id="receivable-list" style="font-size:12px;line-height:1.8;color:#555"></div>
  </div>
</div>

<!-- TAB3: ì ˆì„¸ ì‹œë®¬ë ˆì´í„° -->
<div class="tc" id="t3">
  <div style="background:linear-gradient(135deg,#1a2b4b,#2d4a7a);border-radius:var(--r);padding:28px 24px;color:#fff;margin-bottom:20px;position:relative;overflow:hidden" class="fi">
    <div style="position:absolute;right:16px;top:10px;font-size:72px;font-weight:900;opacity:.06">%</div>
    <h2 style="font-size:22px;font-weight:800;margin-bottom:6px;position:relative"><i class="fas fa-calculator" style="color:var(--gd);margin-right:8px"></i>ì ˆì„¸ ì‹œë®¬ë ˆì´í„°</h2>
    <p style="font-size:13px;opacity:.8;position:relative">í•©ë²•ì ìœ¼ë¡œ ì„¸ê¸ˆì„ ìµœì†Œí™”í•˜ëŠ” ì „ëµ ë¶„ì„</p>
  </div>

  <!-- ì ˆì„¸ ìš”ì•½ ì¹´ë“œ -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px" class="fi d1">
    <div style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-radius:var(--r);padding:22px;text-align:center;box-shadow:var(--sh)">
      <div style="font-size:12px;color:#2E7D32;font-weight:600;margin-bottom:6px">ğŸ’° ì´ ì ˆì„¸ ê°€ëŠ¥ì•¡</div>
      <div style="font-size:28px;font-weight:800;color:#1B5E20" id="sv-total">0ì›</div>
      <div style="display:flex;justify-content:center;gap:10px;margin-top:6px;font-size:10px">
        <span style="color:#E65100">ë¶€ê°€ì„¸ <b id="sv-vat-part">0ì›</b></span>
        <span style="color:#1565C0">ì¢…ì†Œì„¸ <b id="sv-inc-part">0ì›</b></span>
      </div>
    </div>
    <div style="background:linear-gradient(135deg,#FFF3E0,#FFE0B2);border-radius:var(--r);padding:22px;text-align:center;box-shadow:var(--sh)">
      <div style="font-size:12px;color:#E65100;font-weight:600;margin-bottom:6px">âš¡ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥</div>
      <div style="font-size:28px;font-weight:800;color:#BF360C" id="sv-action">0ê±´</div>
      <div style="font-size:10px;color:#FF9800;margin-top:4px">ì§€ê¸ˆ ë°”ë¡œ ì²˜ë¦¬</div>
    </div>
  </div>

  <!-- ë¶€ê°€ì„¸ ì ˆì„¸ -->
  <div style="font-size:16px;font-weight:700;margin-bottom:14px" class="fi d2"><i class="fas fa-receipt" style="color:var(--or);margin-right:8px"></i>ë¶€ê°€ì„¸ ì ˆì„¸ ë¶„ì„</div>

  <div id="vat-save-list"></div>

  <!-- ì¢…ì†Œì„¸ ì ˆì„¸ -->
  <div style="font-size:16px;font-weight:700;margin:24px 0 14px" class="fi d3"><i class="fas fa-landmark" style="color:var(--bl);margin-right:8px"></i>ì¢…ì†Œì„¸ ì ˆì„¸ ë¶„ì„</div>

  <!-- ê²½ë¹„ìœ¨ ë¹„êµ ì‹œë®¬ë ˆì´ì…˜ -->
  <div class="cd fi d3" id="expense-sim">
    <div style="font-weight:700;font-size:14px;margin-bottom:12px">ğŸ“Š ì‹ ê³  ë°©ì‹ë³„ ì„¸ê¸ˆ ë¹„êµ</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
      <div style="background:var(--gdb);border:2px solid var(--gd);border-radius:var(--rs);padding:12px 8px;text-align:center;overflow:hidden">
        <div style="font-size:10px;color:#666;margin-bottom:4px">âœ… ì¥ë¶€ê¸°ì¥ (í˜„ì¬)</div>
        <div style="font-size:16px;font-weight:800;color:var(--gn);word-break:break-all" id="sim-book">0ì›</div>
        <div style="font-size:9px;color:var(--gn);margin-top:2px;font-weight:700">ìµœì  ì„ íƒ</div>
      </div>
      <div style="background:#f8f9fa;border:2px solid #e0e0e0;border-radius:var(--rs);padding:12px 8px;text-align:center;overflow:hidden">
        <div style="font-size:10px;color:#666;margin-bottom:4px">ê¸°ì¤€ê²½ë¹„ìœ¨</div>
        <div style="font-size:16px;font-weight:800;color:var(--or);word-break:break-all" id="sim-std">0ì›</div>
        <div style="font-size:9px;color:var(--rd);margin-top:2px" id="sim-std-diff">+0ì›</div>
      </div>
      <div style="background:#f8f9fa;border:2px solid #e0e0e0;border-radius:var(--rs);padding:12px 8px;text-align:center;overflow:hidden">
        <div style="font-size:10px;color:#666;margin-bottom:4px">ë‹¨ìˆœê²½ë¹„ìœ¨</div>
        <div style="font-size:16px;font-weight:800;color:var(--rd);word-break:break-all" id="sim-simple">0ì›</div>
        <div style="font-size:9px;color:var(--rd);margin-top:2px" id="sim-simple-diff">+0ì›</div>
      </div>
    </div>
    <div style="background:#E8F5E9;border-radius:var(--rs);padding:12px 14px;font-size:12px;color:#2E7D32;line-height:1.6"><i class="fas fa-check-circle" style="margin-right:4px"></i><b>ì¥ë¶€ê¸°ì¥ì´ ê°€ì¥ ìœ ë¦¬í•©ë‹ˆë‹¤.</b> ì‹¤ì œ ê²½ë¹„ë¥¼ ì¸ì •ë°›ì•„ ê³¼ì„¸í‘œì¤€ì„ ìµœì†Œí™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  </div>

  <!-- ì†Œë“ê³µì œ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
  <div class="cd fi d3">
    <div style="font-weight:700;font-size:14px;margin-bottom:12px">âœ… ì†Œë“ê³µì œÂ·ì„¸ì•¡ê³µì œ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
    <div id="deduction-list"></div>
  </div>

  <!-- ì¢…ì†Œì„¸ ì ˆì„¸ ì•¡ì…˜ -->
  <div id="inc-save-list"></div>

  <!-- ì ˆì„¸ ì•¡ì…˜í”Œëœ -->
  <div style="font-size:16px;font-weight:700;margin:24px 0 14px" class="fi d4"><i class="fas fa-bolt" style="color:var(--gd);margin-right:8px"></i>ì§€ê¸ˆ ì‹¤í–‰í•  ì ˆì„¸ ì•¡ì…˜</div>
  <div id="action-list"></div>
</div>

<!-- TAB4: ì„¸ê¸ˆ ì¤„ì´ê¸° ì‹¤ì „ ì‹œë®¬ë ˆì´í„° -->
<div class="tc" id="t4">
  <div style="background:linear-gradient(135deg,#B71C1C,#E53935);border-radius:var(--r);padding:28px 24px;color:#fff;margin-bottom:20px;position:relative;overflow:hidden" class="fi">
    <div style="position:absolute;right:14px;top:8px;font-size:68px;font-weight:900;opacity:.08">â†“</div>
    <h2 style="font-size:22px;font-weight:800;margin-bottom:6px;position:relative"><i class="fas fa-arrow-trend-down" style="margin-right:8px"></i>ì„¸ê¸ˆ ì¤„ì´ê¸°</h2>
    <p style="font-size:13px;opacity:.85;position:relative">ìˆ«ìë¥¼ ë„£ìœ¼ë©´ ì¦‰ì‹œ ì ˆì„¸ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤</p>
  </div>

  <!-- í˜„ì¬ ì„¸ê¸ˆ vs ìµœì í™” ë¹„êµ -->
  <div style="display:grid;grid-template-columns:1fr 40px 1fr;gap:0;align-items:center;margin-bottom:20px" class="fi d1">
    <div style="background:#FFEBEE;border-radius:var(--r);padding:20px;text-align:center;box-shadow:var(--sh)">
      <div style="font-size:11px;color:#C62828;font-weight:600;margin-bottom:6px">í˜„ì¬ ì˜ˆìƒ ì„¸ê¸ˆ</div>
      <div style="font-size:24px;font-weight:800;color:#B71C1C" id="tx-now">0ì›</div>
      <div style="font-size:10px;color:#E57373;margin-top:4px">ë¶€ê°€ì„¸+ì¢…ì†Œì„¸</div>
    </div>
    <div style="text-align:center;font-size:24px;color:var(--gn)"><i class="fas fa-arrow-right"></i></div>
    <div style="background:#E8F5E9;border-radius:var(--r);padding:20px;text-align:center;box-shadow:var(--sh)">
      <div style="font-size:11px;color:#2E7D32;font-weight:600;margin-bottom:6px">ìµœì í™” í›„ ì„¸ê¸ˆ</div>
      <div style="font-size:24px;font-weight:800;color:#1B5E20" id="tx-opt">0ì›</div>
      <div style="font-size:10px;color:#66BB6A;margin-top:4px" id="tx-saved">ì ˆì„¸ì•¡: 0ì›</div>
    </div>
  </div>

  <!-- ì‹œë®¬ë ˆì´í„° 1: ì¶”ê°€ ë§¤ì…ìœ¼ë¡œ ë¶€ê°€ì„¸ ì¤„ì´ê¸° -->
  <div class="cd fi d2">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#FFF3E0;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--or)"><i class="fas fa-cart-shopping"></i></div><div><div style="font-size:15px;font-weight:700">â‘  ì¶”ê°€ ë§¤ì…ìœ¼ë¡œ ë¶€ê°€ì„¸ ì¤„ì´ê¸°</div><div style="font-size:11px;color:var(--sub)">2ê°œ ëª©ë¡ì—ì„œ ê°ê° ì„ íƒ â†’ í•©ì‚° ì ˆì„¸ ì‹œë®¬ë ˆì´ì…˜</div></div></div>
    
    <!-- ëª©ë¡ A: ì‚¬ì—…ê²½ë¹„ í•­ëª© -->
    <div style="background:#f8f9fa;border-radius:var(--rs);padding:14px;margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:var(--nv);margin-bottom:8px">ğŸ“¦ ì‚¬ì—…ê²½ë¹„ í•­ëª© <span style="font-weight:400;color:var(--sub)">(êµ¬ë§¤ ì˜ˆì •ì¸ í•­ëª© ì„ íƒ)</span></div>
      <div id="expense-items">
        <div class="expense-row" style="display:flex;gap:6px;margin-bottom:6px;align-items:center">
          <select class="expense-select" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px" onchange="calcSim()">
            <option value="">-- ê²½ë¹„ í•­ëª© ì„ íƒ --</option>
            <option value="ë…¸íŠ¸ë¶/PC">ğŸ’» ë…¸íŠ¸ë¶Â·PC êµ¬ë§¤</option>
            <option value="ëª¨ë‹ˆí„°/ì¥ë¹„">ğŸ–¥ï¸ ëª¨ë‹ˆí„°Â·ì¥ë¹„</option>
            <option value="ì†Œí”„íŠ¸ì›¨ì–´">ğŸ“€ ì†Œí”„íŠ¸ì›¨ì–´Â·ë¼ì´ì„ ìŠ¤</option>
            <option value="ê´‘ê³ ë¹„">ğŸ“¢ ê´‘ê³ ë¹„(ë„¤ì´ë²„Â·êµ¬ê¸€)</option>
            <option value="ì‚¬ë¬´ìš©í’ˆ">ğŸ“¦ ì‚¬ë¬´ìš©í’ˆÂ·ì†Œëª¨í’ˆ</option>
            <option value="ì°¨ëŸ‰ìœ ì§€ë¹„">ğŸš— ì°¨ëŸ‰ìœ ì§€ë¹„(ìœ ë¥˜Â·ìˆ˜ë¦¬)</option>
            <option value="í†µì‹ ë¹„">ğŸ“± í†µì‹ ë¹„Â·ì¸í„°ë„·</option>
            <option value="êµìœ¡ë¹„">ğŸ“š êµìœ¡Â·ì„¸ë¯¸ë‚˜ë¹„</option>
            <option value="ì ‘ëŒ€ë¹„">ğŸ½ï¸ ì ‘ëŒ€ë¹„(í•œë„ ë‚´)</option>
            <option value="ê¸°íƒ€ê²½ë¹„">ğŸ“ ê¸°íƒ€ ì‚¬ì—…ê²½ë¹„</option>
          </select>
          <input type="text" placeholder="ê¸ˆì•¡(ì›)" style="width:110px;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcSim()">
        </div>
      </div>
      <button onclick="addExpenseRow()" style="width:100%;padding:8px;border:2px dashed #d0d5dd;border-radius:var(--rs);background:none;font-family:inherit;font-size:11px;color:var(--sub);cursor:pointer;margin-top:4px"><i class="fas fa-plus"></i> ê²½ë¹„ í•­ëª© ì¶”ê°€</button>
    </div>
    
    <!-- ëª©ë¡ B: ì¹´ë“œë§¤ì… ê±°ë˜ì²˜ -->
    <div style="background:#FFF8E1;border-radius:var(--rs);padding:14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#E65100;margin-bottom:8px">ğŸ’³ ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… ê±°ë˜ì²˜ <span style="font-weight:400;color:var(--sub)">(ê¸°ì¡´ ë§¤ì… ë‚´ì—­ì—ì„œ ì„ íƒ)</span></div>
      <div id="card-items"></div>
      <div id="card-items-empty" style="font-size:11px;color:var(--sub);padding:8px;text-align:center">ì¥ë¶€ì— ë§¤ì… ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
    
    <!-- í•©ì‚° ê²°ê³¼ -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
      <div style="background:#FFEBEE;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C62828">í˜„ì¬ ë¶€ê°€ì„¸</div><div style="font-size:16px;font-weight:800;color:#B71C1C" id="sim1-now">0ì›</div></div>
      <div style="background:#E8F5E9;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#2E7D32">ì ˆì„¸ í›„</div><div style="font-size:16px;font-weight:800;color:#1B5E20" id="sim1-after">0ì›</div></div>
      <div style="background:var(--gdb);padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#8B6914">ë¶€ê°€ì„¸ ì ˆê°</div><div style="font-size:16px;font-weight:800;color:var(--gd)" id="sim1-save">-0ì›</div></div>
    </div>
  </div>

  <!-- ì‹œë®¬ë ˆì´í„° 4: ë¶ˆê³µì œâ†’ê³µì œ ì „í™˜ ì‹œë®¬ -->
  <div class="cd fi d3">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#FFEBEE;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--rd)"><i class="fas fa-rotate"></i></div><div><div style="font-size:15px;font-weight:700">â‘£ ë¶ˆê³µì œâ†’ê³µì œ ì „í™˜ ì‹œë®¬ë ˆì´ì…˜</div><div style="font-size:11px;color:var(--sub)">ì ê²©ì¦ë¹™ í™•ë³´ ì‹œ ì¦‰ì‹œ ì ˆì„¸ íš¨ê³¼</div></div></div>
    <div id="nd-sim-list"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
      <div style="background:#FFEBEE;padding:14px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C62828">í˜„ì¬ ë¶ˆê³µì œ ì„¸ì•¡</div><div style="font-size:18px;font-weight:800;color:#B71C1C" id="sim4-now">0ì›</div></div>
      <div style="background:#E8F5E9;padding:14px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#2E7D32">ì „í™˜ ì‹œ ì ˆì„¸ì•¡</div><div style="font-size:18px;font-weight:800;color:#1B5E20" id="sim4-save">0ì›</div></div>
    </div>
  </div>

  <!-- ì‹œë®¬ë ˆì´í„° 5: ë§¤ì¶œ êµ¬ê°„ë³„ ìµœì  ì„¸ìœ¨ -->

  <!-- â˜… ì¢…ì†Œì„¸ ì¤„ì´ê¸° ì‹œë®¬ë ˆì´í„° (ë¶€ê°€ì„¸â‘ ê³¼ ë™ì¼ êµ¬ì¡°) -->
  <div class="cd fi d3" style="border-left:4px solid var(--bl)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#E3F2FD;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--bl)"><i class="fas fa-landmark"></i></div><div><div style="font-size:15px;font-weight:700">â‘¡ ê²½ë¹„ ì¶”ê°€ë¡œ ì¢…ì†Œì„¸ ì¤„ì´ê¸°</div><div style="font-size:11px;color:var(--sub)">ê²½ë¹„ë¥¼ ì¶”ê°€í•˜ë©´ ê³¼ì„¸í‘œì¤€ì´ ì¤„ì–´ ì¢…ì†Œì„¸ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤</div></div></div>
    
    <!-- ê²½ë¹„ í•­ëª© ì„ íƒ -->
    <div style="background:#f8f9fa;border-radius:var(--rs);padding:14px;margin-bottom:10px">
      <div style="font-size:12px;font-weight:700;color:var(--nv);margin-bottom:8px">ğŸ“¦ ì¶”ê°€ ê²½ë¹„ í•­ëª© <span style="font-weight:400;color:var(--sub)">(ì¢…ì†Œì„¸ í•„ìš”ê²½ë¹„ë¡œ ì¸ì •)</span></div>
      <div id="inc-expense-items">
        <div class="inc-expense-row" style="display:flex;gap:6px;margin-bottom:6px;align-items:center">
          <select class="inc-expense-select" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px" onchange="calcIncSim()">
            <option value="">-- ê²½ë¹„ í•­ëª© ì„ íƒ --</option>
            <optgroup label="ğŸ  ìíƒ ì‚¬ì—…ì¥ ê²½ë¹„">
              <option value="ê´€ë¦¬ë¹„(50%)">ğŸ¢ ê´€ë¦¬ë¹„ (50% ì‚¬ì—…ìš©)</option>
              <option value="ì „ê¸°ì„¸(50%)">ğŸ’¡ ì „ê¸°ì„¸ (50% ì‚¬ì—…ìš©)</option>
              <option value="ì¸í„°ë„·(100%)">ğŸŒ ì¸í„°ë„· (100% ì‚¬ì—…ìš©)</option>
            </optgroup>
            <optgroup label="ğŸ“± í†µì‹ /SW">
              <option value="í•¸ë“œí°(70%)">ğŸ“± í•¸ë“œí° ìš”ê¸ˆ (70% ì‚¬ì—…ìš©)</option>
              <option value="ì†Œí”„íŠ¸ì›¨ì–´">ğŸ’» ì†Œí”„íŠ¸ì›¨ì–´Â·êµ¬ë…ë£Œ</option>
              <option value="í´ë¼ìš°ë“œ">â˜ï¸ í´ë¼ìš°ë“œÂ·ì„œë²„ë¹„ìš©</option>
            </optgroup>
            <optgroup label="ğŸš— êµí†µ/ì¶œì¥">
              <option value="êµí†µë¹„">ğŸš„ KTXÂ·íƒì‹œÂ·ë²„ìŠ¤</option>
              <option value="ì£¼ìœ ë¹„">â›½ ì£¼ìœ ë¹„ (ì—…ë¬´ìš©)</option>
              <option value="ì¶œì¥ë¹„">âœˆï¸ ì¶œì¥ë¹„Â·ìˆ™ë°•ë¹„</option>
            </optgroup>
            <optgroup label="ğŸ“š ê¸°íƒ€ ì‚¬ì—…ê²½ë¹„">
              <option value="ì‚¬ë¬´ìš©í’ˆ">ğŸ“¦ ì‚¬ë¬´ìš©í’ˆÂ·ì†Œëª¨í’ˆ</option>
              <option value="ê´‘ê³ ë¹„">ğŸ“¢ ê´‘ê³ ë¹„Â·ë§ˆì¼€íŒ…ë¹„</option>
              <option value="êµìœ¡ë¹„">ğŸ“š êµìœ¡Â·ì„¸ë¯¸ë‚˜Â·ë„ì„œ</option>
              <option value="ë…¸íŠ¸ë¶/ì¥ë¹„">ğŸ’» ë…¸íŠ¸ë¶Â·ì¥ë¹„ êµ¬ë§¤</option>
              <option value="ë³´í—˜ë£Œ">ğŸ›¡ï¸ ì‚¬ì—…ìš© ë³´í—˜ë£Œ</option>
              <option value="ê¸°íƒ€">ğŸ“ ê¸°íƒ€ ì‚¬ì—…ê²½ë¹„</option>
            </optgroup>
          </select>
          <input type="text" placeholder="ê¸ˆì•¡(ì›)" style="width:110px;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcIncSim()">
        </div>
      </div>
      <button onclick="addIncExpenseRow()" style="width:100%;padding:8px;border:2px dashed #d0d5dd;border-radius:var(--rs);background:none;font-family:inherit;font-size:11px;color:var(--sub);cursor:pointer;margin-top:4px"><i class="fas fa-plus"></i> ê²½ë¹„ í•­ëª© ì¶”ê°€</button>
    </div>

    <!-- ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… ê±°ë˜ì²˜ (ì¢…ì†Œì„¸ìš©) -->
    <div style="background:#E3F2FD;border-radius:var(--rs);padding:14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#1565C0;margin-bottom:8px">ğŸ’³ ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… ê±°ë˜ì²˜ <span style="font-weight:400;color:var(--sub)">(ì²´í¬í•˜ë©´ í•„ìš”ê²½ë¹„ ì¶”ê°€)</span></div>
      <div id="inc-card-items"></div>
      <div id="inc-card-items-empty" style="font-size:11px;color:var(--sub);padding:8px;text-align:center">ë§¤ì… ë°ì´í„° ì—…ë¡œë“œ ì‹œ ìë™ í‘œì‹œ</div>
    </div>

    <!-- ì†Œë“ê³µì œ ì¶”ê°€ -->
    <div style="background:#F3E5F5;border-radius:var(--rs);padding:14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:#6A1B9A;margin-bottom:8px">ğŸ¦ ì†Œë“ê³µì œ í•­ëª©</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ë…¸ë€ìš°ì‚°ê³µì œ (ì›”/ë§Œì›)</div><input type="number" id="inc-umbrella" value="0" min="0" max="50" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-size:12px;text-align:right" oninput="calcIncSim()"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì¶”ê°€ ë¶€ì–‘ê°€ì¡± (ëª…)</div><input type="number" id="inc-dependents" value="0" min="0" max="10" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-size:12px;text-align:right" oninput="calcIncSim()"></div>
      </div>
    </div>

    <!-- ê²°ê³¼ -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
      <div style="background:#FFEBEE;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C62828">í˜„ì¬ ì¢…ì†Œì„¸</div><div style="font-size:16px;font-weight:800;color:#B71C1C" id="inc-sim-now">0ì›</div></div>
      <div style="background:#E8F5E9;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#2E7D32">ì ˆì„¸ í›„</div><div style="font-size:16px;font-weight:800;color:#1B5E20" id="inc-sim-after">0ì›</div></div>
      <div style="background:var(--gdb);padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#8B6914">ì¢…ì†Œì„¸ ì ˆê°</div><div style="font-size:16px;font-weight:800;color:var(--gd)" id="inc-sim-save">-0ì›</div></div>
    </div>
    <!-- ì„¸ë¶€ ë‚´ì—­ -->
    <div style="background:#f8f9fa;border-radius:var(--rs);padding:12px;font-size:11px;line-height:1.8;color:#555">
      <div style="display:flex;justify-content:space-between"><span>ê³¼ì„¸í‘œì¤€ (í˜„ì¬)</span><span id="inc-sim-base1">0ì›</span></div>
      <div style="display:flex;justify-content:space-between"><span>ê³¼ì„¸í‘œì¤€ (ì ˆì„¸ í›„)</span><span id="inc-sim-base2" style="color:var(--gn)">0ì›</span></div>
      <div style="display:flex;justify-content:space-between"><span>ì ìš©ì„¸ìœ¨ ë³€í™”</span><span id="inc-sim-rate">-</span></div>
      <div style="display:flex;justify-content:space-between;border-top:1px solid #e0e0e0;padding-top:6px;margin-top:6px;font-weight:700"><span>ì„¸ì•¡ê°ë©´ (ì¤‘ì†Œê¸°ì—… 20%)</span><span id="inc-sim-sme" style="color:var(--bl)">-0ì›</span></div>
    </div>
  </div>

  <div class="cd fi d4">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#E8F5E9;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--gn)"><i class="fas fa-chart-bar"></i></div><div><div style="font-size:15px;font-weight:700">â‘¤ ì—°ê°„ ë§¤ì¶œ ì‹œë®¬ë ˆì´ì…˜</div><div style="font-size:11px;color:var(--sub)">ì—°ë§¤ì¶œ ë³€ê²½ ì‹œ ì„¸ê¸ˆ ë³€í™” ë¯¸ë¦¬ë³´ê¸°</div></div></div>
    <div style="background:#f8f9fa;border-radius:var(--rs);padding:16px;margin-bottom:14px">
      <div style="font-size:11px;font-weight:600;color:var(--nv);margin-bottom:6px">ì˜ˆìƒ ì—°ë§¤ì¶œ (ë§Œì›)</div>
      <input type="range" id="annual-range" min="1000" max="50000" step="500" value="15000" oninput="calcAnnual()" style="width:100%;accent-color:var(--nv)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-top:4px"><span>1ì²œë§Œ</span><span id="annual-val" style="font-weight:700;color:var(--nv);font-size:12px">1ì–µ 5ì²œë§Œì›</span><span>5ì–µ</span></div>
    </div>
    <div id="annual-result" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
      <div style="background:#fff;border:1px solid #e0e0e0;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:9px;color:var(--sub)">ë¶€ê°€ì„¸</div><div style="font-size:14px;font-weight:800" id="ann-vat">0</div></div>
      <div style="background:#fff;border:1px solid #e0e0e0;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:9px;color:var(--sub)">ì¢…ì†Œì„¸</div><div style="font-size:14px;font-weight:800" id="ann-inc">0</div></div>
      <div style="background:#fff;border:1px solid #e0e0e0;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:9px;color:var(--sub)">í•©ê³„</div><div style="font-size:14px;font-weight:800;color:var(--rd)" id="ann-total">0</div></div>
      <div style="background:#E8F5E9;border:1px solid #A5D6A7;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:9px;color:#2E7D32">ì‹¤íš¨ì„¸ìœ¨</div><div style="font-size:14px;font-weight:800;color:#1B5E20" id="ann-rate">0%</div></div>
    </div>
  </div>

  <!-- â‘¥ ë¶ˆê³µì œ í•­ëª© ê³µì œ ì „í™˜ ì¶”ì²œ -->
  <div class="cd fi d4">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#FFE0B2;display:flex;align-items:center;justify-content:center;font-size:18px;color:#E65100"><i class="fas fa-lightbulb"></i></div><div><div style="font-size:15px;font-weight:700">â‘¥ ë¶ˆê³µì œ â†’ ê³µì œ ì „í™˜ ì¶”ì²œ</div><div style="font-size:11px;color:var(--sub)">ì´ë ‡ê²Œ í•˜ë©´ ê³µì œ ê°€ëŠ¥í•œ í•­ëª©ì„ ìë™ ë¶„ì„</div></div></div>
    <div id="nd-recommend"></div>
    <div style="background:#FFF3E0;border-radius:var(--rs);padding:12px;margin-top:10px;font-size:11px;color:#E65100;line-height:1.5"><i class="fas fa-exclamation-triangle" style="margin-right:4px"></i>ìœ„ ì¶”ì²œ í•­ëª©ì„ í´ë¦­í•˜ë©´ <b>"â‘  ì¶”ê°€ ë§¤ì…"</b>ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. ì‹¤ì œ ì ìš© ì „ ì„¸ë¬´ì‚¬ í™•ì¸ í•„ìˆ˜.</div>
  </div>

  <!-- â‘¦ ê²½ì¡°ì‚¬ë¹„ ê´€ë¦¬ -->
  <div class="cd fi d4">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#FCE4EC;display:flex;align-items:center;justify-content:center;font-size:18px;color:#C2185B"><i class="fas fa-gift"></i></div><div><div style="font-size:15px;font-weight:700">â‘¦ ê²½ì¡°ì‚¬ë¹„ ê´€ë¦¬ (ì ‘ëŒ€ë¹„)</div><div style="font-size:11px;color:var(--sub)">ê²°í˜¼Â·ë¶€ì˜ê¸ˆÂ·ëŒì”ì¹˜ ë“± ê²½ì¡°ì‚¬ë¹„ ê¸°ë¡ ë° í•œë„ ê´€ë¦¬</div></div></div>
    <!-- í•œë„ ê²Œì´ì§€ -->
    <div style="background:#f8f9fa;border-radius:var(--rs);padding:16px;margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:12px;font-weight:600;color:var(--nv)">ì ‘ëŒ€ë¹„ í•œë„ ì‚¬ìš©í˜„í™©</span><span style="font-size:12px;font-weight:700" id="evt-limit-text">0 / 12,000,000ì›</span></div>
      <div style="background:#e0e0e0;border-radius:10px;height:12px;overflow:hidden;position:relative"><div id="evt-bar" style="height:100%;border-radius:10px;background:linear-gradient(90deg,var(--gn),var(--or));width:0%;transition:width .5s"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-top:4px"><span>ì‚¬ìš©: <b id="evt-used">0ì›</b></span><span>ì”ì—¬: <b id="evt-remain" style="color:var(--gn)">12,000,000ì›</b></span></div>
      <div style="background:#FFF8E1;border-radius:var(--rs);padding:8px 10px;margin-top:8px;font-size:10px;color:#8B6914;line-height:1.5">
        ğŸ“Œ <b>ì ‘ëŒ€ë¹„ í•œë„</b>: ê¸°ë³¸ 1,200ë§Œì› + ìˆ˜ì…ê¸ˆì•¡ë³„ ì¶”ê°€<br>
        ğŸ“Œ <b>ê²½ì¡°ì‚¬ë¹„ ê±´ë‹¹ í•œë„</b>: 20ë§Œì› (ì´ˆê³¼ë¶„ ë¶ˆì¸ì •)<br>
        ğŸ“Œ <b>ì¦ë¹™</b>: ì²­ì²©ì¥Â·ë¶€ê³ ë¬¸ìÂ·ê³„ì¢Œì´ì²´ í™•ì¸ì¦ í•„ìˆ˜ ë³´ê´€
      </div>
    </div>
    <!-- ê²½ì¡°ì‚¬ë¹„ ì…ë ¥ -->
    <div style="background:#fff;border:2px solid #e0e0e0;border-radius:var(--rs);padding:16px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:600;color:var(--nv);margin-bottom:10px"><i class="fas fa-plus-circle" style="margin-right:4px"></i>ê²½ì¡°ì‚¬ë¹„ ì…ë ¥</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:4px">ë‚ ì§œ</div><input type="date" id="evt-date" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:4px">ìœ í˜•</div><select id="evt-type" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><option value="ê²°í˜¼">ğŸ’’ ê²°í˜¼ì¶•ì˜ê¸ˆ</option><option value="ë¶€ì˜">ğŸ•¯ï¸ ë¶€ì˜ê¸ˆ(ì¡°ì˜ê¸ˆ)</option><option value="ëŒì”ì¹˜">ğŸ‘¶ ëŒì”ì¹˜</option><option value="íšŒê°‘">ğŸ‚ íšŒê°‘Â·ì¹ ìˆœ</option><option value="ê¸°íƒ€">ğŸ ê¸°íƒ€ ê²½ì¡°ì‚¬</option></select></div>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:8px;margin-bottom:8px">
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:4px">ëŒ€ìƒ(ì´ë¦„/ê´€ê³„)</div><input type="text" id="evt-name" placeholder="ì˜ˆ: í™ê¸¸ë™ íŒ€ì¥" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
        <div><div style="font-size:10px;color:var(--sub);margin-bottom:4px">ê¸ˆì•¡(ì›)</div><input type="text" id="evt-amt" placeholder="200,000" style="width:100%;padding:8px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;text-align:right" oninput="checkEvtLimit()"></div>
      </div>
      <!-- ì¦ë¹™ ì—…ë¡œë“œ -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div class="evt-upload" onclick="document.getElementById('evt-file').click()" style="border:2px dashed #d0d5dd;border-radius:var(--rs);padding:12px;text-align:center;cursor:pointer;transition:all .2s"><i class="fas fa-camera" style="font-size:18px;color:var(--gd);margin-bottom:4px;display:block"></i><div style="font-size:11px;color:var(--sub)">ì¦ë¹™ ì´ë¯¸ì§€ ì²¨ë¶€</div><div style="font-size:9px;color:#bbb">ì²­ì²©ì¥Â·ë¶€ê³ ë¬¸ì ë“±</div><input type="file" id="evt-file" accept="image/*,.pdf" style="display:none" onchange="evtFileAttached(this)"></div>
        <div id="evt-preview" style="border:2px solid #e0e0e0;border-radius:var(--rs);padding:12px;text-align:center;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:12px"><i class="fas fa-image" style="font-size:28px"></i></div>
      </div>
      <div id="evt-warn" style="display:none;background:#FFEBEE;border-radius:var(--rs);padding:8px 10px;font-size:11px;color:var(--rd);margin-bottom:8px"><i class="fas fa-exclamation-circle" style="margin-right:4px"></i><span id="evt-warn-text"></span></div>
      <button onclick="addEvt()" style="width:100%;padding:12px;background:var(--nv);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:600;font-size:14px;cursor:pointer;transition:all .15s"><i class="fas fa-plus" style="margin-right:6px"></i>ê²½ì¡°ì‚¬ë¹„ ë“±ë¡</button>
    </div>
    <!-- ê²½ì¡°ì‚¬ë¹„ ëª©ë¡ -->
    <div id="evt-list"></div>
    <!-- ê²½ì¡°ì‚¬ë¹„ í•©ê³„ -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px">
      <div style="background:#FCE4EC;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C2185B">ì´ ê²½ì¡°ì‚¬ë¹„</div><div style="font-size:16px;font-weight:800;color:#880E4F" id="evt-total">0ì›</div></div>
      <div style="background:#E8F5E9;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#2E7D32">ê³µì œ ì¸ì •ì•¡</div><div style="font-size:16px;font-weight:800;color:#1B5E20" id="evt-deduct">0ì›</div></div>
      <div style="background:#FFEBEE;padding:12px;border-radius:var(--rs);text-align:center"><div style="font-size:10px;color:#C62828">ì´ˆê³¼ ë¶ˆì¸ì •</div><div style="font-size:16px;font-weight:800;color:#B71C1C" id="evt-over">0ì›</div></div>
    </div>
  </div>

  <!-- â‘§ ë²•ì  í•œë„ ëŒ€ì‹œë³´ë“œ -->
  <div class="cd fi d4">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="width:40px;height:40px;border-radius:10px;background:#E3F2FD;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--bl)"><i class="fas fa-scale-balanced"></i></div><div><div style="font-size:15px;font-weight:700">â‘§ ë²•ì  í•œë„ ì‹¤ì‹œê°„ í˜„í™©</div><div style="font-size:11px;color:var(--sub)">ëª¨ë“  ê³µì œÂ·ê²½ë¹„ í•­ëª©ì˜ ë²•ì • í•œë„ì™€ ì”ì—¬ë¶„</div></div></div>
    <div id="limit-dashboard"></div>
  </div>

  <!-- ì¢…í•© ì ˆì„¸ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ -->
  <div style="background:linear-gradient(135deg,var(--nv),var(--nvl));border-radius:var(--r);padding:24px;text-align:center;color:#fff;margin-top:8px;cursor:pointer" onclick="exSaveReport()" class="fi d4">
    <div style="font-size:16px;font-weight:700;margin-bottom:4px"><i class="fas fa-download" style="margin-right:6px"></i>ì ˆì„¸ ë¦¬í¬íŠ¸ PDF ë‹¤ìš´ë¡œë“œ</div>
    <div style="font-size:12px;opacity:.7">í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ PDFë¡œ ì €ì¥</div>
  </div>
</div>

<!-- TAB5: MONEY -->
<div class="tc" id="t5">
  <div class="mh fi"><h2 style="font-size:20px;font-weight:800"><i class="fas fa-star" style="color:var(--gd);margin-right:8px"></i>$$ MONEY & í˜œíƒ</h2><p style="font-size:12px;color:#888;margin-top:4px">ì§€ìœ¤ì§„ ëŒ€í‘œë‹˜ ë§ì¶¤ â€” ëˆ ë¹Œë¦¬ê³ Â·ë²Œê³ Â·ë°›ëŠ” ëª¨ë“  ê²ƒ</p></div>
  <div class="mu-bar fi d1" style="display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:14px;margin-bottom:16px"><div><i class="fas fa-clock" style="color:var(--gd);margin-right:4px"></i><span id="ut" style="font-size:12px">ìµœì¢…: ë¡œë”©ì¤‘...</span></div><button onclick="rfMoney()" style="padding:8px 16px;background:var(--gd);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit"><i class="fas fa-rotate" style="margin-right:4px"></i>ìµœì‹  í™•ì¸</button></div>

  <!-- ìš”ì•½ ì¹´ë“œ -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px" class="fi d1">
    <div style="background:linear-gradient(135deg,#E3F2FD,#BBDEFB);border-radius:var(--r);padding:14px;text-align:center">
      <div style="font-size:24px;margin-bottom:4px">ğŸ’°</div>
      <div style="font-size:10px;color:#1565C0;font-weight:600">ëŒ€ì¶œÂ·ìê¸ˆ</div>
      <div style="font-size:16px;font-weight:800;color:#0D47A1">3ê±´</div>
    </div>
    <div style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-radius:var(--r);padding:14px;text-align:center">
      <div style="font-size:24px;margin-bottom:4px">ğŸ</div>
      <div style="font-size:10px;color:#2E7D32;font-weight:600">ì§€ì›Â·í˜œíƒ</div>
      <div style="font-size:16px;font-weight:800;color:#1B5E20">3ê±´</div>
    </div>
    <div style="background:linear-gradient(135deg,#FFF3E0,#FFE0B2);border-radius:var(--r);padding:14px;text-align:center">
      <div style="font-size:24px;margin-bottom:4px">ğŸ’¸</div>
      <div style="font-size:10px;color:#E65100;font-weight:600">ì„¸ê¸ˆê°ë©´</div>
      <div style="font-size:16px;font-weight:800;color:#BF360C">2ê±´</div>
    </div>
  </div>

  <div id="ml"></div>

  <!-- ì‹¤ì‹œê°„ ê³µê³  ë°”ë¡œê°€ê¸° -->
  <div class="cd fi d2" style="border-left:4px solid var(--gd)">
    <div style="font-size:14px;font-weight:700;margin-bottom:10px"><i class="fas fa-bullhorn" style="color:var(--gd);margin-right:6px"></i>ì‹¤ì‹œê°„ ê³µê³  í™•ì¸</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <a href="https://www.bizinfo.go.kr" target="_blank" style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fa;border-radius:var(--rs);text-decoration:none;color:var(--nv);font-size:12px;font-weight:600"><i class="fas fa-search" style="color:var(--bl)"></i>ê¸°ì—…ë§ˆë‹¹ í†µí•©ê²€ìƒ‰</a>
      <a href="https://www.k-startup.go.kr" target="_blank" style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fa;border-radius:var(--rs);text-decoration:none;color:var(--nv);font-size:12px;font-weight:600"><i class="fas fa-rocket" style="color:var(--or)"></i>K-Startup</a>
      <a href="https://ols.semas.or.kr" target="_blank" style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fa;border-radius:var(--rs);text-decoration:none;color:var(--nv);font-size:12px;font-weight:600"><i class="fas fa-hand-holding-usd" style="color:var(--gn)"></i>ì†Œì§„ê³µ ì •ì±…ìê¸ˆ</a>
      <a href="https://www.sbiz.or.kr" target="_blank" style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fa;border-radius:var(--rs);text-decoration:none;color:var(--nv);font-size:12px;font-weight:600"><i class="fas fa-store" style="color:var(--pr)"></i>ì†Œìƒê³µì¸ë§ˆë‹¹</a>
    </div>
  </div>

  <div class="cd fi d3" style="border-left:4px solid var(--gd)"><div style="font-size:13px;color:#555;line-height:1.7"><b style="color:var(--nv)">ğŸ’¡ ëŒ€í‘œë‹˜ ì ìš© ê¸°ì¤€</b><br>â–¸ ì—…ì¢…: í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ… (ì§€ì‹ì„œë¹„ìŠ¤ì—…)<br>â–¸ ì†Œì¬ì§€: ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ (ìˆ˜ë„ê¶Œ ê³¼ë°€)<br>â–¸ ì—…ë ¥: 6ë…„ ì°¨ Â· 1ì¸ ì‚¬ì—…ì<br>â–¸ ë§¤ì¶œ: 1~2ì–µ Â· ì†Œê¸°ì—…<br>â–¸ ë¹„ìˆ˜ë„ê¶Œ í˜œíƒ = ì œì™¸ (êµ¬ë¦¬=ê³¼ë°€ì–µì œê¶Œì—­)</div></div>
</div>

<!-- TAB6: ì„¸ë¬´ ë„êµ¬í•¨ -->
<div class="tc" id="t6">
  <div class="fi" style="background:linear-gradient(135deg,#1A2B4B,#2C3E6B);border-radius:var(--r);padding:24px;color:#fff;margin-bottom:16px">
    <h2 style="font-size:20px;font-weight:800;margin-bottom:4px"><i class="fas fa-toolbox" style="margin-right:8px;color:var(--gd)"></i>ì„¸ë¬´ ë„êµ¬í•¨</h2>
    <p style="font-size:12px;opacity:.7;margin:0">ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ ë§ì¶¤ â€” ì•„ì´ì½˜ í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸°</p>
  </div>

  <!-- ë„êµ¬ ê²€ìƒ‰ -->
  <div style="margin-bottom:14px"><input type="text" id="tool-search" placeholder="ğŸ” ë„êµ¬ ê²€ìƒ‰ (í™ˆíƒìŠ¤, ë¶€ê°€ì„¸, 4ëŒ€ë³´í—˜, ì¹´ì¹´ì˜¤...)" oninput="searchTools(this.value)" style="width:100%;padding:12px 16px;border:2px solid #e0e0e0;border-radius:var(--r);font-family:inherit;font-size:13px;transition:border-color .2s" onfocus="this.style.borderColor='var(--gd)'" onblur="this.style.borderColor='#e0e0e0'"></div>
  <div id="tool-search-results" style="display:none;margin-bottom:14px"></div>
  <!-- 6ê°œ ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ ê·¸ë¦¬ë“œ -->
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px" id="tool-grid">
    <div class="tool-icon" onclick="toggleToolDetail('tl-1')" style="background:linear-gradient(135deg,#E3F2FD,#BBDEFB);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-1">
      <div style="font-size:32px;margin-bottom:8px">ğŸ›ï¸</div>
      <div style="font-size:12px;font-weight:800;color:#0D47A1">ì„¸ê¸ˆì‹ ê³ Â·ì¡°íšŒ</div>
      <div style="font-size:10px;color:#5C8DC4;margin-top:2px">í™ˆíƒìŠ¤Â·ìœ„íƒìŠ¤</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-2')" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-2">
      <div style="font-size:32px;margin-bottom:8px">ğŸ‘¥</div>
      <div style="font-size:12px;font-weight:800;color:#1B5E20">4ëŒ€ë³´í—˜Â·ì¸ê±´ë¹„</div>
      <div style="font-size:10px;color:#4CAF50;margin-top:2px">êµ­ë¯¼ì—°ê¸ˆÂ·ê±´ë³´</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-3')" style="background:linear-gradient(135deg,#FFF8E1,#FFECB3);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-3">
      <div style="font-size:32px;margin-bottom:8px">ğŸ¦</div>
      <div style="font-size:12px;font-weight:800;color:#E65100">ì€í–‰</div>
      <div style="font-size:10px;color:#FF9800;margin-top:2px">ë†í˜‘Â·ì‹ í•œÂ·í† ìŠ¤Â·ì¹´ì¹´ì˜¤</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-4')" style="background:linear-gradient(135deg,#F3E5F5,#E1BEE7);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-4">
      <div style="font-size:32px;margin-bottom:8px">ğŸ“„</div>
      <div style="font-size:12px;font-weight:800;color:#6A1B9A">ì¦ëª…ì„œÂ·ì„œë¥˜</div>
      <div style="font-size:10px;color:#9C27B0;margin-top:2px">ì •ë¶€24Â·ë“±ê¸°ì†Œ</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-5')" style="background:linear-gradient(135deg,#ECEFF1,#CFD8DC);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-5">
      <div style="font-size:32px;margin-bottom:8px">ğŸ› ï¸</div>
      <div style="font-size:12px;font-weight:800;color:#37474F">ì„¸ë¬´ ë„êµ¬</div>
      <div style="font-size:10px;color:#78909C;margin-top:2px">ì‚¬ì—…ìì¡°íšŒÂ·ë…¸ë€ìš°ì‚°</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-6')" style="background:linear-gradient(135deg,#FBE9E7,#FFCCBC);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-6">
      <div style="font-size:32px;margin-bottom:8px">ğŸ”</div>
      <div style="font-size:12px;font-weight:800;color:#BF360C">í”„ëœì°¨ì´ì¦ˆ</div>
      <div style="font-size:10px;color:#E64A19;margin-top:2px">ê³µì •ìœ„Â·ì†Œìƒê³µì¸</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-7')" style="background:linear-gradient(135deg,#E0F7FA,#B2EBF2);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-7">
      <div style="font-size:32px;margin-bottom:8px">ğŸ§®</div>
      <div style="font-size:12px;font-weight:800;color:#00695C">ê°„í¸ ê³„ì‚°ê¸°</div>
      <div style="font-size:10px;color:#26A69A;margin-top:2px">4ëŒ€ë³´í—˜Â·3.3%</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-8')" style="background:linear-gradient(135deg,#FCE4EC,#F8BBD0);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-8">
      <div style="font-size:32px;margin-bottom:8px">ğŸ“</div>
      <div style="font-size:12px;font-weight:800;color:#880E4F">ì‹ ê³ ì–‘ì‹ ë°”ë¡œê°€ê¸°</div>
      <div style="font-size:10px;color:#C2185B;margin-top:2px">ë¶€ê°€ì„¸Â·ì¢…ì†Œì„¸Â·ì§€ë°©ì„¸</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-9')" style="background:linear-gradient(135deg,#E8EAF6,#C5CAE9);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-9">
      <div style="font-size:32px;margin-bottom:8px">ğŸ“‹</div>
      <div style="font-size:12px;font-weight:800;color:#283593">êµ¬ë… ê´€ë¦¬</div>
      <div style="font-size:10px;color:#5C6BC0;margin-top:2px">AIÂ·SaaS ê²½ë¹„</div>
    </div>
    <div class="tool-icon" onclick="toggleToolDetail('tl-10')" style="background:linear-gradient(135deg,#E0F2F1,#B2DFDB);border-radius:var(--r);padding:20px 12px;text-align:center;cursor:pointer;transition:transform .15s;border:2px solid transparent" id="ti-10">
      <div style="font-size:32px;margin-bottom:8px">ğŸ¦</div>
      <div style="font-size:12px;font-weight:800;color:#004D40">ì‹ ìš©ë„ ê´€ë¦¬</div>
      <div style="font-size:10px;color:#00897B;margin-top:2px">ëŒ€í‘œì ì‹ ìš©Â·ëŒ€ì¶œ</div>
    </div>
  </div>

  <!-- ìƒì„¸ íŒ¨ë„ë“¤ -->
  <div class="tool-detail" id="tl-1" style="display:none">
    <div class="cd" style="border-left:4px solid #1565C0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#0D47A1">ğŸ›ï¸ ì„¸ê¸ˆì‹ ê³ Â·ì¡°íšŒ</div>
        <button onclick="toggleToolDetail('tl-1')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-landmark"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">í™ˆíƒìŠ¤</div><div class="tool-item-desc">ë¶€ê°€ì„¸Â·ì¢…ì†Œì„¸ ì‹ ê³ , ì„¸ê¸ˆê³„ì‚°ì„œ ì¡°íšŒÂ·ë°œê¸‰, ì‚¬ì—…ìë“±ë¡ ê´€ë¦¬</div><div class="tool-item-use">â–¸ 1/7ì›” ë¶€ê°€ì„¸, 5ì›” ì¢…ì†Œì„¸ ì‹ ê³  ì‹œ ì‚¬ìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.wetax.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-map-marked-alt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ìœ„íƒìŠ¤</div><div class="tool-item-desc">ì§€ë°©ì†Œë“ì„¸ ì‹ ê³ Â·ë‚©ë¶€ (ì¢…ì†Œì„¸ì˜ 10%)</div><div class="tool-item-use">â–¸ ì¢…ì†Œì„¸ ì‹ ê³  í›„ ë°˜ë“œì‹œ ìœ„íƒìŠ¤ì—ì„œ ì§€ë°©ì†Œë“ì„¸ ë³„ë„ ë‚©ë¶€</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-mobile-alt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì†íƒìŠ¤ (ëª¨ë°”ì¼)</div><div class="tool-item-desc">í™ˆíƒìŠ¤ ëª¨ë°”ì¼ ë²„ì „ â€” ê°„í¸ ì¡°íšŒÂ·ë‚©ë¶€Â·ì„¸ê¸ˆê³„ì‚°ì„œ í™•ì¸</div><div class="tool-item-use">â–¸ ì´ë™ ì¤‘ ë§¤ì¶œÂ·ë§¤ì… í™•ì¸, ê°„í¸ ë‚©ë¶€ ì‹œ ì‚¬ìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <div class="tool-detail" id="tl-2" style="display:none">
    <div class="cd" style="border-left:4px solid #2E7D32">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#1B5E20">ğŸ‘¥ 4ëŒ€ë³´í—˜Â·ì¸ê±´ë¹„</div>
        <button onclick="toggleToolDetail('tl-2')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div class="tool-item" onclick="window.open('https://www.4insure.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-shield-halved"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">4ëŒ€ì‚¬íšŒë³´í—˜ ì •ë³´ì—°ê³„ì„¼í„°</div><div class="tool-item-desc">4ëŒ€ë³´í—˜ ì·¨ë“Â·ìƒì‹¤ ì‹ ê³ , ë³´í—˜ë£Œ í†µí•© ì¡°íšŒ</div><div class="tool-item-use">â–¸ ì§ì› ì±„ìš©/í‡´ì§ ì‹œ ì·¨ë“Â·ìƒì‹¤ ì‹ ê³  í•œë²ˆì— ì²˜ë¦¬</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.nps.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-piggy-bank"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">êµ­ë¯¼ì—°ê¸ˆê³µë‹¨</div><div class="tool-item-desc">êµ­ë¯¼ì—°ê¸ˆ ë‚©ë¶€ë‚´ì—­, ì˜ˆìƒì—°ê¸ˆ ì¡°íšŒ, ì†Œë“ê³µì œ í™•ì¸</div><div class="tool-item-use">â–¸ ì¢…ì†Œì„¸ ì†Œë“ê³µì œ ê¸ˆì•¡ í™•ì¸ ì‹œ ì‚¬ìš© (ì—°ê°„ ë‚©ë¶€í™•ì¸ì„œ)</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.nhis.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#FCE4EC;color:#C62828"><i class="fas fa-heart-pulse"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">êµ­ë¯¼ê±´ê°•ë³´í—˜ê³µë‹¨</div><div class="tool-item-desc">ê±´ë³´ë£Œ ë‚©ë¶€í™•ì¸ì„œ, í”¼ë¶€ì–‘ì ê´€ë¦¬, ì¥ê¸°ìš”ì–‘ë³´í—˜</div><div class="tool-item-use">â–¸ ê±´ë³´ë£Œ+ì¥ê¸°ìš”ì–‘ë³´í—˜ë£Œ ë‚©ë¶€í™•ì¸ì„œ â†’ ì¢…ì†Œì„¸ ì†Œë“ê³µì œ</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://total.comwel.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-briefcase"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ê³ ìš©Â·ì‚°ì¬ë³´í—˜ í† íƒˆì„œë¹„ìŠ¤</div><div class="tool-item-desc">ê³ ìš©ë³´í—˜ ì´ë ¥, ì‹¤ì—…ê¸‰ì—¬, ì‚°ì¬ë³´í—˜ ì¡°íšŒ</div><div class="tool-item-use">â–¸ ê³ ìš©ë³´í—˜ë£Œ ë‚©ë¶€í™•ì¸ â†’ ì†Œë“ê³µì œ, ì§ì› ê³ ìš© ì‹œ ìê²©ì·¨ë“ ì‹ ê³ </div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.comwel.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#ECEFF1;color:#455A64"><i class="fas fa-hard-hat"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ê·¼ë¡œë³µì§€ê³µë‹¨</div><div class="tool-item-desc">ì‚°ì¬ë³´í—˜, í‡´ì§ì—°ê¸ˆ, ì²´ë‹¹ê¸ˆ</div><div class="tool-item-use">â–¸ ì§ì› ì±„ìš© ì‹œ ì‚°ì¬ë³´í—˜ ê´€ë¦¬, í‡´ì§ì—°ê¸ˆ ì„¤ì •</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <div class="tool-detail" id="tl-3" style="display:none">
    <div class="cd" style="border-left:4px solid #E65100">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#E65100">ğŸ¦ ì€í–‰</div>
        <button onclick="toggleToolDetail('tl-3')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div style="background:#FFF8E1;padding:10px;border-radius:var(--rs);margin-bottom:10px;font-size:11px;color:#F57F17"><i class="fas fa-info-circle" style="margin-right:4px"></i>ì¹´ì¹´ì˜¤ë±…í¬ ì²´í¬ì¹´ë“œëŠ” ê³„ì¢Œ ê±°ë˜ë‚´ì—­ì— í¬í•¨ â†’ ë³„ë„ ì¹´ë“œë‚´ì—­ ë¶ˆí•„ìš”. ë‹¨, <b>í™ˆíƒìŠ¤ ì‚¬ì—…ìš©ì¹´ë“œ ë“±ë¡</b>ì€ ë³„ë„ í•„ìˆ˜!</div>
      <div class="tool-item" onclick="window.open('https://banking.nonghyup.com','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-building-columns"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">NHë†í˜‘ì€í–‰</div><div class="tool-item-desc">ì‚¬ì—…ìš© í†µì¥ ê±°ë˜ë‚´ì—­ ì¡°íšŒÂ·ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</div><div class="tool-item-use">â–¸ ì¥ë¶€íƒ­ â†’ í†µì¥ ì—…ë¡œë“œìš© XLS ë‹¤ìš´. ë¶€ê°€ì„¸ ëŒ€ì‚¬ìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://bank.shinhan.com','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#0D47A1"><i class="fas fa-building-columns"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì‹ í•œì€í–‰</div><div class="tool-item-desc">ì‚¬ì—…ìš© í†µì¥ ê±°ë˜ë‚´ì—­ ì¡°íšŒÂ·ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</div><div class="tool-item-use">â–¸ ì‚¬ì—…ìš© í†µì¥ ì…ì¶œê¸ˆ ë‚´ì—­ â†’ ë¯¸ìˆ˜ê¸ˆ ì¶”ì  ëŒ€ì‚¬</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.tossbank.com','_blank')">
        <div class="tool-item-icon" style="background:#EDE7F6;color:#5E35B1"><i class="fas fa-building-columns"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">í† ìŠ¤ë±…í¬</div><div class="tool-item-desc">ì…ì¶œê¸ˆ ë‚´ì—­ ì¡°íšŒ, ì´ì í˜„í™©</div><div class="tool-item-use">â–¸ ì´ìì†Œë“ ë°œìƒ ì‹œ ì¢…ì†Œì„¸ í•©ì‚° ëŒ€ìƒ í™•ì¸</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.kakaobank.com','_blank')">
        <div class="tool-item-icon" style="background:#FFF9C4;color:#F57F17"><i class="fas fa-building-columns"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¹´ì¹´ì˜¤ë±…í¬</div><div class="tool-item-desc">ê³„ì¢Œ+ì²´í¬ì¹´ë“œ í†µí•© ë‚´ì—­ (ì¹´ë“œ ë³„ë„ ë¶ˆí•„ìš”)</div><div class="tool-item-use">â–¸ ì²´í¬ì¹´ë“œ ì‚¬ìš©ë‚´ì—­ = ê³„ì¢Œë‚´ì—­ì— ìë™ í¬í•¨</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <div class="tool-detail" id="tl-4" style="display:none">
    <div class="cd" style="border-left:4px solid #6A1B9A">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#6A1B9A">ğŸ“„ ì¦ëª…ì„œÂ·ì„œë¥˜ ë°œê¸‰</div>
        <button onclick="toggleToolDetail('tl-4')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div class="tool-item" onclick="window.open('https://www.gov.kr','_blank')">
        <div class="tool-item-icon" style="background:#F3E5F5;color:#6A1B9A"><i class="fas fa-file-certificate"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì •ë¶€24</div><div class="tool-item-desc">ì‚¬ì—…ìë“±ë¡ì¦ëª…, ë‚©ì„¸ì¦ëª…, 4ëŒ€ë³´í—˜ ì™„ë‚©ì¦ëª… ë°œê¸‰</div><div class="tool-item-use">â–¸ ê°€ë§¹ë³¸ë¶€ ê³„ì•½ ì‹œ ë‚©ì„¸ì¦ëª…Â·ì‚¬ì—…ìë“±ë¡ì¦ëª… ì œì¶œìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.iros.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-gavel"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¸í„°ë„·ë“±ê¸°ì†Œ</div><div class="tool-item-desc">ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸ ì—´ëŒÂ·ë°œê¸‰</div><div class="tool-item-use">â–¸ ì›ìœŒì•¤ì½” ë“±ê¸° í™•ì¸, ê°€ë§¹ë³¸ë¶€ ë²•ì¸ ì‹¤ì²´ í™•ì¸ìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://ecfs.scourt.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#ECEFF1;color:#455A64"><i class="fas fa-balance-scale"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ëŒ€ë²•ì› ì „ìì†Œì†¡</div><div class="tool-item-desc">ì†Œì†¡ ì„œë¥˜ ì¡°íšŒ (ë¶„ìŸ ë°œìƒ ì‹œ)</div><div class="tool-item-use">â–¸ ê°€ë§¹ ë¶„ìŸ, ë¯¸ìˆ˜ê¸ˆ ì†Œì†¡ ì‹œ ì „ìì†Œì†¡ ì ‘ìˆ˜Â·ì¡°íšŒ</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.credit4u.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-chart-bar"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì‹ ìš©ì •ë³´ì› í¬ë ˆë”§</div><div class="tool-item-desc">ì‚¬ì—…ì ì‹ ìš©ë“±ê¸‰ ì¡°íšŒ</div><div class="tool-item-use">â–¸ ì •ì±…ìê¸ˆÂ·ëŒ€ì¶œ ì‹ ì²­ ì „ ì‚¬ì—…ì ì‹ ìš©ë“±ê¸‰ ì‚¬ì „ í™•ì¸</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <div class="tool-detail" id="tl-5" style="display:none">
    <div class="cd" style="border-left:4px solid #455A64">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#37474F">ğŸ› ï¸ ì„¸ë¬´ ë„êµ¬Â·ìœ í‹¸ë¦¬í‹°</div>
        <button onclick="toggleToolDetail('tl-5')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div class="tool-item" onclick="window.open('https://teht.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/ab/a/a/UTABAAA01.xml','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-search"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì‚¬ì—…ìë“±ë¡ ìƒíƒœì¡°íšŒ</div><div class="tool-item-desc">ê±°ë˜ì²˜ ì‚¬ì—…ìë²ˆí˜¸ ì§„ìœ„Â·íœ´íì—… í™•ì¸</div><div class="tool-item-use">â–¸ ìƒˆ ê±°ë˜ì²˜ì™€ ê³„ì•½ ì „ ì‚¬ì—…ìë²ˆí˜¸ ìœ íš¨ì„± ë°˜ë“œì‹œ í™•ì¸</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰</div><div class="tool-item-desc">í™ˆíƒìŠ¤ì—ì„œ ë§¤ì¶œ ì„¸ê¸ˆê³„ì‚°ì„œ ì§ì ‘ ë°œê¸‰</div><div class="tool-item-use">â–¸ ì›ìœŒì•¤ì½”Â·ë‚´ì¼ì‚¬ì¥ ë§¤ì¶œ ë°œìƒ ì‹œ ì¦‰ì‹œ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.8899.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-umbrella"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ë…¸ë€ìš°ì‚°ê³µì œ</div><div class="tool-item-desc">ì†Œê¸°ì—… ëŒ€í‘œ í‡´ì§ê¸ˆ ì ë¦½ + ì†Œë“ê³µì œ (ì—° 200~500ë§Œì›)</div><div class="tool-item-use">â–¸ ê°€ì…í•˜ë©´ ì—° ìµœëŒ€ 500ë§Œì› ì†Œë“ê³µì œ. ì‚¬ì—…ì†Œë“ 4ì²œë§Œ ì´í•˜ ì‹œ 300ë§Œì› ê³µì œ</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://sminfo.mss.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#F3E5F5;color:#6A1B9A"><i class="fas fa-certificate"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¤‘ì†Œê¸°ì—…í˜„í™©ì •ë³´ì‹œìŠ¤í…œ</div><div class="tool-item-desc">ì¤‘ì†Œê¸°ì—… í™•ì¸ì„œ ë°œê¸‰ (ì„¸ì•¡ê°ë©´Â·ì •ì±…ìê¸ˆ ì‹ ì²­ìš©)</div><div class="tool-item-use">â–¸ ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´(20%) ì ìš© ì‹œ í™•ì¸ì„œ í•„ìš”</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <div class="tool-detail" id="tl-6" style="display:none">
    <div class="cd" style="border-left:4px solid #BF360C">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#BF360C">ğŸ” í”„ëœì°¨ì´ì¦ˆ ì—…ë¬´</div>
        <button onclick="toggleToolDetail('tl-6')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div class="tool-item" onclick="window.open('https://franchise.ftc.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#FBE9E7;color:#BF360C"><i class="fas fa-store"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ê³µì •ìœ„ ê°€ë§¹ì‚¬ì—…ì •ë³´</div><div class="tool-item-desc">ì •ë³´ê³µê°œì„œ ë“±ë¡Â·ì¡°íšŒ, ê°€ë§¹ì‚¬ì—… í˜„í™© í™•ì¸</div><div class="tool-item-use">â–¸ ì»¨ì„¤íŒ… ëŒ€ìƒ ë¸Œëœë“œ ì •ë³´ê³µê°œì„œ í™•ì¸, ê°€ë§¹ë³¸ë¶€ ì¬ë¬´ì œí‘œ ì—´ëŒ</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.sbiz.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-hand-holding-usd"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì†Œìƒê³µì¸ë§ˆë‹¹</div><div class="tool-item-desc">ì†Œìƒê³µì¸ ì§€ì›ì‚¬ì—…, ì •ì±…ìê¸ˆ, êµìœ¡ í”„ë¡œê·¸ë¨</div><div class="tool-item-use">â–¸ ê³ ê°(ì˜ˆë¹„ ì°½ì—…ì)ì—ê²Œ ì •ì±…ìê¸ˆÂ·êµìœ¡ ì•ˆë‚´ ì‹œ í™œìš©</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
      <div class="tool-item" onclick="window.open('https://www.mss.go.kr','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-landmark"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¤‘ì†Œë²¤ì²˜ê¸°ì—…ë¶€</div><div class="tool-item-desc">ì°½ì—…ì§€ì›, ì •ì±…ìê¸ˆ, ê·œì œ íŠ¹ë¡€ ì •ë³´</div><div class="tool-item-use">â–¸ í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ… ì‹œ ì •ë¶€ ì§€ì› ì •ì±… ì•ˆë‚´ ìë£Œ í™•ì¸</div></div>
        <i class="fas fa-external-link-alt" style="color:#aaa;font-size:12px"></i>
      </div>
    </div>
  </div>

  <!-- tl-7: ê°„í¸ ê³„ì‚°ê¸° -->
  <div class="tool-detail" id="tl-7" style="display:none">
    <div class="cd" style="border-left:4px solid #00695C">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#00695C">ğŸ§® ê°„í¸ ê³„ì‚°ê¸°</div>
        <button onclick="toggleToolDetail('tl-7')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>

      <!-- 4ëŒ€ë³´í—˜ ê³„ì‚°ê¸° -->
      <div style="background:#E0F7FA;border-radius:var(--rs);padding:14px;margin-bottom:12px">
        <div style="font-size:13px;font-weight:700;color:#00695C;margin-bottom:10px"><i class="fas fa-shield-halved" style="margin-right:4px"></i>4ëŒ€ë³´í—˜ ê³„ì‚°ê¸°</div>
        <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:10px">
          <div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì›” ê¸‰ì—¬(ì›)</div><input type="text" id="calc-ins-salary" placeholder="2,000,000" style="width:100%;padding:9px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;text-align:right" oninput="fmtInput(this);calcInsurance()"></div>
          <button onclick="calcInsurance()" style="padding:9px 16px;background:#00695C;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap">ê³„ì‚°</button>
        </div>
        <div id="calc-ins-result" style="font-size:12px;line-height:1.8"></div>
      </div>

      <!-- 3.3% ì›ì²œì§•ìˆ˜ ê³„ì‚°ê¸° -->
      <div style="background:#FFF8E1;border-radius:var(--rs);padding:14px">
        <div style="font-size:13px;font-weight:700;color:#E65100;margin-bottom:10px"><i class="fas fa-percent" style="margin-right:4px"></i>3.3% ì›ì²œì§•ìˆ˜ ê³„ì‚°ê¸°</div>
        <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:10px">
          <div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:3px">ì§€ê¸‰ ì´ì•¡(ì›)</div><input type="text" id="calc-wh-amount" placeholder="1,000,000" style="width:100%;padding:9px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;text-align:right" oninput="fmtInput(this);calcWithholding()"></div>
          <button onclick="calcWithholding()" style="padding:9px 16px;background:#E65100;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap">ê³„ì‚°</button>
        </div>
        <div id="calc-wh-result" style="font-size:12px;line-height:1.8"></div>
      </div>
    </div>
  </div>

  <!-- tl-8: ì„¸ê¸ˆì‹ ê³  ì–‘ì‹ ë°”ë¡œê°€ê¸° -->
  <div class="tool-detail" id="tl-8" style="display:none">
    <div class="cd" style="border-left:4px solid #880E4F">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#880E4F">ğŸ“ ì„¸ê¸ˆì‹ ê³  ì–‘ì‹ ë°”ë¡œê°€ê¸°</div>
        <button onclick="toggleToolDetail('tl-8')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div style="font-size:11px;color:#888;margin-bottom:10px">í™ˆíƒìŠ¤ ë¡œê·¸ì¸ í›„ í•´ë‹¹ ë©”ë‰´ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤</div>

      <div style="font-size:12px;font-weight:700;color:#1565C0;margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid #e0e0e0">ğŸ“‹ ë¶€ê°€ê°€ì¹˜ì„¸</div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0404010000','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-file-alt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ë¶€ê°€ì„¸ í™•ì •ì‹ ê³ ì„œ ì‘ì„± <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ì¼ë°˜ê³¼ì„¸ì ë¶€ê°€ì„¸ ì‹ ê³ ì„œ ì‘ì„± (1ê¸°Â·2ê¸°)</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0404030000','_blank')">
        <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ë§¤ì¶œÂ·ë§¤ì… ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ë°œí–‰/ìˆ˜ì·¨ ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ ì¡°íšŒ</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0505000000','_blank')">
        <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-receipt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰ <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ë§¤ì¶œ ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ì§ì ‘ ë°œê¸‰</div></div>
      </div>

      <div style="font-size:12px;font-weight:700;color:#2E7D32;margin:16px 0 6px;padding-bottom:4px;border-bottom:1px solid #e0e0e0">ğŸ“‹ ì¢…í•©ì†Œë“ì„¸</div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0406000000','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-file-alt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¢…ì†Œì„¸ ì‹ ê³ ì„œ ì‘ì„± (ì •ê¸°ì‹ ê³ ) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">5ì›” ì •ê¸° ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ì„œ ì‘ì„±</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0406050000','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-calculator"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì¢…ì†Œì„¸ ìë™ê³„ì‚° (ëª¨ì˜ê³„ì‚°) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ê³¼ì„¸í‘œì¤€Â·ì‚°ì¶œì„¸ì•¡ ìë™ ê³„ì‚° (ë¯¸ë¦¬ë³´ê¸°)</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0411000000','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-file-contract"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ê°„í¸ì¥ë¶€ ì†Œë“ê¸ˆì•¡ê³„ì‚°ì„œ <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ë³„ì§€ ì œ74í˜¸ â€” ê°„í¸ì¥ë¶€ ê¸°ë°˜ ì†Œë“ê¸ˆì•¡ ê³„ì‚°</div></div>
      </div>

      <div style="font-size:12px;font-weight:700;color:#6A1B9A;margin:16px 0 6px;padding-bottom:4px;border-bottom:1px solid #e0e0e0">ğŸ“‹ ì§€ë°©ì†Œë“ì„¸Â·ê¸°íƒ€</div>
      <div class="tool-item" onclick="window.open('https://www.wetax.go.kr/main/?cmd=LPTIIA0R0','_blank')">
        <div class="tool-item-icon" style="background:#F3E5F5;color:#6A1B9A"><i class="fas fa-map-marked-alt"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì§€ë°©ì†Œë“ì„¸ ì‹ ê³  (ìœ„íƒìŠ¤) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ì¢…ì†Œì„¸ ì‹ ê³  í›„ ë°˜ë“œì‹œ ì§€ë°©ì†Œë“ì„¸ ë³„ë„ ì‹ ê³ Â·ë‚©ë¶€</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0109000000','_blank')">
        <div class="tool-item-icon" style="background:#ECEFF1;color:#455A64"><i class="fas fa-credit-card"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì„¸ê¸ˆ ë‚©ë¶€ (ì „ìë‚©ë¶€) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ë¶€ê°€ì„¸Â·ì¢…ì†Œì„¸Â·ì›ì²œì„¸ ì „ìë‚©ë¶€</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=0407000000','_blank')">
        <div class="tool-item-icon" style="background:#ECEFF1;color:#455A64"><i class="fas fa-file-signature"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì›ì²œì„¸ ì‹ ê³  (ë§¤ì›” 10ì¼) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ê·¼ë¡œì†Œë“ ì›ì²œì§•ìˆ˜ ì‹ ê³ ì„œ â€” ë‚´ì¼ì‚¬ì¥ ê¸‰ì—¬ ê´€ë ¨</div></div>
      </div>
    </div>
  </div>

  <!-- tl-9: êµ¬ë… ê´€ë¦¬ (AIÂ·SaaS ê²½ë¹„) -->
  <div class="tool-detail" id="tl-9" style="display:none">
    <div class="cd" style="border-left:4px solid #283593">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#283593">ğŸ“‹ AIÂ·SaaS êµ¬ë… ê²½ë¹„ ê´€ë¦¬</div>
        <button onclick="toggleToolDetail('tl-9')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div style="font-size:11px;color:#888;margin-bottom:14px">AI ì„œë¹„ìŠ¤Â·SaaS êµ¬ë…ë£Œë¥¼ ë“±ë¡í•˜ê³  ë§¤ì…ì„¸ì•¡ê³µì œÂ·ê²½ë¹„ ì¸ì • í˜„í™©ì„ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤</div>

      <div class="sub-mgr-form" id="sub-form">
        <input type="text" id="sub-name" placeholder="ì„œë¹„ìŠ¤ëª… (ì˜ˆ: ChatGPT Plus)">
        <input type="text" id="sub-amount" placeholder="ì›” ê²°ì œê¸ˆì•¡ (ì›)" oninput="fmtInput(this)">
        <select id="sub-day">
          <option value="">ê²°ì œì¼ ì„ íƒ</option>
          <script>for(var _i=1;_i<=28;_i++)document.write('<option value="'+_i+'">ë§¤ì›” '+_i+'ì¼</option>')</script>
        </select>
        <select id="sub-method">
          <option value="ì¹´ë“œ">ì¹´ë“œ</option>
          <option value="ê³„ì¢Œ">ê³„ì¢Œì´ì²´</option>
        </select>
        <select id="sub-category">
          <option value="ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ">ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ</option>
          <option value="ê´‘ê³ ì„ ì „ë¹„">ê´‘ê³ ì„ ì „ë¹„</option>
          <option value="ì†Œëª¨í’ˆë¹„">ì†Œëª¨í’ˆë¹„</option>
        </select>
        <button onclick="addSubscription()" style="padding:9px 16px;background:#283593;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:13px;cursor:pointer">+ ë“±ë¡</button>
      </div>

      <div id="sub-list"></div>
      <div class="sub-summary" id="sub-summary" style="display:none"></div>
    </div>
  </div>

  <!-- tl-10: ëŒ€í‘œì ì‹ ìš©ë„ ê´€ë¦¬ -->
  <div class="tool-detail" id="tl-10" style="display:none">
    <div class="cd" style="border-left:4px solid #00695C">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:16px;font-weight:800;color:#004D40">ğŸ¦ ëŒ€í‘œì ì‹ ìš©ë„ ê´€ë¦¬</div>
        <button onclick="toggleToolDetail('tl-10')" style="background:none;border:none;font-size:18px;cursor:pointer;color:#999">âœ•</button>
      </div>
      <div style="font-size:11px;color:#888;margin-bottom:16px">ì‚¬ì—…ì ëŒ€ì¶œÂ·ê¸ˆìœµê±°ë˜ì— í•µì‹¬ì¸ ëŒ€í‘œì ê°œì¸ì‹ ìš©ë„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>

      <!-- ì‹ ìš© ì •ë³´ ì…ë ¥ -->
      <div style="background:linear-gradient(135deg,#E0F2F1,#B2DFDB);border-radius:var(--r);padding:20px;margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;color:#004D40;margin-bottom:12px">ğŸ“Š ë‚´ ì‹ ìš© ì •ë³´ ì…ë ¥</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="font-size:11px;color:#555;font-weight:600">ì‹ ìš©ì ìˆ˜ (NICE ê¸°ì¤€)</label>
            <input type="text" id="credit-score" placeholder="ì˜ˆ: 850" style="width:100%;padding:9px 12px;border:2px solid #B2DFDB;border-radius:var(--rs);font-family:inherit;font-size:14px;font-weight:700;text-align:center;margin-top:4px" oninput="this.value=this.value.replace(/[^0-9]/g,'');updateCreditInfo()">
          </div>
          <div>
            <label style="font-size:11px;color:#555;font-weight:600">ì‹ ìš©ë“±ê¸‰ (1~10ë“±ê¸‰)</label>
            <select id="credit-grade" style="width:100%;padding:9px 12px;border:2px solid #B2DFDB;border-radius:var(--rs);font-family:inherit;font-size:13px;margin-top:4px;appearance:auto" onchange="updateCreditInfo()">
              <option value="">ì„ íƒ</option>
              <option value="1">1ë“±ê¸‰ (900~1000)</option>
              <option value="2">2ë“±ê¸‰ (870~899)</option>
              <option value="3">3ë“±ê¸‰ (840~869)</option>
              <option value="4">4ë“±ê¸‰ (805~839)</option>
              <option value="5">5ë“±ê¸‰ (750~804)</option>
              <option value="6">6ë“±ê¸‰ (665~749)</option>
              <option value="7">7ë“±ê¸‰ (600~664)</option>
              <option value="8">8ë“±ê¸‰ (515~599)</option>
              <option value="9">9ë“±ê¸‰ (445~514)</option>
              <option value="10">10ë“±ê¸‰ (0~444)</option>
            </select>
          </div>
        </div>
        <button onclick="saveCreditInfo()" style="margin-top:12px;width:100%;padding:10px;background:#00695C;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:13px;cursor:pointer">ğŸ’¾ ì €ì¥</button>
      </div>

      <!-- ì‹ ìš© ë¶„ì„ ê²°ê³¼ -->
      <div id="credit-result"></div>

      <!-- ì˜¬í¬ë ˆë”§ ì—°ë™ -->
      <div style="background:#fff;border:2px solid #26A69A;border-radius:var(--r);padding:20px;margin-bottom:16px">
        <div style="font-size:14px;font-weight:800;color:#004D40;margin-bottom:10px">ğŸ”— ì˜¬í¬ë ˆë”§ (ìœ ë£ŒíšŒì›) ë°”ë¡œê°€ê¸°</div>
        <div style="font-size:11px;color:#666;margin-bottom:14px;line-height:1.6">ì˜¬í¬ë ˆë”§ ìœ ë£ŒíšŒì›ì´ì‹œë©´ ì•„ë˜ ë§í¬ì—ì„œ ìƒì„¸ ì‹ ìš©ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="tool-item" onclick="window.open('https://www.allcredit.co.kr/mypage/myCredit.ac','_blank')" style="margin-bottom:0">
            <div class="tool-item-icon" style="background:#E0F2F1;color:#00695C"><i class="fas fa-chart-line"></i></div>
            <div class="tool-item-info"><div class="tool-item-name" style="font-size:12px">ë‚´ ì‹ ìš©ì ìˆ˜ <i class="fas fa-external-link-alt" style="font-size:9px;color:#aaa"></i></div><div class="tool-item-desc" style="font-size:10px">NICE ì‹ ìš©ì ìˆ˜ ì¡°íšŒ</div></div>
          </div>
          <div class="tool-item" onclick="window.open('https://www.allcredit.co.kr/mypage/myCreditChange.ac','_blank')" style="margin-bottom:0">
            <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-arrows-spin"></i></div>
            <div class="tool-item-info"><div class="tool-item-name" style="font-size:12px">ì ìˆ˜ ë³€ë™ì´ë ¥ <i class="fas fa-external-link-alt" style="font-size:9px;color:#aaa"></i></div><div class="tool-item-desc" style="font-size:10px">ìµœê·¼ ë³€ë™ ì¶”ì´ í™•ì¸</div></div>
          </div>
          <div class="tool-item" onclick="window.open('https://www.allcredit.co.kr/mypage/myCreditInfo.ac','_blank')" style="margin-bottom:0">
            <div class="tool-item-icon" style="background:#FFF3E0;color:#E65100"><i class="fas fa-file-invoice"></i></div>
            <div class="tool-item-info"><div class="tool-item-name" style="font-size:12px">ì‹ ìš©ì •ë³´ ìƒì„¸ <i class="fas fa-external-link-alt" style="font-size:9px;color:#aaa"></i></div><div class="tool-item-desc" style="font-size:10px">ëŒ€ì¶œÂ·ì¹´ë“œÂ·ì—°ì²´ ë‚´ì—­</div></div>
          </div>
          <div class="tool-item" onclick="window.open('https://www.allcredit.co.kr/mypage/loanInfo.ac','_blank')" style="margin-bottom:0">
            <div class="tool-item-icon" style="background:#E3F2FD;color:#1565C0"><i class="fas fa-hand-holding-dollar"></i></div>
            <div class="tool-item-info"><div class="tool-item-name" style="font-size:12px">ëŒ€ì¶œ í˜„í™© <i class="fas fa-external-link-alt" style="font-size:9px;color:#aaa"></i></div><div class="tool-item-desc" style="font-size:10px">ê¸°ì¡´ ëŒ€ì¶œ ì¡°íšŒÂ·ê´€ë¦¬</div></div>
          </div>
        </div>
      </div>

      <!-- ê¸°íƒ€ ì‹ ìš©ì¡°íšŒ ë§í¬ -->
      <div style="font-size:12px;font-weight:700;color:#004D40;margin-bottom:8px">ğŸ“Œ ê¸°íƒ€ ì‹ ìš©ì¡°íšŒÂ·ê¸ˆìœµ ì„œë¹„ìŠ¤</div>
      <div class="tool-item" onclick="window.open('https://www.niceinfo.co.kr/creditrating/main.nice','_blank')">
        <div class="tool-item-icon" style="background:#E0F2F1;color:#00695C"><i class="fas fa-shield-halved"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">NICE ì§€í‚¤ë¯¸ (ë¬´ë£Œ) <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ì—° 3íšŒ ë¬´ë£Œ ì‹ ìš©ì ìˆ˜ ì¡°íšŒ</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.credit.co.kr','_blank')">
        <div class="tool-item-icon" style="background:#FFF8E1;color:#F57F17"><i class="fas fa-star"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">KCB ì˜¬í¬ë ˆë”§ í™ˆ <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">KCB ì‹ ìš©ì ìˆ˜Â·ë§ˆì´ë°ì´í„°</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.sbiz.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#E8F5E9;color:#2E7D32"><i class="fas fa-store"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì†Œìƒê³µì¸ë§ˆë‹¹ <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">ì •ì±…ìê¸ˆÂ·ì €ê¸ˆë¦¬ ëŒ€ì¶œ í™•ì¸</div></div>
      </div>
      <div class="tool-item" onclick="window.open('https://www.kinfa.or.kr','_blank')">
        <div class="tool-item-icon" style="background:#F3E5F5;color:#6A1B9A"><i class="fas fa-landmark"></i></div>
        <div class="tool-item-info"><div class="tool-item-name">ì„œë¯¼ê¸ˆìœµì§„í¥ì› <i class="fas fa-external-link-alt" style="font-size:10px;color:#aaa"></i></div><div class="tool-item-desc">í–‡ì‚´ë¡ Â·ë¯¸ì†Œê¸ˆìœµ ë“±</div></div>
      </div>
    </div>
  </div>

</div>

</div><!-- /ct -->

<div class="nav"><div class="ni">
  <button class="nb on" onclick="sw(1,this)"><i class="fas fa-chart-line"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
  <button class="nb" onclick="sw(2,this)"><i class="fas fa-book"></i><span>ì¥ë¶€</span></button>
  <button class="nb" onclick="sw(3,this)"><i class="fas fa-calculator"></i><span>ì ˆì„¸</span></button>
  <button class="nb" onclick="sw(4,this)"><i class="fas fa-arrow-trend-down"></i><span>ì„¸ê¸ˆì¤„ì´ê¸°</span></button>
  <button class="nb mn" onclick="sw(5,this)"><i class="fas fa-star"></i><span>MONEY</span></button>
  <button class="nb" onclick="sw(6,this)"><i class="fas fa-toolbox"></i><span>ë„êµ¬í•¨</span></button>
</div></div>

<style>
.tool-icon:hover{transform:scale(1.05)}
.tool-icon:active{transform:scale(0.97)}
.tool-item{display:flex;align-items:center;gap:12px;padding:14px;background:#fff;border:1px solid #f0f0f0;border-radius:var(--rs);margin-bottom:8px;cursor:pointer;transition:all .15s}
.tool-item:hover{background:#f8f9fa;border-color:#ddd}
.tool-item:active{transform:scale(0.99)}
.tool-item-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.tool-item-info{flex:1;min-width:0}
.tool-item-name{font-size:13px;font-weight:700;color:var(--nv);margin-bottom:2px}
.tool-item-desc{font-size:11px;color:#666;line-height:1.4}
.tool-item-use{font-size:10px;color:var(--bl);margin-top:3px;font-weight:600}
</style>
<script>
function searchTools(q){
  var results=document.getElementById('tool-search-results');
  var grid=document.getElementById('tool-grid');
  if(!q||q.length<1){results.style.display='none';grid.style.display='grid';document.querySelectorAll('.tool-detail').forEach(function(d){d.style.display='none'});return}
  q=q.toLowerCase();
  var items=document.querySelectorAll('.tool-item');
  var matches=[];
  items.forEach(function(item){
    var name=item.querySelector('.tool-item-name');
    var desc=item.querySelector('.tool-item-desc');
    var use=item.querySelector('.tool-item-use');
    var text=(name?name.textContent:'')+(desc?desc.textContent:'')+(use?use.textContent:'');
    if(text.toLowerCase().indexOf(q)>-1){matches.push(item.cloneNode(true))}
  });
  if(matches.length){
    grid.style.display='none';
    document.querySelectorAll('.tool-detail').forEach(function(d){d.style.display='none'});
    results.style.display='block';
    results.innerHTML='<div style="font-size:12px;color:var(--sub);margin-bottom:8px">ê²€ìƒ‰ ê²°ê³¼: '+matches.length+'ê±´</div>';
    var wrap=document.createElement('div');wrap.className='cd';wrap.style.borderLeft='4px solid var(--gd)';
    matches.forEach(function(m){wrap.appendChild(m)});
    results.appendChild(wrap);
  }else{
    grid.style.display='none';
    results.style.display='block';
    results.innerHTML='<div style="text-align:center;padding:20px;color:var(--sub)"><i class="fas fa-search" style="font-size:20px;display:block;margin-bottom:6px;color:#ddd"></i>"'+q+'" ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  }
}
function toggleToolDetail(id){
  var el=document.getElementById(id);
  var allDetails=document.querySelectorAll('.tool-detail');
  var allIcons=document.querySelectorAll('.tool-icon');
  if(el.style.display==='block'){
    el.style.display='none';
    allIcons.forEach(function(ic){ic.style.borderColor='transparent'});
    return;
  }
  allDetails.forEach(function(d){d.style.display='none'});
  allIcons.forEach(function(ic){ic.style.borderColor='transparent'});
  el.style.display='block';
  var idx=id.replace('tl-','');
  var icon=document.getElementById('ti-'+idx);
  if(icon)icon.style.borderColor='var(--gd)';
  el.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function fmtInput(el){var v=el.value.replace(/[^0-9]/g,'');if(v){var cursor=el.selectionStart;var beforeLen=el.value.length;el.value=parseInt(v).toLocaleString('ko-KR');var afterLen=el.value.length;el.setSelectionRange(cursor+(afterLen-beforeLen),cursor+(afterLen-beforeLen))}else{el.value=''}}
function calcInsurance(){
  var raw=document.getElementById('calc-ins-salary').value.replace(/[^0-9]/g,'');
  var sal=parseInt(raw)||0;
  if(!sal){document.getElementById('calc-ins-result').innerHTML='<span style="color:#999">ê¸‰ì—¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>';return}
  var nps=Math.floor(sal*0.045);
  var nhi=Math.floor(sal*0.03545);
  var ltc=Math.floor(nhi*0.9182/7.09/10)*10;
  var ei=Math.round(sal*0.009);
  var total=nps+nhi+ltc+ei;var net=sal-total;
  var h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">';
  h+='<div style="display:flex;justify-content:space-between"><span>êµ­ë¯¼ì—°ê¸ˆ (4.5%)</span><b>'+fm(nps)+'ì›</b></div>';
  h+='<div style="display:flex;justify-content:space-between"><span>ê±´ê°•ë³´í—˜ (3.545%)</span><b>'+fm(nhi)+'ì›</b></div>';
  h+='<div style="display:flex;justify-content:space-between"><span>ì¥ê¸°ìš”ì–‘ (ê±´ë³´Ã—0.9182Ã·7.09)</span><b>'+fm(ltc)+'ì›</b></div>';
  h+='<div style="display:flex;justify-content:space-between"><span>ê³ ìš©ë³´í—˜ (0.9%)</span><b>'+fm(ei)+'ì›</b></div>';
  h+='</div>';
  h+='<div style="margin-top:8px;padding-top:8px;border-top:2px solid #00695C;display:flex;justify-content:space-between;font-weight:800"><span>4ëŒ€ë³´í—˜ í•©ê³„</span><span style="color:#C62828">-'+fm(total)+'ì›</span></div>';
  h+='<div style="display:flex;justify-content:space-between;font-weight:800;color:#00695C;margin-top:4px"><span>ì˜ˆìƒ ì‹¤ìˆ˜ë ¹ì•¡</span><span>'+fm(net)+'ì›</span></div>';
  h+='<div style="font-size:10px;color:#999;margin-top:6px">â€» ê·¼ë¡œì ë¶€ë‹´ë¶„ ê¸°ì¤€ (ì‚¬ì—…ì£¼ ë¶€ë‹´ë¶„ ë³„ë„)</div>';
  document.getElementById('calc-ins-result').innerHTML=h;
}
function calcWithholding(){
  var raw=document.getElementById('calc-wh-amount').value.replace(/[^0-9]/g,'');
  var amt=parseInt(raw)||0;
  if(!amt){document.getElementById('calc-wh-result').innerHTML='<span style="color:#999">ì§€ê¸‰ ì´ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”</span>';return}
  var incomeTax=Math.round(amt*0.03);var localTax=Math.round(incomeTax*0.1);var total=incomeTax+localTax;var net=amt-total;
  var h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">';
  h+='<div style="display:flex;justify-content:space-between"><span>ì†Œë“ì„¸ (3%)</span><b>'+fm(incomeTax)+'ì›</b></div>';
  h+='<div style="display:flex;justify-content:space-between"><span>ì§€ë°©ì†Œë“ì„¸ (0.3%)</span><b>'+fm(localTax)+'ì›</b></div>';
  h+='</div>';
  h+='<div style="margin-top:8px;padding-top:8px;border-top:2px solid #E65100;display:flex;justify-content:space-between;font-weight:800"><span>ì›ì²œì§•ìˆ˜ í•©ê³„ (3.3%)</span><span style="color:#C62828">-'+fm(total)+'ì›</span></div>';
  h+='<div style="display:flex;justify-content:space-between;font-weight:800;color:#E65100;margin-top:4px"><span>ì‹¤ì§€ê¸‰ì•¡</span><span>'+fm(net)+'ì›</span></div>';
  h+='<div style="font-size:10px;color:#999;margin-top:6px">â€» ì‚¬ì—…ì†Œë“(í”„ë¦¬ëœì„œ) ì›ì²œì§•ìˆ˜ ê¸°ì¤€. ë§¤ì›” 10ì¼ê¹Œì§€ ì›ì²œì„¸ ì‹ ê³ Â·ë‚©ë¶€</div>';
  document.getElementById('calc-wh-result').innerHTML=h;
}
</script>
<style>
.ub-btn{padding:8px 18px;border-radius:20px;border:2px solid #e0e0e0;background:#fff;font-family:inherit;font-weight:600;font-size:13px;cursor:pointer;transition:all .15s;color:var(--nv)}
.ub-btn:hover{border-color:var(--gd);background:var(--gdb)}
.ub-btn.ub-on{background:var(--nv);color:#fff;border-color:var(--nv)}
.add-row select:focus,.add-row input:focus{border-color:var(--gd);outline:none}
.nd-item{display:flex;align-items:center;gap:10px;padding:12px;background:#f8f9fa;border-radius:var(--rs);margin-bottom:8px}
.nd-toggle{width:44px;height:24px;border-radius:12px;border:none;cursor:pointer;position:relative;transition:all .2s}
.nd-toggle::after{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;top:2px;left:2px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.nd-toggle.on{background:var(--gn)}.nd-toggle.on::after{left:22px}
.nd-toggle.off{background:#ddd}
</style>

<div class="mo" id="mo"><div class="ml"><h3 id="mt">íŒŒì¼ ì¢…ë¥˜ ì„ íƒ</h3><div class="ml-fn" id="mfn"></div><div class="ml-g" id="ml-g-btns">
  <button class="ml-b" style="border-color:var(--bl);color:var(--bl)" onclick="mC('bank')"><i class="fas fa-building-columns"></i>í†µì¥</button>
  <button class="ml-b" style="border-color:var(--or);color:var(--or)" onclick="mC('tax')"><i class="fas fa-file-invoice"></i>ì„¸ê¸ˆê³„ì‚°ì„œ</button>
  <button class="ml-b" style="border-color:var(--pr);color:var(--pr)" onclick="mC('card')"><i class="fas fa-credit-card"></i>ì¹´ë“œ</button>
  <button class="ml-b" style="border-color:#888;color:#888" onclick="mC('etc')"><i class="fas fa-wand-magic-sparkles"></i>ìë™</button>
</div><div id="mc"></div></div></div>

<!-- í†µí•© API ì„¤ì • ëª¨ë‹¬ -->
<div id="settings-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:260;align-items:center;justify-content:center;padding:20px">
<div style="background:#fff;border-radius:var(--r);padding:0;max-width:480px;width:100%;max-height:90vh;overflow-y:auto">
  <!-- í—¤ë” -->
  <div style="background:linear-gradient(135deg,var(--nv),var(--nvl));color:#fff;padding:20px 24px;border-radius:var(--r) var(--r) 0 0">
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:18px;font-weight:800"><i class="fas fa-gear" style="margin-right:8px"></i>API ì—°ë™ ì„¤ì •</div><button onclick="closeSettings()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;opacity:.7"><i class="fas fa-xmark"></i></button></div>
    <div style="font-size:11px;opacity:.7;margin-top:4px">Gemini AI + Claude AI + Perplexity + Alpha Vantage + Drive ì—°ë™</div>
  </div>
  <div style="padding:24px">
    <!-- â‘  Gemini AI -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#4285F4,#EA4335,#FBBC05,#34A853);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff"><i class="fas fa-wand-magic-sparkles"></i></div><div><div style="font-size:15px;font-weight:700">Gemini AI</div><div style="font-size:11px;color:var(--sub)">ì˜ìˆ˜ì¦ ìŠ¤ìº” Â· AI ë¶„ì„</div></div><div id="gemini-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div style="margin-bottom:8px"><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">Gemini API Key</div><div style="display:flex;gap:6px"><input type="password" id="gemini-api-key" placeholder="Google AI Studioì—ì„œ ë°œê¸‰" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><button onclick="saveGeminiKey()" style="padding:10px 16px;background:var(--bl);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save"></i> ì €ì¥</button></div></div>
      <div style="background:#E8F5E9;border-radius:var(--rs);padding:10px;font-size:10px;color:#2E7D32;line-height:1.5"><b>ë¬´ë£Œ ë°œê¸‰:</b> <a href="https://aistudio.google.com/apikey" target="_blank" style="color:#1565C0;font-weight:700">aistudio.google.com/apikey</a> â†’ Create API Key â†’ ë³µì‚¬ â†’ ë¶™ì—¬ë„£ê¸°</div>
    </div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin-bottom:20px"></div>
    <!-- â‘  -2 Claude AI -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#D97706,#B45309);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff"><i class="fas fa-brain"></i></div><div><div style="font-size:15px;font-weight:700">Claude AI</div><div style="font-size:11px;color:var(--sub)">ê²½ë¹„ ìë™ë¶„ë¥˜ Â· ë¶ˆê³µì œ íŒë‹¨ Â· ì„¸ë¬´ ìƒë‹´</div></div><div id="claude-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div style="margin-bottom:8px"><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">Claude API Key</div><div style="display:flex;gap:6px"><input type="password" id="claude-api-key" placeholder="sk-ant-api03-..." style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><button onclick="saveClaudeKey()" style="padding:10px 16px;background:#D97706;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save"></i> ì €ì¥</button></div></div>
      <div style="background:#FEF3C7;border-radius:var(--rs);padding:10px;font-size:10px;color:#92400E;line-height:1.6"><b>ë°œê¸‰ (3ë‹¨ê³„):</b><br>1. <a href="https://console.anthropic.com" target="_blank" style="color:#0D47A1;font-weight:700">console.anthropic.com</a> â†’ íšŒì›ê°€ì… (êµ¬ê¸€ ë¡œê·¸ì¸ ê°€ëŠ¥)<br>2. ëŒ€ì‹œë³´ë“œ â†’ API Keys â†’ Create Key â†’ ë³µì‚¬<br>3. Billing â†’ $5 í¬ë ˆë”§ ì¶©ì „ (API í˜¸ì¶œì— í•„ìš”)<br><b>ê¸°ëŠ¥:</b> ê±°ë˜ì²˜ í´ë¦­ ì‹œ ê²½ë¹„ë¶„ë¥˜ AI ìë™ ì¶”ì²œ Â· ë¶ˆê³µì œ ì‚¬ìœ  ë¶„ì„ Â· ì„¸ë¬´ Q&A</div>
    </div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin-bottom:20px"></div>
    <!-- â‘¡ Google Drive -->
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:#E8F0FE;display:flex;align-items:center;justify-content:center;font-size:18px;color:#4285F4"><i class="fab fa-google-drive"></i></div><div><div style="font-size:15px;font-weight:700">Google Drive</div><div style="font-size:11px;color:var(--sub)">íŒŒì¼ ìë™ ë¶„ë¥˜ Â· í´ë¼ìš°ë“œ ì €ì¥</div></div><div id="drive-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div id="drive-env-warning" style="display:none;background:#FFF3E0;border:1px solid #FFE0B2;border-radius:var(--rs);padding:10px;font-size:11px;color:#E65100;margin-bottom:10px;line-height:1.5"><b>âš ï¸ file:// í™˜ê²½ì—ì„œëŠ” Drive ì—°ë™ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</b><br>YJ_Tax_Master_ì‹¤í–‰.batë¥¼ ì‚¬ìš©í•˜ì—¬ localhostë¡œ ì‹¤í–‰í•˜ì„¸ìš”.</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">
        <div><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">API Key</div><input type="text" id="drive-api-key" value="AIzaSyDLI18EzG7eSEgH2Gd1NGzB55sFuKi-6HI" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
        <div><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">Client ID</div><input type="text" id="drive-client-id" value="972087681610-vvhb2087qvs7d93c4ogjur93jlck9558.apps.googleusercontent.com" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"></div>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:10px">
        <button onclick="connectDrive()" id="drive-connect-btn" style="flex:1;padding:12px;background:#4285F4;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px"><i class="fab fa-google-drive"></i>Drive ì—°ê²°</button>
        <button onclick="disconnectDrive()" id="drive-disconnect-btn" style="display:none;padding:12px 16px;background:#FFEBEE;color:var(--rd);border:1px solid #EF9A9A;border-radius:var(--rs);font-family:inherit;font-weight:600;font-size:12px;cursor:pointer"><i class="fas fa-unlink"></i></button>
      </div>
      <div id="drive-connect-log" style="display:none;background:#f8f9fa;border-radius:var(--rs);padding:10px;font-size:10px;color:#555;line-height:1.6;max-height:120px;overflow-y:auto;margin-bottom:10px"></div>
      <div style="background:#f8f9fa;border-radius:var(--rs);padding:12px;font-size:10px;color:#555;line-height:1.8;font-family:monospace">ğŸ“ YJ_Tax_Master / 2026 / 02ì›” / í†µì¥Â·ì„¸ê¸ˆê³„ì‚°ì„œÂ·ì¹´ë“œÂ·ê¸°íƒ€Â·ê²½ì¡°ì‚¬ë¹„</div>
    </div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin:20px 0"></div>
    <!-- ì—…ë¡œë“œ ë¡œê·¸ -->
    <div><div style="font-size:12px;font-weight:600;color:var(--nv);margin-bottom:6px">ğŸ“‹ ì—…ë¡œë“œ ê¸°ë¡</div><div id="drive-log" style="max-height:150px;overflow-y:auto;font-size:11px;color:var(--sub)">ê¸°ë¡ ì—†ìŒ</div></div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin:20px 0"></div>
    <!-- â‘¢ êµ­ì„¸ì²­ Open API -->
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:#E3F2FD;display:flex;align-items:center;justify-content:center;font-size:18px;color:#1565C0"><i class="fas fa-landmark"></i></div><div><div style="font-size:15px;font-weight:700">êµ­ì„¸ì²­ Open API</div><div style="font-size:11px;color:var(--sub)">ì‚¬ì—…ì ìƒíƒœì¡°íšŒ Â· íœ´íì—… í™•ì¸ Â· ê³¼ì„¸ìœ í˜•</div></div><div id="nts-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div style="margin-bottom:8px"><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">ê³µê³µë°ì´í„°í¬í„¸ ì„œë¹„ìŠ¤í‚¤ (Encoding)</div><div style="display:flex;gap:6px"><input type="password" id="nts-api-key" placeholder="ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°œê¸‰ë°›ì€ ì„œë¹„ìŠ¤í‚¤" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:11px"><button onclick="saveNtsKey()" style="padding:10px 16px;background:#1565C0;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save"></i> ì €ì¥</button></div></div>
      <div style="background:#E3F2FD;border-radius:var(--rs);padding:10px;font-size:10px;color:#1565C0;line-height:1.6"><b>ë¬´ë£Œ ë°œê¸‰ (3ë‹¨ê³„):</b><br>1. <a href="https://www.data.go.kr/tcs/dss/selectApiDataDetailView.do?publicDataPk=15081808" target="_blank" style="color:#0D47A1;font-weight:700">data.go.kr í™œìš©ì‹ ì²­</a> í´ë¦­<br>2. íšŒì›ê°€ì… â†’ í™œìš©ì‹ ì²­ (ìŠ¹ì¸ ì¦‰ì‹œ~3ì‹œê°„)<br>3. ë§ˆì´í˜ì´ì§€ â†’ ì¸ì¦í‚¤(Encoding) ë³µì‚¬ â†’ ì—¬ê¸° ë¶™ì—¬ë„£ê¸°<br><b>ê¸°ëŠ¥:</b> ë§¤ì… ê±°ë˜ì²˜ íœ´íì—… ìë™ í™•ì¸ Â· ê³¼ì„¸ìœ í˜• ì¡°íšŒ Â· ìœ„í—˜ ê²½ê³ </div>
      <!-- ì¦‰ì„ ì¡°íšŒ -->
      <div style="margin-top:10px;display:flex;gap:6px"><input type="text" id="nts-bno-input" placeholder="ì‚¬ì—…ìë²ˆí˜¸ (- ì—†ì´ 10ìë¦¬)" maxlength="10" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:monospace;font-size:13px;letter-spacing:1px"><button onclick="ntsQuickCheck()" style="padding:10px 16px;background:#1565C0;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-search"></i> ì¡°íšŒ</button></div>
      <div id="nts-quick-result" style="display:none;margin-top:8px;padding:10px;border-radius:var(--rs);font-size:12px"></div>
    </div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin:20px 0"></div>
    <!-- â‘£ Perplexity AI -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#20B2AA,#008080);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff"><i class="fas fa-magnifying-glass-chart"></i></div><div><div style="font-size:15px;font-weight:700">Perplexity AI</div><div style="font-size:11px;color:var(--sub)">ì‹¤ì‹œê°„ ê²€ìƒ‰ Â· ì„¸ë¬´ ë¦¬ì„œì¹˜ Â· ë²•ë ¹ ì¡°íšŒ</div></div><div id="perplexity-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div style="margin-bottom:8px"><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">Perplexity API Key</div><div style="display:flex;gap:6px"><input type="password" id="perplexity-api-key" placeholder="pplx-..." style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><button onclick="savePerplexityKey()" style="padding:10px 16px;background:#008080;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save"></i> ì €ì¥</button></div></div>
      <div style="background:#E0F2F1;border-radius:var(--rs);padding:10px;font-size:10px;color:#00695C;line-height:1.5"><b>ë°œê¸‰:</b> <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color:#00695C;font-weight:700">perplexity.ai/settings/api</a> â†’ API Key ìƒì„± â†’ ë³µì‚¬<br><b>ê¸°ëŠ¥:</b> ì‹¤ì‹œê°„ ì„¸ë¬´ ë²•ë ¹ ê²€ìƒ‰ Â· ìµœì‹  ì„¸ë²• ë³€ê²½ì‚¬í•­ Â· AI ë¦¬ì„œì¹˜</div>
    </div>
    <!-- êµ¬ë¶„ì„  -->
    <div style="border-top:2px solid #f0f0f0;margin:20px 0"></div>
    <!-- â‘¤ Alpha Vantage -->
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#FF6B35,#D4380D);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff"><i class="fas fa-chart-line"></i></div><div><div style="font-size:15px;font-weight:700">Alpha Vantage</div><div style="font-size:11px;color:var(--sub)">ì£¼ì‹ ì‹œì„¸ Â· í™˜ìœ¨ ì¡°íšŒ Â· ì¬ë¬´ ë°ì´í„°</div></div><div id="alpha-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#f0f0f0;color:#999">ë¯¸ì—°ë™</div></div>
      <div style="margin-bottom:8px"><div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">Alpha Vantage API Key</div><div style="display:flex;gap:6px"><input type="password" id="alpha-api-key" placeholder="Alpha Vantage API Key" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px"><button onclick="saveAlphaKey()" style="padding:10px 16px;background:#D4380D;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap"><i class="fas fa-save"></i> ì €ì¥</button></div></div>
      <div style="background:#FFF3E0;border-radius:var(--rs);padding:10px;font-size:10px;color:#BF360C;line-height:1.5"><b>ë¬´ë£Œ ë°œê¸‰:</b> <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color:#BF360C;font-weight:700">alphavantage.co</a> â†’ Get Free API Key â†’ ë³µì‚¬<br><b>ê¸°ëŠ¥:</b> ì‹¤ì‹œê°„ ì£¼ì‹ ì‹œì„¸ Â· USD/KRW í™˜ìœ¨ Â· ê¸°ì—… ì¬ë¬´ì œí‘œ ì¡°íšŒ</div>
    </div>
  </div>
</div>
</div>

<!-- ì˜ìˆ˜ì¦ ìŠ¤ìº” ê²°ê³¼ í† ìŠ¤íŠ¸ -->
<div id="ai-toast" style="display:none;position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--nv);color:#fff;padding:14px 24px;border-radius:var(--r);font-size:13px;font-weight:600;z-index:500;box-shadow:0 8px 32px rgba(0,0,0,.3);transition:all .3s"><i class="fas fa-check-circle" style="margin-right:6px;color:var(--gn)"></i><span id="ai-toast-msg">ì™„ë£Œ</span></div>

<!-- ìŠ¤ë§ˆíŠ¸ ë§¤ì… ì„ íƒ íŒì—… -->
<div id="smart-purchase-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:270;align-items:center;justify-content:center;padding:20px">
<div style="background:#fff;border-radius:var(--r);padding:24px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:16px;font-weight:700"><i class="fas fa-search-dollar" style="color:var(--bl);margin-right:8px"></i>ë§¤ì… ë‚´ì—­ ì„ íƒ</div><button onclick="closeSmartPurchase()" style="background:none;border:none;font-size:18px;color:#999;cursor:pointer"><i class="fas fa-xmark"></i></button></div>
  <input type="text" id="smart-search" placeholder="ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰ (ì‚¼ì„±, ë…¸íŠ¸ë¶, ì¿ íŒ¡...)" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:13px;margin-bottom:12px" oninput="filterSmartPurchase(this.value)">
  <div id="smart-purchase-list" style="font-size:13px"></div>
</div>
</div>

<!-- AI ì–´ì‹œìŠ¤í„´íŠ¸ íŒ¨ë„ -->
<div id="ai-panel" style="display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.4)">
<div style="position:absolute;right:0;top:0;bottom:0;width:100%;max-width:480px;background:#fff;display:flex;flex-direction:column;box-shadow:-8px 0 40px rgba(0,0,0,.15)">
  <div style="background:linear-gradient(135deg,var(--nv),var(--nvl));color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;background:var(--gd);border-radius:50%;display:flex;align-items:center;justify-content:center"><i class="fas fa-robot" style="color:var(--nv);font-size:16px"></i></div><div><div style="font-size:15px;font-weight:700">YJ ì„¸ë¬´ ì–´ì‹œìŠ¤í„´íŠ¸</div><div style="font-size:11px;opacity:.7">ì¥ë¶€ ë°ì´í„° ê¸°ë°˜ ë‹µë³€ Â· íŒŒì¼ ìƒì„±</div></div></div>
    <button onclick="closeAI()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:4px 8px"><i class="fas fa-xmark"></i></button>
  </div>
  <div style="display:flex;gap:6px;padding:12px 16px;border-bottom:1px solid #eee;flex-shrink:0;flex-wrap:wrap" id="ai-chips">
    <button class="ai-chip" onclick="aiAsk('ì´ë²ˆ ë‹¬ ë§¤ì¶œ í•©ê³„ ì•Œë ¤ì¤˜')">ë§¤ì¶œ í•©ê³„</button>
    <button class="ai-chip" onclick="aiAsk('ë¶€ê°€ì„¸ ì–¼ë§ˆ ë‚´ì•¼ í•´?')">ë¶€ê°€ì„¸</button>
    <button class="ai-chip" onclick="aiAsk('ë¶ˆê³µì œ í•­ëª© ì•Œë ¤ì¤˜')">ë¶ˆê³µì œ í•­ëª©</button>
    <button class="ai-chip" onclick="aiAsk('ì ˆì„¸ ë°©ë²• ì•Œë ¤ì¤˜')">ì ˆì„¸ ë°©ë²•</button>
    <button class="ai-chip" onclick="aiAsk('ì„¸ê¸ˆê³„ì‚°ì„œ ì—‘ì…€ë¡œ ë§Œë“¤ì–´ì¤˜')">ì—‘ì…€ ì¶œë ¥</button>
    <button class="ai-chip" onclick="aiAsk('ë§¤ì¶œ ë¦¬í¬íŠ¸ PDF ë§Œë“¤ì–´ì¤˜')">PDF ë¦¬í¬íŠ¸</button>
    <button class="ai-chip" onclick="aiAsk('ê±°ë˜ì²˜ë³„ ë§¤ì¶œ ë¹„êµí•´ì¤˜')">ê±°ë˜ì²˜ ë¹„êµ</button>
    <button class="ai-chip" onclick="aiAsk('ì¢…ì†Œì„¸ ì–¼ë§ˆì•¼?')">ì¢…ì†Œì„¸</button>
    <button class="ai-chip" onclick="aiPerplexitySearch('ìµœì‹  ë¶€ê°€ì„¸ ì„¸ë²• ë³€ê²½ì‚¬í•­')" style="background:#E0F2F1;border-color:#80CBC4;color:#00695C"><i class="fas fa-magnifying-glass" style="margin-right:3px;font-size:10px"></i>ì„¸ë²• ê²€ìƒ‰</button>
    <button class="ai-chip" onclick="aiPerplexitySearch('ê°œì¸ì‚¬ì—…ì ì ˆì„¸ ë°©ë²• 2026')" style="background:#E0F2F1;border-color:#80CBC4;color:#00695C"><i class="fas fa-magnifying-glass" style="margin-right:3px;font-size:10px"></i>ì ˆì„¸ ë¦¬ì„œì¹˜</button>
  </div>
  <!-- AI ì—”ì§„ ì„ íƒ -->
  <div style="display:flex;align-items:center;gap:6px;padding:6px 16px;border-bottom:1px solid #eee;flex-shrink:0;background:#fafbfc;font-size:11px">
    <span style="color:var(--sub);font-weight:600">AI ì—”ì§„:</span>
    <select id="ai-engine-select" style="padding:4px 8px;border:1px solid #ddd;border-radius:var(--rs);font-family:inherit;font-size:11px;background:#fff;cursor:pointer">
      <option value="local">ë‚´ì¥ (ì˜¤í”„ë¼ì¸)</option>
      <option value="gemini">Gemini AI</option>
      <option value="perplexity">Perplexity (ê²€ìƒ‰)</option>
      <option value="claude">Claude AI</option>
    </select>
    <span id="ai-engine-status" style="margin-left:auto;font-size:10px;color:var(--sub)"></span>
  </div>
  <div id="ai-chat" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px">
    <div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-robot"></i></div><div class="ai-bubble">ì•ˆë…•í•˜ì„¸ìš”, ì§€ìœ¤ì§„ ëŒ€í‘œë‹˜! ğŸ’¼<br><br>ì¥ë¶€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ <b>ì§ˆë¬¸ ë‹µë³€</b>, <b>íŒŒì¼ ìƒì„±</b>, <b>ì„¸ë¬´ ë¶„ì„</b>ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.<br><br><b>Perplexity ê²€ìƒ‰</b>: ì‹¤ì‹œê°„ ì„¸ë²•/ë²•ë ¹ ê²€ìƒ‰<br><b>Gemini/Claude</b>: ì‹¬ì¸µ AI ë¶„ì„<br><br>ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</div></div>
  </div>
  <div style="border-top:1px solid #eee;padding:12px 16px;display:flex;gap:8px;flex-shrink:0;background:#fafbfc">
    <input id="ai-input" type="text" placeholder="ì§ˆë¬¸í•˜ì„¸ìš”... (ì˜ˆ: ë§¤ì¶œ í•©ê³„, ë¶€ê°€ì„¸, ì—‘ì…€ ì¶œë ¥)" style="flex:1;padding:12px 16px;border:2px solid #e0e0e0;border-radius:12px;font-family:inherit;font-size:14px;outline:none;transition:border .2s" onfocus="this.style.borderColor='var(--gd)'" onblur="this.style.borderColor='#e0e0e0'" onkeydown="if(event.key==='Enter')aiSend()">
    <button onclick="aiSend()" style="background:var(--nv);color:#fff;border:none;width:44px;height:44px;border-radius:12px;cursor:pointer;font-size:16px;transition:all .15s;flex-shrink:0"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>
</div>

<style>
.ai-chip{background:#f0f2f5;border:1px solid #e0e0e0;border-radius:20px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--nv);cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap}
.ai-chip:hover{background:var(--gdb);border-color:var(--gd);transform:translateY(-1px)}
.ai-msg{display:flex;gap:10px;align-items:flex-start}
.ai-msg.ai-user{flex-direction:row-reverse}
.ai-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.ai-bot .ai-av{background:var(--gd);color:var(--nv)}
.ai-user .ai-av{background:var(--nv);color:#fff}
.ai-bubble{max-width:85%;padding:12px 16px;border-radius:16px;font-size:13px;line-height:1.6}
.ai-bot .ai-bubble{background:#f0f2f5;border-top-left-radius:4px;color:var(--tx)}
.ai-user .ai-bubble{background:var(--nv);color:#fff;border-top-right-radius:4px}
.ai-file{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:10px 14px;margin-top:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s}
.ai-file:hover{background:var(--gdb);border-color:var(--gd)}
.ai-typing{display:flex;gap:4px;padding:12px 16px}.ai-typing span{width:8px;height:8px;background:#ccc;border-radius:50%;animation:blink 1.4s infinite both}
.ai-typing span:nth-child(2){animation-delay:.2s}.ai-typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
</style>

<script>
if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
var D={bank:[],tax:[],card:[],proof:[],etc:[],files:[],isDemo:true},pn={f:null,r:null,t:''};
// localStorage ì €ì¥/ë¡œë“œ
function saveData(){
  try{
    localStorage.setItem('yjtax_D',JSON.stringify(D));
    localStorage.setItem('yjtax_evt',JSON.stringify(evtData));
    // ìë™ ì´ì¤‘ë°±ì—…: ë§¤ ì €ì¥ ì‹œ shadow ë³µì‚¬ë³¸ ìœ ì§€
    localStorage.setItem('yjtax_D_shadow',JSON.stringify(D));
    localStorage.setItem('yjtax_evt_shadow',JSON.stringify(evtData));
  }catch(e){}
}
function ensureD(){
  // êµ¬ë²„ì „ localStorage ë°ì´í„° í˜¸í™˜ + ëˆ„ë½ ì†ì„± ë³´ì •
  if(!D.bank)D.bank=[];if(!D.tax)D.tax=[];if(!D.card)D.card=[];
  if(!D.proof)D.proof=[];if(!D.etc)D.etc=[];if(!D.files)D.files=[];
  if(D.isDemo===undefined)D.isDemo=true;
  if(!Array.isArray(D.bank))D.bank=[];if(!Array.isArray(D.tax))D.tax=[];
  if(!Array.isArray(D.card))D.card=[];if(!Array.isArray(D.proof))D.proof=[];
  if(!Array.isArray(D.etc))D.etc=[];if(!Array.isArray(D.files))D.files=[];
}
function loadData(){
  try{
    var d=localStorage.getItem('yjtax_D');
    if(d){D=JSON.parse(d);ensureD();return true}
    // ì›ë³¸ ì—†ìœ¼ë©´ shadowì—ì„œ ë³µì› ì‹œë„
    var shadow=localStorage.getItem('yjtax_D_shadow');
    if(shadow){D=JSON.parse(shadow);ensureD();showToast('âš ï¸ ë°±ì—…ì—ì„œ ë°ì´í„° ìë™ ë³µì›ë¨');saveData();return true}
    return false;
  }catch(e){
    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ shadow ì‹œë„
    try{var shadow2=localStorage.getItem('yjtax_D_shadow');if(shadow2){D=JSON.parse(shadow2);ensureD();showToast('âš ï¸ ì†ìƒ ê°ì§€ â†’ ë°±ì—…ì—ì„œ ë³µì›');saveData();return true}}catch(e2){}
    return false;
  }
}
// ì¼ê°„ ìŠ¤ëƒ…ìƒ· â€” ìµœê·¼ 7ì¼ë¶„ ìë™ ë³´ê´€
function dailySnapshot(){
  try{
    var today=new Date().toISOString().slice(0,10);
    var snapKey='yjtax_snap_'+today;
    if(localStorage.getItem(snapKey))return; // ì˜¤ëŠ˜ ì´ë¯¸ ì €ì¥ë¨
    var allData=getAllBackupData();
    localStorage.setItem(snapKey,JSON.stringify(allData));
    // 7ì¼ ì´ì „ ìŠ¤ëƒ…ìƒ· ì‚­ì œ
    var keys=[];for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);if(k&&k.startsWith('yjtax_snap_'))keys.push(k)}
    keys.sort();while(keys.length>7){localStorage.removeItem(keys.shift())}
  }catch(e){}
}
function getAllBackupData(){
  var allKeys=['yjtax_D','yjtax_evt','yjtax_income','yjtax_cal_memos','yjtax_salarylog','yjtax_gemini_key','yjtax_gemini_backup','yjtax_claude_key','yjtax_nts_key','yjtax_perplexity_key','yjtax_alpha_key','yjtax_drive','yjtax_private','yjtax_subscriptions','yjtax_credit'];
  var backup={version:'v8',date:new Date().toISOString(),keys:{}};
  allKeys.forEach(function(k){try{var v=localStorage.getItem(k);if(v)backup.keys[k]=v}catch(e){}});
  return backup;
}
function updateBackupStatus(){
  try{
    var snaps=[];for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);if(k&&k.startsWith('yjtax_snap_'))snaps.push(k)}
    snaps.sort();
    var lastSnap=snaps.length?snaps[snaps.length-1].replace('yjtax_snap_',''):'ì—†ìŒ';
    var hasShadow=!!localStorage.getItem('yjtax_D_shadow');
    var statusEl=document.getElementById('backup-status');
    if(statusEl){
      var dataCount=(D.tax?D.tax.length:0)+(D.bank?D.bank.length:0)+(D.card?D.card.length:0)+(D.proof?D.proof.length:0);
      statusEl.innerHTML='ğŸ”’ ì´ì¤‘ë°±ì—… '+(hasShadow?'âœ…':'âŒ')+' Â· ìŠ¤ëƒ…ìƒ· <b>'+snaps.length+'</b>ê°œ (ìµœê·¼: '+lastSnap+') Â· ë°ì´í„° <b>'+dataCount+'</b>ê±´';
    }
  }catch(e){}
}
function loadEvt(){try{var e=localStorage.getItem('yjtax_evt');if(e)evtData=JSON.parse(e)}catch(e){}}
var DTAX=[{date:'2026-02-09',type:'ë§¤ì¶œ',client:'ì£¼ì‹íšŒì‚¬ ì›ìœŒì•¤ì½”',supply:6000000,tax:600000,deductible:'-',item:'ì°¨ì•Œ ì„ì§€ë¡œì  í”„ëœì°¨ì´ì¦ˆ ê°€ë§¹ ì˜ì—… ëŒ€í–‰ ë° í†µí•© ë§ˆì¼€íŒ… ìš©ì—­',bizNo:'275-88-03346'},{date:'2026-02-04',type:'ë§¤ì¶œ',client:'ì£¼ì‹íšŒì‚¬ ì›ìœŒì•¤ì½”',supply:3252636,tax:325264,deductible:'-',item:'ì°¨ì•Œ ìŠ¤íƒ€í•„ë“œ ê³ ì–‘ì  ê²½ì˜ ìë¬¸ ë° ì˜¨ë¼ì¸ ë§ˆì¼€íŒ… ìš©ì—­',bizNo:'275-88-03346'},{date:'2026-02-01',type:'ë§¤ì¶œ',client:'ì£¼ì‹íšŒì‚¬ ì›ìœŒì•¤ì½”',supply:3000000,tax:300000,deductible:'-',item:'ê°€ë§¹ì‚¬ì—… ê²½ì˜ìë¬¸ ë° ì˜ì—…ì§€ì› ìš©ì—­ë¹„',bizNo:'275-88-03346'},{date:'2026-02-01',type:'ë§¤ì…',client:'ì¿ íŒ¡ ì£¼ì‹íšŒì‚¬',supply:25936,tax:2594,deductible:'ë¶ˆê³µì œ',item:''},{date:'2026-02-01',type:'ë§¤ì…',client:'í‚¤ë‹¤ì³‰íŠ¸ë ˆì´ë”©',supply:19909,tax:1991,deductible:'ë¶ˆê³µì œ',item:''},{date:'2026-02-01',type:'ë§¤ì…',client:'ì¿ íŒ¡ ì£¼ì‹íšŒì‚¬',supply:50182,tax:5018,deductible:'ë¶ˆê³µì œ',item:''},{date:'2026-02-01',type:'ë§¤ì…',client:'ì£¼ì‹íšŒì‚¬ ìœ„ë“œì˜¨',supply:25636,tax:2564,deductible:'ê³µì œ',item:''}];

// === NAV ===
function sw(n,b){document.querySelectorAll('.tc').forEach(function(e){e.classList.remove('on')});document.querySelectorAll('.nb').forEach(function(e){e.classList.remove('on')});document.getElementById('t'+n).classList.add('on');b.classList.add('on');document.getElementById('ht').textContent={1:'2ì›” ì„¸ë¬´ ë¦¬í¬íŠ¸',2:'ëˆ ë²„ëŠ” ì¥ë¶€',3:'ì ˆì„¸ ì‹œë®¬ë ˆì´í„°',4:'ì„¸ê¸ˆ ì¤„ì´ê¸°',5:'$$ MONEY & í˜œíƒ',6:'ì„¸ë¬´ ë„êµ¬í•¨'}[n];window.scrollTo(0,0);if(n===3)renderSave();if(n===4)initTaxCut()}
function switchTab(n){var btns=document.querySelectorAll('.nb');document.querySelectorAll('.tc').forEach(function(e){e.classList.remove('on')});btns.forEach(function(e){e.classList.remove('on')});document.getElementById('t'+n).classList.add('on');if(btns[n-1])btns[n-1].classList.add('on');document.getElementById('ht').textContent={1:'2ì›” ì„¸ë¬´ ë¦¬í¬íŠ¸',2:'ëˆ ë²„ëŠ” ì¥ë¶€',3:'ì ˆì„¸ ì‹œë®¬ë ˆì´í„°',4:'ì„¸ê¸ˆ ì¤„ì´ê¸°',5:'$$ MONEY & í˜œíƒ',6:'ì„¸ë¬´ ë„êµ¬í•¨'}[n];window.scrollTo(0,0);if(n===3)renderSave();if(n===4)initTaxCut()}
function switchPanel(panelId){var panels=document.querySelectorAll('.ip');panels.forEach(function(p){p.style.display='none'});var target=document.getElementById(panelId);if(target)target.style.display='block';document.querySelectorAll('.pt').forEach(function(t){t.classList.remove('on')});document.querySelectorAll('.pt').forEach(function(t){if(t.getAttribute('onclick')&&t.getAttribute('onclick').indexOf(panelId)>-1)t.classList.add('on')})}
function openShareMenu(){
  var d=document.createElement('div');d.id='share-modal';
  d.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:flex-end;justify-content:center';
  d.innerHTML='<div style="background:#fff;border-radius:20px 20px 0 0;padding:24px;width:100%;max-width:480px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:18px;font-weight:800"><i class="fas fa-share-from-square" style="margin-right:8px;color:var(--pr)"></i>ë‚´ë³´ë‚´ê¸°</div><button onclick="document.getElementById(\'share-modal\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#999"><i class="fas fa-xmark"></i></button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><button onclick="shareKakao();document.getElementById(\'share-modal\').remove()" style="padding:16px;border:2px solid #FEE500;border-radius:12px;background:#FFF9DB;cursor:pointer;text-align:center;font-family:inherit"><div style="font-size:24px;margin-bottom:6px">ğŸ’¬</div><div style="font-size:13px;font-weight:700;color:#3C1E1E">ì¹´ì¹´ì˜¤í†¡</div><div style="font-size:10px;color:#999">ì„¸ë¬´í˜„í™© ê³µìœ </div></button><button onclick="shareEmail();document.getElementById(\'share-modal\').remove()" style="padding:16px;border:2px solid #E3F2FD;border-radius:12px;background:#F5F9FF;cursor:pointer;text-align:center;font-family:inherit"><div style="font-size:24px;margin-bottom:6px">ğŸ“§</div><div style="font-size:13px;font-weight:700;color:#1565C0">ì´ë©”ì¼</div><div style="font-size:10px;color:#999">ì„¸ë¬´í˜„í™© ë°œì†¡</div></button><button onclick="exReport();document.getElementById(\'share-modal\').remove()" style="padding:16px;border:2px solid #E8F5E9;border-radius:12px;background:#F5FFF5;cursor:pointer;text-align:center;font-family:inherit"><div style="font-size:24px;margin-bottom:6px">ğŸ“Š</div><div style="font-size:13px;font-weight:700;color:#2E7D32">Excel ë¦¬í¬íŠ¸</div><div style="font-size:10px;color:#999">ì„¸ê¸ˆì‹ ê³ ì„œ</div></button><button onclick="exSaveReport();document.getElementById(\'share-modal\').remove()" style="padding:16px;border:2px solid #F3E5F5;border-radius:12px;background:#FDF5FF;cursor:pointer;text-align:center;font-family:inherit"><div style="font-size:24px;margin-bottom:6px">ğŸ“„</div><div style="font-size:13px;font-weight:700;color:#6A1B9A">PDF ë¦¬í¬íŠ¸</div><div style="font-size:10px;color:#999">ì ˆì„¸ë¦¬í¬íŠ¸</div></button></div></div>';
  d.onclick=function(e){if(e.target===d)d.remove()};
  document.body.appendChild(d);
}
function shareKakao(){
  var b=getBaseNumbers();
  var msg='ğŸ“Š ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ ì„¸ë¬´í˜„í™©\n';
  msg+='â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  msg+='ğŸ“ˆ ë§¤ì¶œ: '+fm(b.totalSales)+'ì›\n';
  msg+='ğŸ“‰ ë§¤ì…: '+fm(b.totalExp)+'ì›\n';
  msg+='ğŸ’° ìˆœìˆ˜ìµ: '+fm(b.totalSales-b.totalExp)+'ì›\n';
  msg+='â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  msg+='ğŸš© ë¶€ê°€ì„¸: '+fm(b.vat)+'ì›\n';
  msg+='ğŸ“‹ ì¢…ì†Œì„¸: '+fm(b.incTax)+'ì›\n';
  msg+='ğŸ’µ í•©ê³„ ì„¸ê¸ˆ: '+fm(b.vat+b.incTax)+'ì›\n';
  msg+='â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  msg+='YJ Tax Master v7\n'+new Date().toLocaleDateString();
  if(navigator.share){navigator.share({title:'YJ Tax Master',text:msg}).catch(function(){})}
  else{navigator.clipboard.writeText(msg).then(function(){showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨ â†’ ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸°')}).catch(function(){prompt('ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:',msg)})}
}
function shareEmail(){
  var b=getBaseNumbers();
  var subject='[YJ Tax Master] ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ ì„¸ë¬´í˜„í™© '+new Date().toLocaleDateString();
  var body='ë§¤ì¶œ: '+fm(b.totalSales)+'ì›%0D%0Aë§¤ì…: '+fm(b.totalExp)+'ì›%0D%0Aë¶€ê°€ì„¸: '+fm(b.vat)+'ì›%0D%0Aì¢…ì†Œì„¸: '+fm(b.incTax)+'ì›%0D%0Aí•©ê³„: '+fm(b.vat+b.incTax)+'ì›';
  window.open('mailto:jyjzzjtube@gmail.com?subject='+encodeURIComponent(subject)+'&body='+body);
}
// ì„¸ë¬´ìº˜ë¦°ë” ë©”ëª¨
var calMemos={};try{calMemos=JSON.parse(localStorage.getItem('yjtax_cal_memos'))||{}}catch(e){}
function addCalMemo(dateStr){
  var existing=calMemos[dateStr]||'';
  var memo=prompt((dateStr)+' ë©”ëª¨ ì…ë ¥:',existing?existing.replace(/\[ì•Œë¦¼\]/g,''):'');
  if(memo===null)return;
  if(memo){
    var setAlarm=confirm('ì´ ë‚ ì§œì— ì•Œë¦¼ì„ ì„¤ì •í• ê¹Œìš”?\n(í•´ë‹¹ ë‚ ì§œì— ì•±ì„ ì—´ë©´ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤)');
    calMemos[dateStr]=(setAlarm?'[ì•Œë¦¼]':'')+memo;
  }else delete calMemos[dateStr];
  localStorage.setItem('yjtax_cal_memos',JSON.stringify(calMemos));
  renderCal();showToast(memo?'ğŸ“ ë©”ëª¨ ì €ì¥'+(calMemos[dateStr]&&calMemos[dateStr].indexOf('[ì•Œë¦¼]')>-1?' + ğŸ”” ì•Œë¦¼ ì„¤ì •':''):'ğŸ—‘ï¸ ë©”ëª¨ ì‚­ì œ');
}
function checkCalAlarms(){
  var today=new Date();var todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
  Object.keys(calMemos).forEach(function(k){
    if(k===todayStr&&calMemos[k].indexOf('[ì•Œë¦¼]')>-1){
      var msg=calMemos[k].replace('[ì•Œë¦¼]','');
      setTimeout(function(){
        if('Notification' in window&&Notification.permission==='granted'){new Notification('ğŸ“… YJ Tax Master',{body:'ì˜¤ëŠ˜ ì¼ì •: '+msg,icon:'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>ğŸ“‹</text></svg>'})}
        showToast('ğŸ”” ì˜¤ëŠ˜ ì¼ì •: '+msg);
      },1000);
    }
    // D-day ì•Œë¦¼: 3ì¼ ì „, 1ì¼ ì „
    var diff=Math.round((new Date(k)-today)/(86400000));
    if((diff===3||diff===1)&&calMemos[k].indexOf('[ì•Œë¦¼]')>-1){
      var msg2=calMemos[k].replace('[ì•Œë¦¼]','');
      setTimeout(function(){showToast('ğŸ“… D-'+diff+' ì•Œë¦¼: '+msg2)},2000);
    }
  });
  // ì„¸ë¬´ ì´ë²¤íŠ¸ D-day ì•Œë¦¼
  TAX_EVENTS.forEach(function(e){
    var evtDate=new Date(calYear,e.m,e.d);var diff2=Math.round((evtDate-today)/(86400000));
    if(diff2>=0&&diff2<=3){setTimeout(function(){showToast('âš ï¸ D-'+diff2+' '+e.nm)},1500+diff2*500)}
  });
  // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
  if('Notification' in window&&Notification.permission==='default'){Notification.requestPermission()}
}
function swI(b,id){b.parentElement.querySelectorAll('.ib').forEach(function(e){e.classList.remove('on')});b.classList.add('on');document.querySelectorAll('.ip').forEach(function(e){e.classList.remove('on')});document.getElementById('p-'+id).classList.add('on')}
var fm=function(n){n=Number(n)||0;return Math.round(n).toLocaleString('ko-KR')};
var fD=function(d){if(!d||d==='-'||d===''){var n=new Date();return String(n.getMonth()+1).padStart(2,'0')+'/'+String(n.getDate()).padStart(2,'0')}var t=new Date(d);if(isNaN(t)){var s=String(d).replace(/[^0-9\-\/\.]/g,'');t=new Date(s);if(isNaN(t))return String(d).substring(0,10)}return String(t.getMonth()+1).padStart(2,'0')+'/'+String(t.getDate()).padStart(2,'0')};
var toN=function(v){if(!v&&v!==0)return 0;return Math.abs(parseInt(String(v).replace(/[,\sì›â‚©]/g,''),10))||0};

// === D-DAY ===
function renderDD(){
  var now=new Date();now.setHours(0,0,0,0);var y=now.getFullYear();var m=now.getMonth();
  var nxM=new Date(y,m+1,10);var nxM2=new Date(y,m+1,10);
  var evts=[
    {nm:'ë¶€ê°€ì„¸ í™•ì •ì‹ ê³ ',dt:new Date(y,0,25),ic:'fa-receipt'},
    {nm:'ë¶€ê°€ì„¸ 1ê¸° ì˜ˆì •',dt:new Date(y,3,25),ic:'fa-receipt'},
    {nm:'ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ',dt:new Date(y,4,31),ic:'fa-landmark'},
    {nm:'ë¶€ê°€ì„¸ í™•ì •ì‹ ê³ ',dt:new Date(y,6,25),ic:'fa-receipt'},
    {nm:'ë¶€ê°€ì„¸ 2ê¸° ì˜ˆì •',dt:new Date(y,9,25),ic:'fa-receipt'},
    {nm:'ì›ì²œì„¸ ë‚©ë¶€',dt:nxM,ic:'fa-hand-holding-dollar'},
    {nm:'4ëŒ€ë³´í—˜ ë‚©ë¶€',dt:nxM2,ic:'fa-shield-halved'},
    {nm:'ì¢…í•©ì†Œë“ì„¸',dt:new Date(y+1,4,31),ic:'fa-landmark'}
  ];
  var list=evts.map(function(e){var diff=Math.ceil((e.dt-now)/(86400000));return{nm:e.nm,dt:e.dt,ic:e.ic,diff:diff}}).filter(function(e){return e.diff>=-7}).sort(function(a,b){return a.diff-b.diff}).slice(0,6);
  var html=list.map(function(e){
    var cls=e.diff<0?'dd-p':e.diff<=7?'dd-u':e.diff<=30?'dd-s':'dd-ok';
    var col=e.diff<0?'var(--sub)':e.diff<=7?'var(--rd)':e.diff<=30?'var(--or)':'var(--gn)';
    var bg=e.diff<0?'#f0f0f0':e.diff<=7?'#FFEBEE':e.diff<=30?'#FFF3E0':'#E8F5E9';
    var label=e.diff<0?'D+'+Math.abs(e.diff):e.diff===0?'D-DAY':'D-'+e.diff;
    var ds=(e.dt.getMonth()+1)+'/'+e.dt.getDate();
    return'<div class="dd '+cls+'"><div class="dd-ic" style="background:'+bg+';color:'+col+'"><i class="fas '+e.ic+'"></i></div><div><div class="dd-nm">'+e.nm+'</div><div class="dd-dt">'+ds+'</div></div><div class="dd-ct" style="color:'+col+'">'+label+'</div></div>';
  }).join('');
  document.getElementById('ddg').innerHTML=html;
}

// === MONEY í˜œíƒ (ì ‘ì†ì‹œë§ˆë‹¤ ë‚ ì§œ ì—…ë°ì´íŠ¸) ===
var BENEFITS=[
  {n:'â‘ ',t:'ì†Œìƒê³µì¸ ì •ì±…ìê¸ˆ (ì§ì ‘ëŒ€ì¶œ)',st:'ì‹ ì²­ ê°€ëŠ¥',sc:'st-v',si:'ğŸ“Œ',tags:['ìµœëŒ€ 1ì–µ','ì—°2~3%','ì—…ë ¥3ë…„â†‘'],d:'ì†Œì§„ê³µ ì§ì ‘ëŒ€ì¶œ. ì—…ë ¥6ë…„Â·ì»¨ì„¤íŒ…ì—…Â·1ì¸ì‚¬ì—…ì ìš”ê±´ì¶©ì¡±. <b>ì—° 2~3%, ìµœëŒ€ 1ì–µ</b>. ë§¤ë…„ 1~3ì›” ì ‘ìˆ˜.',am:'ğŸ’° ìµœëŒ€ 1ì–µ ì›',url:'https://ols.semas.or.kr',ul:'ì •ì±…ìê¸ˆ ì‹ ì²­'},
  {n:'â‘¡',t:'ì†Œìƒê³µì¸ ëŒ€ë¦¬ëŒ€ì¶œ (ì€í–‰ ê²½ìœ )',st:'ìƒì‹œ',sc:'st-a',si:'âœ…',tags:['ì‹œì¤‘ì€í–‰','ìµœëŒ€7ì²œë§Œ','ìƒì‹œì ‘ìˆ˜'],d:'NHë†í˜‘Â·ì‹ í•œ ë“± ì‹œì¤‘ì€í–‰ ê²½ìœ . <b>ìµœëŒ€ 7ì²œë§Œ ì›</b>. ìƒì‹œ ì ‘ìˆ˜ ê°€ëŠ¥.',am:'ğŸ’° ìµœëŒ€ 7ì²œë§Œ ì›',url:'https://ols.semas.or.kr',ul:'ëŒ€ë¦¬ëŒ€ì¶œ ì¡°íšŒ'},
  {n:'â‘¢',t:'1ì¸ ì°½ì¡°ê¸°ì—… ë§ˆì¼€íŒ… ì§€ì›',st:'ì‹ ì²­ ê°€ëŠ¥',sc:'st-v',si:'ğŸ“Œ',tags:['ê´‘ê³ Â·ì»¨ì„¤íŒ…','ìµœëŒ€2ì²œë§Œ'],d:'í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ… = 1ì¸ ì°½ì¡°ê¸°ì—…. <b>ë§ˆì¼€íŒ…ë¹„ ìµœëŒ€ 2,000ë§Œ ì›</b> ì§€ì›.',am:'ğŸ’° ìµœëŒ€ 2,000ë§Œ ì›',url:'https://www.k-startup.go.kr',ul:'K-Startup'},
  {n:'â‘£',t:'ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´',st:'ìë™ ì ìš©',sc:'st-a',si:'âœ…',tags:['ê²½ì˜ì»¨ì„¤íŒ…','ì†Œë“ì„¸20%','ì†Œê¸°ì—…'],d:'ì¡°íŠ¹ë²•Â§7. ì†Œê¸°ì—…Â·ì§€ì‹ì„œë¹„ìŠ¤ì—…. <b>ì†Œë“ì„¸ 20% ê°ë©´</b>. í™ˆíƒìŠ¤ì—ì„œ ì„ íƒ.',am:'ğŸ’¸ ì†Œë“ì„¸ 20%',url:'https://www.nts.go.kr',ul:'êµ­ì„¸ì²­'},
  {n:'â‘¤',t:'ë…¸ë€ìš°ì‚°ê³µì œ ì†Œë“ê³µì œ',st:'ê°€ì… ê°€ëŠ¥',sc:'st-v',si:'ğŸ“Œ',tags:['ì—°300ë§Œê³µì œ','í‡´ì§ê¸ˆíš¨ê³¼','ì†Œê¸°ì—…'],d:'ì‚¬ì—…ì†Œë“ 4ì²œë§Œâ†“ ì‹œ <b>ì—° 300ë§Œì› ì†Œë“ê³µì œ</b>. ì‚¬ì—…ì í‡´ì§ê¸ˆ íš¨ê³¼.',am:'ğŸ’¸ ì—° 300ë§Œ ê³µì œ',url:'https://www.8899.or.kr',ul:'ë…¸ë€ìš°ì‚° ê°€ì…'},
  {n:'â‘¥',t:'ê²½ê¸°ë„ ì†Œìƒê³µì¸ ê²½ì˜ì•ˆì •ìê¸ˆ',st:'í™•ì¸ í•„ìš”',sc:'st-c',si:'ğŸ”',tags:['ê²½ê¸°ë„','êµ¬ë¦¬ì‹œ','ìµœëŒ€3ì²œë§Œ'],d:'ê²½ê¸°ë„ ì†Œì¬ ì†Œìƒê³µì¸. <b>ìµœëŒ€ 3ì²œë§Œ ì›</b> ì €ê¸ˆë¦¬. ìˆ˜ì‹œ ì ‘ìˆ˜.',am:'ğŸ’° ìµœëŒ€ 3ì²œë§Œ ì›',url:'https://www.sbiz.or.kr',ul:'ì†Œìƒê³µì¸ë§ˆë‹¹'},
  {n:'â‘¦',t:'ì†Œìƒê³µì¸ ì—­ëŸ‰ê°•í™” êµìœ¡',st:'ìƒì‹œ',sc:'st-a',si:'âœ…',tags:['ë¬´ë£Œêµìœ¡','ì˜¨ë¼ì¸','ê²½ì˜Â·ì„¸ë¬´'],d:'ì†Œì§„ê³µ ë¬´ë£Œ ê²½ì˜Â·ì„¸ë¬´Â·ë§ˆì¼€íŒ… êµìœ¡. <b>ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸</b>.',am:'ğŸ“ ë¬´ë£Œ',url:'https://edu.semas.or.kr',ul:'êµìœ¡ ì‹ ì²­'},
  {n:'â‘§',t:'ê¸°ì—…ë§ˆë‹¹ í†µí•©ì§€ì›ì‚¬ì—… ê²€ìƒ‰',st:'ì‹¤ì‹œê°„',sc:'st-a',si:'âœ…',tags:['í†µí•©ê²€ìƒ‰','700+ì‚¬ì—…','ë§ì¶¤ì¶”ì²œ'],d:'ì •ë¶€ ì§€ì›ì‚¬ì—… <b>700ê°œ+</b> í†µí•©ê²€ìƒ‰. ì—…ì¢…Â·ì§€ì—­Â·ê·œëª¨ë³„ í•„í„°ë§.',am:'ğŸ” í†µí•©ê²€ìƒ‰',url:'https://www.bizinfo.go.kr',ul:'ê¸°ì—…ë§ˆë‹¹'}
];
function renderMoney(){
  var now=new Date();var ds=now.getFullYear()+'.'+(now.getMonth()+1)+'.'+now.getDate()+' '+now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
  document.getElementById('ut').textContent='ìµœì¢… í™•ì¸: '+ds;
  document.getElementById('ml').innerHTML=BENEFITS.map(function(b){
    return'<div class="bc fi"><div class="bc-hd"><div class="bc-t">'+b.n+' '+b.t+'</div><span class="bc-st '+b.sc+'">'+b.si+' '+b.st+'</span></div><div class="bc-tg">'+b.tags.map(function(t){return'<span class="mt">'+t+'</span>'}).join('')+'</div><div class="bc-d">'+b.d+'</div><div class="bc-bt"><div class="bc-am"><i class="fas fa-coins"></i> '+b.am+'</div><a href="'+b.url+'" target="_blank" class="bc-lk"><i class="fas fa-external-link-alt"></i> '+b.ul+'</a></div></div>';
  }).join('');
}
function rfMoney(){renderMoney();showToast('âœ… ìµœì‹  ì •ë³´ ê°±ì‹  ì™„ë£Œ')}

// === PARSE ENGINE ===
var _mpQueue=[];var _mpProcessing=false;var _mpTotal=0;var _mpDone=0;
function mpQ(file){_mpQueue.push(file);_mpTotal++;muShowProgress();if(!_mpProcessing)mpNext()}
var processFile=mpQ; // alias for drag-drop handlers
async function mpNext(){if(!_mpQueue.length){_mpProcessing=false;_mpTotal=0;_mpDone=0;muHideProgress();return}_mpProcessing=true;var f=_mpQueue.shift();try{await mp(f)}catch(e){showToast('âš ï¸ '+f.name+': '+e.message)}_mpDone++;muUpdateProgress();mpNext()}
function muShowProgress(){var p=document.getElementById('muProgress');if(p)p.classList.add('on')}
function muHideProgress(){var p=document.getElementById('muProgress');if(p){p.classList.remove('on');var b=document.getElementById('muProgressBar');if(b)b.style.width='0%'}}
function muUpdateProgress(){var b=document.getElementById('muProgressBar');if(b&&_mpTotal>0)b.style.width=Math.round(_mpDone/_mpTotal*100)+'%'}
async function mp(file){
  ensureD();
  var ext=file.name.split('.').pop().toLowerCase();
  var ft=ext==='xlsx'||ext==='xls'?'excel':ext==='csv'||ext==='tsv'?'csv':ext==='pdf'?'pdf':ext==='doc'||ext==='docx'?'word':(ext==='png'||ext==='jpg'||ext==='jpeg'||ext==='gif'||ext==='webp'||ext==='heic'||ext==='bmp'||ext==='tiff'||ext==='tif'||ext==='svg'||ext==='avif')?'image':(file.type&&file.type.startsWith('image/'))?'image':'text';
  showToast('ğŸ“‚ ì²˜ë¦¬ ì¤‘: '+file.name+' ('+ft+')');
  try{
    var rows=[];
    if(ft==='image'){
      // ì´ë¯¸ì§€ â†’ ì§€ì¶œì¦ë¹™ ì „ìš© AI ìŠ¤ìº”ìœ¼ë¡œ ì§ì ‘ ì²˜ë¦¬ (ë” ì •í™•í•œ ì¸ì‹)
      var gk=localStorage.getItem('yjtax_gemini_key');
      if(gk){
        showToast('ğŸ“¸ ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”: '+file.name);
        try{
          var result=await geminiProofScan(file,gk);
          if(result&&!result.error){
            var entry=buildProofEntry(result,file.name);
            if(D.isDemo){D.bank=[];D.tax=[];D.card=[];D.proof=[];D.etc=[];D.files=[];D.isDemo=false}
            D.proof.push(entry);
            D.files.push({name:file.name,format:'image',category:'proof',count:1});
            driveUpload(file,'proof');
            showToast('âœ… '+file.name+' â†’ '+entry.desc+' '+fm(entry.total)+'ì› ['+entry.category+']');
            rAll();
          }else{
            showToast('âš ï¸ '+file.name+': '+(result?result.error:'ì¸ì‹ ì‹¤íŒ¨'));
          }
        }catch(ge){showToast('âš ï¸ AI ìŠ¤ìº” ì‹¤íŒ¨: '+ge.message)}
        return; // ì§€ì¶œì¦ë¹™ìœ¼ë¡œ ì²˜ë¦¬ ì™„ë£Œ
      }else{showToast('âš ï¸ ì´ë¯¸ì§€ ìŠ¤ìº”ì€ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”');return}
    }
    else if(ft==='pdf'&&/ê±°ë˜í™•ì¸ì¦|ì˜ìˆ˜ì¦|ëŒ€ë¦¬ìš´ì „|íƒì‹œ|êµí†µ|ì¹´ì¹´ì˜¤í˜ì´|ì¦ë¹™/i.test(file.name)){
      // ì¦ë¹™ì„± PDF â†’ ì§€ì¶œì¦ë¹™ ì „ìš© AI ìŠ¤ìº”
      var gk2=localStorage.getItem('yjtax_gemini_key');
      if(gk2){
        showToast('ğŸ“„ ì§€ì¶œì¦ë¹™ PDF ìŠ¤ìº”: '+file.name);
        try{
          var result2=await geminiProofScan(file,gk2);
          if(result2&&!result2.error){
            var entry2=buildProofEntry(result2,file.name);
            if(D.isDemo){D.bank=[];D.tax=[];D.card=[];D.proof=[];D.etc=[];D.files=[];D.isDemo=false}
            D.proof.push(entry2);
            D.files.push({name:file.name,format:'pdf',category:'proof',count:1});
            driveUpload(file,'proof');
            showToast('âœ… '+file.name+' â†’ '+entry2.desc+' '+fm(entry2.total)+'ì›');
            rAll();return;
          }
        }catch(e2){}
      }
      rows=pTxt(await pPDF(file)); // fallback
    }
    else if(ft==='excel')rows=await pXL(file);else if(ft==='csv')rows=pCSV(await rTxt(file));else if(ft==='pdf')rows=pTxt(await pPDF(file));else if(ft==='word')rows=pTxt(await pWord(file));else rows=pTxt(await rTxt(file));
    if(!rows.length){showToast('âš ï¸ '+file.name+': ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return}
    var cat=aCls(rows,file.name);
    if(cat){apR(file.name,ft,cat,rows);driveUpload(file,cat)}
    else{
      // Gemini AI ë¶„ë¥˜ ì‹œë„
      var gk=localStorage.getItem('yjtax_gemini_key');
      if(gk&&rows.length>0){
        try{
          var sample=rows.slice(0,3).map(function(r){return JSON.stringify(r)}).join('\n');
          var resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+gk,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:'ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶„ë¥˜í•´ì¤˜. bank(í†µì¥), tax(ì„¸ê¸ˆê³„ì‚°ì„œ), card(ì¹´ë“œ), etc(ê¸°íƒ€) ì¤‘ í•˜ë‚˜ë§Œ ë‹µí•´. íŒŒì¼ëª…: '+file.name+'\në°ì´í„° ìƒ˜í”Œ:\n'+sample}]}]})
          });
          var data=await resp.json();
          var aiCat=(data.candidates[0].content.parts[0].text||'').trim().toLowerCase();
          if(['bank','tax','card','etc'].indexOf(aiCat)>-1){
            apR(file.name,ft,aiCat,rows);driveUpload(file,aiCat);
            showToast('ğŸ¤– AI ìë™ ë¶„ë¥˜: '+(aiCat==='bank'?'í†µì¥':aiCat==='tax'?'ì„¸ê¸ˆê³„ì‚°ì„œ':aiCat==='card'?'ì¹´ë“œ':'ê¸°íƒ€'));
            return;
          }
        }catch(e){console.log('AI classify fallback',e)}
      }
      pn={f:file.name,r:rows,t:ft,file:file};document.getElementById('mfn').textContent=file.name+' ('+rows.length+'ê±´)';document.getElementById('mo').classList.add('show')
    }
  }catch(e){alert(file.name+': '+e.message)}
}
function pXL(f){return new Promise(function(res,rej){var r=new FileReader;r.onload=function(e){try{var wb=XLSX.read(e.target.result,{type:'array',cellDates:true});var ws=wb.Sheets[wb.SheetNames[0]];
var allRows=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});
if(!allRows.length){res([]);return}
// 1. í—¤ë”í–‰ ì°¾ê¸° â€” ìš”ì•½í–‰ ì œì™¸, í•µì‹¬ í‚¤ì›Œë“œ 2ê°œ ì´ìƒ
var headerIdx=-1;
var kwAll=['ì‘ì„±ì¼ì','ë°œê¸‰ì¼ì','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ìŠ¹ì¸ë²ˆí˜¸','ì¼ì','í’ˆëª©ëª…','ê³µê¸‰ì','ê³µê¸‰ë°›ëŠ”ì','ê±°ë˜ì¼','ì…ê¸ˆ','ì¶œê¸ˆ','ì”ì•¡','ì ìš”','ì´ìš©ì¼','ê°€ë§¹ì ','ì´ìš©ê¸ˆì•¡','ë‚´ìš©','ê±°ë˜ë‚´ìš©','ë©”ëª¨','ë¹„ê³ ','ê¸°ì¬ë‚´ìš©','ë°›ëŠ”ë¶„','ë³´ë‚´ëŠ”ë¶„','ê±°ë˜ì ','ë‚ ì§œ','ê¸ˆì•¡','ì§€ê¸‰','ìˆ˜í‘œ','ê±°ë˜í›„ì”ì•¡','ì·¨ê¸‰ì '];
for(var hi=0;hi<Math.min(allRows.length,15);hi++){
  var cells=allRows[hi];if(!cells)continue;
  var strs=cells.map(function(c){return String(c).trim()});
  var rowStr=strs.join(' ');
  if(rowStr.indexOf('ì´ í•©ê³„')>-1||rowStr.indexOf('ì´ ê³µê¸‰')>-1||rowStr.indexOf('ì´ ì„¸ì•¡')>-1)continue;
  if(strs.filter(function(s){return s&&s!=='undefined'&&s!==''}).length<3)continue;
  var hits=0;kwAll.forEach(function(k){if(rowStr.indexOf(k)>-1)hits++});
  if(hits>=2){headerIdx=hi;break}
}
// 2. í—¤ë” ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ íŒŒì„œ
if(headerIdx<0){
  var j2=XLSX.utils.sheet_to_json(ws,{defval:''});
  if(!j2.length){res([]);return}
  var c2=Object.keys(j2[0]);
  console.log('[YJ Parser] í´ë°±ëª¨ë“œ ì»¬ëŸ¼:',JSON.stringify(c2));
  var fd2=function(kws){return c2.find(function(col){return kws.some(function(k){return String(col).indexOf(k)!==-1})})};
  var descCol=fd2(['ì ìš”','ë‚´ìš©','ê±°ë˜ë‚´ìš©','ë©”ëª¨','ë¹„ê³ ','ìƒí˜¸','ê±°ë˜ì²˜','í’ˆëª©ëª…','ê¸°ì¬ë‚´ìš©','ë°›ëŠ”ë¶„','ë³´ë‚´ëŠ”ë¶„']);
  res(j2.map(function(row){
    var d=descCol?String(row[descCol]||'').trim():'';
    // í´ë°±: desc ë¹„ì–´ìˆìœ¼ë©´ ìˆ«ì ì•„ë‹Œ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ í•©ì¹˜ê¸°
    if(!d){var txts=[];c2.forEach(function(k){var v=String(row[k]||'').trim();if(v&&v!=='undefined'&&v!=='-'&&!/^[\d,.]+$/.test(v)&&v.length>1&&!fd2(['ì¼ì','ë‚ ì§œ','ê±°ë˜ì¼','êµ¬ë¶„'])||false)txts.push(v)});d=txts.join(' ').substring(0,60)}
    return{date:row[fd2(['ì¼ì','ë‚ ì§œ','ê±°ë˜ì¼'])]||'',desc:d,inAmt:toN(row[fd2(['ê³µê¸‰ê°€ì•¡','ê¸ˆì•¡','ì…ê¸ˆ'])]),outAmt:toN(row[fd2(['ì¶œê¸ˆ','ì§€ì¶œ'])]),tax:toN(row[fd2(['ì„¸ì•¡'])]),balance:toN(row[fd2(['ì”ì•¡'])]),type:row[fd2(['êµ¬ë¶„'])]||'',deductible:'-',bizNo:row[fd2(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë²ˆí˜¸'])]||'',item:row[fd2(['í’ˆëª©ëª…','í’ˆëª…','í’ˆëª©'])]||''}
  }).filter(function(r){return r.inAmt||r.outAmt||r.tax}));
  return;
}
// 3. í—¤ë” â†’ ì»¬ëŸ¼ëª…:ì¸ë±ìŠ¤ ë§µ
var hdr=allRows[headerIdx].map(function(c){return String(c).trim()});
var colMap={};hdr.forEach(function(h,i){if(h&&h!=='undefined'&&!colMap.hasOwnProperty(h))colMap[h]=i});
console.log('[YJ Parser] íŒŒì¼:',f.name,'í—¤ë”:',JSON.stringify(hdr),'colMap:',JSON.stringify(colMap));
function findCol(keywords,exclude){var keys=Object.keys(colMap);for(var ki=0;ki<keywords.length;ki++){for(var ci=0;ci<keys.length;ci++){if(keys[ci].indexOf(keywords[ki])>-1){if(exclude&&exclude.some(function(ex){return keys[ci].indexOf(ex)>-1}))continue;return colMap[keys[ci]]}}}return -1}
function findAllCols(keywords,exclude){var r=[];var keys=Object.keys(colMap);keywords.forEach(function(k){keys.forEach(function(c){if(c.indexOf(k)>-1){if(exclude&&exclude.some(function(ex){return c.indexOf(ex)>-1}))return;if(r.indexOf(colMap[c])<0)r.push(colMap[c])}})});return r}
// 4. ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
var isSales=/ë§¤ì¶œ/.test(f.name),isPurch=/ë§¤ì…/.test(f.name);
var iDate=findCol(['ê±°ë˜ì¼ì‹œ','ì‘ì„±ì¼ì','ë°œê¸‰ì¼ì','ê±°ë˜ì¼ì','ê±°ë˜ì¼','ì¼ì','ë‚ ì§œ','ì´ìš©ì¼']);
// === ì€í–‰ë³„ desc(ìƒëŒ€ë°©) + bankType(ê±°ë˜ìœ í˜•) ë¶„ë¦¬ ë§¤í•‘ ===
// desc = ê±°ë˜ê¸°ë¡ì‚¬í•­/ì ìš”/ë‚´ìš© (ìƒëŒ€ë°©: ì¿ íŒ¡(ì£¼), ë„¤ì´ë²„í˜ì´, ì •ì„¸ì§, ì„¸ë¸ì¼ë ˆë¸ ë“±)
// bankType = ê±°ë˜ë‚´ìš©/ê±°ë˜êµ¬ë¶„/ê±°ë˜ìœ í˜• (ìœ í˜•: NHì²´í¬, ì‹¤ì‹œê°„ì´ì²´, ì²´í¬ì¹´ë“œê²°ì œ, ì¶œê¸ˆ ë“±)
var iDesc;
if(isSales)iDesc=findCol(['ê³µê¸‰ë°›ëŠ”ì ìƒí˜¸','ê³µê¸‰ë°›ëŠ”ììƒí˜¸','ìƒí˜¸','ë²•ì¸ëª…','ê±°ë˜ì²˜','ì—…ì²´ëª…','ê°€ë§¹ì ','í’ˆëª©ëª…','ê³µê¸‰ë°›ëŠ”ì'],['ë“±ë¡ë²ˆí˜¸','ê¸ˆì•¡','ì”ì•¡']);
else if(isPurch)iDesc=findCol(['ê³µê¸‰ì ìƒí˜¸','ê³µê¸‰ììƒí˜¸','ìƒí˜¸','ë²•ì¸ëª…','ê±°ë˜ì²˜','ì—…ì²´ëª…','ê°€ë§¹ì ','í’ˆëª©ëª…','ê³µê¸‰ì'],['ë“±ë¡ë²ˆí˜¸','ê¸ˆì•¡','ì”ì•¡']);
else iDesc=findCol(['ê±°ë˜ê¸°ë¡ì‚¬í•­','ì ìš”','ë‚´ìš©','ë©”ëª¨','ê±°ë˜ë©”ëª¨','ë¹„ê³ ','ìƒí˜¸','ë²•ì¸ëª…','ê±°ë˜ì²˜','ì—…ì²´ëª…','ê°€ë§¹ì ','í’ˆëª©ëª…','ê¸°ì¬ë‚´ìš©','ë°›ëŠ”ë¶„','ë³´ë‚´ëŠ”ë¶„'],['ë“±ë¡ë²ˆí˜¸','ê¸ˆì•¡','ì”ì•¡','ì¼ì‹œ','ì¼ì','ê±°ë˜ì ','ê±°ë˜êµ¬ë¶„','ê±°ë˜ ìœ í˜•','ê±°ë˜ ê¸°ê´€','ê³„ì¢Œë²ˆí˜¸','êµ¬ë¶„','ê±°ë˜ë‚´ìš©']);
// ê±°ë˜ë‚´ìš©/ê±°ë˜ìœ í˜• (NHì²´í¬, ì²´í¬ì¹´ë“œê²°ì œ ë“±)
var iBankType=findCol(['ê±°ë˜ë‚´ìš©','ê±°ë˜êµ¬ë¶„','ê±°ë˜ ìœ í˜•'],['ê¸ˆì•¡','ì”ì•¡','ì¼ì‹œ','ì¼ì','ê±°ë˜ì ','ê±°ë˜ê¸°ë¡']);
// ì…ê¸ˆ/ì¶œê¸ˆ: ë³„ë„ ì»¬ëŸ¼ ë°©ì‹ (ë†í˜‘/ì‹ í•œ) vs ë‹¨ì¼ê¸ˆì•¡ ì»¬ëŸ¼ ë°©ì‹ (ì¹´ì¹´ì˜¤/í† ìŠ¤)
var iSupply=findCol(['ì…ê¸ˆê¸ˆì•¡','ì…ê¸ˆì•¡','ì…ê¸ˆ(ì›)','ì…ê¸ˆ'],['ì¼ì‹œ','ì¼ì']);
var iOut=findCol(['ì¶œê¸ˆê¸ˆì•¡','ì¶œê¸ˆì•¡','ì¶œê¸ˆ(ì›)','ì¶œê¸ˆ'],['ì¼ì‹œ','ì¼ì']);
// ë‹¨ì¼ ê¸ˆì•¡ ì»¬ëŸ¼ (ì¹´ì¹´ì˜¤/í† ìŠ¤: ì–‘ìˆ˜=ì…ê¸ˆ, ìŒìˆ˜=ì¶œê¸ˆ)
var iSingleAmt=-1;
if(iSupply<0&&iOut<0)iSingleAmt=findCol(['ê±°ë˜ê¸ˆì•¡','ê±°ë˜ ê¸ˆì•¡','ê¸ˆì•¡','ì´ìš©ê¸ˆì•¡'],['ì”ì•¡']);
// ê³µê¸‰ê°€ì•¡ (ì„¸ê¸ˆê³„ì‚°ì„œìš©) â€” 'ê³µê¸‰ê°€ì•¡'ì„ ìš°ì„  ì°¾ê³ , í•©ê³„/ì´ì•¡ ì»¬ëŸ¼ì€ ì œì™¸
var iTaxSupply=findCol(['ê³µê¸‰ê°€ì•¡'],['ì”ì•¡','ì¶œê¸ˆ','ê±°ë˜í›„','í•©ê³„','ì´']);
var iTotalAmt=findCol(['í•©ê³„ê¸ˆì•¡','í•©ê³„','ì´ê¸ˆì•¡','ì´ì•¡'],['ì”ì•¡']);
if(iSupply<0&&iSingleAmt<0){
  if(iTaxSupply>=0)iSupply=iTaxSupply;
  else iSupply=findCol(['ê¸ˆì•¡','ì´ìš©ê¸ˆì•¡','ìˆ˜ì…'],['ì”ì•¡','ì¶œê¸ˆ','ê±°ë˜í›„','í•©ê³„','ì´','ì„¸ì•¡']);
}
if(iOut<0&&iSingleAmt<0)iOut=findCol(['ì§€ì¶œ','ì°¾ì€ê¸ˆì•¡','ì§€ê¸‰'],['ì”ì•¡']);
var iTax=findCol(['ì„¸ì•¡']);
var iBal=findCol(['ê±°ë˜í›„ì”ì•¡','ê±°ë˜í›„ ì”ì•¡','ê±°ë˜ í›„ ì”ì•¡','ì”ì•¡(ì›)','ì”ì•¡','ì”ê³ ']);
var iBiz;
if(isSales)iBiz=findCol(['ê³µê¸‰ë°›ëŠ”ìë“±ë¡ë²ˆí˜¸','ê³µê¸‰ë°›ëŠ”ìì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸']);
else if(isPurch)iBiz=findCol(['ê³µê¸‰ìë“±ë¡ë²ˆí˜¸','ê³µê¸‰ìì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸']);
else iBiz=findCol(['ê³µê¸‰ë°›ëŠ”ìë“±ë¡ë²ˆí˜¸','ê³µê¸‰ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë²ˆí˜¸']);
var iType=findCol(['ê±°ë˜êµ¬ë¶„','ê±°ë˜ ìœ í˜•','êµ¬ë¶„','ìœ í˜•','ë¶„ë¥˜','ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë¶„ë¥˜'],['ê¸ˆì•¡','ì”ì•¡']);
var iDed=findCol(['ê³µì œì—¬ë¶€','ê³µì œ']);
var iName=findCol(['ìƒí˜¸']);
var iItem=findCol(['í’ˆëª©ëª…','í’ˆëª…','í’ˆëª©']);
console.log('[YJ Parser] iDate:',iDate,'iDesc:',iDesc,'iBankType:',iBankType,'iSupply:',iSupply,'iOut:',iOut,'iSingleAmt:',iSingleAmt,'iBal:',iBal,'iItem:',iItem);
// 5. ë°ì´í„°í–‰ íŒŒì‹±
var results=[];
var fileType=isSales?'ë§¤ì¶œ':isPurch?'ë§¤ì…':'';
for(var di=headerIdx+1;di<allRows.length;di++){
  var row=allRows[di];if(!row)continue;
  // === ê¸ˆì•¡ íŒŒì‹± (ì€í–‰ë³„ ë‹¤ë¥¸ ë°©ì‹ ì²˜ë¦¬) ===
  var supply=0,outV=0;
  if(iSingleAmt>=0){
    // ì¹´ì¹´ì˜¤/í† ìŠ¤: ë‹¨ì¼ ê¸ˆì•¡ ì»¬ëŸ¼ (ì–‘ìˆ˜=ì…ê¸ˆ, ìŒìˆ˜=ì¶œê¸ˆ)
    var raw=String(row[iSingleAmt]||'').replace(/,/g,'').trim();
    var amt=parseFloat(raw)||0;
    if(amt>0)supply=amt;else if(amt<0)outV=Math.abs(amt);
  }else{
    supply=toN(iSupply>=0?row[iSupply]:'');
    outV=toN(iOut>=0?row[iOut]:'');
  }
  var tax=toN(iTax>=0?row[iTax]:'');
  // ì„¸ê¸ˆê³„ì‚°ì„œ: í•©ê³„ê¸ˆì•¡ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ supply+tax ê²€ì¦/ë³´ì •
  var totalAmtCol=toN(iTotalAmt>=0?row[iTotalAmt]:'');
  if(totalAmtCol>0&&tax>0){
    // í•©ê³„ê¸ˆì•¡ì´ ìˆê³  ì„¸ì•¡ë„ ìˆìœ¼ë©´, ê³µê¸‰ê°€ì•¡ = í•©ê³„ - ì„¸ì•¡
    if(supply>0&&Math.abs(supply+tax-totalAmtCol)>10&&Math.abs(supply-totalAmtCol)<10){
      // supplyê°€ ì‹¤ì œ í•©ê³„ê¸ˆì•¡ê³¼ ê°™ë‹¤ë©´ â†’ supplyì— í•©ê³„ê°€ ë“¤ì–´ê°„ ê²ƒ â†’ ë³´ì •
      supply=totalAmtCol-tax;
    }else if(supply===0||supply===totalAmtCol){
      supply=totalAmtCol-tax;
    }
  }else if(!totalAmtCol&&supply>0&&tax>0){
    // í•©ê³„ ì»¬ëŸ¼ì´ ì—†ì§€ë§Œ, supply/1.1 â‰ˆ supply-tax ì¸ì§€ ì²´í¬ (supplyê°€ ì´ë¯¸ VATí¬í•¨ì¸ ê²½ìš°)
    var estSupply=Math.round(supply/1.1);
    if(Math.abs(estSupply*0.1-tax)<100&&supply>tax*5){
      // supplyê°€ VATí¬í•¨ ê¸ˆì•¡ìœ¼ë¡œ ë³´ì„ â†’ ë³´ì •
      supply=supply-tax;
    }
  }
  if(!supply&&!tax&&!outV)continue;
  // === desc(ìƒëŒ€ë°©) ì¶”ì¶œ ===
  var desc=(iDesc>=0?String(row[iDesc]||'').trim():'');
  if(!desc&&iName>=0)desc=String(row[iName]||'').trim();
  // ìµœì¢… í´ë°±: ìˆ«ì/ë‚ ì§œ ì•„ë‹Œ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ í•©ì¹¨
  if(!desc){
    var txts=[];
    for(var ci2=0;ci2<row.length;ci2++){
      if(ci2===iDate||ci2===iSupply||ci2===iOut||ci2===iTax||ci2===iBal||ci2===iSingleAmt||ci2===iBiz||ci2===iDed||ci2===iBankType||ci2===iType)continue;
      var cv2=String(row[ci2]||'').trim();
      if(cv2&&cv2!=='undefined'&&cv2!=='-'&&cv2!=='0'&&!/^[\d,.]+$/.test(cv2)&&cv2.length>1)txts.push(cv2);
    }
    desc=txts.join(' ').substring(0,80);
  }
  // === ê±°ë˜ë‚´ìš©/ìœ í˜• (NHì²´í¬, ì²´í¬ì¹´ë“œê²°ì œ ë“±) ===
  var bankTypeVal=(iBankType>=0?String(row[iBankType]||'').trim():'');
  // type ê²°ì •
  var rowType=(iType>=0?String(row[iType]||'').trim():'');
  if(!rowType&&bankTypeVal)rowType=bankTypeVal;
  if(!rowType&&fileType)rowType=fileType;
  // item: ì„¸ê¸ˆê³„ì‚°ì„œ í’ˆëª©ëª… or ê±°ë˜ë‚´ìš©(ì€í–‰)
  var itemVal=(iItem>=0?String(row[iItem]||'').trim():'');
  if(!itemVal&&bankTypeVal)itemVal=bankTypeVal;
  // ë‚ ì§œ: ì‹œê°„ ë¶€ë¶„ ì œê±° (2026/02/16 14:51:03 â†’ 2026/02/16)
  var dateRaw=(iDate>=0?String(row[iDate]||'').trim():'');
  dateRaw=dateRaw.replace(/\s+\d{1,2}:\d{2}(:\d{2})?$/,'').trim();
  results.push({date:dateRaw,desc:desc,inAmt:supply,outAmt:outV,tax:tax,balance:toN(iBal>=0?String(row[iBal]||'').replace(/,/g,''):''),type:rowType,deductible:(iDed>=0?String(row[iDed]||'').trim():'-'),bizNo:(iBiz>=0?String(row[iBiz]||'').trim():''),item:itemVal});
}
if(results.length)console.log('[YJ Parser] ìƒ˜í”Œ:',JSON.stringify(results[0]),JSON.stringify(results[Math.min(1,results.length-1)]));
res(results);
}catch(err){rej(err)}};r.readAsArrayBuffer(f)})}
function pCSV(txt){var ls=txt.trim().split('\n');if(ls.length<2)return[];var sp=ls[0].indexOf('\t')>-1?'\t':',';var hd=ls[0].split(sp).map(function(h){return h.trim().replace(/"/g,'')});return ls.slice(1).map(function(l){var v=l.split(sp).map(function(x){return x.trim().replace(/"/g,'')});var row={};hd.forEach(function(h,i){row[h]=v[i]||''});var fd=function(kws){return hd.find(function(h){return kws.some(function(k){return h.indexOf(k)>-1})})};return{date:row[fd(['ì¼ì','ë‚ ì§œ'])]||'',desc:row[fd(['ì ìš”','ë‚´ìš©','ê±°ë˜ë‚´ìš©','ë©”ëª¨','ë¹„ê³ ','ìƒí˜¸','ê±°ë˜ì²˜','ê°€ë§¹ì ','ê¸°ì¬ë‚´ìš©','ë°›ëŠ”ë¶„','ë³´ë‚´ëŠ”ë¶„'])]||'',inAmt:toN(row[fd(['ê³µê¸‰ê°€ì•¡','ê¸ˆì•¡','ì…ê¸ˆ','ë§¤ì¶œ'])]),outAmt:toN(row[fd(['ì¶œê¸ˆ','ì§€ì¶œ','ë§¤ì…'])]),tax:toN(row[fd(['ì„¸ì•¡'])]),balance:toN(row[fd(['ì”ì•¡'])]),type:row[fd(['êµ¬ë¶„'])]||'',deductible:row[fd(['ê³µì œ'])]||'-',bizNo:row[fd(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ì‚¬ì—…ìë²ˆí˜¸'])]||'',item:row[fd(['í’ˆëª©ëª…','í’ˆëª…','í’ˆëª©'])]||''}}).filter(function(r){return r.inAmt||r.outAmt||r.tax})}
async function pPDF(f){var buf=await f.arrayBuffer();var pdf=await pdfjsLib.getDocument({data:buf}).promise;var t='';for(var i=1;i<=pdf.numPages;i++){var pg=await pdf.getPage(i);var c=await pg.getTextContent();t+=c.items.map(function(x){return x.str}).join(' ')+'\n'}return t}
async function pWord(f){var buf=await f.arrayBuffer();return(await mammoth.extractRawText({arrayBuffer:buf})).value}
function rTxt(f){return new Promise(function(res,rej){var r=new FileReader;r.onload=function(e){res(e.target.result)};r.onerror=function(){rej(new Error('ì½ê¸°ì‹¤íŒ¨'))};r.readAsText(f,'UTF-8')})}
function pTxt(txt){var ls=txt.split('\n').filter(function(l){return l.trim()});var rows=[];var dR=/(\d{4}[-./]?\d{2}[-./]?\d{2})/;var aR=/[\d,]{3,}/g;ls.forEach(function(l){var dm=l.match(dR);var am=l.match(aR);if(!am)return;var amounts=am.map(function(a){return parseInt(a.replace(/,/g,''),10)}).filter(function(a){return a>=100});if(!amounts.length)return;var isO=/ì¶œê¸ˆ|ì§€ì¶œ|ë§¤ì…|ê²°ì œ|ì´ìš©|ì¹´ë“œ|ë¹„ìš©|êµ¬ë§¤/.test(l);var isI=/ì…ê¸ˆ|ë§¤ì¶œ|ìˆ˜ì…|í™˜ê¸‰/.test(l);var desc=l.replace(dR,'').replace(aR,'').replace(/[|,\t]+/g,' ').trim().substring(0,40);rows.push({date:dm?dm[1]:'',desc:desc||'ë‚´ì—­',inAmt:isI?amounts[0]:(!isO?amounts[0]:0),outAmt:isO?amounts[0]:0,tax:amounts.length>1?amounts[1]:0,balance:amounts.length>2?amounts[amounts.length-1]:0,type:'',deductible:'-'})});return rows}
function aCls(rows,fn){fn=fn.toLowerCase();if(/í†µì¥|ì…ì¶œê¸ˆ|ê³„ì¢Œ|bank|ê±°ë˜ë‚´ì—­|ì˜ˆê¸ˆ|ì ê¸ˆ|ì´ì²´/.test(fn))return'bank';if(/ì„¸ê¸ˆê³„ì‚°ì„œ|ë§¤ì¶œ|ë§¤ì…|tax|invoice|ì „ìì„¸ê¸ˆ|í™ˆíƒìŠ¤/.test(fn))return'tax';if(/ì¹´ë“œ|card|ìŠ¹ì¸|ê²°ì œ|ì‹ ìš©|ì²´í¬|ì´ìš©ë‚´ì—­/.test(fn))return'card';if(/ì§€ì¶œì¦ë¹™|ê±°ë˜í™•ì¸ì¦|ëŒ€ë¦¬ìš´ì „|íƒì‹œ|êµí†µë¹„|ë´‰ì‚¬ë£Œ/.test(fn))return'proof';if(/ì˜ìˆ˜ì¦|receipt|ê°„ì´ì˜ìˆ˜ì¦|í˜„ê¸ˆì˜ìˆ˜ì¦/.test(fn))return'proof';
  // ë°ì´í„° ë¶„ì„ìœ¼ë¡œ ìë™ ë¶„ë¥˜
  var hasBal=rows.filter(function(r){return r.balance>0}).length;
  var hasTax=rows.filter(function(r){return r.tax>0}).length;
  var hasBizNo=rows.filter(function(r){return r.bizNo&&r.bizNo.length>=10}).length;
  var allOut=rows.every(function(r){return r.outAmt>0&&r.inAmt===0});
  if(hasBal>rows.length*.3)return'bank';
  if(hasBizNo>0||hasTax>rows.length*.3)return'tax';
  if(allOut&&rows.length>=3)return'card';
  if(rows.length===1&&rows[0].outAmt>0)return'etc';
  return null}
function apR(fn,ft,cat,rows){
  ensureD();
  // ê°™ì€ íŒŒì¼ ì¬ì—…ë¡œë“œ â†’ ê¸°ì¡´ ë°ì´í„° êµì²´ (ë®ì–´ì“°ê¸°)
  var existIdx=D.files.findIndex(function(f){return f.name===fn});
  if(existIdx>-1){
    var oldCat=D.files[existIdx].category;
    // í•´ë‹¹ íŒŒì¼ ì†ŒìŠ¤ ë°ì´í„° ì œê±°
    if(oldCat==='bank')D.bank=D.bank.filter(function(r){return r._src!==fn});
    else if(oldCat==='tax')D.tax=D.tax.filter(function(r){return r._src!==fn});
    else if(oldCat==='card')D.card=D.card.filter(function(r){return r._src!==fn});
    else if(oldCat==='proof')D.proof=D.proof.filter(function(r){return r._src!==fn});
    else D.etc=D.etc.filter(function(r){return r._src!==fn});
    D.files.splice(existIdx,1);
    showToast('ğŸ”„ '+fn+' ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸');
  }
  // ì²« ì‹¤ë°ì´í„° ì—…ë¡œë“œ ì‹œ ë°ëª¨ ë°ì´í„° ì œê±°
  if(D.isDemo){D.bank=[];D.tax=[];D.card=[];D.proof=[];D.etc=[];D.files=[]}
  if(cat==='bank')rows.forEach(function(r){D.bank.push({date:r.date,desc:r.desc,inAmt:r.inAmt,outAmt:r.outAmt,balance:r.balance,item:r.item||r.type||'',_src:fn})});
  else if(cat==='tax')rows.forEach(function(r){
    var s=/ë§¤ì¶œ/.test(r.type);
    var p=/ë§¤ì…/.test(r.type);
    if(!s&&!p){s=r.inAmt>0&&!r.outAmt}
    D.tax.push({date:r.date,type:s?'ë§¤ì¶œ':'ë§¤ì…',client:r.desc,bizNo:r.bizNo||'',supply:r.inAmt||r.outAmt,tax:r.tax,deductible:r.deductible||'-',item:r.item||'',_src:fn});
  });
  else if(cat==='card')rows.forEach(function(r){D.card.push({date:r.date,merchant:r.desc,amount:r.outAmt||r.inAmt,type:r.inAmt>0?'ë§¤ì¶œ':'ë§¤ì…',item:r.item||r.desc||'',_src:fn})});
  else if(cat==='proof')rows.forEach(function(r){D.proof.push({date:r.date,desc:r.desc||'',proofType:r.proofType||'ê¸°íƒ€',category:r.category||classifyExpense(r.desc),supply:r.supply||r.inAmt||0,tax:r.tax||0,tip:r.tip||0,total:r.outAmt||r.inAmt||(r.supply||r.inAmt||0)+(r.tax||0)+(r.tip||0),payment:r.payment||'-',deductible:r.deductible||'-',_src:fn})});
  else rows.forEach(function(r){D.etc.push({date:r.date,desc:r.desc,amount:r.inAmt||r.outAmt,_src:fn})});
  D.files.push({name:fn,format:ft,category:cat,count:rows.length});D.isDemo=false;rAll();
  var catNm=cat==='bank'?'í†µì¥':cat==='tax'?'ì„¸ê¸ˆê³„ì‚°ì„œ':cat==='card'?'ì¹´ë“œ':cat==='proof'?'ì§€ì¶œì¦ë¹™':'ê¸°íƒ€';
  showToast('âœ… '+fn+' â†’ <b>'+catNm+'</b> '+rows.length+'ê±´ ë“±ë¡');
  // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
  var tabMap={bank:0,tax:1,card:2,proof:3};
  var tabIdx=tabMap[cat]!==undefined?tabMap[cat]:4;
  var tabId={bank:'bank',tax:'tax',card:'card',proof:'proof'}[cat]||'all';
  var btns=document.querySelectorAll('.ib');
  if(btns[tabIdx])swI(btns[tabIdx],tabId);
  // === ìë™ íŒŒì´í”„ë¼ì¸ (ë¹„ë™ê¸°) ===
  setTimeout(function(){autoPostProcess(cat)},500);
}
async function autoPostProcess(cat){
  // 1. ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… â†’ AI ë¶ˆê³µì œ ìë™ íŒë‹¨
  if(cat==='tax'){
    var purchases=D.tax.filter(function(r){return r.type==='ë§¤ì…'&&r.deductible==='-'});
    if(purchases.length>0){
      var gk=localStorage.getItem('yjtax_gemini_key');
      var ck=localStorage.getItem('yjtax_claude_key');
      if(ck){
        showToast('ğŸ§  Claude AI ë¶ˆê³µì œ ìë™ íŒë‹¨ ì¤‘...');
        try{await claudeDeductAnalysis(true)}catch(e){console.log('Claude auto fail',e)}
      }else if(gk){
        showToast('ğŸ¤– Gemini AI ë¶ˆê³µì œ ìë™ íŒë‹¨ ì¤‘...');
        try{await geminiDeductCheck(true)}catch(e){console.log('Gemini auto fail',e)}
      }
    }
  }
  // 2. ì‚¬ì—…ìë²ˆí˜¸ ìˆìœ¼ë©´ â†’ êµ­ì„¸ì²­ ìë™ ê²€ì¦
  if(cat==='tax'){
    var ntsKey=localStorage.getItem('yjtax_nts_key');
    var hasBiz=D.tax.some(function(r){return r.bizNo&&r.bizNo.replace(/[^0-9]/g,'').length===10});
    if(ntsKey&&hasBiz){
      showToast('ğŸ›ï¸ êµ­ì„¸ì²­ ê±°ë˜ì²˜ ìë™ ê²€ì¦ ì¤‘...');
      try{
        var bnoSet={};var bnoClients={};
        D.tax.forEach(function(r){
          if(r.bizNo){var clean=r.bizNo.replace(/[^0-9]/g,'');if(clean.length===10){bnoSet[clean]=true;bnoClients[clean]=bnoClients[clean]||[];bnoClients[clean].push(r.client)}}
        });
        var bnoArr=Object.keys(bnoSet);
        if(bnoArr.length){
          var results=await ntsStatusCheck(bnoArr);
          if(results&&results.length){
            var warns=results.filter(function(r){return r.b_stt_cd!=='01'}).length;
            showToast('ğŸ›ï¸ ê±°ë˜ì²˜ ê²€ì¦ ì™„ë£Œ'+(warns?' âš ï¸ '+warns+'ê±´ ì£¼ì˜':''));
          }
        }
      }catch(e){console.log('NTS auto fail',e)}
    }
  }
}
function mC(cat){document.getElementById('mo').classList.remove('show');resetModal();if(!pn.r)return;if(cat==='etc'){var c=aCls(pn.r,'')||'etc';apR(pn.f,pn.t,c,pn.r);if(pn.file)driveUpload(pn.file,c)}else{apR(pn.f,pn.t,cat,pn.r);if(pn.file)driveUpload(pn.file,cat)}pn={f:null,r:null,t:'',file:null}}
function openModal(title,html){
  document.getElementById('mt').textContent=title;
  document.getElementById('mc').innerHTML=html;
  document.getElementById('ml-g-btns').style.display='none';
  document.getElementById('mfn').style.display='none';
  document.getElementById('mo').classList.add('show');
}
function resetModal(){
  document.getElementById('mt').textContent='íŒŒì¼ ì¢…ë¥˜ ì„ íƒ';
  document.getElementById('mc').innerHTML='';
  document.getElementById('ml-g-btns').style.display='';
  document.getElementById('mfn').style.display='';
}
function resetAll(){if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;D.bank=[];D.tax=DTAX.slice();D.card=[];D.proof=[];D.etc=[];D.files=[];D.isDemo=true;evtData=[];ndToggles={};try{localStorage.removeItem('yjtax_D');localStorage.removeItem('yjtax_evt')}catch(e){}rAll();try{renderEvtList();renderNdSim()}catch(e){}}

// === EXPORT ===
function exXL(){
  var wb=XLSX.utils.book_new();
  if(D.tax.length){var ws=XLSX.utils.json_to_sheet(D.tax.map(function(r){return{ë‚ ì§œ:r.date,êµ¬ë¶„:r.type,ê±°ë˜ì²˜:r.client,í’ˆëª©ëª…:r.item||'',ì‚¬ì—…ìë²ˆí˜¸:r.bizNo||'',ê³µê¸‰ê°€ì•¡:r.supply,ì„¸ì•¡:r.tax,ê³µì œì—¬ë¶€:r.deductible}}));XLSX.utils.book_append_sheet(wb,ws,'ì„¸ê¸ˆê³„ì‚°ì„œ')}
  if(D.bank.length){var ws2=XLSX.utils.json_to_sheet(D.bank.map(function(r){return{ë‚ ì§œ:r.date,ê±°ë˜ë‚´ìš©:r.item||'',ê±°ë˜ê¸°ë¡ì‚¬í•­:r.desc,ì…ê¸ˆ:r.inAmt,ì¶œê¸ˆ:r.outAmt,ì”ì•¡:r.balance}}));XLSX.utils.book_append_sheet(wb,ws2,'í†µì¥')}
  if(D.card.length){var ws3=XLSX.utils.json_to_sheet(D.card.map(function(r){return{ë‚ ì§œ:r.date,ê°€ë§¹ì :r.merchant,ë‚´ìš©:r.item||'',ê¸ˆì•¡:r.amount,êµ¬ë¶„:r.type}}));XLSX.utils.book_append_sheet(wb,ws3,'ì¹´ë“œ')}
  if(D.proof.length){var wsPf=XLSX.utils.json_to_sheet(D.proof.map(function(r){return{ê±°ë˜ì¼:r.date,ë‚´ìš©:r.desc,ì¦ë¹™ìœ í˜•:r.proofType,ì§€ì¶œë¶„ë¥˜:r.category,ê³¼ì„¸ê¸ˆì•¡:r.supply,ë¶€ê°€ì„¸:r.tax,ë´‰ì‚¬ë£Œ:r.tip||0,ì´ê²°ì œê¸ˆì•¡:r.total,ê²°ì œë°©ë²•:r.payment,ê³µì œì—¬ë¶€:r.deductible}}));XLSX.utils.book_append_sheet(wb,wsPf,'ì§€ì¶œì¦ë¹™')}
  // ìš”ì•½ ì‹œíŠ¸
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0),dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var sum=[{í•­ëª©:'ì´ë§¤ì¶œ',ê¸ˆì•¡:ts},{í•­ëª©:'ì´ë§¤ì…',ê¸ˆì•¡:te},{í•­ëª©:'ìˆœìˆ˜ìµ',ê¸ˆì•¡:ts-te},{í•­ëª©:'ë§¤ì¶œì„¸ì•¡',ê¸ˆì•¡:sTx},{í•­ëª©:'ê³µì œë§¤ì…ì„¸ì•¡',ê¸ˆì•¡:dTx},{í•­ëª©:'ì˜ˆì •ë¶€ê°€ì„¸',ê¸ˆì•¡:sTx-dTx}];
  var ws4=XLSX.utils.json_to_sheet(sum);XLSX.utils.book_append_sheet(wb,ws4,'ìš”ì•½');
  if(evtData.length){var ws5=XLSX.utils.json_to_sheet(evtData.map(function(e){return{ë‚ ì§œ:e.date,ìœ í˜•:e.type,ëŒ€ìƒ:e.name,ê¸ˆì•¡:e.amount,ê³µì œì¸ì •:e.deduct,ì´ˆê³¼ë¶ˆì¸ì •:e.over,ì¦ë¹™:e.file||'ì—†ìŒ'}}));XLSX.utils.book_append_sheet(wb,ws5,'ê²½ì¡°ì‚¬ë¹„')}
  XLSX.writeFile(wb,'YJ_ì¥ë¶€_'+new Date().toISOString().slice(0,10)+'.xlsx')
}
function exCSV(){
  var all=[];
  D.tax.forEach(function(r){all.push([r.date,r.type==='ë§¤ì¶œ'?'ì„¸ê¸ˆê³„ì‚°ì„œ(ë§¤ì¶œ)':'ì„¸ê¸ˆê³„ì‚°ì„œ(ë§¤ì…)',r.client,r.supply,r.tax,r.deductible])});
  D.bank.forEach(function(r){all.push([r.date,'í†µì¥',r.desc,r.inAmt,r.outAmt,''])});
  D.card.forEach(function(r){all.push([r.date,'ì¹´ë“œ',r.merchant+(r.item?' ('+r.item+')':''),r.type==='ë§¤ì¶œ'?r.amount:0,r.type==='ë§¤ì…'?r.amount:0,''])});
  D.proof.forEach(function(r){all.push([r.date,'ì§€ì¶œì¦ë¹™('+r.proofType+')',r.desc+' ['+r.category+']',0,r.total,r.deductible])});
  var csv='ë‚ ì§œ,ë¶„ë¥˜,ë‚´ìš©,ì…ê¸ˆ/ê³µê¸‰ê°€ì•¡,ì¶œê¸ˆ/ì„¸ì•¡,ë¹„ê³ \n'+all.map(function(r){return r.join(',')}).join('\n');
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='YJ_ì¥ë¶€_'+new Date().toISOString().slice(0,10)+'.csv';a.click()
}
function exPDF(){
  var doc=new jspdf.jsPDF('p','mm','a4');
  doc.setFont('helvetica','bold');doc.setFontSize(18);doc.text('YJ Partners - Ledger Report',14,20);
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.text('Date: '+new Date().toISOString().slice(0,10),14,28);
  doc.text('Representative: Ji Yunjin | YJ Partners',14,34);
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0),dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text('Summary',14,44);
  doc.setFontSize(10);doc.setFont('helvetica','normal');
  doc.text('Total Sales: '+fm(ts)+' KRW ('+st.length+' items)',14,52);
  doc.text('Total Expense: '+fm(te)+' KRW ('+et.length+' items)',14,58);
  doc.text('Net Profit: '+fm(ts-te)+' KRW',14,64);
  doc.text('VAT (Est.): '+fm(sTx-dTx)+' KRW',14,70);
  if(D.tax.length){
    doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text('Tax Invoices',14,82);
    doc.autoTable({startY:86,head:[['Date','Type','Client','Supply','Tax','Deduct']],body:D.tax.map(function(r,i){return[r.date,r.type==='ë§¤ì¶œ'?'Sales':'Purchase','Client '+(i+1),fm(r.supply),fm(r.tax),r.deductible==='ë¶ˆê³µì œ'?'Non-ded':r.deductible==='-'?'-':'Ded']}),styles:{fontSize:8},headStyles:{fillColor:[26,43,75]}})
  }
  doc.save('YJ_Report_'+new Date().toISOString().slice(0,10)+'.pdf')
}

// === REFRESH ===
function rAll(){
  ensureD();
  try{uKPI()}catch(e){console.error('[rAll] uKPI error:',e)}
  try{rTbls()}catch(e){console.error('[rAll] rTbls error:',e)}
  try{rChart()}catch(e){console.error('[rAll] rChart error:',e)}
  try{rFL()}catch(e){console.error('[rAll] rFL error:',e)}
  try{uUI()}catch(e){console.error('[rAll] uUI error:',e)}
  try{renderTrend()}catch(e){}
  try{checkMismatch()}catch(e){}
  try{renderClients()}catch(e){}
  saveData();
}
function uKPI(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  // ë§¤ì¶œ = ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œë§Œ (ê³µê¸‰ê°€ì•¡+ì„¸ì•¡)
  var tsSupply=st.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0);
  var tsVat=tsSupply+sTx;
  // ë§¤ì… = í†µì¥ ì¶œê¸ˆ + ì¹´ë“œ ê²°ì œë§Œ
  var bankOut=D.bank.reduce(function(a,r){return a+r.outAmt},0);
  var cardOut=D.card.filter(function(r){return r.type!=='ë§¤ì¶œ'}).reduce(function(a,r){return a+r.amount},0);
  var teVat=bankOut+cardOut;
  // ìˆœìˆ˜ìµ = ë§¤ì¶œ(VATí¬í•¨) - ë§¤ì…(í†µì¥ì¶œê¸ˆ+ì¹´ë“œ)
  var pr=tsVat-teVat;
  // ë¶€ê°€ì„¸ ê³„ì‚°ì€ ì„¸ê¸ˆê³„ì‚°ì„œ ê¸°ì¤€
  var dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var ndTx=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var pfDedTx=D.proof.filter(function(r){return r.deductible==='ê³µì œ'}).reduce(function(a,r){return a+(r.tax||0)},0);
  var pfNdTx=D.proof.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+(r.tax||0)},0);
  var pfExpTotal=D.proof.reduce(function(a,r){return a+(r.total||0)},0);
  dTx+=pfDedTx;ndTx+=pfNdTx;
  var vat=sTx-dTx;
  // ì „ì²´ ë¹„ìš© ë³€ìˆ˜ (ê²½ë¹„í˜„í™©ìš©)
  var te=et.reduce(function(a,r){return a+r.supply},0)+bankOut+cardOut+pfExpTotal;
  var ts=tsSupply;
  var pe=document.getElementById('k-pr');pe.textContent=fm(pr)+'ì›';pe.style.color=pr>=0?'var(--gn)':'var(--rd)';
  document.getElementById('k-sl').textContent=fm(tsVat)+'ì›';document.getElementById('k-ex').textContent=fm(teVat)+'ì›';
  document.getElementById('v-a').textContent=fm(vat)+' ì›';
  var d='ë§¤ì¶œì„¸ì•¡ '+fm(sTx)+'ì› - ê³µì œ '+fm(dTx)+'ì›';if(ndTx)d+=' / ë¶ˆê³µì œ '+fm(ndTx)+'ì›';
  document.getElementById('v-d').textContent=d;
  // ê²½ë¹„ í˜„í™© KPI
  var dedItems=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'});
  var ndItems=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'});
  // ì ‘ëŒ€ë¹„ = ì¹´ë“œ ì¤‘ ì ‘ëŒ€ë¹„ ë¶„ë¥˜ + ì„¸ê¸ˆê³„ì‚°ì„œ ì ‘ëŒ€ë¹„ + ì§€ì¶œì¦ë¹™ ì ‘ëŒ€ë¹„
  var entAmt=D.card.filter(function(c){return(c.aiCategory||c.item||c.merchant||'').indexOf('ì ‘ëŒ€')>-1}).reduce(function(a,c){return a+c.amount},0);
  entAmt+=et.filter(function(r){return(r.aiCategory||r.item||r.client||'').indexOf('ì ‘ëŒ€')>-1}).reduce(function(a,r){return a+r.supply},0);
  entAmt+=D.proof.filter(function(r){return r.category==='ì ‘ëŒ€ë¹„'}).reduce(function(a,r){return a+(r.total||0)},0);
  var entLimitKpi=12000000+Math.round(Math.min(ts,10000000000)*0.003);
  try{
    document.getElementById('kpi-ded-amt').textContent=fm(dedItems.reduce(function(a,r){return a+r.supply},0))+'ì›';
    document.getElementById('kpi-ded-cnt').textContent=dedItems.length+'ê±´';
    document.getElementById('kpi-nded-amt').textContent=fm(ndItems.reduce(function(a,r){return a+r.supply},0))+'ì›';
    document.getElementById('kpi-nded-cnt').textContent=ndItems.length+'ê±´';
    document.getElementById('kpi-ent-amt').textContent=fm(entAmt)+'ì›';
    document.getElementById('kpi-ent-limit').textContent='í•œë„: '+fm(entLimitKpi)+'ì›';
    // ì‹¤ì œ ë²ˆ ëˆ = ë§¤ì¶œ - ë§¤ì… - ë¶€ê°€ì„¸ - ì¢…ì†Œì„¸(ì¶”ì •)
    var estIncTax=Math.round(calcIncomeTax(Math.max(pr-1500000,0)));
    var realIncome=pr-Math.max(vat,0)-estIncTax;
    document.getElementById('kpi-real-income').textContent=fm(realIncome)+'ì›';
    // ì ˆì„¸ ê¸ˆì•¡ = ê°ë©´+ê³µì œ
    var savedAmt=Math.min(Math.round(estIncTax*0.20),100000000)+70000+20000; // SME+í‘œì¤€+ì „ì
    document.getElementById('kpi-saved').textContent=fm(savedAmt)+'ì›';
  }catch(e){}
  document.getElementById('s-sc').textContent=st.length;document.getElementById('s-ec').textContent=et.length;
  try{document.getElementById('s-sales-total').textContent=fm(ts)+'ì›';document.getElementById('s-exp-total').textContent=fm(te)+'ì›'}catch(e){}
  document.getElementById('s-nd').textContent=fm(ndTx)+'ì›';
  var cm={};st.forEach(function(r){cm[r.client]=(cm[r.client]||0)+r.supply});
  var tp=Object.entries(cm).sort(function(a,b){return b[1]-a[1]})[0];
  document.getElementById('s-tp').textContent=tp?tp[0]:'-';
  document.getElementById('c-bk').textContent=D.bank.length;document.getElementById('c-tx').textContent=D.tax.length;
  document.getElementById('c-cd').textContent=D.card.length;try{document.getElementById('c-pf').textContent=D.proof.length}catch(e){};document.getElementById('c-et').textContent=D.etc.length;
  document.getElementById('cg').style.display=D.files.length?'grid':'none';
  var dm=document.getElementById('dm');dm.textContent=D.isDemo?'ğŸ”¶ ë°ëª¨':'âœ… ì‹¤ë°ì´í„°';dm.className='dm '+(D.isDemo?'dm-d':'dm-l');
  // ì‚¬ì—…ì†Œë“ í‘œì‹œ
  var bizTs=st.reduce(function(a,r){return a+r.supply},0),bizTe=et.reduce(function(a,r){return a+r.supply},0);
  try{var manualRev=parseInt(document.getElementById('biz-manual-revenue').value||0)*10000;var manualExp=parseInt(document.getElementById('biz-manual-expense').value||0)*10000;bizTs+=manualRev;bizTe+=manualExp}catch(e){}
  var bizIncome=bizTs-bizTe;
  try{
    document.getElementById('biz-revenue').textContent=fm(bizTs)+'ì›';
    document.getElementById('biz-expense').textContent=fm(bizTe)+'ì›';
    document.getElementById('biz-income').textContent=fm(bizIncome)+'ì›';
  }catch(e){}
  // ê¸‰ì—¬/ì›ì²œì§•ìˆ˜/ë°°ë‹¹ KPI ì—…ë°ì´íŠ¸
  try{
    var salKeys=Object.keys(salaryLog).map(Number);
    // ê¸‰ì—¬ = ì‹¤ìˆ˜ë ¹ì•¡ í•©ê³„ (4ëŒ€ë³´í—˜ ì´ë¯¸ ì œì™¸ëœ ê¸ˆì•¡)
    var totalSalaryNet=salKeys.reduce(function(a,k){return a+(salaryLog[k].net||0)},0);
    var bt=getBonusByType();
    var dividendTotal=bt.dividend;
    var bonusSalary=bt.salary;
    // ì›ì²œì§•ìˆ˜ = 3.3% ë–¼ì¸ ê¸ˆì•¡ë§Œ (ì„±ê³¼ê¸ˆ/ìƒì—¬ ê¸°ì¤€)
    var withheld33=0;
    if(bonusSalary>0)withheld33+=Math.round(bonusSalary*0.033);
    // ë°°ë‹¹ ì›ì²œì§•ìˆ˜ 15.4%
    var withheldDiv=0;
    if(dividendTotal>0)withheldDiv=Math.round(dividendTotal*0.154);
    document.getElementById('k-salary').textContent=fm(totalSalaryNet)+'ì›';
    document.getElementById('k-salary-sub').textContent=salKeys.length+'íšŒ ìˆ˜ë ¹ (4ëŒ€ë³´í—˜ ì œì™¸ ì‹¤ìˆ˜ë ¹)';
    document.getElementById('k-withhold').textContent=fm(withheld33)+'ì›';
    document.getElementById('k-withhold-sub').textContent=bonusSalary>0?'ì„±ê³¼ê¸ˆ '+fm(bonusSalary)+'ì› Ã— 3.3%':'3.3% ì›ì²œì§•ìˆ˜ ë‚´ì—­ ì—†ìŒ';
    document.getElementById('k-dividend').textContent=fm(dividendTotal)+'ì›';
    document.getElementById('k-dividend-sub').textContent=dividendTotal?'ì›ì²œì§•ìˆ˜ '+fm(withheldDiv)+'ì› (15.4%)':'ë°°ë‹¹ ë‚´ì—­ ì—†ìŒ';
  }catch(e){console.log('KPI salary/dividend update error',e)}
  calcTotalIncome();
}

// === ì†Œë“ í†µí•© ê³„ì‚° ===
function calcSalaryDeduction(totalSalary){
  // ê·¼ë¡œì†Œë“ê³µì œ (2025ë…„ ê¸°ì¤€)
  if(totalSalary<=5000000)return totalSalary*0.7;
  if(totalSalary<=15000000)return 3500000+(totalSalary-5000000)*0.4;
  if(totalSalary<=45000000)return 7500000+(totalSalary-15000000)*0.15;
  if(totalSalary<=100000000)return 12000000+(totalSalary-45000000)*0.05;
  return 14750000+(totalSalary-100000000)*0.02;
}

// ê¸‰ì—¬ ê¸°ë¡
var salaryLog={0:{date:'2026-01-12',net:1814110},1:{date:'2026-02-10',net:1808470}};
try{var _sl=localStorage.getItem('yjtax_salarylog');if(_sl)salaryLog=JSON.parse(_sl)}catch(e){}
function saveSalaryLog(){try{localStorage.setItem('yjtax_salarylog',JSON.stringify(salaryLog))}catch(e){}}

function addSalaryRecord(){
  var dateVal=document.getElementById('sal-input-date').value;
  var netStr=document.getElementById('sal-input-net').value;
  var netVal=parseInt(String(netStr).replace(/[,\sì›]/g,''),10);
  if(!dateVal){alert('ì§€ê¸‰ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');return}
  if(!netVal||netVal<0){alert('ì‹¤ìˆ˜ë ¹ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');return}
  var month=parseInt(dateVal.split('-')[1],10)-1;
  salaryLog[month]={date:dateVal,net:netVal};
  saveSalaryLog();
  document.getElementById('sal-input-date').value='';
  document.getElementById('sal-input-net').value='';
  calcTotalIncome();
}
function removeSalaryRecord(m){
  delete salaryLog[m];saveSalaryLog();calcTotalIncome();
}

function calcTotalIncome(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var bizTs=st.reduce(function(a,r){return a+r.supply},0),bizTe=et.reduce(function(a,r){return a+r.supply},0);
  try{bizTs+=parseInt(document.getElementById('biz-manual-revenue').value||0)*10000;bizTe+=parseInt(document.getElementById('biz-manual-expense').value||0)*10000}catch(e){}
  var bizIncome=bizTs-bizTe;

  var salaryMonthly=parseInt(document.getElementById('salary-monthly').value||0)*10000;
  if(!salaryMonthly)salaryMonthly=2000000;
  var salaryAnnual=salaryMonthly*12;

  // 4ëŒ€ë³´í—˜ (ì„¸ì „ ê¸°ì¤€) â€” 2025ë…„ ê³µì‹ ìš”ìœ¨
  var nps=Math.floor(salaryMonthly*0.045);
  var nhi=Math.floor(salaryMonthly*0.03545);
  var ltc=Math.floor(nhi*0.9182/7.09/10)*10;
  var ei=Math.round(salaryMonthly*0.009);
  var insTotal=nps+nhi+ltc+ei;
  var monthlyTax=0;
  if(salaryMonthly<=1060000)monthlyTax=0;
  else if(salaryMonthly<=1500000)monthlyTax=Math.round(salaryMonthly*0.003);
  else if(salaryMonthly<=2000000)monthlyTax=Math.round((salaryMonthly-1500000)*0.04);
  else if(salaryMonthly<=3000000)monthlyTax=Math.round(19520+(salaryMonthly-2000000)*0.05);
  else if(salaryMonthly<=5000000)monthlyTax=Math.round(69520+(salaryMonthly-3000000)*0.08);
  else monthlyTax=Math.round(229520+(salaryMonthly-5000000)*0.10);
  var monthlyLocalTax=Math.round(monthlyTax*0.1);
  var monthlyTaxTotal=monthlyTax+monthlyLocalTax;

  // ìˆ˜ë ¹ ë‚´ì—­ ëª©ë¡ ë Œë”ë§
  var keys=Object.keys(salaryLog).map(Number).sort(function(a,b){return a-b});
  var totalNet=0;var totalDeduct=0;
  var listHtml='';
  if(keys.length){
    keys.forEach(function(m){
      var rec=salaryLog[m];totalNet+=rec.net;
      var deduct=salaryMonthly-rec.net;totalDeduct+=deduct;
      var dd=rec.date.split('-');
      listHtml+='<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border:1px solid #e0e0e0;border-radius:var(--rs);margin-bottom:4px">';
      listHtml+='<div style="width:36px;height:36px;border-radius:50%;background:#E8F5E9;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--gn);flex-shrink:0"><i class="fas fa-check"></i></div>';
      listHtml+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700">'+(m+1)+'ì›” ê¸‰ì—¬</div><div style="font-size:11px;color:var(--sub)">'+rec.date+' ì§€ê¸‰</div></div>';
      listHtml+='<div style="text-align:right"><div style="font-size:14px;font-weight:800;color:var(--bl)">'+fm(rec.net)+'ì›</div><div style="font-size:10px;color:var(--rd)">ê³µì œ '+fm(deduct)+'ì›</div></div>';
      listHtml+='<button onclick="removeSalaryRecord('+m+')" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:14px;padding:4px;margin-left:4px"><i class="fas fa-xmark"></i></button>';
      listHtml+='</div>';
    });
  }else{
    listHtml='<div style="text-align:center;padding:16px;color:var(--sub);font-size:12px"><i class="fas fa-inbox" style="font-size:20px;display:block;margin-bottom:6px;color:#ddd"></i>ê¸‰ì—¬ ìˆ˜ë ¹ ê¸°ë¡ì„ ì¶”ê°€í•˜ì„¸ìš”</div>';
  }
  document.getElementById('salary-records').innerHTML=listHtml;

  // í•©ê³„ í‘œì‹œ
  document.getElementById('sal-count').textContent=keys.length+'íšŒ / 12íšŒ';
  document.getElementById('sal-net-total').textContent=fm(totalNet)+'ì›';
  document.getElementById('salary-annual').textContent=fm(salaryAnnual)+'ì›';
  document.getElementById('sal-deduct-total').textContent=fm(totalDeduct)+'ì›';
  document.getElementById('ins-total').textContent=fm(insTotal)+'ì›';
  document.getElementById('ins-tax').textContent=fm(monthlyTaxTotal)+'ì›';

  var salaryDeduction=Math.round(calcSalaryDeduction(salaryAnnual));
  var salaryIncome=Math.max(salaryAnnual-salaryDeduction,0);
  document.getElementById('salary-deducted').textContent=fm(salaryIncome)+'ì›';

  var avgDeduct=keys.length?Math.round(totalDeduct/keys.length):insTotal+monthlyTaxTotal;
  var salaryWithheld=keys.length*Math.round(avgDeduct*0.13)+(12-keys.length)*monthlyTaxTotal;
  document.getElementById('salary-withheld').textContent=fm(salaryWithheld)+'ì›';

  // â‘¡ ì›ìœŒì•¤ì½” ì„±ê³¼ê¸ˆ (ì›”ë³„ í•©ì‚°)
  var bt=getBonusByType();
  var bonusAmt=bt.salary+bt.dividend;
  var bonusIncome=0,bonusWithheld=0;
  if(bt.salary>0){
    var totalSalary=salaryAnnual+bt.salary;
    var totalSalaryDeduction=Math.round(calcSalaryDeduction(totalSalary));
    salaryIncome=Math.max(totalSalary-totalSalaryDeduction,0);
    bonusWithheld+=Math.round(bt.salary*0.033);
  }
  if(bt.dividend>0){
    bonusIncome=bt.dividend;
    bonusWithheld+=Math.round(bt.dividend*0.154);
  }
  document.getElementById('bonus-withheld').textContent=fm(bonusWithheld)+'ì›';

  // â‘¢ ì‚¬ì—…ì†Œë“ (ì¥ë¶€ì—ì„œ ìë™)
  // ì¢…í•©ì†Œë“ê¸ˆì•¡ í•©ì‚°
  var totalIncome=salaryIncome+bonusIncome+Math.max(bizIncome,0);
  var basicDeduction=1500000; // ê¸°ë³¸ê³µì œ
  var taxBase=Math.max(totalIncome-basicDeduction,0);

  // ëˆ„ì§„ì„¸ìœ¨ ì ìš©
  var calcTax=0;
  if(taxBase<=14000000)calcTax=taxBase*0.06;
  else if(taxBase<=50000000)calcTax=14000000*0.06+(taxBase-14000000)*0.15;
  else if(taxBase<=88000000)calcTax=14000000*0.06+36000000*0.15+(taxBase-50000000)*0.24;
  else if(taxBase<=150000000)calcTax=14000000*0.06+36000000*0.15+38000000*0.24+(taxBase-88000000)*0.35;
  else if(taxBase<=300000000)calcTax=14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+(taxBase-150000000)*0.38;
  else if(taxBase<=500000000)calcTax=14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+150000000*0.38+(taxBase-300000000)*0.40;
  else if(taxBase<=1000000000)calcTax=14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+150000000*0.38+200000000*0.40+(taxBase-500000000)*0.42;
  else calcTax=14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+150000000*0.38+200000000*0.40+500000000*0.42+(taxBase-1000000000)*0.45;
  calcTax=Math.round(calcTax);

  // ì„¸ì•¡ê°ë©´Â·ê³µì œ
  var smeReductionKpi=Math.min(Math.round(calcTax*0.20),100000000); // ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ ì†Œê¸°ì—… ì§€ì‹ì„œë¹„ìŠ¤ì—… 20%
  var eFilingKpi=20000; // ì „ìì‹ ê³ 
  var stdCreditKpi=70000; // í‘œì¤€ì„¸ì•¡ê³µì œ
  var totalCreditKpi=smeReductionKpi+eFilingKpi+stdCreditKpi;
  var afterReduction=Math.max(calcTax-totalCreditKpi,0);
  var totalPrepaid=salaryWithheld+bonusWithheld;
  var finalTax=afterReduction-totalPrepaid;

  // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
  document.getElementById('inc-a').textContent=fm(Math.max(finalTax,0))+' ì›';
  document.getElementById('inc-base').textContent=fm(taxBase)+'ì›';
  document.getElementById('inc-calc').textContent=fm(calcTax)+'ì›';
  
  document.getElementById('inc-prepaid').textContent='-'+fm(totalPrepaid)+'ì›';
  var incDesc='3ê°œ ì†Œë“ í•©ì‚° '+fm(totalIncome)+'ì›';
  
  document.getElementById('inc-d').textContent=incDesc;

  // í•©ì‚° ìš”ì•½ ë°”
  document.getElementById('total-income-display').textContent=fm(totalIncome)+'ì›';
  document.getElementById('total-prepaid-display').textContent=fm(totalPrepaid)+'ì›';
  var finalEl=document.getElementById('total-final-display');
  if(finalTax>=0){finalEl.textContent='+'+fm(finalTax)+'ì›';finalEl.style.color='#FFCDD2'}
  else{finalEl.textContent=fm(finalTax)+'ì› (í™˜ê¸‰)';finalEl.style.color='#A5D6A7'}
  // localStorage ì €ì¥
  saveBonusData();
}

function loadIncomeData(){
  try{var d=localStorage.getItem('yjtax_income');if(d){var o=JSON.parse(d);
    document.getElementById('salary-monthly').value=o.salaryMonthly||200;
    if(o.bonusEntries)bonusEntries=o.bonusEntries;
    if(o.names&&o.names.length>=3){document.getElementById('income-name-1').value=o.names[0];document.getElementById('income-name-2').value=o.names[1];document.getElementById('income-name-3').value=o.names[2]}
    if(o.bizManual&&o.bizManual.length>=2){document.getElementById('biz-manual-revenue').value=o.bizManual[0]||0;document.getElementById('biz-manual-expense').value=o.bizManual[1]||0}
  }}catch(e){}
  renderBonusList();
}
var bonusEntries=[];
function addBonusEntry(){
  var month=document.getElementById('bonus-month').value;
  var type=document.getElementById('bonus-type').value;
  var amt=parseInt(document.getElementById('bonus-amt').value||0);
  if(!amt){showToast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  bonusEntries.push({month:parseInt(month),type:type,amt:amt});
  bonusEntries.sort(function(a,b){return a.month-b.month});
  document.getElementById('bonus-amt').value='';
  renderBonusList();calcTotalIncome();saveBonusData();showToast(month+'ì›” '+fm(amt*10000)+'ì› ì €ì¥');
}
function removeBonusEntry(idx){bonusEntries.splice(idx,1);renderBonusList();calcTotalIncome();saveBonusData()}
function renderBonusList(){
  var box=document.getElementById('bonus-list');if(!box)return;
  if(!bonusEntries.length){box.innerHTML='<div style="color:var(--sub);font-size:11px;text-align:center;padding:8px">ì›”ë³„ ì„±ê³¼ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”</div>';document.getElementById('bonus-total').textContent='0ì›';return}
  box.innerHTML=bonusEntries.map(function(e,i){
    return'<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #f0f0f0;font-size:12px"><span style="font-weight:600">'+e.month+'ì›”</span><span class="badge '+(e.type==='salary'?'b-bl':'b-pr')+'" style="font-size:9px">'+(e.type==='salary'?'ê¸‰ì—¬':'ë°°ë‹¹')+'</span><span style="font-weight:700">'+fm(e.amt*10000)+'ì›</span><button onclick="removeBonusEntry('+i+')" style="background:none;border:none;color:var(--rd);cursor:pointer;font-size:12px">âœ•</button></div>';
  }).join('');
  var total=bonusEntries.reduce(function(a,e){return a+e.amt},0);
  document.getElementById('bonus-total').textContent=fm(total*10000)+'ì›';
}
function saveBonusData(){
  try{localStorage.setItem('yjtax_income',JSON.stringify({
    salaryMonthly:document.getElementById('salary-monthly').value,
    bonusEntries:bonusEntries,
    names:[document.getElementById('income-name-1').value,document.getElementById('income-name-2').value,document.getElementById('income-name-3').value],
    bizManual:[document.getElementById('biz-manual-revenue').value,document.getElementById('biz-manual-expense').value]
  }))}catch(e){}
}
function getBonusTotal(){return bonusEntries.reduce(function(a,e){return a+e.amt*10000},0)}
function getBonusByType(){var sal=0,div=0;bonusEntries.forEach(function(e){if(e.type==='salary')sal+=e.amt*10000;else div+=e.amt*10000});return{salary:sal,dividend:div}}
function rTbls(){
  document.querySelector('#tb-bk tbody').innerHTML=D.bank.map(function(r){return'<tr><td style="white-space:nowrap">'+fD(r.date)+'</td><td style="font-size:12px;color:#555">'+(r.item||'<span style="color:#ccc">-</span>')+'</td><td style="font-size:12px;font-weight:600">'+(r.desc||'<span style="color:#ccc">-</span>')+'</td><td class="am pos">'+(r.inAmt?fm(r.inAmt):'')+'</td><td class="am neg">'+(r.outAmt?fm(r.outAmt):'')+'</td><td class="am">'+(r.balance?fm(r.balance):'')+'</td></tr>'}).join('');
  document.getElementById('em-bk').style.display=D.bank.length?'none':'block';
  document.querySelector('#tb-tx tbody').innerHTML=D.tax.map(function(r,i){return'<tr data-idx="'+i+'" style="border-bottom:1px solid #f0f0f0"><td style="white-space:nowrap">'+fD(r.date)+'</td><td><span class="badge '+(r.type==='ë§¤ì¶œ'?'b-bl':'b-rd')+'">'+r.type+'</span></td><td style="font-size:12px;font-weight:600;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.client+'</td><td style="font-size:11px;color:#555;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(r.item||'<span style="color:#ccc">-</span>')+'</td><td style="font-family:monospace;font-size:10px;color:#999">'+(r.bizNo||'-')+'</td><td class="am" style="font-weight:700">'+fm(r.supply)+'</td><td class="am" style="font-weight:700">'+fm(r.tax)+'</td><td><span class="badge '+(r.deductible==='ê³µì œ'?'b-gn':r.deductible==='ë¶ˆê³µì œ'?'b-rd':'b-gy')+'">'+r.deductible+'</span></td></tr>'}).join('')+(D.tax.length?'<tr style="background:#f8f9fa;border-top:2px solid #333;font-weight:800"><td colspan="5" style="text-align:right;padding:10px">í•©ê³„ (ë§¤ì¶œ '+D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}).length+'ê±´ / ë§¤ì… '+D.tax.filter(function(r){return r.type==='ë§¤ì…'}).length+'ê±´)</td><td class="am pos" style="font-size:13px">'+fm(D.tax.reduce(function(a,r){return a+r.supply},0))+'</td><td class="am" style="font-size:13px">'+fm(D.tax.reduce(function(a,r){return a+r.tax},0))+'</td><td></td></tr>':'');
  document.getElementById('em-tx').style.display=D.tax.length?'none':'block';
  document.querySelector('#tb-cd tbody').innerHTML=D.card.map(function(r){return'<tr><td>'+fD(r.date)+'</td><td>'+r.merchant+'</td><td style="font-size:11px;color:#555;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(r.item||'<span style="color:#ccc">-</span>')+'</td><td class="am neg">'+fm(r.amount)+'</td><td><span class="badge b-rd">'+r.type+'</span></td></tr>'}).join('');
  document.getElementById('em-cd').style.display=D.card.length?'none':'block';
  // ì§€ì¶œì¦ë¹™ í…Œì´ë¸” (ë´‰ì‚¬ë£Œ+ê²°ì œë°©ë²• ì¶”ê°€)
  document.querySelector('#tb-pf tbody').innerHTML=D.proof.map(function(r,i){return'<tr><td style="white-space:nowrap">'+fD(r.date)+'</td><td style="font-size:12px;font-weight:600;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+r.desc+'">'+r.desc+'</td><td><span class="badge b-or" style="font-size:9px">'+r.proofType+'</span></td><td><span class="badge b-bl" style="font-size:9px">'+r.category+'</span></td><td class="am">'+fm(r.supply)+'</td><td class="am">'+fm(r.tax)+'</td><td class="am" style="color:#9C27B0">'+(r.tip?fm(r.tip):'<span style="color:#ddd">-</span>')+'</td><td class="am neg" style="font-weight:700;color:#E65100">'+fm(r.total)+'</td><td style="font-size:10px;color:#555">'+(r.payment||'-')+'</td><td>'+(r.deductible==='ê³µì œ'?'<span class="badge b-gn">ê³µì œ</span>':r.deductible==='ë¶ˆê³µì œ'?'<span class="badge b-rd">ë¶ˆê³µì œ</span>':'<span class="badge b-gy">'+r.deductible+'</span>')+'</td></tr>'}).join('')+(D.proof.length?'<tr style="background:#FFF8E1;border-top:2px solid #F57F17;font-weight:800"><td colspan="4" style="text-align:right;padding:10px;font-size:12px">í•©ê³„ ('+D.proof.length+'ê±´)</td><td class="am" style="font-size:12px">'+fm(D.proof.reduce(function(a,r){return a+r.supply},0))+'</td><td class="am" style="font-size:12px">'+fm(D.proof.reduce(function(a,r){return a+r.tax},0))+'</td><td class="am" style="font-size:12px;color:#9C27B0">'+fm(D.proof.reduce(function(a,r){return a+(r.tip||0)},0))+'</td><td class="am neg" style="font-size:13px;color:#E65100">'+fm(D.proof.reduce(function(a,r){return a+r.total},0))+'</td><td></td><td></td></tr>':'');
  document.getElementById('em-pf').style.display=D.proof.length?'none':'block';
  var all=[];
  D.bank.forEach(function(r){all.push({c:'í†µì¥',cc:'b-bl',tp:r.inAmt?'ì…ê¸ˆ':'ì¶œê¸ˆ',d:r.date,n:r.desc,it:r.item||'',i:r.inAmt,o:r.outAmt})});
  D.tax.forEach(function(r){all.push({c:'ì„¸ê¸ˆê³„ì‚°ì„œ',cc:'b-or',tp:r.type,d:r.date,n:r.client+' ('+(r.bizNo||'-')+')',it:r.item||'',i:r.type==='ë§¤ì¶œ'?(r.supply+r.tax):0,o:r.type==='ë§¤ì…'?(r.supply+r.tax):0})});
  D.card.forEach(function(r){
    var isIn=r.type==='ë§¤ì¶œ';
    all.push({c:'ì¹´ë“œ',cc:'b-pr',tp:isIn?'ë§¤ì¶œ':'ë§¤ì…',d:r.date,n:r.merchant||r.desc||'',it:r.item||'',i:isIn?r.amount:0,o:isIn?0:r.amount});
  });
  D.proof.forEach(function(r){all.push({c:'ì§€ì¶œì¦ë¹™',cc:'b-or',tp:r.category||'ì§€ì¶œ',d:r.date,n:r.desc||'',it:r.proofType||'',i:0,o:r.total})});
  D.etc.forEach(function(r){if(r.amount)all.push({c:'ê¸°íƒ€',cc:'b-gy',tp:r.type||'ê¸°íƒ€',d:r.date,n:r.desc||'',it:'',i:r.type==='ë§¤ì¶œ'?r.amount:0,o:r.type!=='ë§¤ì¶œ'?r.amount:0})});
  all.sort(function(a,b){return new Date(b.d)-new Date(a.d)});
  var totalIn=all.reduce(function(a,r){return a+(r.i||0)},0);
  var totalOut=all.reduce(function(a,r){return a+(r.o||0)},0);
  document.querySelector('#tb-al tbody').innerHTML=all.map(function(r){
    var tpClass=r.tp==='ë§¤ì¶œ'||r.tp==='ì…ê¸ˆ'?'b-bl':'b-rd';
    return'<tr style="border-bottom:1px solid #f0f0f0"><td><span class="badge '+r.cc+'">'+r.c+'</span></td><td><span class="badge '+tpClass+'" style="font-size:10px">'+r.tp+'</span></td><td style="font-size:12px;white-space:nowrap">'+fD(r.d)+'</td><td style="font-size:12px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.n+'</td><td style="font-size:11px;color:#555;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(r.it||'<span style="color:#ccc">-</span>')+'</td><td class="am pos" style="font-size:13px;font-weight:700">'+(r.i?fm(r.i):'')+'</td><td class="am neg" style="font-size:13px;font-weight:700">'+(r.o?fm(r.o):'')+'</td></tr>'
  }).join('')+'<tr style="background:#f8f9fa;border-top:2px solid #333;font-weight:800"><td colspan="5" style="text-align:right;padding:10px;font-size:13px">í•©ê³„</td><td class="am pos" style="font-size:14px;color:#1565C0">'+fm(totalIn)+'</td><td class="am neg" style="font-size:14px;color:#C62828">'+fm(totalOut)+'</td></tr>';
  document.getElementById('em-al').style.display=all.length?'none':'block';
}
var dc=null;
function rChart(){
  var cm={};D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}).forEach(function(r){cm[r.client]=(cm[r.client]||0)+r.supply});
  var lb=Object.keys(cm),vl=Object.values(cm);var cv=document.getElementById('donut'),ec=document.getElementById('em-ch');
  if(!lb.length){cv.style.display='none';ec.style.display='block';if(dc){dc.destroy();dc=null}return}
  cv.style.display='block';ec.style.display='none';if(dc)dc.destroy();
  dc=new Chart(cv.getContext('2d'),{type:'doughnut',data:{labels:lb,datasets:[{data:vl,backgroundColor:['#3498DB','#2ECC71','#F39C12','#E74C3C','#9B59B6','#1ABC9C','#34495E'],borderWidth:0}]},options:{cutout:'60%',plugins:{legend:{position:'bottom',labels:{font:{family:'Pretendard',size:12},padding:16}}},responsive:true,maintainAspectRatio:true}})
}
// === ì§€ì¶œì¦ë¹™ í•¨ìˆ˜ ===
function classifyExpense(desc){desc=(desc||'').toLowerCase();if(/ëŒ€ë¦¬ìš´ì „|íƒì‹œ|êµí†µ|ì£¼ì°¨|í†¨ê²Œì´íŠ¸|ê³ ì†|ê¸°ì°¨|ktx|ë²„ìŠ¤|ì§€í•˜ì² |uber|ì¹´ì¹´ì˜¤T/.test(desc))return'êµí†µë¹„';if(/ì‹ëŒ€|ìŒì‹|ì‹ì‚¬|ì¹´í˜|ì»¤í”¼|ë°°ë‹¬|ì¹˜í‚¨|í”¼ì|ì ì‹¬|ì €ë…|ì•„ì¹¨/.test(desc))return'ì‹ëŒ€';if(/ì‚¬ë¬´|ë¬¸êµ¬|ë³µì‚¬|í”„ë¦°íŠ¸|ì‰í¬|ì¢…ì´|íœ|ë…¸íŠ¸/.test(desc))return'ì‚¬ë¬´ìš©í’ˆ';if(/ì ‘ëŒ€|íšŒì‹|ì„ ë¬¼|ê²½ì¡°|í™”í™˜|ë¶€ì¡°/.test(desc))return'ì ‘ëŒ€ë¹„';if(/í†µì‹ |ì „í™”|ì¸í„°ë„·|í•¸ë“œí°|ìš”ê¸ˆ/.test(desc))return'í†µì‹ ë¹„';if(/ë³´í—˜|ê°€ì…|ë³´ì¥/.test(desc))return'ë³´í—˜ë£Œ';return'ê¸°íƒ€'}

// === ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬ ===
async function handleProofDrop(e){
  var dt=e.dataTransfer;if(!dt||!dt.files||!dt.files.length)return;
  var files=Array.from(dt.files).filter(function(f){
    return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name);
  });
  if(!files.length){showToast('âš ï¸ ì´ë¯¸ì§€(PNG/JPG) ë˜ëŠ” PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');return}
  showToast('ğŸ“ '+files.length+'ê°œ íŒŒì¼ ë“œë¡­ë¨ â€” AI ìŠ¤ìº” ì‹œì‘!');
  await processProofBatch(files);
}
// íŒŒì¼ ì¶”ê°€ ì˜ì—­ ë“œë˜ê·¸&ë“œë¡­ (ì—‘ì…€â†’íŒŒì‹±, ì´ë¯¸ì§€/PDFâ†’ì§€ì¶œì¦ë¹™)
async function handleMu2Drop(e){
  var dt=e.dataTransfer;if(!dt||!dt.files||!dt.files.length)return;
  var allFiles=Array.from(dt.files);
  var imgPdf=allFiles.filter(function(f){return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
  var xlsCsv=allFiles.filter(function(f){return/\.(xlsx?|csv|txt)$/i.test(f.name)});
  if(imgPdf.length>0){
    showToast('ğŸ“¸ ì´ë¯¸ì§€/PDF '+imgPdf.length+'ê±´ â†’ ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”');
    await processProofBatch(imgPdf);
  }
  if(xlsCsv.length>0){xlsCsv.forEach(function(f){processFile(f)})}
  if(!imgPdf.length&&!xlsCsv.length){showToast('âš ï¸ ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤')}
}
// ë©”ì¸ ì—…ë¡œë“œ ì˜ì—­ì—ë„ ë“œë˜ê·¸&ë“œë¡­ ì§€ì› (ì§€ì¶œì¦ë¹™ íƒ­ì´ ì•„ë‹ˆì–´ë„ ë™ì‘)
document.addEventListener('DOMContentLoaded',function(){
  var mainDrop=document.querySelector('.mu');
  if(mainDrop){
    mainDrop.addEventListener('dragover',function(e){e.preventDefault();e.stopPropagation();mainDrop.style.borderColor='#FFD700';mainDrop.style.boxShadow='0 0 20px rgba(255,215,0,.4)'});
    mainDrop.addEventListener('dragleave',function(e){e.preventDefault();mainDrop.style.borderColor='';mainDrop.style.boxShadow=''});
    mainDrop.addEventListener('drop',function(e){
      e.preventDefault();e.stopPropagation();mainDrop.style.borderColor='';mainDrop.style.boxShadow='';
      var dt=e.dataTransfer;if(!dt||!dt.files||!dt.files.length)return;
      var allFiles=Array.from(dt.files);
      var imgPdf=allFiles.filter(function(f){return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
      var xlsCsv=allFiles.filter(function(f){return/\.(xlsx?|csv|txt)$/i.test(f.name)});
      // ì´ë¯¸ì§€/PDF â†’ ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”
      if(imgPdf.length>0){
        showToast('ğŸ“¸ ì´ë¯¸ì§€/PDF '+imgPdf.length+'ê±´ â†’ ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”');
        processProofBatch(imgPdf);
      }
      // ì—‘ì…€/CSV â†’ ê¸°ì¡´ íŒŒì‹±
      if(xlsCsv.length>0){
        xlsCsv.forEach(function(f){processFile(f)});
      }
    });
  }
});

// === ì§€ì¶œì¦ë¹™ AI ìë™ ìŠ¤ìº” ===
async function scanProofFiles(input){
  if(!input.files||!input.files.length)return;
  var files=Array.from(input.files).filter(function(f){return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
  if(!files.length){showToast('âš ï¸ ì´ë¯¸ì§€ ë˜ëŠ” PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');return}
  await processProofBatch(files);
  input.value='';
}
async function scanProofFolder(input){
  if(!input.files||!input.files.length)return;
  var files=Array.from(input.files).filter(function(f){return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
  if(!files.length){showToast('âš ï¸ í´ë”ì— ì´ë¯¸ì§€/PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');return}
  await processProofBatch(files);
  input.value='';
}
async function processProofBatch(files){
  ensureD();
  var gk=localStorage.getItem('yjtax_gemini_key')||localStorage.getItem('yjtax_gemini_backup');
  if(!gk){alert('âš™ï¸ ì„¤ì •ì—ì„œ Gemini API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');return}
  var prog=document.getElementById('proof-scan-progress');
  var bar=document.getElementById('proof-scan-bar');
  var status=document.getElementById('proof-scan-status');
  var log=document.getElementById('proof-scan-log');
  prog.style.display='block';bar.style.width='0%';log.innerHTML='';
  var total=files.length,done=0,added=0;
  status.textContent='ğŸ” '+total+'ê°œ íŒŒì¼ ìŠ¤ìº” ì‹œì‘...';
  if(D.isDemo){D.bank=[];D.tax=[];D.card=[];D.proof=[];D.etc=[];D.files=[];D.isDemo=false}
  for(var i=0;i<files.length;i++){
    var file=files[i];
    status.textContent='ğŸ“¸ ('+(i+1)+'/'+total+') '+file.name;
    bar.style.width=Math.round((i/total)*100)+'%';
    try{
      var result=await geminiProofScan(file,gk);
      if(result&&!result.error){
        var entry=buildProofEntry(result,file.name);
        D.proof.push(entry);
        D.files.push({name:file.name,format:file.type.startsWith('image/')?'image':'pdf',category:'proof',count:1});
        driveUpload(file,'proof');
        added++;
        log.innerHTML+='<div style="color:#2E7D32">âœ… '+file.name+' â†’ '+entry.desc+' '+fm(entry.total)+'ì› ['+entry.category+']</div>';
      }else{
        log.innerHTML+='<div style="color:#C62828">âŒ '+file.name+': '+(result?result.error:'ì¸ì‹ ì‹¤íŒ¨')+'</div>';
      }
    }catch(e){
      log.innerHTML+='<div style="color:#C62828">âŒ '+file.name+': '+e.message+'</div>';
    }
    done++;
    await new Promise(function(r){setTimeout(r,300)});
  }
  bar.style.width='100%';
  status.textContent='âœ… ì™„ë£Œ! '+added+'/'+total+'ê±´ ìë™ ë“±ë¡';
  rAll();
  showToast('âœ… ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº” ì™„ë£Œ: '+added+'ê±´ ìë™ ë“±ë¡');
  setTimeout(function(){prog.style.display='none'},8000);
}

async function geminiProofScan(file,apiKey){
  var b64;
  if(file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf')){
    try{
      var buf=await file.arrayBuffer();
      var pdf=await pdfjsLib.getDocument({data:buf}).promise;
      var text='';
      for(var p=1;p<=Math.min(pdf.numPages,3);p++){
        var pg=await pdf.getPage(p);var c=await pg.getTextContent();
        text+=c.items.map(function(x){return x.str}).join(' ')+'\n';
      }
      var resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+apiKey,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:'ë‹¤ìŒì€ ì§€ì¶œì¦ë¹™ PDF í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë¶„ì„í•´ì„œ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´ì£¼ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n{"date":"YYYY-MM-DD","desc":"ìƒí˜¸ëª…/ê±°ë˜ì²˜","proofType":"ê±°ë˜í™•ì¸ì¦|í˜„ê¸ˆì˜ìˆ˜ì¦|ê°„ì´ì˜ìˆ˜ì¦|ì¹´ë“œì „í‘œ|ëŒ€ë¦¬ìš´ì „ì˜ìˆ˜ì¦|íƒì‹œì˜ìˆ˜ì¦|ê¸°íƒ€","category":"êµí†µë¹„|ì‹ëŒ€|ì‚¬ë¬´ìš©í’ˆ|ì ‘ëŒ€ë¹„|ì†Œëª¨í’ˆë¹„|í†µì‹ ë¹„|ê¸°íƒ€","supply":ê³¼ì„¸ê¸ˆì•¡ìˆ«ì,"tax":ë¶€ê°€ì„¸ìˆ«ì,"tip":ë´‰ì‚¬ë£Œìˆ«ì,"total":ì´ê²°ì œê¸ˆì•¡ìˆ«ì,"payment":"ì¹´ë“œ|í˜„ê¸ˆ|ì¹´ì¹´ì˜¤í˜ì´|ê³„ì¢Œì´ì²´|ê¸°íƒ€","deductible":"ê³µì œ|ë¶ˆê³µì œ"}\n\n** ì¹´ì¹´ì˜¤í˜ì´ ê±°ë˜í™•ì¸ì¦ PDFì¸ ê²½ìš°: ê±°ë˜ì¼ì‹œ, ê²°ì œê¸ˆì•¡, ê°€ë§¹ì ëª… ì •í™•íˆ ì¶”ì¶œ. payment=ì¹´ì¹´ì˜¤í˜ì´ **\n- ì´ê²°ì œê¸ˆì•¡ = ê³¼ì„¸ê¸ˆì•¡+ë¶€ê°€ì„¸+ë´‰ì‚¬ë£Œ\n- ìˆ«ìëŠ” ì½¤ë§ˆ ì—†ì´ ìˆœìˆ˜ ìˆ«ìë§Œ\nì¸ì‹ ë¶ˆê°€ ì‹œ {"error":"ì¸ì‹ ë¶ˆê°€"} ë°˜í™˜.\n\ní…ìŠ¤íŠ¸:\n'+text}]}]})
      });
      var data=await resp.json();
      return parseGeminiProofResult(data);
    }catch(e){return{error:e.message}}
  }
  try{
    b64=await new Promise(function(res){var r=new FileReader;r.onload=function(e){res(e.target.result.split(',')[1])};r.readAsDataURL(file)});
    var resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+apiKey,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts:[
        {inline_data:{mime_type:file.type||'image/png',data:b64}},
        {text:'ì´ ì§€ì¶œì¦ë¹™ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì„œ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´ì£¼ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n{"date":"YYYY-MM-DD","desc":"ìƒí˜¸ëª…/ê±°ë˜ì²˜","proofType":"ê±°ë˜í™•ì¸ì¦|í˜„ê¸ˆì˜ìˆ˜ì¦|ê°„ì´ì˜ìˆ˜ì¦|ì¹´ë“œì „í‘œ|ëŒ€ë¦¬ìš´ì „ì˜ìˆ˜ì¦|íƒì‹œì˜ìˆ˜ì¦|ê¸°íƒ€","category":"êµí†µë¹„|ì‹ëŒ€|ì‚¬ë¬´ìš©í’ˆ|ì ‘ëŒ€ë¹„|ì†Œëª¨í’ˆë¹„|í†µì‹ ë¹„|ê¸°íƒ€","supply":ê³¼ì„¸ê¸ˆì•¡ìˆ«ì,"tax":ë¶€ê°€ì„¸ìˆ«ì,"exempt":ë©´ì„¸ê¸ˆì•¡ìˆ«ì,"tip":ë´‰ì‚¬ë£Œìˆ«ì,"total":ì´ê²°ì œê¸ˆì•¡ìˆ«ì,"payment":"ì¹´ë“œ|í˜„ê¸ˆ|ì¹´ì¹´ì˜¤í˜ì´|ê³„ì¢Œì´ì²´|ê¸°íƒ€","deductible":"ê³µì œ|ë¶ˆê³µì œ","from":"ì¶œë°œì§€(í•´ë‹¹ì‹œ)","to":"ë„ì°©ì§€(í•´ë‹¹ì‹œ)","time":"ìš´í–‰ì‹œê°„(í•´ë‹¹ì‹œ)"}\n\n** ì˜ìˆ˜ì¦ ìœ í˜•ë³„ ì¸ì‹ ê°€ì´ë“œ **\n1. ëŒ€ë¦¬ìš´ì „ ì˜ìˆ˜ì¦ (ìŒë‘¥ì´ëŒ€ë¦¬ìš´ì „ ë“±): ê³¼ì„¸ê¸ˆì•¡, ë¶€ê°€ì„¸, ë©´ì„¸ê¸ˆì•¡, ë´‰ì‚¬ë£Œ, ê²°ì œë°©ë²•, ì´ê²°ì œê¸ˆì•¡ ì •í™•íˆ ì½ê¸°. category=êµí†µë¹„\n2. íƒì‹œ ì´ìš© ìƒì„¸ (ì¹´ì¹´ì˜¤T): ë‚ ì§œ(26.01.24â†’2026-01-24), ì¶œë°œ/ë„ì°©, ìš´í–‰ì‹œê°„ ì½ê¸°. ê¸ˆì•¡ ì—†ìœ¼ë©´ total=0. category=êµí†µë¹„\n3. ì¹´ì¹´ì˜¤í˜ì´ ê±°ë˜í™•ì¸ì¦: ê²°ì œê¸ˆì•¡, ê±°ë˜ì²˜ëª…, ë‚ ì§œ ì½ê¸°. payment=ì¹´ì¹´ì˜¤í˜ì´\n4. ì¼ë°˜ ì˜ìˆ˜ì¦/ì¹´ë“œì „í‘œ: ê³¼ì„¸ê¸ˆì•¡, ë¶€ê°€ì„¸, ì´ê¸ˆì•¡ ì½ê¸°\n\n- ë´‰ì‚¬ë£Œê°€ ìˆìœ¼ë©´ ë°˜ë“œì‹œ tipì— ë„£ì–´ì£¼ì„¸ìš” (ëŒ€ë¦¬ìš´ì „ ë´‰ì‚¬ë£ŒëŠ” ë©´ì„¸)\n- ì´ê²°ì œê¸ˆì•¡ = ê³¼ì„¸ê¸ˆì•¡ + ë¶€ê°€ì„¸ + ë´‰ì‚¬ë£Œ\n- ë‚ ì§œê°€ 26.01.24 í˜•ì‹ì´ë©´ 2026-01-24ë¡œ ë³€í™˜\n- ìˆ«ìëŠ” ë°˜ë“œì‹œ ì½¤ë§ˆ ì—†ì´ ìˆœìˆ˜ ìˆ«ìë§Œ\nì¸ì‹ ë¶ˆê°€ ì‹œ {"error":"ì¸ì‹ ë¶ˆê°€"} ë°˜í™˜.'}
      ]}]})
    });
    var data=await resp.json();
    return parseGeminiProofResult(data);
  }catch(e){return{error:e.message}}
}

function parseGeminiProofResult(data){
  try{
    if(data.error)return{error:data.error.message};
    var text=data.candidates[0].content.parts[0].text;
    var clean=text.replace(/```json|```/g,'').trim();
    var jsonMatch=clean.match(/\{[\s\S]*?\}/);
    if(!jsonMatch)return{error:'JSON íŒŒì‹± ì‹¤íŒ¨'};
    var parsed=JSON.parse(jsonMatch[0]);
    if(parsed.error)return parsed;
    return parsed;
  }catch(e){return{error:'íŒŒì‹± ì˜¤ë¥˜: '+e.message}}
}

function buildProofEntry(result,fileName){
  var supply=Math.abs(parseInt(result.supply)||0);
  var tax=Math.abs(parseInt(result.tax)||0);
  var tip=Math.abs(parseInt(result.tip)||0);
  var total=Math.abs(parseInt(result.total)||0);
  if(!total&&(supply||tax||tip))total=supply+tax+tip;
  if(total&&!supply&&!tax){supply=Math.round(total/1.1);tax=total-supply-tip}
  var desc=result.desc||fileName.replace(/\.[^.]+$/,'');
  var category=result.category||classifyExpense(desc);
  var proofType=result.proofType||'ê¸°íƒ€';
  var payment=result.payment||'ì¹´ë“œ';
  var deductible=result.deductible||'ê³µì œ';
  var date=result.date||new Date().toISOString().slice(0,10);
  if(/^\d{2}\.\d{2}\.\d{2}$/.test(date)){date='20'+date.replace(/\./g,'-')}
  return{date:date,desc:desc,proofType:proofType,category:category,supply:supply,tax:tax,tip:tip,total:total,payment:payment,deductible:deductible};
}
function calcProofTotal(){try{var s=parseInt(String(document.getElementById('pf-supply').value||0).replace(/[,\s]/g,''),10)||0;var t=parseInt(String(document.getElementById('pf-tax').value||0).replace(/[,\s]/g,''),10)||0;var tip=parseInt(String(document.getElementById('pf-tip').value||0).replace(/[,\s]/g,''),10)||0;document.getElementById('pf-total').value=fm(s+t+tip)}catch(e){}}
function addProofEntry(){
  var dt=document.getElementById('pf-date').value;var desc=document.getElementById('pf-desc').value.trim();
  var totalStr=document.getElementById('pf-total').value;var total=parseInt(String(totalStr||0).replace(/[,\sì›]/g,''),10)||0;
  if(!dt){alert('ê±°ë˜ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');return}if(!desc){alert('ìƒí˜¸ëª…/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');return}if(!total){alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');return}
  var supply=parseInt(String(document.getElementById('pf-supply').value||0).replace(/[,\s]/g,''),10)||0;
  var tax=parseInt(String(document.getElementById('pf-tax').value||0).replace(/[,\s]/g,''),10)||0;
  var tip=parseInt(String(document.getElementById('pf-tip').value||0).replace(/[,\s]/g,''),10)||0;
  if(!supply&&!tax&&total)supply=Math.round(total/1.1);tax=tax||total-supply-tip;
  D.proof.push({date:dt,desc:desc,proofType:document.getElementById('pf-type').value,category:document.getElementById('pf-cat').value,supply:supply,tax:tax,tip:tip,total:total,payment:document.getElementById('pf-pay').value,deductible:document.getElementById('pf-deduct').value});
  showToast('âœ… ì§€ì¶œì¦ë¹™ ì¶”ê°€: '+desc+' '+fm(total)+'ì›');
  document.getElementById('pf-desc').value='';document.getElementById('pf-supply').value='';document.getElementById('pf-tax').value='';document.getElementById('pf-tip').value='';document.getElementById('pf-total').value='';
  D.isDemo=false;rAll();
}
function rFL(){
  var c=document.getElementById('fl'),rb=document.getElementById('rb'),xb=document.getElementById('xb'),wrap=document.getElementById('fl-wrap');
  if(!D.files.length){c.innerHTML='';rb.style.display='none';xb.style.display='none';wrap.style.display='none';return}
  rb.style.display='inline-flex';xb.style.display='flex';wrap.style.display='block';
  document.getElementById('fl-title').textContent='ì—…ë¡œë“œ íŒŒì¼ ('+D.files.length+'ê°œ)';
  var ic={excel:'fa-file-excel',csv:'fa-file-csv',pdf:'fa-file-pdf',word:'fa-file-word',text:'fa-file-lines',image:'fa-file-image'};
  var bg={excel:'#E8F5E9',csv:'#FFF3E0',pdf:'#FFEBEE',word:'#E3F2FD',text:'#F3E5F5',image:'#FFF8E1'};
  var cb={bank:'b-bl',tax:'b-or',card:'b-pr',proof:'b-or',etc:'b-gy'};var cl={bank:'í†µì¥',tax:'ì„¸ê¸ˆê³„ì‚°ì„œ',card:'ì¹´ë“œ',proof:'ì§€ì¶œì¦ë¹™',etc:'ê¸°íƒ€'};
  c.innerHTML=D.files.map(function(f,i){return'<div class="lg"><div class="lg-ic" style="background:'+(bg[f.format]||'#ECEFF1')+'"><i class="fas '+(ic[f.format]||'fa-file')+'"></i></div><div style="flex:1;min-width:0"><div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+f.name+'</div><div style="font-size:11px;color:#999">'+f.count+'ê±´ Â· '+f.format.toUpperCase()+'</div><span class="badge '+(cb[f.category]||'b-gy')+'">'+(cl[f.category]||'ê¸°íƒ€')+'</span></div><button class="lg-rm" onclick="rmF('+i+')"><i class="fas fa-xmark"></i></button></div>'}).join('')}
var flOpen=false;
function toggleFileList(){
  flOpen=!flOpen;
  document.getElementById('fl').style.display=flOpen?'block':'none';
  document.getElementById('fl-chevron').style.transform=flOpen?'rotate(180deg)':'rotate(0deg)';
  try{localStorage.setItem('yjtax_fl_open',flOpen?'1':'0')}catch(e){}
}
// ì´ˆê¸° ìƒíƒœ ë³µì›
try{if(localStorage.getItem('yjtax_fl_open')==='1'){flOpen=true;document.getElementById('fl').style.display='block';document.getElementById('fl-chevron').style.transform='rotate(180deg)'}}catch(e){}
function rmF(i){D.files.splice(i,1);if(!D.files.length)resetAll();else rFL()}
function uUI(){
  // ë§ˆìŠ¤í„° ì—…ë¡œë“œ í•­ìƒ í‘œì‹œ (ê³ ì •) â€” íŒŒì¼ ìˆìœ¼ë©´ compact ëª¨ë“œ + ìƒíƒœ í‘œì‹œ
  var muEl=document.getElementById('mu1');var usEl=document.getElementById('us1');
  if(!D.isDemo){
    muEl.classList.add('mu-compact');
    usEl.classList.add('on');
    document.getElementById('um1').textContent=D.files.length+'ê°œ íŒŒì¼ Â· '+(D.bank.length+D.tax.length+D.card.length+D.proof.length+D.etc.length)+'ê±´ ë¡œë“œ ì™„ë£Œ';
  }else{
    muEl.classList.remove('mu-compact');
    usEl.classList.remove('on');
  }
  document.getElementById('xb').style.display=(D.tax.length||D.bank.length||D.card.length||D.proof.length)?'flex':'none';
}

// === í´ë” ì¬ê·€ íƒìƒ‰ (ë“œë˜ê·¸ í´ë” ì§€ì›) ===
function readEntryFiles(entry){
  return new Promise(function(resolve){
    if(entry.isFile){
      entry.file(function(f){resolve([f])},function(){resolve([])});
    }else if(entry.isDirectory){
      var reader=entry.createReader();
      var allEntries=[];
      (function readAll(){
        reader.readEntries(function(entries){
          if(!entries.length){
            Promise.all(allEntries.map(readEntryFiles)).then(function(arrs){
              resolve(arrs.reduce(function(a,b){return a.concat(b)},[]))
            });
          }else{
            allEntries=allEntries.concat(Array.from(entries));
            readAll();
          }
        },function(){resolve([])});
      })();
    }else resolve([]);
  });
}
function handleDrop(e){
  e.preventDefault();
  var items=e.dataTransfer.items;
  if(items&&items.length){
    var entries=[];
    for(var i=0;i<items.length;i++){
      var entry=items[i].webkitGetAsEntry&&items[i].webkitGetAsEntry();
      if(entry)entries.push(entry);
    }
    if(entries.length){
      var folderFound=entries.some(function(en){return en.isDirectory});
      if(folderFound)showToast('ğŸ“‚ í´ë” ìŠ¤ìº” ì¤‘...');
      Promise.all(entries.map(readEntryFiles)).then(function(arrs){
        var files=arrs.reduce(function(a,b){return a.concat(b)},[]);
        // ì„ì‹œíŒŒì¼/ìˆ¨ê¹€íŒŒì¼ ì œì™¸
        files=files.filter(function(f){return !f.name.startsWith('~$')&&!f.name.startsWith('.')&&f.size>0});
        if(folderFound)showToast('ğŸ“‚ '+files.length+'ê°œ íŒŒì¼ ë°œê²¬');
        // ì´ë¯¸ì§€/PDFëŠ” ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”ìœ¼ë¡œ ë¶„ë¦¬ ì²˜ë¦¬
        var imgPdfFiles=files.filter(function(f){return f.type.startsWith('image/')||f.type==='application/pdf'||/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
        var otherFiles=files.filter(function(f){return!f.type.startsWith('image/')&&f.type!=='application/pdf'&&!/\.(png|jpg|jpeg|gif|webp|heic|bmp|tiff|tif|pdf)$/i.test(f.name)});
        if(imgPdfFiles.length>0){showToast('ğŸ“¸ ì´ë¯¸ì§€/PDF '+imgPdfFiles.length+'ê±´ â†’ ì§€ì¶œì¦ë¹™ AI ìŠ¤ìº”');processProofBatch(imgPdfFiles)}
        otherFiles.forEach(mpQ);
      });
      return;
    }
  }
  // í´ë°±: ì¼ë°˜ íŒŒì¼
  Array.from(e.dataTransfer.files).forEach(mpQ);
}
// === BIND ===
function bind(z,f){var ze=document.getElementById(z),fe=document.getElementById(f);ze.addEventListener('click',function(){fe.click()});fe.addEventListener('change',function(e){Array.from(e.target.files).forEach(mpQ);fe.value=''});ze.addEventListener('dragover',function(e){e.preventDefault();ze.style.borderColor='var(--gd)';ze.style.background='#FFF8E1';ze.style.transform='scale(1.02)'});ze.addEventListener('dragleave',function(){ze.style.borderColor='';ze.style.background='';ze.style.transform=''});ze.addEventListener('drop',function(e){ze.style.borderColor='';ze.style.background='';ze.style.transform='';handleDrop(e)})}
bind('mu1','fi1');bind('mu2','fi2');
document.getElementById('mo').addEventListener('click',function(e){if(e.target===this){this.classList.remove('show');resetModal();pn={f:null,r:null,t:''}}});

// === Google Drive API ===
var GD={connected:false,token:null,rootId:null,log:[]};
var SCOPES='https://www.googleapis.com/auth/drive.file';
var DISCOVERY_DOC='https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
var gapiInited=false,gisInited=false,tokenClient=null;

// ì €ì¥/ë¡œë“œ API í‚¤
function saveDriveConfig(){try{localStorage.setItem('yjtax_drive',JSON.stringify({apiKey:document.getElementById('drive-api-key').value,clientId:document.getElementById('drive-client-id').value,log:GD.log}))}catch(e){}}
function loadDriveConfig(){try{var c=localStorage.getItem('yjtax_drive');if(c){var d=JSON.parse(c);document.getElementById('drive-api-key').value=d.apiKey||'';document.getElementById('drive-client-id').value=d.clientId||'';GD.log=d.log||[];renderDriveLog()}}catch(e){}}

function openSettings(){
  document.getElementById('settings-modal').style.display='flex';
  loadDriveConfig();
  var k=localStorage.getItem('yjtax_gemini_key');
  if(k)document.getElementById('gemini-api-key').value=k;
  var ck=localStorage.getItem('yjtax_claude_key');
  if(ck)document.getElementById('claude-api-key').value=ck;
  var nk=localStorage.getItem('yjtax_nts_key');
  if(nk)document.getElementById('nts-api-key').value=nk;
  var pk=localStorage.getItem('yjtax_perplexity_key');
  if(pk)document.getElementById('perplexity-api-key').value=pk;
  var ak=localStorage.getItem('yjtax_alpha_key');
  if(ak)document.getElementById('alpha-api-key').value=ak;
  updateGeminiBadge();updateDriveBadge();updateClaudeBadge();updateNtsBadge();updatePerplexityBadge();updateAlphaBadge();checkDriveEnv();
}
function closeSettings(){document.getElementById('settings-modal').style.display='none';saveDriveConfig()}

// === êµ­ì„¸ì²­ Open API ===
function saveNtsKey(){var k=document.getElementById('nts-api-key').value.trim();if(!k){alert('ì„œë¹„ìŠ¤í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}localStorage.setItem('yjtax_nts_key',k);updateNtsBadge();showToast('âœ… êµ­ì„¸ì²­ API ì„œë¹„ìŠ¤í‚¤ ì €ì¥ ì™„ë£Œ')}
function updateNtsBadge(){var k=localStorage.getItem('yjtax_nts_key');var b=document.getElementById('nts-badge');if(!b)return;if(k){b.textContent='âœ… ì—°ë™';b.style.background='#E3F2FD';b.style.color='#1565C0'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999'}}

// ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ì²´í¬ë””ì§€íŠ¸ ê²€ì¦ (êµ­ì„¸ì²­ ê²€ì¦ ì•Œê³ ë¦¬ì¦˜)
function validateBizNo(bno){
  var n=bno.replace(/[^0-9]/g,'');
  if(n.length!==10)return false;
  var w=[1,3,7,1,3,7,1,3,5];var sum=0;
  for(var i=0;i<9;i++)sum+=parseInt(n[i])*w[i];
  sum+=Math.floor(parseInt(n[8])*5/10);
  var check=(10-(sum%10))%10;
  return check===parseInt(n[9]);
}

// ìƒíƒœì¡°íšŒ (ì‚¬ì—…ìë²ˆí˜¸ ë°°ì—´ â†’ ê²°ê³¼) â€” CORS í”„ë¡ì‹œ ìë™ í´ë°±
async function ntsStatusCheck(bnoArr){
  var key=localStorage.getItem('yjtax_nts_key');if(!key)return null;
  var validArr=bnoArr.filter(function(b){return validateBizNo(b)});
  var invalidArr=bnoArr.filter(function(b){return !validateBizNo(b)});
  if(invalidArr.length)console.warn('ì²´í¬ë””ì§€íŠ¸ ì˜¤ë¥˜ ì‚¬ì—…ìë²ˆí˜¸: '+invalidArr.join(', '));
  if(!validArr.length)return null;
  var baseUrl='https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey='+encodeURIComponent(key);
  var proxies=['',  'https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
  for(var pi=0;pi<proxies.length;pi++){
    try{
      var url=proxies[pi]?proxies[pi]+encodeURIComponent(baseUrl):baseUrl;
      var resp=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','accept':'application/json'},body:JSON.stringify({b_no:validArr})});
      var data=await resp.json();
      if(data.status_code==='OK')return data.data;
      if(data.data)return data.data;
      console.warn('NTS proxy '+pi+' status:',data.status_code);
    }catch(e){console.warn('NTS proxy '+pi+' error:',e.message);continue}
  }
  console.error('NTS API: all methods failed');return null;
}

// ì¦‰ì„ ì¡°íšŒ
async function ntsQuickCheck(){
  var bno=document.getElementById('nts-bno-input').value.replace(/[^0-9]/g,'');
  var resultEl=document.getElementById('nts-quick-result');
  if(bno.length!==10){alert('ì‚¬ì—…ìë²ˆí˜¸ 10ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}
  var key=localStorage.getItem('yjtax_nts_key');
  if(!key){alert('âš™ï¸ ì„œë¹„ìŠ¤í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.');return}
  resultEl.style.display='block';resultEl.innerHTML='<i class="fas fa-spinner fa-spin"></i> êµ­ì„¸ì²­ ì¡°íšŒ ì¤‘...';resultEl.style.background='#F5F5F5';resultEl.style.color='#333';
  
  var results=await ntsStatusCheck([bno]);
  if(!results||!results.length){resultEl.innerHTML='âŒ ì¡°íšŒ ì‹¤íŒ¨ (ì„œë¹„ìŠ¤í‚¤ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ í™•ì¸)';resultEl.style.background='#FFEBEE';resultEl.style.color='#C62828';return}
  
  var r=results[0];
  var status=r.b_stt||'ì•Œìˆ˜ì—†ìŒ';
  var statusCd=r.b_stt_cd||'';
  var taxType=r.tax_type||'';
  var endDt=r.end_dt||'';
  
  var isActive=statusCd==='01';
  var isClosed=statusCd==='03';
  var isSuspended=statusCd==='02';
  
  var bg=isActive?'#E8F5E9':isClosed?'#FFEBEE':isSuspended?'#FFF3E0':'#F5F5F5';
  var color=isActive?'#2E7D32':isClosed?'#C62828':isSuspended?'#E65100':'#333';
  var icon=isActive?'âœ…':isClosed?'âŒ':'âš ï¸';
  
  var html=icon+' <b>'+bno.replace(/(\d{3})(\d{2})(\d{5})/,'$1-$2-$3')+'</b><br>';
  html+='ìƒíƒœ: <b style="color:'+color+'">'+status+'</b>';
  if(taxType)html+=' | ê³¼ì„¸ìœ í˜•: '+taxType;
  if(endDt)html+='<br>íì—…ì¼: '+endDt.replace(/(\d{4})(\d{2})(\d{2})/,'$1-$2-$3');
  if(isClosed)html+='<br><span style="color:#C62828;font-weight:700">âš ï¸ íì—… ì‚¬ì—…ì! ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì…ì„¸ì•¡ ê³µì œ ë¶ˆê°€ ìœ„í—˜</span>';
  if(isSuspended)html+='<br><span style="color:#E65100;font-weight:700">âš ï¸ íœ´ì—… ì¤‘! ê±°ë˜ ì£¼ì˜</span>';
  
  resultEl.innerHTML=html;resultEl.style.background=bg;resultEl.style.color=color;
}

// ì„¸ê¸ˆê³„ì‚°ì„œ ê±°ë˜ì²˜ ì¼ê´„ ê²€ì¦
async function ntsBatchCheck(){
  var key=localStorage.getItem('yjtax_nts_key');
  if(!key){alert('âš™ï¸ ì„¤ì •ì—ì„œ êµ­ì„¸ì²­ API ì„œë¹„ìŠ¤í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');return}
  
  // ì„¸ê¸ˆê³„ì‚°ì„œì—ì„œ ì‚¬ì—…ìë²ˆí˜¸ ì¶”ì¶œ (D.taxì— bno í•„ë“œê°€ ìˆëŠ” ê²½ìš°)
  var bnoSet={};var bnoClients={};
  D.tax.forEach(function(r){
    if(r.bizNo){
      var clean=r.bizNo.replace(/[^0-9]/g,'');
      if(clean.length===10){bnoSet[clean]=true;bnoClients[clean]=bnoClients[clean]||[];bnoClients[clean].push(r.client)}
    }
  });
  
  var bnoArr=Object.keys(bnoSet);
  if(!bnoArr.length){
    openModal('ğŸ›ï¸ êµ­ì„¸ì²­ ì‚¬ì—…ì ìƒíƒœì¡°íšŒ','<div style="margin-bottom:12px;font-size:12px;color:#555">ì„¸ê¸ˆê³„ì‚°ì„œì— ì‚¬ì—…ìë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œë¡œ êµ¬ë¶„):</div><textarea id="nts-manual-input" placeholder="1234567890, 0987654321" style="width:100%;height:80px;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:monospace;font-size:13px;resize:none"></textarea><button onclick="ntsManualCheck()" style="width:100%;padding:12px;background:#1565C0;color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:14px;cursor:pointer;margin-top:8px"><i class="fas fa-landmark"></i> êµ­ì„¸ì²­ ì¡°íšŒ</button><div id="nts-batch-result" style="margin-top:12px;max-height:300px;overflow-y:auto"></div>');
    return;
  }
  
  showToast('ğŸ›ï¸ êµ­ì„¸ì²­ ì¡°íšŒ ì¤‘... ('+bnoArr.length+'ê±´)');
  var results=await ntsStatusCheck(bnoArr);
  if(!results){showToast('âŒ êµ­ì„¸ì²­ API í˜¸ì¶œ ì‹¤íŒ¨');return}
  
  showNtsResults(results,bnoClients);
}

async function ntsManualCheck(){
  var input=document.getElementById('nts-manual-input').value;
  var bnoArr=input.split(/[,\s\n]+/).map(function(s){return s.replace(/[^0-9]/g,'')}).filter(function(s){return s.length===10});
  if(!bnoArr.length){alert('ìœ íš¨í•œ ì‚¬ì—…ìë²ˆí˜¸(10ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}
  
  document.getElementById('nts-batch-result').innerHTML='<div style="text-align:center;padding:16px;color:#1565C0"><i class="fas fa-spinner fa-spin"></i> '+bnoArr.length+'ê±´ ì¡°íšŒ ì¤‘...</div>';
  var results=await ntsStatusCheck(bnoArr);
  if(!results){document.getElementById('nts-batch-result').innerHTML='<div style="color:#C62828">âŒ ì¡°íšŒ ì‹¤íŒ¨</div>';return}
  
  var html='';
  results.forEach(function(r){
    var bno=r.b_no;var status=r.b_stt||'ì•Œìˆ˜ì—†ìŒ';var statusCd=r.b_stt_cd||'';
    var taxType=r.tax_type||'';var endDt=r.end_dt||'';
    var isActive=statusCd==='01';var isClosed=statusCd==='03';
    var bg=isActive?'#E8F5E9':isClosed?'#FFEBEE':'#FFF3E0';
    var icon=isActive?'âœ…':isClosed?'âŒ':'âš ï¸';
    html+='<div style="display:flex;align-items:center;gap:10px;padding:10px;background:'+bg+';border-radius:8px;margin-bottom:4px">';
    html+='<span style="font-size:16px">'+icon+'</span>';
    html+='<div style="flex:1"><div style="font-weight:700;font-family:monospace">'+bno.replace(/(\d{3})(\d{2})(\d{5})/,'$1-$2-$3')+'</div>';
    html+='<div style="font-size:11px;color:#555">'+status+(taxType?' Â· '+taxType:'')+(endDt?' Â· íì—… '+endDt:'')+'</div></div></div>';
  });
  document.getElementById('nts-batch-result').innerHTML=html;
}

function showNtsResults(results,bnoClients){
  var warnings=0;
  var html='<div style="max-height:350px;overflow-y:auto">';
  results.forEach(function(r){
    var bno=r.b_no;var status=r.b_stt||'ì•Œìˆ˜ì—†ìŒ';var statusCd=r.b_stt_cd||'';
    var taxType=r.tax_type||'';var endDt=r.end_dt||'';
    var isActive=statusCd==='01';var isClosed=statusCd==='03';var isSuspended=statusCd==='02';
    if(!isActive)warnings++;
    var bg=isActive?'#E8F5E9':isClosed?'#FFEBEE':'#FFF3E0';
    var icon=isActive?'âœ…':isClosed?'âŒ':'âš ï¸';
    var clients=(bnoClients[bno]||[]).join(', ');
    html+='<div style="display:flex;align-items:center;gap:10px;padding:10px;background:'+bg+';border-radius:8px;margin-bottom:4px">';
    html+='<span style="font-size:18px">'+icon+'</span>';
    html+='<div style="flex:1"><div style="font-weight:700;font-size:13px">'+(clients||bno.replace(/(\d{3})(\d{2})(\d{5})/,'$1-$2-$3'))+'</div>';
    html+='<div style="font-size:11px;font-family:monospace;color:#999">'+bno.replace(/(\d{3})(\d{2})(\d{5})/,'$1-$2-$3')+'</div>';
    html+='<div style="font-size:11px;color:#555">'+status+(taxType?' Â· '+taxType:'')+'</div>';
    if(isClosed)html+='<div style="font-size:11px;color:#C62828;font-weight:700">âš ï¸ íì—…! ë§¤ì…ì„¸ì•¡ ê³µì œ ë¶ˆê°€ ìœ„í—˜</div>';
    if(isSuspended)html+='<div style="font-size:11px;color:#E65100;font-weight:700">âš ï¸ íœ´ì—… ì¤‘! ê±°ë˜ ì£¼ì˜</div>';
    html+='</div></div>';
  });
  html+='</div>';
  
  openModal('ğŸ›ï¸ êµ­ì„¸ì²­ ê±°ë˜ì²˜ ê²€ì¦ ê²°ê³¼'+(warnings>0?' (âš ï¸ '+warnings+'ê±´ ì£¼ì˜)':''),html+'<button onclick="document.getElementById(\'mo\').classList.remove(\'show\');resetModal()" style="width:100%;padding:12px;background:var(--nv);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer;margin-top:12px">í™•ì¸</button>');
  showToast('ğŸ›ï¸ êµ­ì„¸ì²­ ê²€ì¦ ì™„ë£Œ!'+(warnings>0?' âš ï¸ '+warnings+'ê±´ ì£¼ì˜':''));
}
function updateGeminiBadge(){var k=localStorage.getItem('yjtax_gemini_key');var b=document.getElementById('gemini-badge');if(k){b.textContent='âœ… ì—°ë™';b.style.background='#E8F5E9';b.style.color='#2E7D32'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999'}}
function updateDriveBadge(){var b=document.getElementById('drive-badge');if(GD.connected){b.textContent='âœ… ì—°ë™';b.style.background='#E8F5E9';b.style.color='#2E7D32';document.getElementById('drive-connect-btn').style.display='none';document.getElementById('drive-disconnect-btn').style.display='block'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999';document.getElementById('drive-connect-btn').style.display='flex';document.getElementById('drive-disconnect-btn').style.display='none'}}
function checkDriveEnv(){var w=document.getElementById('drive-env-warning');if(location.protocol==='file:')w.style.display='block';else w.style.display='none'}
function driveLog(msg){var el=document.getElementById('drive-connect-log');el.style.display='block';el.innerHTML+=new Date().toLocaleTimeString()+' â€” '+msg+'<br>';el.scrollTop=el.scrollHeight}

function updateDriveStatus(){try{updateDriveBadge()}catch(e){}}

function renderDriveLog(){
  var el=document.getElementById('drive-log');
  if(!GD.log.length){el.innerHTML='ì•„ì§ ì—…ë¡œë“œ ê¸°ë¡ ì—†ìŒ';return}
  el.innerHTML=GD.log.slice(-20).reverse().map(function(l){
    return'<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:6px">'+(l.ok?'<i class="fas fa-check-circle" style="color:var(--gn)"></i>':'<i class="fas fa-times-circle" style="color:var(--rd)"></i>')+'<span>'+l.time+' â€” '+l.name+' â†’ <b>'+l.folder+'</b></span></div>';
  }).join('');
}

// GAPI ì´ˆê¸°í™”
function loadGapi(){
  var s=document.createElement('script');s.src='https://apis.google.com/js/api.js';s.onload=function(){gapi.load('client',initGapiClient)};document.head.appendChild(s);
  var s2=document.createElement('script');s2.src='https://accounts.google.com/gsi/client';s2.onload=function(){gisInited=true};document.head.appendChild(s2);
}

async function initGapiClient(){
  var apiKey=document.getElementById('drive-api-key').value.trim();
  if(!apiKey)return;
  try{await gapi.client.init({apiKey:apiKey,discoveryDocs:[DISCOVERY_DOC]});gapiInited=true}catch(e){console.error('GAPI init error',e)}
}

async function connectDrive(){
  var apiKey=document.getElementById('drive-api-key').value.trim();
  var clientId=document.getElementById('drive-client-id').value.trim();
  if(!apiKey||!clientId){alert('API Keyì™€ Client IDë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');return}
  saveDriveConfig();driveLog('ğŸ”„ ì—°ê²° ì‹œì‘...');
  if(location.protocol==='file:'){driveLog('âŒ file:// í”„ë¡œí† ì½œì—ì„œëŠ” OAuth ë¶ˆê°€');alert('âš ï¸ file:// í™˜ê²½ì—ì„œëŠ” Google Drive ì—°ë™ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.\n\nYJ_Tax_Master_ì‹¤í–‰.batë¥¼ ì‚¬ìš©í•˜ì—¬\nhttp://localhost:8080 ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.');return}
  try{
    // 1. GAPI ë¡œë“œ
    driveLog('ğŸ“¦ Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”©...');
    if(!window.gapi){await new Promise(function(res,rej){var s=document.createElement('script');s.src='https://apis.google.com/js/api.js';s.onload=res;s.onerror=function(){rej(new Error('GAPI ë¡œë“œ ì‹¤íŒ¨'))};document.head.appendChild(s)})}
    driveLog('âœ… GAPI ë¡œë“œ ì™„ë£Œ');
    await new Promise(function(res){gapi.load('client',res)});
    driveLog('ğŸ“¦ Drive API ì´ˆê¸°í™”...');
    await gapi.client.init({apiKey:apiKey,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    driveLog('âœ… Drive API ì´ˆê¸°í™” ì™„ë£Œ');
    // 2. GIS (OAuth) ë¡œë“œ
    driveLog('ğŸ“¦ Google Identity Services ë¡œë”©...');
    if(!window.google||!window.google.accounts){await new Promise(function(res,rej){var s=document.createElement('script');s.src='https://accounts.google.com/gsi/client';s.onload=res;s.onerror=function(){rej(new Error('GIS ë¡œë“œ ì‹¤íŒ¨'))};document.head.appendChild(s)})}
    driveLog('âœ… GIS ë¡œë“œ ì™„ë£Œ');
    driveLog('ğŸ” Google ë¡œê·¸ì¸ íŒì—… ì—´ê¸°...');
    tokenClient=google.accounts.oauth2.initTokenClient({client_id:clientId,scope:'https://www.googleapis.com/auth/drive.file',callback:function(resp){
      if(resp.error){driveLog('âŒ ì¸ì¦ ì‹¤íŒ¨: '+resp.error);alert('ì¸ì¦ ì‹¤íŒ¨: '+(resp.error_description||resp.error));return}
      GD.token=resp.access_token;GD.connected=true;
      driveLog('âœ… Google Drive ì—°ê²° ì„±ê³µ!');
      updateDriveBadge();saveDriveConfig();
      initDriveFolders().then(function(){driveLog('ğŸ“ í´ë” êµ¬ì¡° ìƒì„± ì™„ë£Œ')});
    }});
    tokenClient.requestAccessToken({prompt:'consent'});
  }catch(e){driveLog('âŒ ì˜¤ë¥˜: '+e.message);alert('Drive ì—°ê²° ì‹¤íŒ¨: '+e.message)}
}
function disconnectDrive(){
  if(GD.token){try{google.accounts.oauth2.revoke(GD.token)}catch(e){}}
  GD.connected=false;GD.token=null;GD.rootId=null;
  updateDriveStatus();saveDriveConfig();
}

// í´ë” ìƒì„±/ì¡°íšŒ
async function findOrCreateFolder(name,parentId){
  var q="name='"+name+"' and mimeType='application/vnd.google-apps.folder' and trashed=false";
  if(parentId)q+=" and '"+parentId+"' in parents";
  try{
    var resp=await gapi.client.drive.files.list({q:q,fields:'files(id,name)',spaces:'drive'});
    if(resp.result.files&&resp.result.files.length>0)return resp.result.files[0].id;
    var meta={name:name,mimeType:'application/vnd.google-apps.folder'};
    if(parentId)meta.parents=[parentId];
    var cr=await gapi.client.drive.files.create({resource:meta,fields:'id'});
    return cr.result.id;
  }catch(e){console.error('Folder error',e);return null}
}

async function initDriveFolders(){
  GD.rootId=await findOrCreateFolder('YJ_Tax_Master');
  if(GD.rootId){
    var now=new Date();var yearId=await findOrCreateFolder(now.getFullYear()+'',GD.rootId);
    if(yearId){
      var mStr=String(now.getMonth()+1).padStart(2,'0')+'ì›”';
      var monthId=await findOrCreateFolder(mStr,yearId);
      if(monthId){
        await findOrCreateFolder('í†µì¥',monthId);
        await findOrCreateFolder('ì„¸ê¸ˆê³„ì‚°ì„œ',monthId);
        await findOrCreateFolder('ì¹´ë“œ',monthId);
        await findOrCreateFolder('ì§€ì¶œì¦ë¹™',monthId);
        await findOrCreateFolder('ê¸°íƒ€',monthId);
        await findOrCreateFolder('ê²½ì¡°ì‚¬ë¹„_ì¦ë¹™',monthId);
      }
    }
  }
}

// íŒŒì¼ ì—…ë¡œë“œ to Drive
async function uploadToDrive(file,category){
  if(!GD.connected||!GD.rootId)return;
  var now=new Date();var catMap={bank:'í†µì¥',tax:'ì„¸ê¸ˆê³„ì‚°ì„œ',card:'ì¹´ë“œ',proof:'ì§€ì¶œì¦ë¹™',etc:'ê¸°íƒ€',evt:'ê²½ì¡°ì‚¬ë¹„_ì¦ë¹™'};
  var folderName=catMap[category]||'ê¸°íƒ€';
  var timeStr=now.getFullYear()+'.'+String(now.getMonth()+1).padStart(2,'0')+'.'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  try{
    var yearId=await findOrCreateFolder(now.getFullYear()+'',GD.rootId);
    var mStr=String(now.getMonth()+1).padStart(2,'0')+'ì›”';
    var monthId=await findOrCreateFolder(mStr,yearId);
    var folderId=await findOrCreateFolder(folderName,monthId);
    // multipart upload
    var metadata={name:file.name,parents:[folderId]};
    var form=new FormData();form.append('metadata',new Blob([JSON.stringify(metadata)],{type:'application/json'}));form.append('file',file);
    var resp=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',{method:'POST',headers:{Authorization:'Bearer '+GD.token},body:form});
    var result=await resp.json();
    if(result.id){
      GD.log.push({ok:true,time:timeStr,name:file.name,folder:folderName});
      saveDriveConfig();renderDriveLog();
      console.log('Drive upload OK:',result.name);
    }else{
      GD.log.push({ok:false,time:timeStr,name:file.name,folder:folderName+' (ì‹¤íŒ¨)'});
      saveDriveConfig();renderDriveLog();
    }
  }catch(e){
    GD.log.push({ok:false,time:timeStr,name:file.name,folder:folderName+' (ì—ëŸ¬: '+e.message+')'});
    saveDriveConfig();renderDriveLog();
    console.error('Drive upload error',e);
  }
}

// Drive ì—…ë¡œë“œ ë˜í¼ (ì—ëŸ¬ ì•ˆì „)
function driveUpload(file,cat){try{if(GD.connected)uploadToDrive(file,cat)}catch(e){console.error('Drive upload skip',e)}}

// ê²½ì¡°ì‚¬ë¹„ ì¦ë¹™ë„ Drive ì—…ë¡œë“œ
function driveUploadEvt(file){driveUpload(file,'evt')}

// ============================================================
// === Driveì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (CSV/ì´ë¯¸ì§€) ===
// ============================================================
async function driveListFiles(folderName){
  if(!GD.connected||!GD.rootId){alert('Google Driveì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');return[]}
  try{
    var now=new Date();var yearId=await findOrCreateFolder(now.getFullYear()+'',GD.rootId);
    var mStr=String(now.getMonth()+1).padStart(2,'0')+'ì›”';
    var monthId=await findOrCreateFolder(mStr,yearId);
    var folderId=await findOrCreateFolder(folderName,monthId);
    if(!folderId)return[];
    var resp=await gapi.client.drive.files.list({q:"'"+folderId+"' in parents and trashed=false",fields:'files(id,name,mimeType,size)',orderBy:'createdTime desc',pageSize:50});
    return resp.result.files||[];
  }catch(e){console.error('Drive list error',e);return[]}
}

async function driveDownloadFile(fileId){
  try{
    var resp=await fetch('https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',{headers:{Authorization:'Bearer '+GD.token}});
    return await resp.blob();
  }catch(e){console.error('Drive download error',e);return null}
}

// Driveì—ì„œ ì¹´ë“œ/í†µì¥ CSV ë¶ˆëŸ¬ì˜¤ê¸°
async function driveImportCSV(category){
  if(!GD.connected){alert('Google Driveì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');return}
  var folderName=category==='card'?'ì¹´ë“œ':'í†µì¥';
  showToast('ğŸ“‚ Drive/'+folderName+' í´ë” ê²€ìƒ‰ ì¤‘...');
  var files=await driveListFiles(folderName);
  var csvFiles=files.filter(function(f){return/\.(csv|xlsx|xls|tsv)$/i.test(f.name)});
  if(!csvFiles.length){alert('Drive/'+folderName+' í´ë”ì— CSV/Excel íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.');return}
  
  // íŒŒì¼ ì„ íƒ ëª¨ë‹¬
  var html='<div style="max-height:300px;overflow-y:auto">';
  csvFiles.forEach(function(f,i){
    html+='<label style="display:flex;align-items:center;gap:10px;padding:12px;background:'+(i%2?'#f8f9fa':'#fff')+';border-radius:8px;margin-bottom:4px;cursor:pointer">';
    html+='<input type="checkbox" class="drive-csv-check" value="'+f.id+'" data-name="'+f.name+'" style="width:18px;height:18px;accent-color:var(--bl)">';
    html+='<i class="fas fa-file-csv" style="color:#2E7D32;font-size:18px"></i>';
    html+='<div style="flex:1"><div style="font-weight:600;font-size:13px">'+f.name+'</div>';
    html+='<div style="font-size:11px;color:#999">'+(f.size?(Math.round(f.size/1024)+'KB'):'')+'</div></div></label>';
  });
  html+='</div>';
  
  openModal('ğŸ“‚ Drive/'+folderName+' â€” ë¶ˆëŸ¬ì˜¬ íŒŒì¼ ì„ íƒ',html+'<button onclick="driveImportSelected(\''+category+'\')" style="width:100%;padding:12px;background:var(--bl);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer;margin-top:12px;font-size:14px"><i class="fas fa-cloud-arrow-down"></i> ì„ íƒí•œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>');
}

async function driveImportSelected(category){
  var checks=document.querySelectorAll('.drive-csv-check:checked');
  if(!checks.length){alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');return}
  document.getElementById('mo').classList.remove('show');resetModal();
  var count=0;
  for(var i=0;i<checks.length;i++){
    var fileId=checks[i].value;var fileName=checks[i].getAttribute('data-name');
    showToast('ğŸ“¥ '+fileName+' ë‹¤ìš´ë¡œë“œ ì¤‘...');
    var blob=await driveDownloadFile(fileId);
    if(blob){
      var file=new File([blob],fileName,{type:blob.type});
      await mp(file);count++;
    }
  }
  showToast('âœ… Driveì—ì„œ '+count+'ê°œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
}

// ============================================================
// === Drive ì˜ìˆ˜ì¦ í´ë” ì¼ê´„ Gemini ìŠ¤ìº” ===
// ============================================================
async function driveBatchScan(){
  if(!GD.connected){alert('Google Driveì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');return}
  var geminiKey=localStorage.getItem('yjtax_gemini_key');
  if(!geminiKey){alert('Gemini API Keyë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”. (âš™ï¸ ì„¤ì •)');return}
  
  showToast('ğŸ“‚ Drive/ê¸°íƒ€ í´ë”ì—ì„œ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...');
  var files=await driveListFiles('ê¸°íƒ€');
  var imgFiles=files.filter(function(f){return/\.(jpg|jpeg|png|webp|gif|heic)$/i.test(f.name)||/image\//.test(f.mimeType)});
  if(!imgFiles.length){
    // ì¹´ë“œ í´ë”ë„ ê²€ìƒ‰
    var cardFiles=await driveListFiles('ì¹´ë“œ');
    imgFiles=cardFiles.filter(function(f){return/\.(jpg|jpeg|png|webp|gif|heic)$/i.test(f.name)||/image\//.test(f.mimeType)});
  }
  if(!imgFiles.length){alert('Driveì— ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.\nì˜ìˆ˜ì¦ ì‚¬ì§„ì„ Driveì— ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.');return}
  
  if(!confirm('ğŸ“¸ '+imgFiles.length+'ê°œ ì´ë¯¸ì§€ë¥¼ Geminië¡œ ì¼ê´„ ìŠ¤ìº”í•©ë‹ˆë‹¤.\n(Gemini API í˜¸ì¶œ '+imgFiles.length+'íšŒ)\n\nì§„í–‰í• ê¹Œìš”?'))return;
  
  var results=[];var progress=0;
  showToast('ğŸ”„ ì¼ê´„ ìŠ¤ìº” ì‹œì‘ (0/'+imgFiles.length+')');
  
  for(var i=0;i<imgFiles.length;i++){
    progress=i+1;
    showToast('ğŸ”„ ìŠ¤ìº” ì¤‘... ('+progress+'/'+imgFiles.length+') '+imgFiles[i].name);
    try{
      var blob=await driveDownloadFile(imgFiles[i].id);
      if(!blob)continue;
      var base64=await new Promise(function(res){var r=new FileReader();r.onload=function(){res(r.result.split(',')[1])};r.readAsDataURL(blob)});
      var mimeType=blob.type||'image/jpeg';
      
      var resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+geminiKey,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[
          {inlineData:{mimeType:mimeType,data:base64}},
          {text:'ì´ ì˜ìˆ˜ì¦/ì„¸ê¸ˆê³„ì‚°ì„œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì„œ JSONìœ¼ë¡œ ë°˜í™˜í•´ì¤˜.\ní˜•ì‹: {"date":"YYYY-MM-DD","type":"ë§¤ì… ë˜ëŠ” ë§¤ì¶œ","client":"ê±°ë˜ì²˜ëª…","supply":ê³µê¸‰ê°€ì•¡ìˆ«ì,"tax":ë¶€ê°€ì„¸ìˆ«ì,"deductible":"ê³µì œ ë˜ëŠ” ë¶ˆê³µì œ","items":"í’ˆëª©ì„¤ëª…"}\nìˆ«ìëŠ” ìˆœìˆ˜ ìˆ«ìë§Œ. ì¸ì‹ ë¶ˆê°€ ì‹œ {"error":"ì¸ì‹ ë¶ˆê°€"} ë°˜í™˜.'}
        ]}]})
      });
      var data=await resp.json();
      var text=data.candidates&&data.candidates[0]?data.candidates[0].content.parts[0].text:'';
      var jsonStr=text.replace(/```json\n?/g,'').replace(/```/g,'').trim();
      try{
        var parsed=JSON.parse(jsonStr);
        if(!parsed.error){
          parsed._source='Drive/'+imgFiles[i].name;
          results.push(parsed);
        }
      }catch(pe){}
      // API ì†ë„ ì œí•œ ëŒ€ë¹„ 300ms ëŒ€ê¸°
      await new Promise(function(res){setTimeout(res,300)});
    }catch(e){console.error('Batch scan error for '+imgFiles[i].name,e)}
  }
  
  if(!results.length){showToast('âš ï¸ ì¸ì‹ëœ ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.');return}
  
  // ê²°ê³¼ë¥¼ ì¥ë¶€ì— ì¶”ê°€
  results.forEach(function(r){
    D.tax.push({
      date:r.date||new Date().toISOString().slice(0,10),
      type:r.type||'ë§¤ì…',
      client:r.client||'DriveìŠ¤ìº”',
      supply:parseInt(r.supply)||0,
      tax:parseInt(r.tax)||0,
      deductible:r.deductible||'ê³µì œ',
      source:r._source
    });
  });
  
  rTbls();renderDD();rChart();uUI();
  showToast('âœ… Drive ì¼ê´„ ìŠ¤ìº” ì™„ë£Œ! '+results.length+'ê±´ ì¥ë¶€ ë“±ë¡');
}

// ============================================================
// === Gemini ë¶ˆê³µì œ ì‚¬ìœ  ìë™ íŒë‹¨ ===
// ============================================================
async function geminiDeductCheck(silent){
  var geminiKey=localStorage.getItem('yjtax_gemini_key');
  if(!geminiKey){if(!silent)alert('Gemini API Keyë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”. (âš™ï¸ ì„¤ì •)');return}
  
  var purchases=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  if(!purchases.length){if(!silent)alert('ë§¤ì… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return}
  
  showToast('ğŸ¤– Gemini AI ë¶ˆê³µì œ ë¶„ì„ ì¤‘...');
  
  var prompt='ë‹¤ìŒì€ ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤(365-35-00893) ì§€ìœ¤ì§„ ëŒ€í‘œì˜ ë§¤ì… ë‚´ì—­ì…ë‹ˆë‹¤.\n\n[ì‚¬ì—…ì í”„ë¡œíŒŒì¼]\n- ì—…ì¢…: í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ…, ê°€ë§¹ì˜ì—…ëŒ€í–‰, ì–‘ë„ì–‘ìˆ˜ ì¤‘ê°œ\n- ê±°ë˜ì²˜: (ì£¼)ë‚´ì¼ì‚¬ì¥, (ì£¼)ì›ìœŒì•¤ì½”\n- 1ì¸ ì‚¬ì—…ì, ì§ì› ì—†ìŒ, ì‚¬ì—…ì¥=ìíƒ(êµ¬ë¦¬ì‹œ)\n- ì¹´ë“œ: ê°œì¸+ì‚¬ì—… í˜¼ìš© (í™ˆíƒìŠ¤ ì‚¬ì—…ìš©ì¹´ë“œ ë“±ë¡)\n- ì°¨ëŸ‰: ë³¸ì¸ ëª…ì˜ ì•„ë‹˜\n\n[íŒë‹¨ ê¸°ì¤€]\n- ì»¨ì„¤íŒ…/ì˜ì—…ëŒ€í–‰ ê´€ë ¨ = "ê³µì œ"\n- ê±°ë˜ì²˜ ë¯¸íŒ… ì‹ëŒ€/ì¹´í˜ = "ê³µì œ" (ì ‘ëŒ€ë¹„â†’ë§¤ì…ì„¸ì•¡ë¶ˆê³µì œ, í•„ìš”ê²½ë¹„ëŠ” ì¸ì •)\n- êµí†µë¹„(KTX/íƒì‹œ) = "ê³µì œ"\n- í†µì‹ ë¹„/ì¸í„°ë„·/ê´€ë¦¬ë¹„ = "ê³µì œ" (ì‚¬ì—…ë¹„ìœ¨ 50~100%)\n- ì‚¬ë¬´ìš©í’ˆ/SW/êµ¬ë… = "ê³µì œ"\n- ê°œì¸ ì‹ì‚¬/ìƒí™œìš©í’ˆ/ì˜ë¥˜/ë¯¸ìš© = "ë¶ˆê³µì œ"\n- ì ‘ëŒ€ë¹„ = "ë¶ˆê³µì œ" (ë¶€ê°€ì„¸ ë§¤ì…ì„¸ì•¡ ê³µì œ ë¶ˆê°€)\n- ë¹„ì˜ì—…ìš© ìŠ¹ìš©ì°¨ = "ë¶ˆê³µì œ"\n\nJSON ë°°ì—´ë§Œ ë°˜í™˜:\n[{"index":0,"client":"ê±°ë˜ì²˜ëª…","deductible":"ê³µì œ ë˜ëŠ” ë¶ˆê³µì œ","reason":"ì‚¬ìœ "}]\n\në§¤ì… ë‚´ì—­:\n';
  
  purchases.forEach(function(r,i){
    prompt+=i+'. '+r.client+' | '+fm(r.supply)+'ì› | '+fD(r.date)+'\n';
  });
  
  try{
    var data=await callGeminiWithFallback({contents:[{parts:[{text:prompt}]}]});
    if(!data){showToast('âŒ Gemini API í˜¸ì¶œ ì‹¤íŒ¨ (ë©”ì¸+ë°±ì—… í‚¤ ëª¨ë‘ ì‹¤íŒ¨)');return}
    var text=data.candidates&&data.candidates[0]?data.candidates[0].content.parts[0].text:'';
    var jsonStr=text.replace(/```json\n?/g,'').replace(/```/g,'').trim();
    var results=JSON.parse(jsonStr);

    // ê²°ê³¼ ì ìš©
    var changed=0;
    results.forEach(function(r){
      if(r.index>=0&&r.index<purchases.length){
        var old=purchases[r.index].deductible;
        purchases[r.index].deductible=r.deductible;
        purchases[r.index].aiReason=r.reason;
        if(old!==r.deductible)changed++;
      }
    });
    
    // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
    var html='<div style="max-height:350px;overflow-y:auto">';
    results.forEach(function(r){
      if(r.index>=0&&r.index<purchases.length){
        var p=purchases[r.index];
        var isOk=r.deductible==='ê³µì œ';
        html+='<div style="display:flex;align-items:center;gap:10px;padding:10px;background:'+(isOk?'#E8F5E9':'#FFEBEE')+';border-radius:8px;margin-bottom:4px">';
        html+='<div style="width:28px;height:28px;border-radius:50%;background:'+(isOk?'#4CAF50':'#F44336')+';color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">'+(isOk?'âœ…':'âŒ')+'</div>';
        html+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">'+p.client+' <span style="color:#999;font-weight:400">'+fm(p.supply)+'ì›</span></div>';
        html+='<div style="font-size:11px;color:'+(isOk?'#2E7D32':'#C62828')+'">â†’ '+r.deductible+': '+r.reason+'</div></div></div>';
      }
    });
    html+='</div>';
    
    if(!silent){
      openModal('ğŸ¤– AI ë¶ˆê³µì œ íŒë‹¨ ê²°ê³¼ ('+changed+'ê±´ ë³€ê²½)',html+'<div style="display:flex;gap:8px;margin-top:12px"><button onclick="document.getElementById(\'mo\').classList.remove(\'show\');resetModal();rTbls();renderDD();rChart()" style="flex:1;padding:12px;background:var(--gn);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer"><i class="fas fa-check"></i> ì ìš© ì™„ë£Œ</button><button onclick="document.getElementById(\'mo\').classList.remove(\'show\');resetModal()" style="flex:1;padding:12px;background:#eee;color:#333;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer">ë‹«ê¸°</button></div>');
    }else{rTbls();renderDD();rChart()}
    
    showToast('ğŸ¤– AI ë¶„ì„ ì™„ë£Œ! '+changed+'ê±´ ê³µì œ/ë¶ˆê³µì œ ë³€ê²½');
  }catch(e){
    console.error('Gemini deduct check error',e);
    showToast('âŒ AI ë¶„ì„ ì‹¤íŒ¨: '+e.message);
  }
}

// === ê²€ìƒ‰ ===
function clearFilters(){
  document.getElementById('search-input').value='';
  document.getElementById('filter-cat').value='';
  document.getElementById('filter-deduct').value='';
  document.getElementById('filter-from').value='';
  document.getElementById('filter-to').value='';
  document.getElementById('filter-min').value='';
  document.getElementById('filter-max').value='';
  document.getElementById('filter-summary').style.display='none';
  rTbls();
}
function getFilters(){
  var q=(document.getElementById('search-input').value||'').toLowerCase().trim();
  var cat=document.getElementById('filter-cat').value;
  var ded=document.getElementById('filter-deduct').value;
  var from=document.getElementById('filter-from').value;
  var to=document.getElementById('filter-to').value;
  var min=parseInt(document.getElementById('filter-min').value)||0;
  var max=parseInt(document.getElementById('filter-max').value)||Infinity;
  return{q:q,cat:cat,ded:ded,from:from,to:to,min:min,max:max};
}
function matchRow(r,f,amt){
  if(f.q){var haystack=((r.client||'')+(r.desc||'')+(r.merchant||'')+(r.date||'')+(r.type||'')+(r.bizNo||'')+amt).toLowerCase();if(haystack.indexOf(f.q)===-1)return false}
  if(f.cat&&r.type&&r.type!==f.cat)return false;
  if(f.ded&&r.deductible&&r.deductible!==f.ded)return false;
  var rd=(r.date||'').replace(/[./]/g,'-');
  if(f.from&&rd&&rd<f.from)return false;
  if(f.to&&rd&&rd>f.to)return false;
  if(amt<f.min||amt>f.max)return false;
  return true;
}
function searchLedger(q){
  var f=getFilters();
  var hasFilter=f.q||f.cat||f.ded||f.from||f.to||f.min>0||f.max<Infinity;
  if(!hasFilter){rTbls();document.getElementById('filter-summary').style.display='none';return}
  
  // í†µì¥ í•„í„°
  var fBank=D.bank.filter(function(r){return matchRow(r,f,Math.max(r.inAmt||0,r.outAmt||0))});
  document.querySelector('#tb-bk tbody').innerHTML=fBank.map(function(r){return'<tr><td style="white-space:nowrap">'+fD(r.date)+'</td><td style="font-size:12px;color:#555">'+(r.item||'<span style="color:#ccc">-</span>')+'</td><td style="font-size:12px;font-weight:600">'+(r.desc||'<span style="color:#ccc">-</span>')+'</td><td class="am pos">'+(r.inAmt?fm(r.inAmt):'')+'</td><td class="am neg">'+(r.outAmt?fm(r.outAmt):'')+'</td><td class="am">'+(r.balance?fm(r.balance):'')+'</td></tr>'}).join('');
  document.getElementById('em-bk').style.display=fBank.length?'none':'block';
  
  // ì„¸ê¸ˆê³„ì‚°ì„œ í•„í„°
  var fTax=D.tax.filter(function(r){return matchRow(r,f,r.supply||0)});
  document.querySelector('#tb-tx tbody').innerHTML=fTax.map(function(r,i){return'<tr><td>'+fD(r.date)+'</td><td><span class="badge '+(r.type==='ë§¤ì¶œ'?'b-bl':'b-rd')+'">'+r.type+'</span></td><td style="font-size:12px;font-weight:600;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.client+'</td><td style="font-size:11px;color:#555;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(r.item||'-')+'</td><td style="font-family:monospace;font-size:10px;color:#999">'+(r.bizNo||'-')+'</td><td class="am">'+fm(r.supply)+'</td><td class="am">'+fm(r.tax)+'</td><td><span class="badge '+(r.deductible==='ê³µì œ'?'b-gn':r.deductible==='ë¶ˆê³µì œ'?'b-rd':'b-gy')+'">'+r.deductible+'</span></td></tr>'}).join('');
  document.getElementById('em-tx').style.display=fTax.length?'none':'block';
  
  // ì¹´ë“œ í•„í„°
  var fCard=D.card.filter(function(r){return matchRow(r,f,r.amount||0)});
  document.querySelector('#tb-cd tbody').innerHTML=fCard.map(function(r){return'<tr><td>'+fD(r.date)+'</td><td>'+r.merchant+'</td><td class="am neg">'+fm(r.amount)+'</td><td><span class="badge b-rd">'+r.type+'</span></td></tr>'}).join('');
  document.getElementById('em-cd').style.display=fCard.length?'none':'block';
  
  // ì „ì²´ í•„í„°
  var all=[];
  fBank.forEach(function(r){all.push({c:'í†µì¥',cc:'b-bl',tp:r.inAmt?'ì…ê¸ˆ':'ì¶œê¸ˆ',d:r.date,n:r.desc,i:r.inAmt,o:r.outAmt})});
  fTax.forEach(function(r){all.push({c:'ì„¸ê¸ˆê³„ì‚°ì„œ',cc:'b-or',tp:r.type,d:r.date,n:r.client+' ('+(r.bizNo||'-')+')',i:r.type==='ë§¤ì¶œ'?(r.supply+r.tax):0,o:r.type==='ë§¤ì…'?(r.supply+r.tax):0})});
  fCard.forEach(function(r){var isIn=r.type==='ë§¤ì¶œ';all.push({c:'ì¹´ë“œ',cc:'b-pr',tp:isIn?'ë§¤ì¶œ':'ë§¤ì…',d:r.date,n:r.merchant||r.desc||'',i:isIn?r.amount:0,o:isIn?0:r.amount})});
  all.sort(function(a,b){return new Date(b.d)-new Date(a.d)});
  document.querySelector('#tb-al tbody').innerHTML=all.map(function(r){
    var tpClass=r.tp==='ë§¤ì¶œ'||r.tp==='ì…ê¸ˆ'?'b-bl':'b-rd';
    return'<tr style="border-bottom:1px solid #f0f0f0"><td><span class="badge '+r.cc+'">'+r.c+'</span></td><td><span class="badge '+tpClass+'" style="font-size:10px">'+r.tp+'</span></td><td style="font-size:12px;white-space:nowrap">'+fD(r.d)+'</td><td style="font-size:12px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.n+'</td><td class="am pos" style="font-size:13px;font-weight:700">'+(r.i?fm(r.i):'')+'</td><td class="am neg" style="font-size:13px;font-weight:700">'+(r.o?fm(r.o):'')+'</td></tr>'
  }).join('');
  document.getElementById('em-al').style.display=all.length?'none':'block';
  
  // í•„í„° ê²°ê³¼ ìš”ì•½
  var totalIn=fTax.filter(function(r){return r.type==='ë§¤ì¶œ'}).reduce(function(a,r){return a+r.supply},0)+fBank.reduce(function(a,r){return a+r.inAmt},0);
  var totalOut=fTax.filter(function(r){return r.type==='ë§¤ì…'}).reduce(function(a,r){return a+r.supply},0)+fBank.reduce(function(a,r){return a+r.outAmt},0)+fCard.reduce(function(a,r){return a+r.amount},0);
  var sm=document.getElementById('filter-summary');
  sm.style.display='block';
  sm.innerHTML='ğŸ” ê²€ìƒ‰ ê²°ê³¼: í†µì¥ '+fBank.length+'ê±´ Â· ì„¸ê¸ˆê³„ì‚°ì„œ '+fTax.length+'ê±´ Â· ì¹´ë“œ '+fCard.length+'ê±´ | ì…ê¸ˆ <b style="color:#2E7D32">'+fm(totalIn)+'</b> Â· ì¶œê¸ˆ <b style="color:#C62828">'+fm(totalOut)+'</b>';
}

// === ë°±ì—…/ë³µì› ===
function exportBackup(){
  var backup=getAllBackupData();
  // ë ˆê±°ì‹œ í˜¸í™˜
  backup.D=D;backup.evtData=evtData;
  var blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='YJ_Tax_Backup_'+new Date().toISOString().slice(0,10)+'.json';a.click();
  showToast('ğŸ’¾ ì „ì²´ ë°±ì—… ì™„ë£Œ ('+Object.keys(backup.keys).length+'ê°œ í•­ëª©)');
}
function importBackup(input){
  if(!input.files||!input.files[0])return;
  var reader=new FileReader();reader.onload=function(e){
    try{var backup=JSON.parse(e.target.result);
    // ìƒˆ í˜•ì‹ (keys í¬í•¨)
    if(backup.keys){
      Object.keys(backup.keys).forEach(function(k){
        try{localStorage.setItem(k,backup.keys[k])}catch(e){}
      });
      // D, evtData ë©”ëª¨ë¦¬ì—ë„ ë°˜ì˜
      try{D=JSON.parse(backup.keys['yjtax_D']||'{}')}catch(e){}
      try{evtData=JSON.parse(backup.keys['yjtax_evt']||'[]')}catch(e){}
      ensureD();rAll();loadIncomeData();
      try{renderEvtList();renderNdSim()}catch(e){}
      showToast('âœ… ì „ì²´ ë³µì› ì™„ë£Œ! ('+backup.date+')');
      alert('âœ… ì „ì²´ ë°ì´í„° ë³µì› ì™„ë£Œ!\n\në³µì› ì‹œì : '+backup.date+'\në³µì› í•­ëª©: '+Object.keys(backup.keys).length+'ê°œ');
    }
    // ë ˆê±°ì‹œ í˜•ì‹
    else if(backup.D){D=backup.D;ensureD();if(backup.evtData)evtData=backup.evtData;saveData();rAll();alert('âœ… ë°±ì—… ë³µì› ì™„ë£Œ! ('+backup.date+')')}
    else alert('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.')}catch(err){alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: '+err.message)}};
  reader.readAsText(input.files[0]);input.value='';
}

// === ê¸ˆì•¡ ìë™ ì½¤ë§ˆ í¬ë§· ===
document.addEventListener('input',function(e){
  if(e.target.tagName==='INPUT'&&e.target.type==='text'&&e.target.placeholder&&e.target.placeholder.indexOf('ê¸ˆì•¡')>-1){
    var v=e.target.value.replace(/[^\d]/g,'');if(v)e.target.value=parseInt(v).toLocaleString('ko-KR');
  }
});

// === ì„¸ê¸ˆì¤„ì´ê¸° ì‹œë®¬ë ˆì´í„° ===
var umbrellaMonthly=50000;
var ndToggles={};

function getBaseNumbers(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0);
  var dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var ndTx=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var income=ts-te;var vat=sTx-dTx;
  var taxBase=Math.max(income-1500000,0);var incTax=Math.round(calcIncomeTax(taxBase));
  return{ts:ts,te:te,sTx:sTx,dTx:dTx,ndTx:ndTx,income:income,vat:vat,incTax:incTax,taxBase:taxBase};
}

function initTaxCut(){
  // ì¹´ë“œë§¤ì… ë°ì´í„°ë¥¼ ì¶”ê°€ë§¤ì… í•­ëª© selectì— ì£¼ì…
  try{
    var selects=document.querySelectorAll('.purchase-item-select');
    var cardOpts='<option value="">-- í•­ëª© ì„ íƒ --</option><optgroup label="ğŸ“¦ ì‚¬ì—…ê²½ë¹„ í•­ëª©"><option value="laptop">ë…¸íŠ¸ë¶/ì»´í“¨í„°</option><option value="furniture">ì‚¬ë¬´ìš©ê°€êµ¬</option><option value="software">ì†Œí”„íŠ¸ì›¨ì–´/êµ¬ë…</option><option value="supplies">ì‚¬ë¬´ìš©í’ˆ</option><option value="ads">ê´‘ê³ ë¹„</option><option value="transport">êµí†µë¹„</option><option value="meal">ì‹ëŒ€/íšŒì˜ë¹„</option><option value="etc">ê¸°íƒ€</option></optgroup>';
    // ì¹´ë“œë§¤ì… ë‚´ì—­ ì˜µì…˜ ì¶”ê°€
    if(D.card&&D.card.length>0){
      cardOpts+='<optgroup label="ğŸ’³ ì¹´ë“œ ë§¤ì… ë‚´ì—­">';
      D.card.forEach(function(c,i){if(c.type==='ë§¤ì…'||c.amount>0)cardOpts+='<option value="card_'+i+'" data-amt="'+c.amount+'">'+((c.merchant||c.desc||'')+' '+fm(c.amount)+'ì›').trim()+'</option>'});
      cardOpts+='</optgroup>';
    }
    // í†µì¥ ì¶œê¸ˆ ë‚´ì—­ ì˜µì…˜ ì¶”ê°€
    if(D.bank&&D.bank.length>0){
      cardOpts+='<optgroup label="ğŸ¦ í†µì¥ ì¶œê¸ˆ ë‚´ì—­">';
      D.bank.forEach(function(b,i){if(b.outAmt>0)cardOpts+='<option value="bank_'+i+'" data-amt="'+b.outAmt+'">'+((b.desc||'')+' '+fm(b.outAmt)+'ì›').trim()+'</option>'});
      cardOpts+='</optgroup>';
    }
    selects.forEach(function(s){var curVal=s.value;s.innerHTML=cardOpts;if(curVal)s.value=curVal});
  }catch(e){}
  populatePurchaseSelects();
  var b=getBaseNumbers();
  document.getElementById('tx-now').textContent=fm(b.vat+b.incTax)+'ì›';
  document.getElementById('sim1-now').textContent=fm(b.vat)+'ì›';
  renderNdSim();calcSim();calcAnnual();renderNdRecommend();renderEvtList();renderLimits();updateTotalOpt();initIncSim();calcIncSim();
}

function addExpenseRow(){
  var c=document.getElementById('expense-items');
  var row=document.createElement('div');row.className='expense-row';row.style.cssText='display:flex;gap:6px;margin-bottom:6px;align-items:center';
  row.innerHTML='<select class="expense-select" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px" onchange="calcSim()"><option value="">-- ê²½ë¹„ í•­ëª© ì„ íƒ --</option><option value="ë…¸íŠ¸ë¶/PC">ğŸ’» ë…¸íŠ¸ë¶Â·PC</option><option value="ëª¨ë‹ˆí„°/ì¥ë¹„">ğŸ–¥ï¸ ëª¨ë‹ˆí„°Â·ì¥ë¹„</option><option value="ì†Œí”„íŠ¸ì›¨ì–´">ğŸ“€ ì†Œí”„íŠ¸ì›¨ì–´</option><option value="ê´‘ê³ ë¹„">ğŸ“¢ ê´‘ê³ ë¹„</option><option value="ì‚¬ë¬´ìš©í’ˆ">ğŸ“¦ ì‚¬ë¬´ìš©í’ˆ</option><option value="ì°¨ëŸ‰ìœ ì§€ë¹„">ğŸš— ì°¨ëŸ‰ìœ ì§€ë¹„</option><option value="í†µì‹ ë¹„">ğŸ“± í†µì‹ ë¹„</option><option value="êµìœ¡ë¹„">ğŸ“š êµìœ¡ë¹„</option><option value="ì ‘ëŒ€ë¹„">ğŸ½ï¸ ì ‘ëŒ€ë¹„</option><option value="ê¸°íƒ€ê²½ë¹„">ğŸ“ ê¸°íƒ€</option></select><input type="text" placeholder="ê¸ˆì•¡(ì›)" style="width:110px;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcSim()"><button onclick="this.parentElement.remove();calcSim()" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:14px;padding:4px"><i class="fas fa-xmark"></i></button>';
  c.appendChild(row);
}
function addItem(){addExpenseRow()}

function renderCardItems(){
  var el=document.getElementById('card-items');
  var empty=document.getElementById('card-items-empty');
  var items=[];
  // ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì…
  D.tax.filter(function(r){return r.type==='ë§¤ì…'}).forEach(function(r,i){
    items.push({id:'tax_'+i,label:'ğŸ§¾ '+r.client,amount:r.supply+r.tax,date:r.date});
  });
  // ì¹´ë“œ ê²°ì œ
  if(D.card)D.card.filter(function(c){return c.type==='ë§¤ì…'||c.amount>0}).forEach(function(c,i){
    items.push({id:'card_'+i,label:'ğŸ’³ '+(c.merchant||c.desc||'ì¹´ë“œ'),amount:c.amount,date:c.date||''});
  });
  // í†µì¥ ì¶œê¸ˆ
  D.bank.filter(function(r){return r.outAmt>0}).forEach(function(r,i){
    items.push({id:'bank_'+i,label:'ğŸ¦ '+(r.desc||'í†µì¥ì¶œê¸ˆ'),amount:r.outAmt,date:r.date||''});
  });
  // ì§€ì¶œì¦ë¹™
  D.proof.forEach(function(r,i){
    items.push({id:'proof_'+i,label:'ğŸ“‹ '+(r.desc||'ì§€ì¶œì¦ë¹™'),amount:r.total||0,date:r.date||''});
  });
  if(!items.length){el.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  var expenseOpts='<option value="">-- ê²½ë¹„ ë¶„ë¥˜ ì„ íƒ --</option><option value="ë…¸íŠ¸ë¶/PC">ğŸ’» ë…¸íŠ¸ë¶Â·PC</option><option value="ëª¨ë‹ˆí„°/ì¥ë¹„">ğŸ–¥ï¸ ëª¨ë‹ˆí„°Â·ì¥ë¹„</option><option value="ì†Œí”„íŠ¸ì›¨ì–´">ğŸ“€ ì†Œí”„íŠ¸ì›¨ì–´</option><option value="ê´‘ê³ ë¹„">ğŸ“¢ ê´‘ê³ ë¹„</option><option value="ì‚¬ë¬´ìš©í’ˆ">ğŸ“¦ ì‚¬ë¬´ìš©í’ˆ</option><option value="ì°¨ëŸ‰ìœ ì§€ë¹„">ğŸš— ì°¨ëŸ‰ìœ ì§€ë¹„</option><option value="í†µì‹ ë¹„">ğŸ“± í†µì‹ ë¹„</option><option value="êµìœ¡ë¹„">ğŸ“š êµìœ¡ë¹„</option><option value="ì ‘ëŒ€ë¹„">ğŸ½ï¸ ì ‘ëŒ€ë¹„</option><option value="ê¸°íƒ€ê²½ë¹„">ğŸ“ ê¸°íƒ€</option>';
  el.innerHTML=items.map(function(it,idx){
    return'<div class="card-item-wrap" id="cw-'+idx+'" data-amount="'+it.amount+'" data-client="'+it.label.replace(/[ğŸ§¾ğŸ’³ ]/g,'')+'" style="border:2px solid #e0e0e0;border-radius:var(--rs);margin-bottom:4px;transition:all .15s;overflow:hidden">'
    +'<label style="display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;background:#fff" onclick="event.preventDefault();toggleCardItem('+idx+','+it.amount+')">'
    +'<div class="card-chk-icon" id="ci-'+idx+'" style="width:24px;height:24px;border-radius:6px;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;transition:all .15s"></div>'
    +'<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+it.label+'</div>'
    +'<div style="font-size:10px;color:var(--sub)">'+it.date+'</div></div>'
    +'<div style="font-size:14px;font-weight:800;color:var(--or);white-space:nowrap">'+fm(it.amount)+'ì›</div></label>'
    +'<div class="card-classify" id="cc-'+idx+'" style="display:none;padding:8px 12px;background:#F1F8E9;border-top:1px solid #C8E6C9">'
    +'<div style="display:flex;align-items:center;gap:6px">'
    +'<span style="font-size:11px;font-weight:600;color:#2E7D32;white-space:nowrap">â†’ ê²½ë¹„ ë¶„ë¥˜:</span>'
    +'<select class="card-classify-select" data-idx="'+idx+'" onchange="calcSim()" style="flex:1;padding:8px;border:2px solid #A5D6A7;border-radius:var(--rs);font-family:inherit;font-size:12px;background:#fff">'+expenseOpts+'</select>'
    +'</div></div></div>';
  }).join('');
}

function toggleCardItem(idx,amount){
  var wrap=document.getElementById('cw-'+idx);
  var icon=document.getElementById('ci-'+idx);
  var classify=document.getElementById('cc-'+idx);
  var isOn=wrap.getAttribute('data-on')==='1';
  
  if(isOn){
    // í•´ì œ
    wrap.setAttribute('data-on','0');
    wrap.style.borderColor='#e0e0e0';
    icon.innerHTML='';icon.style.background='#fff';icon.style.borderColor='#ccc';
    classify.style.display='none';
    classify.querySelector('select').value='';
    // AI íƒœê·¸ ì œê±°
    var aiTags=classify.querySelectorAll('div[style*="margin-top"]');
    aiTags.forEach(function(t){if(t.id!=='cc-'+idx)t.remove()});
  }else{
    // ì²´í¬ â†’ ê²½ë¹„ë¶„ë¥˜ ë“œë¡­ë‹¤ìš´ ì—´ê¸°
    wrap.setAttribute('data-on','1');
    wrap.style.borderColor='var(--gn)';
    icon.innerHTML='<i class="fas fa-check" style="color:#fff;font-size:12px"></i>';
    icon.style.background='var(--gn)';icon.style.borderColor='var(--gn)';
    classify.style.display='block';
    // ë“œë¡­ë‹¤ìš´ í¬ì»¤ìŠ¤
    setTimeout(function(){classify.querySelector('select').focus()},100);
    // AI ìë™ ê²½ë¹„ë¶„ë¥˜ (Claude ìš°ì„ , Gemini í´ë°±)
    var clientName=wrap.getAttribute('data-client')||'';
    if(clientName){claudeClassifyItem(clientName,amount,idx)}
  }
  calcSim();
}

function onCardCheck(){}
function onPurchaseSelect(){}
function populatePurchaseSelects(){renderCardItems()}

function calcSim(){
  // ëª©ë¡A: ì‚¬ì—…ê²½ë¹„ í•­ëª© í•©ì‚°
  var expenseTotal=0;
  document.querySelectorAll('.expense-row').forEach(function(r){
    var inp=r.querySelector('input');
    if(inp){var v=parseInt(String(inp.value).replace(/[,\s]/g,''),10);if(v>0)expenseTotal+=v}
  });
  // ëª©ë¡B: ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… ì²´í¬í•œ ê²ƒ í•©ì‚°
  var cardTotal=0;
  document.querySelectorAll('.card-item-wrap[data-on="1"]').forEach(function(wrap){
    cardTotal+=parseInt(wrap.getAttribute('data-amount'))||0;
  });
  var addTotal=expenseTotal+cardTotal;
  var addTax=Math.round(addTotal*0.1);
  var b=getBaseNumbers();var newVat=b.vat-addTax;if(newVat<0)newVat=0;
  document.getElementById('sim1-now').textContent=fm(b.vat)+'ì›';
  document.getElementById('sim1-after').textContent=fm(newVat)+'ì›';
  document.getElementById('sim1-save').textContent='-'+fm(b.vat-newVat)+'ì›';
  updateTotalOpt();
}

function setUmbrella(){}
function setUmbrellaRange(){}
function calcUmbrella(){updateTotalOpt()}
function calcPension(){updateTotalOpt()}

function renderNdSim(){
  var et=D.tax.filter(function(r){return r.type==='ë§¤ì…'&&r.deductible==='ë¶ˆê³µì œ'});
  if(!et.length){document.getElementById('nd-sim-list').innerHTML='<div style="text-align:center;padding:20px;color:var(--gn);font-size:13px"><i class="fas fa-check-circle" style="margin-right:4px"></i>ë¶ˆê³µì œ í•­ëª© ì—†ìŒ! ì˜ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>';document.getElementById('sim4-now').textContent='0ì›';document.getElementById('sim4-save').textContent='0ì›';return}
  ndToggles={};et.forEach(function(r,i){ndToggles[i]=false});
  var html=et.map(function(r,i){
    return'<div class="nd-item"><button class="nd-toggle off" id="ndt-'+i+'" onclick="toggleNd('+i+')"></button><div style="flex:1"><div style="font-size:13px;font-weight:600">'+r.client+'</div><div style="font-size:11px;color:var(--sub)">'+fD(r.date)+' | ê³µê¸‰ê°€ì•¡ '+fm(r.supply)+'ì›</div></div><div style="font-size:14px;font-weight:800;color:var(--rd)">'+fm(r.tax)+'ì›</div></div>';
  }).join('');
  document.getElementById('nd-sim-list').innerHTML=html;
  document.getElementById('sim4-now').textContent=fm(et.reduce(function(a,r){return a+r.tax},0))+'ì›';
  document.getElementById('sim4-save').textContent='0ì›';
}

function toggleNd(i){
  ndToggles[i]=!ndToggles[i];var btn=document.getElementById('ndt-'+i);
  btn.className='nd-toggle '+(ndToggles[i]?'on':'off');
  var et=D.tax.filter(function(r){return r.type==='ë§¤ì…'&&r.deductible==='ë¶ˆê³µì œ'});
  var saved=0;Object.keys(ndToggles).forEach(function(k){if(ndToggles[k]&&et[k])saved+=et[k].tax});
  document.getElementById('sim4-save').textContent=fm(saved)+'ì›';
  updateTotalOpt();
}

function calcAnnual(){
  var annualSales=parseInt(document.getElementById('annual-range').value)*10000;
  document.getElementById('annual-val').textContent=fm(annualSales)+'ì›';
  var expRate=0.3;var annualExp=Math.round(annualSales*expRate);
  var annualVat=Math.round(annualSales*0.1-annualExp*0.1);
  var annualIncome=annualSales-annualExp;
  var annualTaxBase=Math.max(annualIncome-1500000,0);
  var annualIncTax=Math.round(calcIncomeTax(annualTaxBase));
  var total=annualVat+annualIncTax;var rate=annualSales>0?Math.round(total/annualSales*100*10)/10:0;
  document.getElementById('ann-vat').textContent=fm(annualVat);
  document.getElementById('ann-inc').textContent=fm(annualIncTax);
  document.getElementById('ann-total').textContent=fm(total);
  document.getElementById('ann-rate').textContent=rate+'%';
}

// â•â•â• ì¢…ì†Œì„¸ ì‹œë®¬ë ˆì´í„° â•â•â•
function addIncExpenseRow(){
  var c=document.getElementById('inc-expense-items');
  var row=document.createElement('div');row.className='inc-expense-row';row.style.cssText='display:flex;gap:6px;margin-bottom:6px;align-items:center';
  row.innerHTML='<select class="inc-expense-select" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px" onchange="calcIncSim()"><option value="">-- ê²½ë¹„ í•­ëª© ì„ íƒ --</option><optgroup label="ğŸ  ìíƒ ì‚¬ì—…ì¥"><option value="ê´€ë¦¬ë¹„(50%)">ğŸ¢ ê´€ë¦¬ë¹„ (50%)</option><option value="ì „ê¸°ì„¸(50%)">ğŸ’¡ ì „ê¸°ì„¸ (50%)</option><option value="ì¸í„°ë„·(100%)">ğŸŒ ì¸í„°ë„· (100%)</option></optgroup><optgroup label="ğŸ“± í†µì‹ /SW"><option value="í•¸ë“œí°(70%)">ğŸ“± í•¸ë“œí° (70%)</option><option value="ì†Œí”„íŠ¸ì›¨ì–´">ğŸ’» ì†Œí”„íŠ¸ì›¨ì–´</option><option value="í´ë¼ìš°ë“œ">â˜ï¸ í´ë¼ìš°ë“œ</option></optgroup><optgroup label="ğŸš— êµí†µ"><option value="êµí†µë¹„">ğŸš„ KTXÂ·íƒì‹œ</option><option value="ì£¼ìœ ë¹„">â›½ ì£¼ìœ ë¹„</option><option value="ì¶œì¥ë¹„">âœˆï¸ ì¶œì¥Â·ìˆ™ë°•</option></optgroup><optgroup label="ğŸ“š ê¸°íƒ€"><option value="ì‚¬ë¬´ìš©í’ˆ">ğŸ“¦ ì‚¬ë¬´ìš©í’ˆ</option><option value="ê´‘ê³ ë¹„">ğŸ“¢ ê´‘ê³ ë¹„</option><option value="êµìœ¡ë¹„">ğŸ“š êµìœ¡Â·ë„ì„œ</option><option value="ë…¸íŠ¸ë¶/ì¥ë¹„">ğŸ’» ë…¸íŠ¸ë¶Â·ì¥ë¹„</option><option value="ê¸°íƒ€">ğŸ“ ê¸°íƒ€</option></optgroup></select><input type="text" placeholder="ê¸ˆì•¡(ì›)" style="width:110px;padding:10px;border:2px solid #e0e0e0;border-radius:var(--rs);font-family:inherit;font-size:12px;text-align:right" oninput="calcIncSim()"><button onclick="this.parentElement.remove();calcIncSim()" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:14px;padding:4px"><i class="fas fa-xmark"></i></button>';
  c.appendChild(row);
}

function initIncSim(){
  // ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… ëª©ë¡ì„ ì¢…ì†Œì„¸ ì‹œë®¬ì—ë„ í‘œì‹œ
  var box=document.getElementById('inc-card-items');
  var empty=document.getElementById('inc-card-items-empty');
  var items=[];
  D.tax.filter(function(r){return r.type==='ë§¤ì…'}).forEach(function(r,i){
    items.push({label:r.client+' '+fD(r.date),amt:r.supply,key:'tax_'+i});
  });
  D.card.filter(function(c){return c.type==='ë§¤ì…'||c.type!=='ë§¤ì¶œ'}).forEach(function(c,i){
    items.push({label:(c.merchant||c.desc||'')+' '+fD(c.date),amt:c.amount,key:'card_'+i});
  });
  if(items.length){
    empty.style.display='none';
    box.innerHTML=items.map(function(it){
      return '<label style="display:flex;align-items:center;padding:10px 14px;background:#fff;border:2px solid #e0e0e0;border-radius:var(--rs);margin-bottom:6px;cursor:pointer;transition:all .15s" onmouseover="this.style.borderColor=\'var(--bl)\'" onmouseout="this.style.borderColor=\'#e0e0e0\'"><input type="checkbox" class="inc-card-check" data-amt="'+it.amt+'" style="accent-color:var(--bl);margin-right:10px;width:18px;height:18px" onchange="calcIncSim()"><div style="flex:1"><div style="font-size:12px;font-weight:600">'+it.label+'</div></div><div style="font-size:14px;font-weight:700;color:var(--bl)">'+fm(it.amt)+'ì›</div></label>';
    }).join('');
  }
}

function calcIncSim(){
  var b=getBaseNumbers();
  // í˜„ì¬ ì¢…ì†Œì„¸
  var curBase=Math.max(b.income-1500000,0);
  var curTax=Math.round(calcIncomeTax(curBase));
  var curSme=Math.min(Math.round(curTax*0.20),100000000);
  var curFinal=Math.max(curTax-curSme-70000-20000,0);

  // ì¶”ê°€ ê²½ë¹„ í•©ì‚°
  var addExp=0;
  document.querySelectorAll('.inc-expense-row').forEach(function(row){
    var sel=row.querySelector('.inc-expense-select');
    var inp=row.querySelector('input[type="text"]');
    if(sel&&sel.value&&inp){
      var val=parseInt((inp.value||'0').replace(/,/g,''))||0;
      // ë¹„ìœ¨ ì ìš©
      if(sel.value.indexOf('50%')>-1)val=Math.round(val*0.5);
      else if(sel.value.indexOf('70%')>-1)val=Math.round(val*0.7);
      addExp+=val;
    }
  });
  // ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ ì²´í¬ í•­ëª©
  document.querySelectorAll('.inc-card-check:checked').forEach(function(cb){
    addExp+=parseInt(cb.dataset.amt)||0;
  });
  // ì†Œë“ê³µì œ ì¶”ê°€
  var umbrella=(parseInt(document.getElementById('inc-umbrella').value)||0)*10000*12;
  // ë…¸ë€ìš°ì‚°ê³µì œ í•œë„: ì†Œë“ 4ì²œë§Œ ì´í•˜ 500ë§Œ, 4ì²œ~1ì–µ 300ë§Œ, 1ì–µ ì´ˆê³¼ 200ë§Œ
  if(b.income<=40000000)umbrella=Math.min(umbrella,5000000);
  else if(b.income<=100000000)umbrella=Math.min(umbrella,3000000);
  else umbrella=Math.min(umbrella,2000000);
  var deps=(parseInt(document.getElementById('inc-dependents').value)||0)*1500000;

  // ì ˆì„¸ í›„ ì¢…ì†Œì„¸
  var newIncome=Math.max(b.income-addExp,0);
  var newDeduct=1500000+deps+umbrella;
  var newBase=Math.max(newIncome-newDeduct,0);
  var newTax=Math.round(calcIncomeTax(newBase));
  var newSme=Math.min(Math.round(newTax*0.20),100000000);
  var newFinal=Math.max(newTax-newSme-70000-20000,0);

  var saved=curFinal-newFinal;

  document.getElementById('inc-sim-now').textContent=fm(curFinal)+'ì›';
  document.getElementById('inc-sim-after').textContent=fm(newFinal)+'ì›';
  document.getElementById('inc-sim-save').textContent='-'+fm(Math.max(saved,0))+'ì›';
  document.getElementById('inc-sim-base1').textContent=fm(curBase)+'ì›';
  document.getElementById('inc-sim-base2').textContent=fm(newBase)+'ì›';
  // ì„¸ìœ¨ ë³€í™”
  function getRate(base){return base<=14000000?'6%':base<=50000000?'15%':base<=88000000?'24%':base<=150000000?'35%':'38%+'}
  document.getElementById('inc-sim-rate').textContent=getRate(curBase)+' â†’ '+getRate(newBase);
  document.getElementById('inc-sim-sme').textContent='-'+fm(newSme)+'ì›';

  updateTotalOpt();
}

function updateTotalOpt(){
  var b=getBaseNumbers();var totalNow=b.vat+b.incTax;
  // ë§¤ì… ì¶”ê°€ ì ˆì„¸
  var rows=document.querySelectorAll('.add-row');var addTotal=0;
  rows.forEach(function(r){var inp=r.querySelector('input');if(inp){var v=parseInt(String(inp.value).replace(/[,\s]/g,''),10);if(v>0)addTotal+=v}});
  var vatSave=Math.min(Math.round(addTotal*0.1),b.vat);
  // ë¶ˆê³µì œ ì „í™˜
  var et=D.tax.filter(function(r){return r.type==='ë§¤ì…'&&r.deductible==='ë¶ˆê³µì œ'});
  var ndSave=0;Object.keys(ndToggles).forEach(function(k){if(ndToggles[k]&&et[k])ndSave+=et[k].tax});

  var totalSave=vatSave+ndSave;
  var optTotal=Math.max(totalNow-totalSave,0);
  document.getElementById('tx-now').textContent=fm(totalNow)+'ì›';
  document.getElementById('tx-opt').textContent=fm(optTotal)+'ì›';
  document.getElementById('tx-saved').textContent='ì ˆì„¸ì•¡: '+fm(totalSave)+'ì›';
  renderLimits();
}

// === ë¶ˆê³µì œ ìë™ ì¶”ì²œ ===
function renderNdRecommend(){
  var et=D.tax.filter(function(r){return r.type==='ë§¤ì…'&&r.deductible==='ë¶ˆê³µì œ'});
  if(!et.length){document.getElementById('nd-recommend').innerHTML='<div style="text-align:center;padding:16px;color:var(--gn);font-size:13px"><i class="fas fa-check-circle"></i> ë¶ˆê³µì œ í•­ëª© ì—†ìŒ!</div>';return}
  var recs=et.map(function(r){
    var methods=[];var client=r.client.toLowerCase();
    if(/ì¿ íŒ¡|ë„¤ì´ë²„|ë°°ë‹¬|ìš”ê¸°|ë§ˆì¼“/.test(client))methods.push({m:'ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œë¡œ ê²°ì œ',detail:'í™ˆíƒìŠ¤ì— ë“±ë¡ëœ ì‚¬ì—…ìš© ì¹´ë“œë¡œ ë™ì¼ í’ˆëª© ì¬êµ¬ë§¤ ì‹œ ë§¤ì…ì„¸ì•¡ê³µì œ ê°€ëŠ¥',action:'ì‚¬ì—…ìš©ì¹´ë“œ ê²°ì œ'});
    if(/íŠ¸ë ˆì´ë”©|ë¬´ì—­|ìˆ˜ì…/.test(client))methods.push({m:'ìˆ˜ì…ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨',detail:'ìˆ˜ì… ë¬¼í’ˆì˜ ê²½ìš° ì„¸ê´€ì—ì„œ ë°œí–‰í•œ ìˆ˜ì…ì„¸ê¸ˆê³„ì‚°ì„œë¡œ ë§¤ì…ì„¸ì•¡ ê³µì œ',action:'ìˆ˜ì…ì„¸ê¸ˆê³„ì‚°ì„œ'});
    methods.push({m:'ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ì¬ë°œí–‰ ìš”ì²­',detail:'ê±°ë˜ì²˜ì— ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì„ ìš”ì²­í•˜ë©´ ì ê²©ì¦ë¹™ìœ¼ë¡œ ê³µì œ ê°€ëŠ¥',action:'ì„¸ê¸ˆê³„ì‚°ì„œ ìš”ì²­'});
    methods.push({m:'ì‚¬ì—…ìš© ì¹´ë“œ ë“±ë¡ í›„ ì¬êµ¬ë§¤',detail:'ë™ì¼ í’ˆëª©ì„ í™ˆíƒìŠ¤ ë“±ë¡ ì‚¬ì—…ìš©ì¹´ë“œë¡œ êµ¬ë§¤í•˜ë©´ ìë™ ê³µì œ',action:'ì¹´ë“œì¬êµ¬ë§¤'});
    return{client:r.client,date:r.date,supply:r.supply,tax:r.tax,methods:methods};
  });
  document.getElementById('nd-recommend').innerHTML=recs.map(function(r){
    return'<div style="background:#FFF8E1;border:1px solid #FFE082;border-radius:var(--rs);padding:14px;margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:13px;font-weight:700;color:#F57F17"><i class="fas fa-exclamation-triangle" style="margin-right:4px"></i>'+r.client+'</div><div style="font-size:12px;font-weight:800;color:var(--rd)">ì„¸ì•¡ '+fm(r.tax)+'ì›</div></div><div style="font-size:11px;color:#555;margin-bottom:8px">ê³µê¸‰ê°€ì•¡ '+fm(r.supply)+'ì› | '+fD(r.date)+'</div><div style="font-size:11px;font-weight:600;color:var(--nv);margin-bottom:6px">ğŸ’¡ ê³µì œ ì „í™˜ ë°©ë²•:</div>'+r.methods.map(function(m){return'<div style="display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:8px;margin-bottom:4px;cursor:pointer;transition:all .15s" onclick="applyNdRecommend(\''+r.client+'\','+r.supply+',\''+m.action+'\')" onmouseover="this.style.background=\'#E8F5E9\'" onmouseout="this.style.background=\'#fff\'"><div style="width:24px;height:24px;border-radius:50%;background:#E8F5E9;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--gn);flex-shrink:0"><i class="fas fa-plus"></i></div><div style="flex:1"><div style="font-size:12px;font-weight:600">'+m.m+'</div><div style="font-size:10px;color:var(--sub)">'+m.detail+'</div></div><div style="font-size:10px;color:var(--gn);font-weight:700">ì ìš© â†’</div></div>'}).join('')+'</div>';
  }).join('');
}
function applyNdRecommend(client,supply,action){
  addItem();
  var rows=document.querySelectorAll('.add-row');var last=rows[rows.length-1];
  if(last){
    var sel=last.querySelector('select');var inp=last.querySelector('input');
    if(sel)sel.value='ê¸°íƒ€ê²½ë¹„';if(inp){inp.value=supply;inp.placeholder=client+' ('+action+')'}
  }
  calcSim();
  alert('âœ… "'+client+'" '+fm(supply)+'ì›ì´ ì¶”ê°€ ë§¤ì…ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹¤ì œ ì ìš© ì „ ì„¸ë¬´ì‚¬ í™•ì¸ í•„ìˆ˜!');
}

// === ê²½ì¡°ì‚¬ë¹„ ê´€ë¦¬ ===
var evtData=[];var evtFileData=null;
var EVT_PER_LIMIT=200000; // ê±´ë‹¹ 20ë§Œì› í•œë„
function getEvtYearLimit(){
  var b=getBaseNumbers();
  // ì ‘ëŒ€ë¹„ í•œë„: ê¸°ë³¸ 1,200ë§Œ + ìˆ˜ì…ê¸ˆì•¡ 1,200ë§Œ ì´í•˜ë¶„ì˜ 0.3% (ê°œì¸ì‚¬ì—…ì ê°„ì´)
  var base=12000000;var addRate=b.ts<=10000000000?0.003:0.002;
  return base+Math.round(b.ts*addRate);
}
function checkEvtLimit(){
  var v=parseInt(String(document.getElementById('evt-amt').value).replace(/[,\s]/g,''),10)||0;
  var warn=document.getElementById('evt-warn');
  if(v>EVT_PER_LIMIT){warn.style.display='block';document.getElementById('evt-warn-text').textContent='ê±´ë‹¹ í•œë„ 20ë§Œì› ì´ˆê³¼! ì´ˆê³¼ë¶„ '+fm(v-EVT_PER_LIMIT)+'ì›ì€ ê²½ë¹„ ë¶ˆì¸ì •ë©ë‹ˆë‹¤.'}
  else warn.style.display='none';
}
function evtFileAttached(input){
  if(!input.files||!input.files[0])return;var file=input.files[0];evtFileData=file.name;
  driveUploadEvt(file);
  var prev=document.getElementById('evt-preview');
  if(file.type.startsWith('image/')){var reader=new FileReader();reader.onload=function(e){prev.innerHTML='<img src="'+e.target.result+'" style="max-width:100%;max-height:80px;border-radius:6px">'};reader.readAsDataURL(file)}
  else prev.innerHTML='<div style="font-size:11px;color:var(--gn)"><i class="fas fa-file-pdf" style="font-size:20px;display:block;margin-bottom:4px"></i>'+file.name+'</div>';
}
function addEvt(){
  var date=document.getElementById('evt-date').value;var type=document.getElementById('evt-type').value;
  var name=document.getElementById('evt-name').value.trim();var amt=parseInt(String(document.getElementById('evt-amt').value).replace(/[,\s]/g,''),10)||0;
  if(!date||!name||!amt){alert('ë‚ ì§œ, ëŒ€ìƒ, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');return}
  var deductAmt=Math.min(amt,EVT_PER_LIMIT);var overAmt=Math.max(amt-EVT_PER_LIMIT,0);
  evtData.push({date:date,type:type,name:name,amount:amt,deduct:deductAmt,over:overAmt,file:evtFileData||null});
  document.getElementById('evt-date').value='';document.getElementById('evt-name').value='';
  document.getElementById('evt-amt').value='';document.getElementById('evt-warn').style.display='none';
  document.getElementById('evt-preview').innerHTML='<i class="fas fa-image" style="font-size:28px"></i>';evtFileData=null;
  renderEvtList();
}
function removeEvt(i){evtData.splice(i,1);renderEvtList();saveData()}
function renderEvtList(){
  var icons={'ê²°í˜¼':'ğŸ’’','ë¶€ì˜':'ğŸ•¯ï¸','ëŒì”ì¹˜':'ğŸ‘¶','íšŒê°‘':'ğŸ‚','ê¸°íƒ€':'ğŸ'};
  var totalAmt=evtData.reduce(function(a,e){return a+e.amount},0);
  var totalDeduct=evtData.reduce(function(a,e){return a+e.deduct},0);
  var totalOver=evtData.reduce(function(a,e){return a+e.over},0);
  var yearLimit=getEvtYearLimit();var usedAmt=totalDeduct;var remainAmt=Math.max(yearLimit-usedAmt,0);
  var pct=yearLimit>0?Math.min(Math.round(usedAmt/yearLimit*100),100):0;
  document.getElementById('evt-bar').style.width=pct+'%';
  document.getElementById('evt-bar').style.background=pct>80?'linear-gradient(90deg,var(--or),var(--rd))':'linear-gradient(90deg,var(--gn),var(--or))';
  document.getElementById('evt-limit-text').textContent=fm(usedAmt)+' / '+fm(yearLimit)+'ì› ('+pct+'%)';
  document.getElementById('evt-used').textContent=fm(usedAmt)+'ì›';
  document.getElementById('evt-remain').textContent=fm(remainAmt)+'ì›';
  document.getElementById('evt-remain').style.color=remainAmt>0?'var(--gn)':'var(--rd)';
  document.getElementById('evt-total').textContent=fm(totalAmt)+'ì›';
  document.getElementById('evt-deduct').textContent=fm(totalDeduct)+'ì›';
  document.getElementById('evt-over').textContent=fm(totalOver)+'ì›';
  if(!evtData.length){document.getElementById('evt-list').innerHTML='';return}
  document.getElementById('evt-list').innerHTML=evtData.map(function(e,i){
    return'<div style="display:flex;align-items:center;gap:10px;padding:12px;background:#f8f9fa;border-radius:var(--rs);margin-bottom:6px"><div style="font-size:20px;flex-shrink:0">'+(icons[e.type]||'ğŸ')+'</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">'+e.name+' <span style="font-size:10px;color:var(--sub)">('+e.type+')</span></div><div style="font-size:11px;color:var(--sub)">'+e.date+(e.file?' Â· ğŸ“ ì¦ë¹™ìˆìŒ':'')+'</div></div><div style="text-align:right"><div style="font-size:13px;font-weight:700">'+fm(e.amount)+'ì›</div>'+(e.over>0?'<div style="font-size:10px;color:var(--rd)">ì´ˆê³¼ '+fm(e.over)+'ì›</div>':'<div style="font-size:10px;color:var(--gn)">ì „ì•¡ ì¸ì •</div>')+'</div><button onclick="removeEvt('+i+')" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:14px;padding:4px"><i class="fas fa-xmark"></i></button></div>';
  }).join('');
  updateTotalOpt();
}

// === ë²•ì  í•œë„ ëŒ€ì‹œë³´ë“œ ===
function renderLimits(){
  var b=getBaseNumbers();var yearLimit=getEvtYearLimit();
  var evtUsed=evtData.reduce(function(a,e){return a+e.deduct},0);

  var items=[
    {name:'ì ‘ëŒ€ë¹„ (ê²½ì¡°ì‚¬ë¹„ í¬í•¨)',icon:'fa-utensils',max:yearLimit,used:evtUsed,law:'ë²•ì¸ì„¸ë²• ì‹œí–‰ë ¹ ì œ42ì¡°',note:'ê¸°ë³¸1,200ë§Œ+ìˆ˜ì…ê¸ˆì•¡ë¹„ë¡€'},
    {name:'ê²½ì¡°ì‚¬ë¹„ ê±´ë‹¹ í•œë„',icon:'fa-gift',max:200000,used:evtData.length>0?Math.max.apply(null,evtData.map(function(e){return e.amount})):0,law:'ì†Œë“ì„¸ë²• ì‹œí–‰ë ¹ ì œ55ì¡°',note:'1ê±´ë‹¹ ìµœëŒ€ 20ë§Œì›'},
    {name:'ê¸°ë³¸ê³µì œ',icon:'fa-user',max:1500000,used:1500000,law:'ì†Œë“ì„¸ë²• ì œ50ì¡°',note:'ë³¸ì¸ ê³µì œ 150ë§Œì›',fixed:true},
    {name:'ì „ìì‹ ê³  ì„¸ì•¡ê³µì œ',icon:'fa-laptop',max:20000,used:20000,law:'ì¡°íŠ¹ë²• ì œ104ì¡°ì˜8',note:'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ì‹œ',fixed:true}
  ];

  document.getElementById('limit-dashboard').innerHTML=items.map(function(item){
    var pct=item.isPct?item.used:item.max>0?Math.min(Math.round(item.used/item.max*100),100):0;
    var remain=item.isPct?(item.max-item.used)+'%':Math.max(item.max-item.used,0);
    var barColor=pct>90?'var(--rd)':pct>60?'var(--or)':'var(--gn)';
    var remainColor=item.isPct?'var(--sub)':(item.max-item.used>0?'var(--gn)':'var(--rd)');
    return'<div style="padding:14px 0;border-bottom:1px solid #f0f0f0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="display:flex;align-items:center;gap:8px"><i class="fas '+item.icon+'" style="color:var(--bl);font-size:14px;width:20px;text-align:center"></i><span style="font-size:13px;font-weight:600">'+item.name+'</span></div><div style="font-size:11px;color:var(--sub)">'+item.law+'</div></div><div style="background:#eee;border-radius:8px;height:8px;overflow:hidden;margin-bottom:4px"><div style="height:100%;border-radius:8px;background:'+barColor+';width:'+pct+'%;transition:width .5s"></div></div><div style="display:flex;justify-content:space-between;font-size:10px"><span style="color:var(--sub)">ì‚¬ìš©: <b>'+(item.isPct?item.used+'%':fm(item.used)+'ì›')+'</b> / í•œë„: <b>'+(item.isPct?item.max+'%':fm(item.max)+'ì›')+'</b></span><span style="color:'+remainColor+';font-weight:700">ì”ì—¬: '+(item.isPct?remain:fm(remain)+'ì›')+'</span></div>'+(item.note?'<div style="font-size:9px;color:#aaa;margin-top:2px">'+item.note+'</div>':'')+'</div>';
  }).join('');
}

function exSaveReport(){
  var b=getBaseNumbers();
  var doc=new jspdf.jsPDF('p','mm','a4');
  doc.setFont('helvetica','bold');doc.setFontSize(20);doc.text('Tax Saving Report',14,22);
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.text('YJ Partners | '+new Date().toISOString().slice(0,10),14,30);
  doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text('Current Tax: '+fm(b.vat+b.incTax)+' KRW',14,44);
  doc.text('VAT: '+fm(b.vat)+' / Income Tax: '+fm(b.incTax),14,52);
  doc.setFontSize(10);doc.setFont('helvetica','normal');
  doc.text('Optimization Strategies:',14,66);
  doc.text('1. Additional purchases - VAT reduction',14,74);
  doc.text('2. Noran Usan (Yellow Umbrella) - Income deduction',14,82);
  doc.text('3. Pension + IRP - Tax credit',14,90);
  doc.text('4. Non-deductible conversion',14,98);
  doc.save('YJ_TaxSaving_'+new Date().toISOString().slice(0,10)+'.pdf');
}

// === AI ì–´ì‹œìŠ¤í„´íŠ¸ ===
function openAI(){document.getElementById('ai-panel').style.display='block';document.getElementById('ai-input').focus()}
function closeAI(){document.getElementById('ai-panel').style.display='none'}
document.getElementById('ai-panel').addEventListener('click',function(e){if(e.target===this)closeAI()});
function aiAsk(q){document.getElementById('ai-input').value=q;aiSend()}
function aiSend(){
  var input=document.getElementById('ai-input');var q=input.value.trim();if(!q)return;input.value='';
  var chat=document.getElementById('ai-chat');
  var engine=document.getElementById('ai-engine-select')?document.getElementById('ai-engine-select').value:'local';
  chat.innerHTML+='<div class="ai-msg ai-user"><div class="ai-av"><i class="fas fa-user"></i></div><div class="ai-bubble">'+q+'</div></div>';
  chat.innerHTML+='<div class="ai-msg ai-bot" id="ai-typing"><div class="ai-av"><i class="fas fa-robot"></i></div><div class="ai-typing"><span></span><span></span><span></span></div></div>';
  chat.scrollTop=chat.scrollHeight;
  if(engine==='perplexity'){aiPerplexitySearch(q);return}
  if(engine==='gemini'){aiGeminiChat(q);return}
  if(engine==='claude'){aiClaudeChat(q);return}
  setTimeout(function(){
    var el=document.getElementById('ai-typing');if(el)el.remove();
    var answer=processAI(q);
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-robot"></i></div><div class="ai-bubble">'+answer+'</div></div>';
    chat.scrollTop=chat.scrollHeight;
  },600);
}
// === Perplexity AI ì‹¤ì‹œê°„ ê²€ìƒ‰ ===
async function aiPerplexitySearch(query){
  var chat=document.getElementById('ai-chat');
  var statusEl=document.getElementById('ai-engine-status');
  if(statusEl)statusEl.textContent='Perplexity ê²€ìƒ‰ ì¤‘...';
  if(!document.getElementById('ai-typing')){
    chat.innerHTML+='<div class="ai-msg ai-bot" id="ai-typing"><div class="ai-av"><i class="fas fa-magnifying-glass" style="color:#008080"></i></div><div class="ai-typing"><span></span><span></span><span></span></div></div>';
    chat.scrollTop=chat.scrollHeight;
  }
  var result=await callPerplexity(query);
  var el=document.getElementById('ai-typing');if(el)el.remove();
  if(statusEl)statusEl.textContent='';
  if(result){
    var formatted=result.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>');
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-magnifying-glass" style="color:#008080"></i></div><div class="ai-bubble" style="border-left:3px solid #20B2AA"><div style="font-size:10px;color:#008080;font-weight:700;margin-bottom:6px"><i class="fas fa-magnifying-glass-chart"></i> Perplexity AI ê²€ìƒ‰ ê²°ê³¼</div>'+formatted+'</div></div>';
  }else{
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-magnifying-glass" style="color:#008080"></i></div><div class="ai-bubble">Perplexity API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.</div></div>';
  }
  chat.scrollTop=chat.scrollHeight;
}
// === Gemini AI ì±„íŒ… ===
async function aiGeminiChat(query){
  var chat=document.getElementById('ai-chat');
  var statusEl=document.getElementById('ai-engine-status');
  if(statusEl)statusEl.textContent='Gemini ë¶„ì„ ì¤‘...';
  var context=buildAIContext();
  var bodyJson={contents:[{parts:[{text:context+'\n\nì‚¬ìš©ì ì§ˆë¬¸: '+query+'\n\ní•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. ê°„ê²°í•˜ê²Œ í•µì‹¬ë§Œ ë‹µë³€.'}]}]};
  var data=await callGeminiWithFallback(bodyJson);
  var el=document.getElementById('ai-typing');if(el)el.remove();
  if(statusEl)statusEl.textContent='';
  if(data&&data.candidates&&data.candidates[0]){
    var text=data.candidates[0].content.parts[0].text||'';
    var formatted=text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>');
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-wand-magic-sparkles" style="color:#4285F4"></i></div><div class="ai-bubble" style="border-left:3px solid #4285F4"><div style="font-size:10px;color:#4285F4;font-weight:700;margin-bottom:6px"><i class="fas fa-wand-magic-sparkles"></i> Gemini AI</div>'+formatted+'</div></div>';
  }else{
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-robot"></i></div><div class="ai-bubble">Gemini API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.</div></div>';
  }
  chat.scrollTop=chat.scrollHeight;
}
// === Claude AI ì±„íŒ… ===
async function aiClaudeChat(query){
  var chat=document.getElementById('ai-chat');
  var statusEl=document.getElementById('ai-engine-status');
  if(statusEl)statusEl.textContent='Claude ë¶„ì„ ì¤‘...';
  var context=buildAIContext();
  var result=await callClaude(context+'\n\nì‚¬ìš©ì ì§ˆë¬¸: '+query+'\n\ní•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. ê°„ê²°í•˜ê²Œ í•µì‹¬ë§Œ ë‹µë³€.',1500);
  var el=document.getElementById('ai-typing');if(el)el.remove();
  if(statusEl)statusEl.textContent='';
  if(result){
    var formatted=result.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>');
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-brain" style="color:#D97706"></i></div><div class="ai-bubble" style="border-left:3px solid #D97706"><div style="font-size:10px;color:#D97706;font-weight:700;margin-bottom:6px"><i class="fas fa-brain"></i> Claude AI</div>'+formatted+'</div></div>';
  }else{
    chat.innerHTML+='<div class="ai-msg ai-bot"><div class="ai-av"><i class="fas fa-robot"></i></div><div class="ai-bubble">Claude API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.</div></div>';
  }
  chat.scrollTop=chat.scrollHeight;
}
// AI ì»¨í…ìŠ¤íŠ¸ ë¹Œë” (ì¥ë¶€ ë°ì´í„° ìš”ì•½)
function buildAIContext(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0),dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  return 'ë‹¹ì‹ ì€ í•œêµ­ ì„¸ë¬´ ì „ë¬¸ AIì…ë‹ˆë‹¤.\n[í˜„ì¬ ì¥ë¶€ ìš”ì•½]\në§¤ì¶œ: '+ts+'ì› ('+st.length+'ê±´), ë§¤ì…: '+te+'ì› ('+et.length+'ê±´)\në§¤ì¶œì„¸ì•¡: '+sTx+'ì›, ê³µì œë§¤ì…ì„¸ì•¡: '+dTx+'ì›\nì˜ˆìƒ ë¶€ê°€ì„¸: '+(sTx-dTx)+'ì›\ní†µì¥: '+D.bank.length+'ê±´, ì¹´ë“œ: '+D.card.length+'ê±´, ì§€ì¶œì¦ë¹™: '+(D.proof?D.proof.length:0)+'ê±´';
}
function processAI(q){
  var ql=q.toLowerCase();
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0),dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var ndTx=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var vat=sTx-dTx,income=ts-te;

  // ë§¤ì¶œ ê´€ë ¨
  if(/ë§¤ì¶œ.*í•©ê³„|ì´ë§¤ì¶œ|ë§¤ì¶œ.*ì–¼ë§ˆ/.test(ql))return'ğŸ“ˆ <b>ì´ ë§¤ì¶œ(ê³µê¸‰ê°€ì•¡): '+fm(ts)+'ì›</b><br>ë§¤ì¶œì„¸ì•¡: '+fm(sTx)+'ì›<br>ë§¤ì¶œ ê±´ìˆ˜: '+st.length+'ê±´<br><br>ì£¼ìš” ë§¤ì¶œì²˜: '+Object.entries(st.reduce(function(a,r){a[r.client]=(a[r.client]||0)+r.supply;return a},{})).map(function(e){return e[0]+' '+fm(e[1])+'ì›'}).join('<br>');

  // ë§¤ì… ê´€ë ¨
  if(/ë§¤ì….*í•©ê³„|ì´ë§¤ì…|ë§¤ì….*ì–¼ë§ˆ|ë¹„ìš©/.test(ql))return'ğŸ“‰ <b>ì´ ë§¤ì…(ê³µê¸‰ê°€ì•¡): '+fm(te)+'ì›</b><br>ë§¤ì…ì„¸ì•¡: '+fm(dTx+ndTx)+'ì›<br>ë§¤ì… ê±´ìˆ˜: '+et.length+'ê±´<br><br>ê±°ë˜ì²˜ë³„:<br>'+Object.entries(et.reduce(function(a,r){a[r.client]=(a[r.client]||0)+r.supply;return a},{})).map(function(e){return'â–¸ '+e[0]+' '+fm(e[1])+'ì›'}).join('<br>');

  // ìˆœìˆ˜ìµ
  if(/ìˆœìˆ˜ìµ|ìˆœì´ìµ|ì´ìµ|ìˆ˜ìµ/.test(ql))return'ğŸ’° <b>ìˆœìˆ˜ìµ: '+fm(income)+'ì›</b><br><br>ë§¤ì¶œ '+fm(ts)+'ì› - ë§¤ì… '+fm(te)+'ì›<br>ìˆ˜ìµë¥ : '+(ts>0?Math.round(income/ts*100):0)+'%';

  // ë¶€ê°€ì„¸
  if(/ë¶€ê°€ì„¸|vat|ë¶€ê°€ê°€ì¹˜/.test(ql))return'ğŸš© <b>ì˜ˆì • ë¶€ê°€ê°€ì¹˜ì„¸: '+fm(vat)+'ì›</b><br><br>â–¸ ë§¤ì¶œì„¸ì•¡: '+fm(sTx)+'ì›<br>â–¸ ê³µì œë§¤ì…ì„¸ì•¡: '+fm(dTx)+'ì›<br>â–¸ ë¶ˆê³µì œ: '+fm(ndTx)+'ì› ('+et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).length+'ê±´)<br><br>ğŸ’¡ ë¶ˆê³µì œ í•­ëª©ì„ ê³µì œë¡œ ì „í™˜í•˜ë©´ <b>'+fm(ndTx)+'ì› ì¶”ê°€ ì ˆì„¸</b> ê°€ëŠ¥!';

  // ì¢…ì†Œì„¸
  if(/ì¢…ì†Œì„¸|ì¢…í•©ì†Œë“|ì†Œë“ì„¸/.test(ql)){
    var taxBase=Math.max(income-1500000,0);var calcTax=Math.round(calcIncomeTax(taxBase));var finalTax=Math.round(calcTax);
    return'ğŸ“‹ <b>ì˜ˆì • ì¢…í•©ì†Œë“ì„¸: '+fm(finalTax)+'ì›</b><br><br>â–¸ ì†Œë“ê¸ˆì•¡: '+fm(income)+'ì›<br>â–¸ ê¸°ë³¸ê³µì œ: -1,500,000ì›<br>â–¸ ê³¼ì„¸í‘œì¤€: '+fm(taxBase)+'ì›<br>â–¸ ì‚°ì¶œì„¸ì•¡: '+fm(calcTax)+'ì›<br>â–¸ ì„¸ì•¡ê³µì œ: <span style="color:var(--gn)">-'+fm(calcTax-finalTax)+'ì›</span><br><br>ğŸ’¡ ì ˆì„¸ íƒ­ì—ì„œ ì¶”ê°€ ë§¤ì… ì‹œë®¬ë ˆì´ì…˜ì„ í™•ì¸í•˜ì„¸ìš”!';
  }

  // ë¶ˆê³µì œ
  if(/ë¶ˆê³µì œ/.test(ql)){
    var ndItems=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'});
    if(!ndItems.length)return'âœ… í˜„ì¬ ë¶ˆê³µì œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤!';
    return'âš ï¸ <b>ë¶ˆê³µì œ í•­ëª© '+ndItems.length+'ê±´</b> (ì„¸ì•¡ í•©ê³„: '+fm(ndTx)+'ì›)<br><br>'+ndItems.map(function(r){return'â–¸ '+r.client+' | '+fm(r.supply)+'ì› | ì„¸ì•¡ '+fm(r.tax)+'ì›'}).join('<br>')+'<br><br>ğŸ’¡ ì‚¬ì—…ìš© ì¹´ë“œ ë“±ë¡ + ì ê²©ì¦ë¹™ ìˆ˜ì·¨ ì‹œ ê³µì œ ì „í™˜ ê°€ëŠ¥!';
  }

  // ê±°ë˜ì²˜ ë¹„êµ
  if(/ê±°ë˜ì²˜.*ë¹„êµ|ê±°ë˜ì²˜.*ë¶„ì„|ë§¤ì¶œì²˜/.test(ql)){
    var cm={};st.forEach(function(r){cm[r.client]=(cm[r.client]||0)+r.supply});
    var sorted=Object.entries(cm).sort(function(a,b){return b[1]-a[1]});
    return'ğŸ¢ <b>ê±°ë˜ì²˜ë³„ ë§¤ì¶œ ë¹„êµ</b><br><br>'+sorted.map(function(e,i){var pct=ts>0?Math.round(e[1]/ts*100):0;return(i+1)+'. '+e[0]+'<br>&nbsp;&nbsp;&nbsp;'+fm(e[1])+'ì› ('+pct+'%)'}).join('<br><br>');
  }

  // ì ˆì„¸
  if(/ì ˆì„¸|ì„¸ê¸ˆ.*ì¤„|ì•„ë¼|ì ˆì•½/.test(ql))return'ğŸ” <b>ì ˆì„¸ ì „ëµ ìš”ì•½</b><br><br><b>[ë¶€ê°€ì„¸]</b><br>â–¸ ë¶ˆê³µì œ '+fm(ndTx)+'ì› â†’ ì ê²©ì¦ë¹™ í™•ë³´ ì‹œ ê³µì œ ê°€ëŠ¥<br>â–¸ ì‚¬ì—…ìš© ì¹´ë“œ í™ˆíƒìŠ¤ ë“±ë¡ í•„ìˆ˜<br>â–¸ ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨ í™•ì¸<br><br><b>[ì¢…ì†Œì„¸]</b><br>â–¸ ì¥ë¶€ê¸°ì¥ ìœ ì§€ (ê²½ë¹„ìœ¨ ëŒ€ë¹„ ìœ ë¦¬)<br>â–¸ ì¶”ê°€ ë§¤ì…ìœ¼ë¡œ ë¶€ê°€ì„¸ ì ˆê° ê·¹ëŒ€í™”<br>â–¸ <br>â–¸ <br><br>ğŸ’¡ <b>ì ˆì„¸ íƒ­</b>ì—ì„œ ìƒì„¸ ì‹œë®¬ë ˆì´ì…˜ í™•ì¸í•˜ì„¸ìš”!';

  // ì—‘ì…€ ì¶œë ¥
  if(/ì—‘ì…€|xlsx|excel|ìŠ¤í”„ë ˆë“œ/.test(ql)){exXL();return'ğŸ“Š <b>ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ!</b><br><br>ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.<br>ì‹œíŠ¸ êµ¬ì„±: ì„¸ê¸ˆê³„ì‚°ì„œ / í†µì¥ / ì¹´ë“œ / ìš”ì•½<br><br><div class="ai-file" onclick="exXL()"><i class="fas fa-file-excel" style="color:#217346;font-size:18px"></i>YJ_ì¥ë¶€.xlsx ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ</div>';}

  // PDF ì¶œë ¥
  if(/pdf|ë¦¬í¬íŠ¸|ë³´ê³ ì„œ|report/.test(ql)){exPDF();return'ğŸ“„ <b>PDF ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!</b><br><br>ë§¤ì¶œ/ë§¤ì… ìš”ì•½ + ì„¸ê¸ˆê³„ì‚°ì„œ ëª©ë¡ì´ í¬í•¨ë©ë‹ˆë‹¤.<br><br><div class="ai-file" onclick="exPDF()"><i class="fas fa-file-pdf" style="color:#C62828;font-size:18px"></i>YJ_Report.pdf ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ</div>';}

  // CSV
  if(/csv/.test(ql)){exCSV();return'ğŸ“‹ <b>CSV íŒŒì¼ ìƒì„± ì™„ë£Œ!</b><br><br>ì „ì²´ ê±°ë˜ ë°ì´í„°ê°€ í¬í•¨ë©ë‹ˆë‹¤.<br><br><div class="ai-file" onclick="exCSV()"><i class="fas fa-file-csv" style="color:var(--or);font-size:18px"></i>YJ_ì¥ë¶€.csv ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ</div>';}

  // í†µì¥
  if(/í†µì¥|ì…ì¶œê¸ˆ|ê³„ì¢Œ/.test(ql)){
    if(!D.bank.length)return'ğŸ¦ í˜„ì¬ í†µì¥ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ì¥ë¶€ íƒ­ì—ì„œ í†µì¥ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!';
    var totalIn=D.bank.reduce(function(a,r){return a+r.inAmt},0),totalOut=D.bank.reduce(function(a,r){return a+r.outAmt},0);
    return'ğŸ¦ <b>í†µì¥ ìš”ì•½</b><br><br>â–¸ ì…ê¸ˆ í•©ê³„: <span style="color:var(--bl)">'+fm(totalIn)+'ì›</span><br>â–¸ ì¶œê¸ˆ í•©ê³„: <span style="color:var(--rd)">'+fm(totalOut)+'ì›</span><br>â–¸ ê±´ìˆ˜: '+D.bank.length+'ê±´<br>â–¸ ìµœê·¼ ì”ì•¡: '+fm(D.bank[0].balance)+'ì›';
  }

  // ì¹´ë“œ
  if(/ì¹´ë“œ/.test(ql)){
    if(!D.card.length)return'ğŸ’³ í˜„ì¬ ì¹´ë“œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ì¥ë¶€ íƒ­ì—ì„œ ì¹´ë“œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!';
    var cardTotal=D.card.reduce(function(a,r){return a+r.amount},0);
    return'ğŸ’³ <b>ì¹´ë“œ ì‚¬ìš© ìš”ì•½</b><br><br>â–¸ ì´ ì‚¬ìš©ì•¡: '+fm(cardTotal)+'ì›<br>â–¸ ê±´ìˆ˜: '+D.card.length+'ê±´<br><br>'+D.card.map(function(r){return'â–¸ '+r.merchant+' '+fm(r.amount)+'ì›'}).join('<br>');
  }

  // D-Day
  if(/ë””ë°ì´|d-day|ì¼ì •|ë§ˆê°|ì‹ ê³ /.test(ql)){
    var now=new Date();now.setHours(0,0,0,0);var y=now.getFullYear();
    var evts=[{nm:'ë¶€ê°€ì„¸ 1ê¸° ì˜ˆì •',dt:new Date(y,3,25)},{nm:'ì¢…ì†Œì„¸ ì‹ ê³ ',dt:new Date(y,4,31)},{nm:'ë¶€ê°€ì„¸ í™•ì •',dt:new Date(y,6,25)}];
    return'ğŸ“… <b>ë‹¤ê°€ì˜¤ëŠ” ì„¸ë¬´ ì¼ì •</b><br><br>'+evts.map(function(e){var diff=Math.ceil((e.dt-now)/86400000);return(diff>0?'D-'+diff:'D+'+Math.abs(diff))+' | '+e.nm+' ('+(e.dt.getMonth()+1)+'/'+e.dt.getDate()+')'}).join('<br>')+'<br><br>ëŒ€ì‹œë³´ë“œ ìƒë‹¨ì—ì„œ ì‹¤ì‹œê°„ í™•ì¸ ê°€ëŠ¥!';
  }

  // ë„ì›€ë§
  if(/ë„ì›€|help|ë­˜.*í• |ê¸°ëŠ¥|ì‚¬ìš©ë²•/.test(ql))return'ğŸ¤– <b>YJ ì„¸ë¬´ ì–´ì‹œìŠ¤í„´íŠ¸ ê¸°ëŠ¥</b><br><br><b>ğŸ“Š ë°ì´í„° ì¡°íšŒ</b><br>â–¸ ë§¤ì¶œ/ë§¤ì…/ìˆœìˆ˜ìµ í•©ê³„<br>â–¸ ê±°ë˜ì²˜ë³„ ë¹„êµ ë¶„ì„<br>â–¸ í†µì¥/ì¹´ë“œ ë‚´ì—­ ìš”ì•½<br><br><b>ğŸ’° ì„¸ê¸ˆ ê³„ì‚°</b><br>â–¸ ë¶€ê°€ì„¸ Â· ì¢…ì†Œì„¸ ì˜ˆìƒì•¡<br>â–¸ ë¶ˆê³µì œ í•­ëª© í™•ì¸<br>â–¸ ì ˆì„¸ ì „ëµ ì•ˆë‚´<br><br><b>ğŸ“ íŒŒì¼ ìƒì„±</b><br>â–¸ "ì—‘ì…€ë¡œ ë§Œë“¤ì–´ì¤˜" â†’ .xlsx<br>â–¸ "PDF ë¦¬í¬íŠ¸" â†’ .pdf<br>â–¸ "CSV ì¶œë ¥" â†’ .csv<br><br><b>ğŸ“… ì¼ì •</b><br>â–¸ ì„¸ë¬´ D-Day í™•ì¸';

  // ê¸°ë³¸ ì‘ë‹µ
  return'ğŸ¤” ì§ˆë¬¸ì„ ì •í™•íˆ ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><br>ì´ëŸ° ê²ƒë“¤ì„ ë¬¼ì–´ë³´ì‹¤ ìˆ˜ ìˆì–´ìš”:<br>â–¸ <b>ë§¤ì¶œ í•©ê³„</b> / <b>ë§¤ì… í•©ê³„</b> / <b>ìˆœìˆ˜ìµ</b><br>â–¸ <b>ë¶€ê°€ì„¸</b> / <b>ì¢…ì†Œì„¸</b> ì˜ˆìƒì•¡<br>â–¸ <b>ë¶ˆê³µì œ</b> í•­ëª© í™•ì¸<br>â–¸ <b>ê±°ë˜ì²˜ ë¹„êµ</b> ë¶„ì„<br>â–¸ <b>ì ˆì„¸ ë°©ë²•</b> ì•ˆë‚´<br>â–¸ <b>ì—‘ì…€</b> / <b>PDF</b> / <b>CSV</b> íŒŒì¼ ìƒì„±<br><br>ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°”ë¡œ ì‹œì‘í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤!';
}

// === ì„¸ë¬´ ìº˜ë¦°ë” ===
var calMonth=new Date().getMonth(),calYear=new Date().getFullYear();
var TAX_EVENTS=[
  {m:0,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#E53935'},{m:0,d:25,nm:'ë¶€ê°€ì„¸ í™•ì •ì‹ ê³ ',c:'#E53935'},
  {m:1,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},{m:2,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},
  {m:3,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},{m:3,d:25,nm:'ë¶€ê°€ì„¸ ì˜ˆì •ì‹ ê³ ',c:'#E53935'},
  {m:4,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},{m:4,d:31,nm:'ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ',c:'#C62828'},
  {m:5,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},{m:6,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},
  {m:6,d:25,nm:'ë¶€ê°€ì„¸ í™•ì •ì‹ ê³ ',c:'#E53935'},{m:7,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},
  {m:8,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},{m:9,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},
  {m:9,d:25,nm:'ë¶€ê°€ì„¸ ì˜ˆì •ì‹ ê³ ',c:'#E53935'},{m:10,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'},
  {m:10,d:30,nm:'ì¢…ì†Œì„¸ ì¤‘ê°„ì˜ˆë‚©',c:'#C62828'},{m:11,d:10,nm:'ì›ì²œì„¸ ë‚©ë¶€',c:'#F57C00'}
];
function calNav(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++}if(calMonth<0){calMonth=11;calYear--}renderCal()}
function renderCal(){
  document.getElementById('cal-title').textContent=calYear+'ë…„ '+(calMonth+1)+'ì›”';
  var fd=new Date(calYear,calMonth,1).getDay(),ld=new Date(calYear,calMonth+1,0).getDate();
  var now=new Date();now.setHours(0,0,0,0);
  var evts=TAX_EVENTS.filter(function(e){return e.m===calMonth});
  var html='';
  for(var i=0;i<fd;i++)html+='<div style="padding:6px;text-align:center"></div>';
  for(var d=1;d<=ld;d++){
    var isToday=d===now.getDate()&&calMonth===now.getMonth()&&calYear===now.getFullYear();
    var evt=evts.find(function(e){return e.d===d});
    var dateStr=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    var hasMemo=calMemos[dateStr];
    var bg=isToday?'var(--nv)':evt?evt.c:hasMemo?'#E8F5E9':'transparent';
    var clr=isToday||evt?'#fff':hasMemo?'#2E7D32':'var(--tx)';
    var dot=evt?'<div style="width:4px;height:4px;background:#fff;border-radius:50%;margin:1px auto 0"></div>':hasMemo?'<div style="width:4px;height:4px;background:#4CAF50;border-radius:50%;margin:1px auto 0"></div>':'';
    html+='<div style="padding:6px 2px;text-align:center;border-radius:8px;background:'+bg+';color:'+clr+';font-size:12px;font-weight:'+(isToday||evt||hasMemo?'700':'400')+';cursor:pointer" onclick="addCalMemo(\''+dateStr+'\')" title="'+(evt?evt.nm:'')+(hasMemo?' ğŸ“'+hasMemo:'')+'">'+d+dot+'</div>';
  }
  document.getElementById('cal-grid').innerHTML=html;
  // ì´ë²¤íŠ¸ + ë©”ëª¨ í‘œì‹œ
  var evtHtml=evts.map(function(e){return'<div style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px"><div style="width:8px;height:8px;border-radius:50%;background:'+e.c+';flex-shrink:0"></div><b>'+e.d+'ì¼</b> '+e.nm+'</div>'}).join('');
  // ì´ë²ˆ ë‹¬ ë©”ëª¨
  var memoHtml='';
  Object.keys(calMemos).forEach(function(k){
    if(k.startsWith(calYear+'-'+String(calMonth+1).padStart(2,'0'))){
      memoHtml+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px;cursor:pointer" onclick="addCalMemo(\''+k+'\')"><div style="width:8px;height:8px;border-radius:50%;background:#4CAF50;flex-shrink:0"></div><b>'+parseInt(k.split('-')[2])+'ì¼</b> ğŸ“ '+calMemos[k]+'</div>';
    }
  });
  document.getElementById('cal-events').innerHTML=(evtHtml+memoHtml)||'<div style="font-size:11px;color:var(--sub);text-align:center;padding:8px">ì´ë²ˆ ë‹¬ ì¼ì • ì—†ìŒ Â· ë‚ ì§œ í´ë¦­í•˜ì—¬ ë©”ëª¨ ì¶”ê°€</div>';
}

// === ì›”ë³„ ì¶”ì„¸ ì°¨íŠ¸ ===
var trendChart=null;
function renderTrend(){
  var months={};
  D.tax.forEach(function(r){
    var key=String(r.date).substring(0,7)||'2026-02';
    if(!months[key])months[key]={sales:0,expense:0};
    if(r.type==='ë§¤ì¶œ')months[key].sales+=r.supply;else months[key].expense+=r.supply;
  });
  D.bank.forEach(function(r){
    var key=String(r.date).substring(0,7)||'2026-02';
    if(!months[key])months[key]={sales:0,expense:0};
    months[key].sales+=r.inAmt;months[key].expense+=r.outAmt;
  });
  var keys=Object.keys(months).sort();
  if(!keys.length)keys=['2026-02'];
  if(!months['2026-02'])months['2026-02']={sales:0,expense:0};
  var labels=keys.map(function(k){var p=k.split('-');return p[1]+'ì›”'});
  var salesData=keys.map(function(k){return months[k].sales});
  var expData=keys.map(function(k){return months[k].expense});
  var profitData=keys.map(function(k){return months[k].sales-months[k].expense});
  var cv=document.getElementById('trend-chart');
  if(trendChart)trendChart.destroy();
  trendChart=new Chart(cv.getContext('2d'),{type:'bar',data:{labels:labels,datasets:[
    {label:'ë§¤ì¶œ',data:salesData,backgroundColor:'rgba(46,134,193,0.7)',borderRadius:6,order:2},
    {label:'ë§¤ì…',data:expData,backgroundColor:'rgba(231,76,60,0.5)',borderRadius:6,order:3},
    {label:'ìˆœìˆ˜ìµ',data:profitData,type:'line',borderColor:'#27AE60',backgroundColor:'rgba(39,174,96,0.1)',borderWidth:3,pointRadius:5,pointBackgroundColor:'#27AE60',fill:true,order:1}
  ]},options:{responsive:true,plugins:{legend:{labels:{font:{family:'Pretendard',size:11}}}},scales:{y:{ticks:{callback:function(v){return(v/10000)+'ë§Œ'}}}}}});
  // ìë™ ë¶„ì„
  if(keys.length>=2){
    var last=months[keys[keys.length-1]],prev=months[keys[keys.length-2]];
    var sChg=prev.sales>0?Math.round((last.sales-prev.sales)/prev.sales*100):0;
    var eChg=prev.expense>0?Math.round((last.expense-prev.expense)/prev.expense*100):0;
    document.getElementById('trend-analysis').innerHTML='<b>ğŸ“Š ìë™ ë¶„ì„</b><br>â–¸ ë§¤ì¶œ: ì „ì›” ëŒ€ë¹„ <b style="color:'+(sChg>=0?'var(--bl)':'var(--rd)')+'">'+sChg+'%</b> '+(sChg>=0?'ì¦ê°€':'ê°ì†Œ')+'<br>â–¸ ë§¤ì…: ì „ì›” ëŒ€ë¹„ <b style="color:'+(eChg>=0?'var(--rd)':'var(--gn)')+'">'+eChg+'%</b> '+(eChg>=0?'ì¦ê°€':'ê°ì†Œ');
  }else document.getElementById('trend-analysis').innerHTML='<div style="color:var(--sub)">2ê°œì›” ì´ìƒ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ì„¸ ë¶„ì„ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
}

// === ì¦ë¹™ ëˆ„ë½ ê°ì§€ ===
var mmDone=[];var mmShowAll=false;
try{mmDone=JSON.parse(localStorage.getItem('yjtax_mismatch_done')||'[]')}catch(e){mmDone=[]}
function checkMismatch(){
  var issues=[];
  // í†µì¥ ì…ê¸ˆ vs ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œ ëŒ€ì‚¬
  if(D.bank.length&&D.tax.length){
    var taxSales=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'});
    taxSales.forEach(function(t){
      var matched=D.bank.find(function(b){return Math.abs(b.inAmt-(t.supply+t.tax))<100||Math.abs(b.inAmt-t.supply)<100});
      if(!matched)issues.push({type:'ë¯¸ì…ê¸ˆ',icon:'fa-circle-exclamation',color:'var(--rd)',text:t.client+' ì„¸ê¸ˆê³„ì‚°ì„œ '+fm(t.supply)+'ì› ë°œí–‰ â†’ <b>í†µì¥ ì…ê¸ˆ í™•ì¸ ì•ˆë¨</b> (ë¯¸ìˆ˜ê¸ˆ ê°€ëŠ¥ì„±)'});
    });
  }
  // í†µì¥ ì¶œê¸ˆ vs ë§¤ì… ì„¸ê¸ˆê³„ì‚°ì„œ ëŒ€ì‚¬
  if(D.bank.length){
    D.bank.filter(function(b){return b.outAmt>=100000}).forEach(function(b){
      var matched=D.tax.find(function(t){return t.type==='ë§¤ì…'&&(Math.abs(t.supply+t.tax-b.outAmt)<100||Math.abs(t.supply-b.outAmt)<100)});
      if(!matched&&b.outAmt>=500000)issues.push({type:'ì¦ë¹™ëˆ„ë½',icon:'fa-file-circle-exclamation',color:'var(--or)',text:fD(b.date)+' ì¶œê¸ˆ '+fm(b.outAmt)+'ì› ('+b.desc+') â†’ <b>ì„¸ê¸ˆê³„ì‚°ì„œ ë¯¸ìˆ˜ì·¨</b> (ì ê²©ì¦ë¹™ í•„ìš”)'});
    });
  }
  // ë¶ˆê³µì œ ê²½ê³ 
  D.tax.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).forEach(function(r){
    issues.push({type:'ë¶ˆê³µì œ',icon:'fa-ban',color:'var(--pr)',text:r.client+' ë§¤ì… '+fm(r.supply)+'ì› â†’ <b>ë¶ˆê³µì œ</b> ì²˜ë¦¬ë¨. ì‚¬ì—…ìš©ì¹´ë“œ/ì„¸ê¸ˆê³„ì‚°ì„œ í™•ë³´ ê²€í† '});
  });
  // ID ë¶€ì—¬
  issues.forEach(function(issue,idx){issue.id='mm-'+idx+'-'+issue.type.replace(/[^a-zA-Zê°€-í£]/g,'')});
  var box=document.getElementById('mismatch-box');
  if(issues.length){
    box.style.display='block';
    var doneCount=issues.filter(function(i){return mmDone.indexOf(i.id)>-1}).length;
    var activeCount=issues.length-doneCount;
    document.getElementById('mismatch-title').innerHTML='âš ï¸ ì¦ë¹™ ëˆ„ë½ ê°ì§€ <span style="font-size:12px;font-weight:500;color:#888">('+issues.length+'ê±´'+(doneCount?' Â· '+doneCount+'ê±´ ì™„ë£Œ':'')+')</span>';
    // ìì„¸íˆ ë³´ê¸° ë²„íŠ¼
    var detailBtn=document.getElementById('mismatch-detail-btn');
    detailBtn.style.display=doneCount?'inline-flex':'none';
    detailBtn.innerHTML=mmShowAll?'<i class="fas fa-eye-slash" style="margin-right:4px"></i>ê°„ëµíˆ ë³´ê¸°':'<i class="fas fa-eye" style="margin-right:4px"></i>ìì„¸íˆ ë³´ê¸° ('+doneCount+')';
    document.getElementById('mismatch-list').innerHTML=issues.map(function(i){
      var isDone=mmDone.indexOf(i.id)>-1;
      if(isDone&&!mmShowAll)return'';
      return'<div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid #f5f5f5;'+(isDone?'opacity:.4;text-decoration:line-through;':'')+'" id="'+i.id+'">'+
        '<i class="fas '+i.icon+'" style="color:'+i.color+';margin-top:3px;flex-shrink:0"></i>'+
        '<span style="flex:1;line-height:1.6">'+i.text+'</span>'+
        '<label style="flex-shrink:0;display:flex;align-items:center;cursor:pointer;margin-left:8px">'+
          '<input type="checkbox" '+(isDone?'checked':'')+' onchange="toggleMismatch(\''+i.id+'\')" style="width:18px;height:18px;accent-color:var(--gn);cursor:pointer">'+
        '</label>'+
      '</div>';
    }).join('');
    // ì™„ë£Œ í•­ëª©ë§Œ ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
    if(activeCount===0&&!mmShowAll)box.style.display='none';
  }else box.style.display='none';
}
function toggleMismatch(id){
  var idx=mmDone.indexOf(id);
  if(idx>-1)mmDone.splice(idx,1);
  else mmDone.push(id);
  try{localStorage.setItem('yjtax_mismatch_done',JSON.stringify(mmDone))}catch(e){}
  // ì²´í¬ ì‹œ fade out í›„ ì¬ë Œë”ë§
  var el=document.getElementById(id);
  if(el&&mmDone.indexOf(id)>-1){
    el.style.transition='opacity .3s, transform .3s';
    el.style.opacity='0';el.style.transform='translateX(20px)';
    setTimeout(function(){checkMismatch()},350);
  }else checkMismatch();
}
function toggleMismatchDetail(){
  mmShowAll=!mmShowAll;
  checkMismatch();
}

// === ê±°ë˜ì²˜ ê´€ë¦¬ ===
function renderClients(){
  var clients={};
  D.tax.forEach(function(r){
    var key=r.client||'ë¯¸ì§€ì •';
    if(!clients[key])clients[key]={bizNo:r.bizNo||'',sales:0,expense:0,saleTax:0,expTax:0,saleCount:0,expCount:0,lastDate:r.date};
    if(r.type==='ë§¤ì¶œ'){clients[key].sales+=r.supply;clients[key].saleTax+=r.tax;clients[key].saleCount++}
    else{clients[key].expense+=r.supply;clients[key].expTax+=r.tax;clients[key].expCount++}
    if(r.bizNo)clients[key].bizNo=r.bizNo;
    if(r.date>clients[key].lastDate)clients[key].lastDate=r.date;
  });
  var sorted=Object.entries(clients).sort(function(a,b){return(b[1].sales+b[1].expense)-(a[1].sales+a[1].expense)});
  if(!sorted.length){document.getElementById('client-mgmt').innerHTML='<div style="color:var(--sub);text-align:center;padding:20px">ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ì‹œ ê±°ë˜ì²˜ ìë™ ë“±ë¡</div>';return}
  var h='<div class="tw"><table style="table-layout:auto"><thead><tr><th style="width:60px">êµ¬ë¶„</th><th>ìƒí˜¸</th><th style="width:110px">ì‚¬ì—…ìë²ˆí˜¸</th><th style="width:40px;text-align:center">ê±´ìˆ˜</th><th style="width:100px;text-align:right">ë§¤ì¶œì•¡</th><th style="width:100px;text-align:right">ë§¤ì…ì•¡</th><th style="width:70px">ìµœê·¼ê±°ë˜</th></tr></thead><tbody>';
  sorted.forEach(function(e){
    var n=e[0],c=e[1];
    var badge=c.sales>0&&c.expense>0?'<span class="badge b-or">ë§¤ì¶œ+ë§¤ì…</span>':c.sales>0?'<span class="badge b-bl">ë§¤ì¶œì²˜</span>':'<span class="badge b-rd">ë§¤ì…ì²˜</span>';
    h+='<tr style="border-bottom:1px solid #f0f0f0"><td>'+badge+'</td><td style="font-weight:600;font-size:12px">'+n+'</td><td style="font-size:11px;font-family:monospace;color:#888">'+(c.bizNo||'-')+'</td><td style="text-align:center;font-weight:700">'+(c.saleCount+c.expCount)+'</td><td class="am pos" style="font-weight:700">'+(c.sales?fm(c.sales):'')+'</td><td class="am neg" style="font-weight:700">'+(c.expense?fm(c.expense):'')+'</td><td style="font-size:11px;color:var(--sub)">'+fD(c.lastDate)+'</td></tr>';
  });
  // í•©ê³„
  var totalS=sorted.reduce(function(a,e){return a+e[1].sales},0);
  var totalE=sorted.reduce(function(a,e){return a+e[1].expense},0);
  h+='<tr style="background:#f8f9fa;border-top:2px solid #333;font-weight:800"><td colspan="3" style="text-align:right">í•©ê³„</td><td style="text-align:center">'+sorted.reduce(function(a,e){return a+e[1].saleCount+e[1].expCount},0)+'</td><td class="am pos" style="font-size:14px">'+fm(totalS)+'</td><td class="am neg" style="font-size:14px">'+fm(totalE)+'</td><td></td></tr>';
  h+='</tbody></table></div>';
  document.getElementById('client-mgmt').innerHTML=h;
  // ë¯¸ìˆ˜ê¸ˆ ë¶„ì„
  var recHtml='';
  if(D.bank.length&&D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}).length){
    var taxSales=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'});
    var bankIn=D.bank.reduce(function(a,r){return a+r.inAmt},0);
    var taxTotal=taxSales.reduce(function(a,r){return a+r.supply+r.tax},0);
    if(taxTotal>bankIn){recHtml='<div style="color:var(--or);font-weight:700"><i class="fas fa-exclamation-triangle" style="margin-right:4px"></i>ì¶”ì • ë¯¸ìˆ˜ê¸ˆ: '+fm(taxTotal-bankIn)+'ì›</div><div style="color:var(--sub);font-size:11px;margin-top:4px">ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì•¡ ëŒ€ë¹„ í†µì¥ ì…ê¸ˆ ë¶€ì¡±ë¶„</div>'}
    else recHtml='<div style="color:var(--gn)"><i class="fas fa-check-circle" style="margin-right:4px"></i>ë¯¸ìˆ˜ê¸ˆ ì—†ìŒ (ì…ê¸ˆ í™•ì¸ ì™„ë£Œ)</div>';
  }else recHtml='<div style="color:var(--sub)">í†µì¥+ì„¸ê¸ˆê³„ì‚°ì„œ ëª¨ë‘ ì—…ë¡œë“œí•˜ë©´ ë¯¸ìˆ˜ê¸ˆ ìë™ ì¶”ì </div>';
  document.getElementById('receivable-list').innerHTML=recHtml;
}

// === ê³ ê°ìš© ì›”ê°„ ë¦¬í¬íŠ¸ PDF ===
function exClientReport(){
  var b=getBaseNumbers();
  var doc=new jspdf.jsPDF('p','mm','a4');
  var now=new Date();var mStr=(now.getMonth()+1)+'ì›”';
  // í—¤ë”
  doc.setFillColor(26,43,75);doc.rect(0,0,210,45,'F');
  doc.setTextColor(255,215,0);doc.setFont('helvetica','bold');doc.setFontSize(22);doc.text('YJ Partners',14,18);
  doc.setTextColor(255,255,255);doc.setFontSize(14);doc.text('Monthly Tax Report - '+calYear+'.'+mStr,14,28);
  doc.setFontSize(10);doc.text('Representative: Ji Yunjin | Prepared: '+now.toISOString().slice(0,10),14,38);
  // KPI
  doc.setTextColor(0,0,0);doc.setFontSize(14);doc.setFont('helvetica','bold');doc.text('Financial Summary',14,56);
  doc.setFontSize(11);doc.setFont('helvetica','normal');
  doc.text('Total Revenue: '+fm(b.ts)+' KRW',14,66);
  doc.text('Total Expense: '+fm(b.te)+' KRW',14,74);
  doc.text('Net Profit: '+fm(b.income)+' KRW',14,82);
  // ì„¸ê¸ˆ
  doc.setFont('helvetica','bold');doc.text('Tax Estimates',14,96);doc.setFont('helvetica','normal');
  doc.text('VAT (Estimated): '+fm(b.vat)+' KRW',14,106);
  var taxBase=Math.max(b.income-1500000,0);var incTax=Math.round(calcIncomeTax(taxBase));
  doc.text('Income Tax (Est.): '+fm(incTax)+' KRW (Youth Startup 50% applied)',14,114);
  doc.text('Total Tax: '+fm(b.vat+incTax)+' KRW',14,122);
  // ê±°ë˜ì²˜
  if(D.tax.length){
    doc.setFont('helvetica','bold');doc.text('Tax Invoice Details',14,136);
    doc.autoTable({startY:140,head:[['Date','Type','Client','Supply','Tax']],body:D.tax.map(function(r){return[r.date,r.type,r.client,fm(r.supply),fm(r.tax)]}),styles:{fontSize:8},headStyles:{fillColor:[26,43,75]}});
  }
  // ì ˆì„¸ íŒ
  var y=doc.lastAutoTable?doc.lastAutoTable.finalY+15:160;
  doc.setFont('helvetica','bold');doc.setFontSize(11);doc.text('Tax Saving Tips',14,y);
  doc.setFont('helvetica','normal');doc.setFontSize(9);
  doc.text('1. Youth Startup Tax Reduction: 50% (Active)',14,y+10);
  doc.text('2. Non-deductible items: '+fm(b.ndTx)+' KRW - Consider proper documentation',14,y+18);
  doc.text('3. Yellow Umbrella: Up to 5M KRW income deduction available',14,y+26);
  // í‘¸í„°
  doc.setFillColor(26,43,75);doc.rect(0,282,210,15,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(8);doc.text('YJ Partners Tax Report | Confidential | Generated by YJ Tax Master',14,290);
  doc.save('YJ_Monthly_Report_'+calYear+mStr+'.pdf');
}


// === Gemini AI ì˜ìˆ˜ì¦ ìŠ¤ìº” ===
function openGeminiSettings(){openSettings()}
function closeGeminiSettings(){closeSettings()}
function saveGeminiKey(){var k=document.getElementById('gemini-api-key').value.trim();if(!k){alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}localStorage.setItem('yjtax_gemini_key',k);updateGeminiBadge();showToast('âœ… Gemini API Key ì €ì¥ ì™„ë£Œ')}
function updateGeminiStatus(){updateGeminiBadge()}

// === Claude AI ì—°ë™ ===
function saveClaudeKey(){var k=document.getElementById('claude-api-key').value.trim();if(!k){alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}localStorage.setItem('yjtax_claude_key',k);updateClaudeBadge();showToast('âœ… Claude API Key ì €ì¥ ì™„ë£Œ')}
function updateClaudeBadge(){var k=localStorage.getItem('yjtax_claude_key');var b=document.getElementById('claude-badge');if(!b)return;if(k){b.textContent='âœ… ì—°ë™';b.style.background='#FEF3C7';b.style.color='#92400E'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999'}}

// === Perplexity AI ì—°ë™ ===
function savePerplexityKey(){var k=document.getElementById('perplexity-api-key').value.trim();if(!k){alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}localStorage.setItem('yjtax_perplexity_key',k);updatePerplexityBadge();showToast('âœ… Perplexity API Key ì €ì¥ ì™„ë£Œ')}
function updatePerplexityBadge(){var k=localStorage.getItem('yjtax_perplexity_key');var b=document.getElementById('perplexity-badge');if(!b)return;if(k){b.textContent='âœ… ì—°ë™';b.style.background='#E0F2F1';b.style.color='#00695C'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999'}}

// === Alpha Vantage ì—°ë™ ===
function saveAlphaKey(){var k=document.getElementById('alpha-api-key').value.trim();if(!k){alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return}localStorage.setItem('yjtax_alpha_key',k);updateAlphaBadge();showToast('âœ… Alpha Vantage API Key ì €ì¥ ì™„ë£Œ')}
function updateAlphaBadge(){var k=localStorage.getItem('yjtax_alpha_key');var b=document.getElementById('alpha-badge');if(!b)return;if(k){b.textContent='âœ… ì—°ë™';b.style.background='#FFF3E0';b.style.color='#BF360C'}else{b.textContent='ë¯¸ì—°ë™';b.style.background='#f0f0f0';b.style.color='#999'}}

// === Perplexity AI ê²€ìƒ‰/ë¦¬ì„œì¹˜ í˜¸ì¶œ ===
async function callPerplexity(query){
  var key=localStorage.getItem('yjtax_perplexity_key');
  if(!key)return null;
  try{
    var resp=await fetch('https://api.perplexity.ai/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model:'sonar',messages:[{role:'system',content:'ë‹¹ì‹ ì€ í•œêµ­ ì„¸ë¬´/íšŒê³„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìµœì‹  ì„¸ë²•ê³¼ ì‹¤ë¬´ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”. í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”.'},{role:'user',content:query}],max_tokens:1500})
    });
    if(!resp.ok)return null;
    var data=await resp.json();
    return data.choices&&data.choices[0]?data.choices[0].message.content:null;
  }catch(e){console.error('Perplexity API error:',e);return null}
}

// === Gemini API í˜¸ì¶œ (ë°±ì—… í‚¤ ìë™ í´ë°±) ===
async function callGeminiWithFallback(bodyJson){
  var mainKey=localStorage.getItem('yjtax_gemini_key');
  var backupKey=localStorage.getItem('yjtax_gemini_backup');
  var keys=[];
  if(mainKey)keys.push(mainKey);
  if(backupKey)keys.push(backupKey);
  if(!keys.length)return null;
  for(var i=0;i<keys.length;i++){
    try{
      var resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+keys[i],{
        method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(bodyJson)
      });
      if(resp.ok){
        var data=await resp.json();
        if(data.candidates&&data.candidates[0])return data;
      }else if(resp.status===429||resp.status===403||resp.status===500){
        console.log('[YJ Tax] Gemini key '+(i+1)+' ì‹¤íŒ¨ ('+resp.status+'), '+(i<keys.length-1?'ë°±ì—… í‚¤ë¡œ ì¬ì‹œë„...':'ëª¨ë“  í‚¤ ì†Œì§„'));
        continue;
      }else{
        return null;
      }
    }catch(e){
      console.error('[YJ Tax] Gemini key '+(i+1)+' ì—ëŸ¬:',e);
      if(i<keys.length-1)continue;
    }
  }
  return null;
}

async function callClaude(prompt,maxTokens){
  var key=localStorage.getItem('yjtax_claude_key');
  if(!key)return null;
  try{
    var resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:maxTokens||1000,messages:[{role:'user',content:prompt}]})
    });
    var data=await resp.json();
    if(data.content&&data.content[0])return data.content[0].text;
    if(data.error)console.error('Claude API error:',data.error.message);
    return null;
  }catch(e){console.error('Claude call error:',e);return null}
}

// ê±°ë˜ì²˜ëª…ìœ¼ë¡œ ê²½ë¹„ë¶„ë¥˜ AI ì¶”ì²œ
async function claudeClassifyItem(clientName,amount,idx){
  var select=document.querySelector('.card-classify-select[data-idx="'+idx+'"]');
  if(!select)return;
  var key=localStorage.getItem('yjtax_claude_key');
  if(!key){
    // Claude ì—†ìœ¼ë©´ Gemini ì‹œë„
    var gKey=localStorage.getItem('yjtax_gemini_key');
    if(gKey){geminiClassifyItem(clientName,amount,idx);return}
    return;
  }
  // AI ë¡œë”© í‘œì‹œ
  var wrap=document.getElementById('cc-'+idx);
  var oldHtml=wrap.innerHTML;
  var aiTag=document.createElement('div');aiTag.id='ai-loading-'+idx;
  aiTag.style.cssText='font-size:10px;color:#D97706;margin-top:4px;display:flex;align-items:center;gap:4px';
  aiTag.innerHTML='<i class="fas fa-spinner fa-spin"></i> Claude AI ë¶„ë¥˜ ì¤‘...';
  wrap.appendChild(aiTag);
  
  var prompt='í•œêµ­ ì‚¬ì—…ì(ê²½ì˜ì»¨ì„¤íŒ…ì—…)ì˜ ë§¤ì… ê±°ë˜ 1ê±´ì„ ê²½ë¹„ ë¶„ë¥˜í•´ì¤˜.\nê±°ë˜ì²˜: '+clientName+'\nê¸ˆì•¡: '+amount+'ì›\n\në‹¤ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•´ì„œ ê·¸ ê°’ë§Œ ë°˜í™˜(ë”°ì˜´í‘œ/ì„¤ëª… ì—†ì´):\në…¸íŠ¸ë¶/PC\nëª¨ë‹ˆí„°/ì¥ë¹„\nì†Œí”„íŠ¸ì›¨ì–´\nê´‘ê³ ë¹„\nì‚¬ë¬´ìš©í’ˆ\nì°¨ëŸ‰ìœ ì§€ë¹„\ní†µì‹ ë¹„\nêµìœ¡ë¹„\nì ‘ëŒ€ë¹„\nê¸°íƒ€ê²½ë¹„';
  
  var result=await callClaude(prompt,50);
  var el=document.getElementById('ai-loading-'+idx);
  if(el)el.remove();
  
  if(result){
    var cleaned=result.trim().replace(/['"]/g,'');
    // selectì—ì„œ ë§¤ì¹­ë˜ëŠ” option ì°¾ê¸°
    var options=select.options;
    for(var i=0;i<options.length;i++){
      if(options[i].value===cleaned){
        select.value=cleaned;
        // AI ì¶”ì²œ í‘œì‹œ
        var tag=document.createElement('div');
        tag.style.cssText='font-size:10px;color:#D97706;margin-top:4px;display:flex;align-items:center;gap:4px';
        tag.innerHTML='<i class="fas fa-brain" style="font-size:9px"></i> Claude ì¶”ì²œ: <b>'+cleaned+'</b>';
        wrap.appendChild(tag);
        calcSim();
        return;
      }
    }
    // ì •í™• ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ë¶€ë¶„ ë§¤ì¹­
    for(var i=0;i<options.length;i++){
      if(options[i].value&&cleaned.indexOf(options[i].value)>-1||options[i].value.indexOf(cleaned)>-1){
        select.value=options[i].value;
        var tag=document.createElement('div');
        tag.style.cssText='font-size:10px;color:#D97706;margin-top:4px;display:flex;align-items:center;gap:4px';
        tag.innerHTML='<i class="fas fa-brain" style="font-size:9px"></i> Claude ì¶”ì²œ: <b>'+options[i].value+'</b>';
        wrap.appendChild(tag);
        calcSim();
        return;
      }
    }
  }
}

// Gemini í´ë°± ê²½ë¹„ë¶„ë¥˜
async function geminiClassifyItem(clientName,amount,idx){
  var key=localStorage.getItem('yjtax_gemini_key');if(!key&&!localStorage.getItem('yjtax_gemini_backup'))return;
  var select=document.querySelector('.card-classify-select[data-idx="'+idx+'"]');if(!select)return;
  var wrap=document.getElementById('cc-'+idx);
  var aiTag=document.createElement('div');aiTag.id='ai-loading-'+idx;
  aiTag.style.cssText='font-size:10px;color:#4285F4;margin-top:4px;display:flex;align-items:center;gap:4px';
  aiTag.innerHTML='<i class="fas fa-spinner fa-spin"></i> Gemini AI ë¶„ë¥˜ ì¤‘...';
  wrap.appendChild(aiTag);

  try{
    var data=await callGeminiWithFallback({contents:[{parts:[{text:'í•œêµ­ ì‚¬ì—…ì(ê²½ì˜ì»¨ì„¤íŒ…ì—…)ì˜ ë§¤ì… ê±°ë˜ 1ê±´ì„ ê²½ë¹„ ë¶„ë¥˜í•´ì¤˜.\nê±°ë˜ì²˜: '+clientName+'\nê¸ˆì•¡: '+amount+'ì›\n\në‹¤ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•´ì„œ ê·¸ ê°’ë§Œ ë°˜í™˜(ë”°ì˜´í‘œ/ì„¤ëª… ì—†ì´):\në…¸íŠ¸ë¶/PC\nëª¨ë‹ˆí„°/ì¥ë¹„\nì†Œí”„íŠ¸ì›¨ì–´\nê´‘ê³ ë¹„\nì‚¬ë¬´ìš©í’ˆ\nì°¨ëŸ‰ìœ ì§€ë¹„\ní†µì‹ ë¹„\nêµìœ¡ë¹„\nì ‘ëŒ€ë¹„\nê¸°íƒ€ê²½ë¹„'}]}]});
    var result=data&&data.candidates&&data.candidates[0]?data.candidates[0].content.parts[0].text.trim():'';
    var el=document.getElementById('ai-loading-'+idx);if(el)el.remove();
    if(result){
      var cleaned=result.replace(/['"]/g,'').trim();
      var options=select.options;
      for(var i=0;i<options.length;i++){
        if(options[i].value===cleaned||options[i].value.indexOf(cleaned)>-1||cleaned.indexOf(options[i].value)>-1){
          select.value=options[i].value;
          var tag=document.createElement('div');tag.style.cssText='font-size:10px;color:#4285F4;margin-top:4px;display:flex;align-items:center;gap:4px';
          tag.innerHTML='<i class="fas fa-wand-magic-sparkles" style="font-size:9px"></i> Gemini ì¶”ì²œ: <b>'+options[i].value+'</b>';
          wrap.appendChild(tag);calcSim();return;
        }
      }
    }
  }catch(e){var el=document.getElementById('ai-loading-'+idx);if(el)el.remove()}
}

// Claude ì „ì²´ ë§¤ì… ë¶ˆê³µì œ ë¶„ì„
async function claudeDeductAnalysis(silent){
  var key=localStorage.getItem('yjtax_claude_key');
  if(!key){if(!silent)alert('âš™ï¸ ì„¤ì •ì—ì„œ Claude API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');return}
  var purchases=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  if(!purchases.length){if(!silent)alert('ë§¤ì… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return}
  showToast('ğŸ§  Claude AI ë¶ˆê³µì œ ì‹¬ì¸µ ë¶„ì„ ì¤‘...');
  
  var prompt='ë‹¹ì‹ ì€ 30ë…„ì°¨ í•œêµ­ ì„¸ë¬´ì‚¬ì…ë‹ˆë‹¤.\nì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤(365-35-00893) ì§€ìœ¤ì§„ ëŒ€í‘œì˜ ë§¤ì… ë‚´ì—­ì„ ë¶„ì„í•˜ì„¸ìš”.\n\n[ì‚¬ì—…ì ì •ë³´]\n- ì—…ì¢…: í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ…, ê°€ë§¹ì˜ì—…ëŒ€í–‰, ì–‘ë„ì–‘ìˆ˜ ì¤‘ê°œ\n- ê±°ë˜ì²˜: (ì£¼)ë‚´ì¼ì‚¬ì¥, (ì£¼)ì›ìœŒì•¤ì½”\n- 1ì¸ ì‚¬ì—…ì, ì§ì› ì—†ìŒ, ì‚¬ì—…ì¥=ìíƒ\n- ì¹´ë“œ: ê°œì¸+ì‚¬ì—… í˜¼ìš©\n- ì°¨ëŸ‰: ë³¸ì¸ ëª…ì˜ ì•„ë‹˜\n\n[íŒë‹¨ ê¸°ì¤€]\n- ì»¨ì„¤íŒ…/ì˜ì—…ëŒ€í–‰ ì§ì ‘ ê´€ë ¨ = ê³µì œ\n- êµí†µë¹„/í†µì‹ ë¹„/ì¸í„°ë„·/ì‚¬ë¬´ìš©í’ˆ/SW = ê³µì œ\n- ê±°ë˜ì²˜ ë¯¸íŒ… ì‹ëŒ€ = ì ‘ëŒ€ë¹„ (ë§¤ì…ì„¸ì•¡ ë¶ˆê³µì œ, í•„ìš”ê²½ë¹„ ì¸ì •)\n- ê°œì¸ìš©ë„(ì‹ì‚¬/ìƒí™œ/ì˜ë¥˜/ë¯¸ìš©) = ë¶ˆê³µì œ\n- ë¹„ì˜ì—…ìš© ìŠ¹ìš©ì°¨(ë³¸ì¸ëª…ì˜ ì•„ë‹˜) = ë¶ˆê³µì œ\n- ì ‘ëŒ€ë¹„ = ë¶ˆê³µì œ (ë¶€ê°€ì„¸)\n\nJSON ë°°ì—´ë§Œ ë°˜í™˜:\n[{"index":0,"deductible":"ê³µì œ","reason":"ì‚¬ìœ ","category":"ê²½ë¹„ë¶„ë¥˜"}]\n\ncategory: ì—¬ë¹„êµí†µë¹„, ì ‘ëŒ€ë¹„, íšŒì˜ë¹„, í†µì‹ ë¹„, ì†Œëª¨í’ˆë¹„, ê´‘ê³ ë¹„, êµìœ¡í›ˆë ¨ë¹„, ì°¨ëŸ‰ìœ ì§€ë¹„, ì‚¬ë¬´ì‹¤ê²½ë¹„, ì†Œí”„íŠ¸ì›¨ì–´, ê¸°íƒ€ê²½ë¹„ ì¤‘ íƒ1\n\në§¤ì… ë‚´ì—­:\n';
  purchases.forEach(function(r,i){prompt+=i+'. '+r.client+' | ê³µê¸‰ê°€ì•¡ '+r.supply+'ì› | ì„¸ì•¡ '+r.tax+'ì› | '+r.date+'\n'});
  
  var result=await callClaude(prompt,2000);
  if(!result){showToast('âŒ Claude API í˜¸ì¶œ ì‹¤íŒ¨');return}
  
  try{
    var jsonStr=result.replace(/```json\n?/g,'').replace(/```/g,'').trim();
    var results=JSON.parse(jsonStr);
    var changed=0;
    results.forEach(function(r){
      if(r.index>=0&&r.index<purchases.length){
        var old=purchases[r.index].deductible;
        purchases[r.index].deductible=r.deductible||old;
        purchases[r.index].aiReason=r.reason||'';
        purchases[r.index].aiCategory=r.category||'';
        if(old!==purchases[r.index].deductible)changed++;
      }
    });
    
    var html='<div style="max-height:350px;overflow-y:auto">';
    results.forEach(function(r){
      if(r.index>=0&&r.index<purchases.length){
        var p=purchases[r.index];var isOk=r.deductible==='ê³µì œ';
        html+='<div style="display:flex;align-items:flex-start;gap:10px;padding:10px;background:'+(isOk?'#E8F5E9':'#FFEBEE')+';border-radius:8px;margin-bottom:4px">';
        html+='<div style="width:28px;height:28px;border-radius:50%;background:'+(isOk?'#4CAF50':'#F44336')+';color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">'+(isOk?'âœ…':'âŒ')+'</div>';
        html+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">'+p.client+' <span style="color:#999;font-weight:400">'+fm(p.supply)+'ì›</span></div>';
        html+='<div style="font-size:11px;color:'+(isOk?'#2E7D32':'#C62828')+'">'+r.deductible+': '+r.reason+'</div>';
        if(r.category)html+='<div style="font-size:10px;color:#D97706;margin-top:2px"><i class="fas fa-tag"></i> ë¶„ë¥˜: '+r.category+'</div>';
        html+='</div></div>';
      }
    });
    html+='</div>';
    
    if(!silent){
      openModal('ğŸ§  Claude AI ì‹¬ì¸µ ë¶„ì„ ('+changed+'ê±´ ë³€ê²½)',html+'<div style="display:flex;gap:8px;margin-top:12px"><button onclick="document.getElementById(\'mo\').classList.remove(\'show\');resetModal();rTbls();renderDD();rChart()" style="flex:1;padding:12px;background:var(--gn);color:#fff;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer"><i class="fas fa-check"></i> ì ìš©</button><button onclick="document.getElementById(\'mo\').classList.remove(\'show\');resetModal()" style="flex:1;padding:12px;background:#eee;color:#333;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;cursor:pointer">ë‹«ê¸°</button></div>');
    }else{rTbls();renderDD();rChart()}
    showToast('ğŸ§  Claude ë¶„ì„ ì™„ë£Œ! '+changed+'ê±´ ë³€ê²½');
  }catch(e){showToast('âŒ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨');console.error(e)}
}
function showToast(msg){var t=document.getElementById('ai-toast');document.getElementById('ai-toast-msg').innerHTML=msg;t.style.display='block';setTimeout(function(){t.style.display='none'},3000)}

function triggerReceiptScan(){var k=localStorage.getItem('yjtax_gemini_key')||localStorage.getItem('yjtax_gemini_backup');if(!k){alert('âš™ï¸ ì„¤ì •ì—ì„œ Gemini API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.\n\nìš°ì¸¡ ìƒë‹¨ âœ¨ ë²„íŠ¼ í´ë¦­ â†’ API Key ì…ë ¥');return}document.getElementById('receipt-file').click()}

async function scanReceipt(input){
  if(!input.files||!input.files[0])return;
  var file=input.files[0];var apiKey=localStorage.getItem('yjtax_gemini_key');
  if(!apiKey){alert('ì„¤ì •ì—ì„œ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');return}
  showToast('ğŸ”„ AIê°€ ì˜ìˆ˜ì¦ì„ ë¶„ì„ ì¤‘...');
  try{
    var base64=await new Promise(function(res){var r=new FileReader();r.onload=function(e){res(e.target.result.split(',')[1])};r.readAsDataURL(file)});
    var bodyJson={contents:[{parts:[
      {inline_data:{mime_type:file.type,data:base64}},
      {text:'ì´ ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì„œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥í•´.\n{"date":"YYYY-MM-DD","client":"ê±°ë˜ì²˜ëª…","amount":ìˆ«ìë§Œ,"item":"í’ˆëª©ëª…"}'}
    ]}]};
    var data=await callGeminiWithFallback(bodyJson);
    if(!data){showToast('âŒ Gemini API í˜¸ì¶œ ì‹¤íŒ¨ (ë©”ì¸+ë°±ì—… í‚¤ ëª¨ë‘ ì‹¤íŒ¨)');return}
    if(data.error){showToast('âŒ API ì˜¤ë¥˜: '+data.error.message);return}
    var text=data.candidates[0].content.parts[0].text;
    var clean=text.replace(/```json|```/g,'').trim();
    var parsed=JSON.parse(clean);
    // ìë™ ì…ë ¥ â†’ ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì…ìœ¼ë¡œ ì¶”ê°€
    if(parsed.date&&parsed.amount){
      D.tax.push({date:parsed.date,type:'ë§¤ì…',client:parsed.client||parsed.item||'AIìŠ¤ìº”',supply:parsed.amount,tax:Math.round(parsed.amount*0.1),deductible:'ê³µì œ'});
      D.isDemo=false;rAll();
      showToast('âœ… AIê°€ ì˜ìˆ˜ì¦ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤: '+fm(parsed.amount)+'ì› ('+(parsed.client||parsed.item)+')');
    }else{showToast('âš ï¸ ì˜ìˆ˜ì¦ ì •ë³´ë¥¼ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.')}
  }catch(e){showToast('âŒ ë¶„ì„ ì‹¤íŒ¨: '+e.message)}
  input.value='';
}

// === ìŠ¤ë§ˆíŠ¸ ë§¤ì… ë¶„ë¥˜ ===
function openSmartPurchase(){document.getElementById('smart-purchase-modal').style.display='flex';renderSmartList('')}
function closeSmartPurchase(){document.getElementById('smart-purchase-modal').style.display='none'}
function filterSmartPurchase(q){renderSmartList(q)}
function renderSmartList(q){
  var all=[];
  D.bank.forEach(function(r){if(r.outAmt>0)all.push({date:r.date,desc:r.desc,amount:r.outAmt,src:'í†µì¥'})});
  D.card.forEach(function(r){if(r.type==='ë§¤ì…')all.push({date:r.date,desc:r.merchant,amount:r.amount,src:'ì¹´ë“œ'})});
  D.etc.forEach(function(r){all.push({date:r.date,desc:r.desc,amount:r.amount,src:'ê¸°íƒ€'})});
  if(q){q=q.toLowerCase();all=all.filter(function(r){return(r.desc+r.date+r.amount).toLowerCase().indexOf(q)>-1})}
  all.sort(function(a,b){return b.amount-a.amount});
  var el=document.getElementById('smart-purchase-list');
  if(!all.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--sub)">ë‚´ì—­ ì—†ìŒ â€” í†µì¥/ì¹´ë“œ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”</div>';return}
  el.innerHTML=all.slice(0,30).map(function(r,i){
    return'<div onclick="pickSmartItem('+i+')" style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #e0e0e0;border-radius:var(--rs);margin-bottom:4px;cursor:pointer;transition:all .15s" onmouseover="this.style.background=\'#f0f7ff\'" onmouseout="this.style.background=\'#fff\'">'
    +'<div style="width:32px;height:32px;border-radius:8px;background:'+(r.src==='í†µì¥'?'#E3F2FD':r.src==='ì¹´ë“œ'?'#F3E5F5':'#ECEFF1')+';display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0"><i class="fas '+(r.src==='í†µì¥'?'fa-building-columns':r.src==='ì¹´ë“œ'?'fa-credit-card':'fa-file')+'"></i></div>'
    +'<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.desc+'</div><div style="font-size:10px;color:var(--sub)">'+(r.date||'')+' Â· '+r.src+'</div></div>'
    +'<div style="font-size:13px;font-weight:700;color:var(--rd);white-space:nowrap">'+fm(r.amount)+'ì›</div>'
    +'</div>';
  }).join('');
  window._smartItems=all.slice(0,30);
}
function pickSmartItem(i){
  var item=window._smartItems[i];if(!item)return;
  // ë§¤ì…ìœ¼ë¡œ ì¶”ê°€ (ë¶€ê°€ì„¸ 10% í¬í•¨ ì—­ì‚°)
  var supply=Math.round(item.amount/1.1);var tax=item.amount-supply;
  D.tax.push({date:item.date||new Date().toISOString().slice(0,10),type:'ë§¤ì…',client:item.desc,supply:supply,tax:tax,deductible:'ê³µì œ'});
  D.isDemo=false;rAll();
  closeSmartPurchase();
  showToast('âœ… ë§¤ì… ì¶”ê°€: '+item.desc+' '+fm(item.amount)+'ì› (ë¶€ê°€ì„¸ ì ˆê° '+fm(tax)+'ì›)');
}

// === CSV ì „ì²´ ë°±ì—… ===
function exportAllCSV(){
  var rows=[['ë‚ ì§œ','ë¶„ë¥˜','ê±°ë˜ì²˜/ì ìš”','ì…ê¸ˆ/ê³µê¸‰ê°€ì•¡','ì¶œê¸ˆ/ì„¸ì•¡','ê³µì œì—¬ë¶€','ì¶œì²˜']];
  D.tax.forEach(function(r){rows.push([r.date,r.type,r.client,r.supply,r.tax,r.deductible,'ì„¸ê¸ˆê³„ì‚°ì„œ'])});
  D.bank.forEach(function(r){rows.push([r.date,'í†µì¥',r.desc,r.inAmt,r.outAmt,'','í†µì¥'])});
  D.card.forEach(function(r){rows.push([r.date,'ì¹´ë“œ',r.merchant,r.type==='ë§¤ì¶œ'?r.amount:0,r.type==='ë§¤ì…'?r.amount:0,'','ì¹´ë“œ'])});
  // ê¸‰ì—¬ ê¸°ë¡
  Object.keys(salaryLog).forEach(function(m){var r=salaryLog[m];rows.push([r.date,'ê¸‰ì—¬','ë‚´ì¼ì‚¬ì¥',r.net,0,'','ê·¼ë¡œì†Œë“'])});
  var csv=rows.map(function(r){return r.map(function(c){return'"'+String(c||'').replace(/"/g,'""')+'"'}).join(',')}).join('\n');
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='YJ_Tax_Data_'+new Date().getFullYear()+'.csv';a.click();
  showToast('ğŸ“‚ CSV ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

// === ì„¸ê¸ˆì‹ ê³  ë¦¬í¬íŠ¸ ìƒì„± ===
function generateTaxReport(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0),te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0);
  var etDed=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'});
  var etNon=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'});
  var dTx=etDed.reduce(function(a,r){return a+r.tax},0);
  var ndTx=etNon.reduce(function(a,r){return a+r.tax},0);
  var vat=sTx-dTx;
  
  // ì¹´ë“œ ë§¤ì¶œ/ë§¤ì… ë¶„ë¦¬
  var cardSales=D.card.filter(function(c){return c.type==='ë§¤ì¶œ'});
  var cardPurchase=D.card.filter(function(c){return c.type==='ë§¤ì…'||c.type!=='ë§¤ì¶œ'});
  var cardSalesAmt=cardSales.reduce(function(a,c){return a+c.amount},0);
  var cardPurchaseAmt=cardPurchase.reduce(function(a,c){return a+c.amount},0);
  
  // ì†Œë“ ë°ì´í„°
  var salMon=parseInt(document.getElementById('salary-monthly').value||0)*10000;
  var salAnnual=salMon*12;
  var bt2=getBonusByType();
  var bonusType=bt2.salary>bt2.dividend?'salary':'dividend';
  var bonusAmt=bt2.salary+bt2.dividend;
  var bizIncome=ts-te;
  var logKeys=Object.keys(salaryLog);
  var totalNetPaid=logKeys.reduce(function(a,k){return a+salaryLog[k].net},0);
  
  var wb=XLSX.utils.book_new();
  
  // ================================================================
  // Sheet 1: ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ì„œ (í™ˆíƒìŠ¤ ì–‘ì‹ ë§¤ì¹­)
  // ================================================================
  var v=[];
  var now=new Date();var vatPeriod=now.getMonth()<6?'1ê¸°':'2ê¸°';var vatType=now.getMonth()%6<3?'ì˜ˆì •':'í™•ì •';
  v.push(['','ì¼ë°˜ê³¼ì„¸ì ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ì„œ','','','','']);
  v.push(['','ì‚¬ì—…ì: ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ (365-35-00893) ì§€ìœ¤ì§„','','ì‹ ê³ ê¸°ê°„: '+now.getFullYear()+'ë…„ '+vatPeriod+' '+vatType,'','']);
  v.push(['']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ê³¼ì„¸í‘œì¤€ ë° ë§¤ì¶œì„¸ì•¡','','ê±´ìˆ˜','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ë¹„ê³ ']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['(1) ì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰ë¶„','',st.length,ts,sTx,'â† í™ˆíƒìŠ¤ (1)ë²ˆ']);
  v.push(['(2) ë§¤ì…ìë°œí–‰ ì„¸ê¸ˆê³„ì‚°ì„œ','',0,0,0,'']);
  v.push(['(3) ì‹ ìš©ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ë¶„','',cardSales.length,Math.round(cardSalesAmt/1.1),Math.round(cardSalesAmt/1.1*0.1),'â† í™ˆíƒìŠ¤ (3)ë²ˆ']);
  v.push(['(4) ê¸°íƒ€(í˜„ê¸ˆë§¤ì¶œ ë“±)','',0,0,0,'ì§ì ‘ ì…ë ¥']);
  v.push(['(9) í•©ê³„','',st.length+cardSales.length,ts+Math.round(cardSalesAmt/1.1),sTx+Math.round(cardSalesAmt/1.1*0.1),'']);
  v.push(['']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ë§¤ì…ì„¸ì•¡','','ê±´ìˆ˜','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ë¹„ê³ ']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['(10) ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨ë¶„ (ì¼ë°˜ë§¤ì…)','',etDed.length,etDed.reduce(function(a,r){return a+r.supply},0),dTx,'â† í™ˆíƒìŠ¤ (10)ë²ˆ']);
  v.push(['(11) ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨ë¶„ (ê³ ì •ìì‚°)','',0,0,0,'í•´ë‹¹ ì‹œ ì…ë ¥']);
  v.push(['(14) ì‹ ìš©ì¹´ë“œ ë§¤ì…ë¶„','',cardPurchase.length,Math.round(cardPurchaseAmt/1.1),Math.round(cardPurchaseAmt/1.1*0.1),'â† í™ˆíƒìŠ¤ (14)ë²ˆ']);
  v.push(['(16) í•©ê³„','',etDed.length+cardPurchase.length,etDed.reduce(function(a,r){return a+r.supply},0)+Math.round(cardPurchaseAmt/1.1),dTx+Math.round(cardPurchaseAmt/1.1*0.1),'']);
  v.push(['']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ê³µì œë°›ì§€ ëª»í•  ë§¤ì…ì„¸ì•¡','','ê±´ìˆ˜','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ì‚¬ìœ ']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  etNon.forEach(function(r){v.push(['(49) ë¶ˆê³µì œ',r.client,1,r.supply,r.tax,r.deductible||'ë¹„ì˜ì—…ìš©/ê°œì¸ìš©'])});
  if(!etNon.length)v.push(['(49) ë¶ˆê³µì œ','í•´ë‹¹ ì—†ìŒ',0,0,0,'']);
  v.push(['ë¶ˆê³µì œ í•©ê³„','',etNon.length,etNon.reduce(function(a,r){return a+r.supply},0),ndTx,'']);
  v.push(['']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ë‚©ë¶€(í™˜ê¸‰)ì„¸ì•¡ ê³„ì‚°','','','','ê¸ˆì•¡','']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['(53) ì°¨ê°Â·ê°€ê°ê³„ (ë§¤ì¶œì„¸ì•¡-ë§¤ì…ì„¸ì•¡)','','','',vat,'â† í™ˆíƒìŠ¤ì— ìë™ ê³„ì‚°']);
  v.push(['(62) ì˜ˆì •ì‹ ê³  ë¯¸í™˜ê¸‰ì„¸ì•¡','','','',0,'ì „ê¸° ë¯¸í™˜ê¸‰ ìˆìœ¼ë©´ ì…ë ¥']);
  v.push(['(64) ì˜ˆì •ê³ ì§€ì„¸ì•¡','','','',0,'ê³ ì§€ì„œ ê¸ˆì•¡ ì…ë ¥']);
  v.push(['(65) ì „ìì‹ ê³  ì„¸ì•¡ê³µì œ','','','',10000,'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ì‹œ (ì¡°íŠ¹ë²•Â§104ì¡°ì˜8)']);
  var vatFinal=Math.max(vat-10000,0);
  v.push(['(73) ì°¨ê°ë‚©ë¶€(í™˜ê¸‰)ì„¸ì•¡','','','',vatFinal,'â˜… ì´ ê¸ˆì•¡ì„ ë‚©ë¶€']);
  v.push(['']);
  
  // ë§¤ì¶œì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ë§¤ì¶œì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œí•©ê³„í‘œ','','','','','']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ìƒí˜¸','ê±´ìˆ˜','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ë¹„ê³ ']);
  // ê±°ë˜ì²˜ë³„ ì§‘ê³„
  var salesByClient={};
  st.forEach(function(r){
    var k=r.client||'ë¯¸ì§€ì •';
    if(!salesByClient[k])salesByClient[k]={count:0,supply:0,tax:0,bizNo:r.bizNo||''};
    salesByClient[k].count++;salesByClient[k].supply+=r.supply;salesByClient[k].tax+=r.tax;
  });
  Object.keys(salesByClient).forEach(function(k){
    var c=salesByClient[k];v.push([c.bizNo||'(í™•ì¸í•„ìš”)',k,c.count,c.supply,c.tax,'']);
  });
  v.push(['í•©ê³„','',st.length,ts,sTx,'']);
  v.push(['']);
  
  // ë§¤ì…ì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ë§¤ì…ì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œí•©ê³„í‘œ','','','','','']);
  v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
  v.push(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','ìƒí˜¸','ê±´ìˆ˜','ê³µê¸‰ê°€ì•¡','ì„¸ì•¡','ê³µì œì—¬ë¶€']);
  var purchByClient={};
  et.forEach(function(r){
    var k=r.client||'ë¯¸ì§€ì •';
    if(!purchByClient[k])purchByClient[k]={count:0,supply:0,tax:0,deductible:r.deductible,bizNo:r.bizNo||''};
    purchByClient[k].count++;purchByClient[k].supply+=r.supply;purchByClient[k].tax+=r.tax;
  });
  Object.keys(purchByClient).forEach(function(k){
    var c=purchByClient[k];v.push([c.bizNo||'(í™•ì¸í•„ìš”)',k,c.count,c.supply,c.tax,c.deductible]);
  });
  v.push(['í•©ê³„','',et.length,te,dTx+ndTx,'']);
  v.push(['']);
  
  // ì‹ ìš©ì¹´ë“œ ë§¤ì… ëª…ì„¸
  if(D.card.length){
    v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
    v.push(['ì‹ ìš©ì¹´ë“œ ë§¤ì¶œì „í‘œ ë“± ìˆ˜ë ¹ëª…ì„¸ì„œ','','','','','']);
    v.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','','','']);
    v.push(['ë‚ ì§œ','ê°€ë§¹ì ëª…','ì´ê¸ˆì•¡','ê³µê¸‰ê°€ì•¡(ì¶”ì •)','ì„¸ì•¡(ì¶”ì •)','ë§¤ì¶œ/ë§¤ì…']);
    D.card.forEach(function(c){
      var sup=Math.round(c.amount/1.1);var tax=c.amount-sup;
      v.push([c.date||'',c.merchant||c.desc||'',c.amount,sup,tax,c.type||'ë§¤ì…']);
    });
    v.push(['í•©ê³„','',D.card.reduce(function(a,c){return a+c.amount},0),'','','']);
  }
  
  var ws1=XLSX.utils.aoa_to_sheet(v);
  ws1['!cols']=[{wch:35},{wch:22},{wch:10},{wch:16},{wch:16},{wch:20}];
  XLSX.utils.book_append_sheet(wb,ws1,'ë¶€ê°€ì„¸_í™ˆíƒìŠ¤_ì…ë ¥ìš©');
  
  // ================================================================
  // Sheet 2: ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ì„œ (í™ˆíƒìŠ¤ ì–‘ì‹ ë§¤ì¹­)
  // ================================================================
  // ì–µì› ë‹¨ìœ„ í¬ë§·
  var fmE=function(n){if(Math.abs(n)>=100000000)return(n/100000000).toFixed(1)+'ì–µ';if(Math.abs(n)>=10000)return fm(n)+'ì›';return fm(n)+'ì›'};
  
  var totalSalary=salAnnual+(bonusType==='salary'?bonusAmt:0);
  var salDeduct=0;
  if(totalSalary<=5000000)salDeduct=totalSalary*0.7;
  else if(totalSalary<=15000000)salDeduct=3500000+(totalSalary-5000000)*0.4;
  else if(totalSalary<=45000000)salDeduct=7500000+(totalSalary-15000000)*0.15;
  else if(totalSalary<=100000000)salDeduct=12000000+(totalSalary-45000000)*0.05;
  else salDeduct=14750000+(totalSalary-100000000)*0.02;
  salDeduct=Math.round(salDeduct);
  var salaryIncome=Math.max(totalSalary-salDeduct,0);
  var divIncome=bonusType==='dividend'?bonusAmt:0;
  var bizNet=Math.max(bizIncome,0);
  
  // â”€â”€â”€ ì¢…í•©ì†Œë“ê¸ˆì•¡ â”€â”€â”€
  var totalIncome=salaryIncome+divIncome+bizNet;
  
  // â”€â”€â”€ ê°„í¸ì¥ë¶€ vs ë³µì‹ë¶€ê¸° ìë™ íŒë³„ â”€â”€â”€
  // ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤: ë‹¤ì—…ì¢… (ì»¨ì„¤íŒ…+ì†Œë§¤+ê´‘ê³ +ë§ˆì¼€íŒ…)
  // ì£¼ëœ ì—…ì¢…: ì»¨ì„¤íŒ…(ì„œë¹„ìŠ¤ì—…) â†’ ìˆ˜ì…ê¸ˆì•¡ 7,500ë§Œì› ì´ìƒ ë³µì‹ë¶€ê¸° ì˜ë¬´
  // ì†Œë§¤ì—…ì€ 3ì–µ ë¯¸ë§Œ ê°„í¸ì¥ë¶€ ê°€ëŠ¥í•˜ì§€ë§Œ, ì£¼ëœ ì—…ì¢… ê¸°ì¤€ ì ìš©
  var bookType=ts>=75000000?'ë³µì‹ë¶€ê¸°(ì˜ë¬´)':'ê°„í¸ì¥ë¶€';
  // ì¶”ê³„ì‹ ê³  ì‹œ ê²½ë¹„ìœ¨ â€” ë‹¤ì—…ì¢… (ì£¼ëœ: ì»¨ì„¤íŒ… 940909)
  // ì»¨ì„¤íŒ…: ë‹¨ìˆœ 19.8% / ê¸°ì¤€ 12.9%
  // ì†Œë§¤ì—…: ë‹¨ìˆœ 11.0% / ê¸°ì¤€ 7.7%
  // ê´‘ê³ ëŒ€í–‰: ë‹¨ìˆœ 19.0% / ê¸°ì¤€ 12.9%
  // â†’ ì£¼ëœ ì—…ì¢…(ì»¨ì„¤íŒ…) ê¸°ì¤€ ì ìš©, ì†Œë§¤ ë³‘í–‰ ì‹œ ì—…ì¢…ë³„ ì•ˆë¶„ í•„ìš”
  var simpleExpRate=0.198; // ì»¨ì„¤íŒ… ë‹¨ìˆœê²½ë¹„ìœ¨
  var stdExpRate=0.129;    // ì»¨ì„¤íŒ… ê¸°ì¤€ê²½ë¹„ìœ¨
  var estimatedExpense=ts<75000000?Math.round(ts*simpleExpRate):Math.round(ts*stdExpRate);
  
  // â”€â”€â”€ ì ‘ëŒ€ë¹„ í•œë„ (ì†Œë“ì„¸ë²•Â§35, ë²•ì¸ì„¸ë²•Â§25) â”€â”€â”€
  // ê¸°ë³¸ 1,200ë§Œì› + (ìˆ˜ì…ê¸ˆì•¡ 100ì–µ ì´í•˜) ìˆ˜ì…ê¸ˆì•¡ Ã— 0.3%
  var entLimitBase=12000000;
  var entLimitAdd=Math.round(Math.min(ts,10000000000)*0.003);
  var entLimit=entLimitBase+entLimitAdd;
  
  // â”€â”€â”€ ì†Œë“ê³µì œ â”€â”€â”€
  var npsA=Math.round(salMon*0.045*12);
  // êµ­ë¯¼ì—°ê¸ˆ ìƒí•œ: ì›” ê¸°ì¤€ì†Œë“ì›”ì•¡ 590ë§Œì›, ë³´í—˜ë£Œ ìƒí•œ 265,500ì› (2025ë…„)
  npsA=Math.min(npsA,265500*12);
  var nhiA=Math.round(salMon*0.03545*12);
  var ltcA=Math.floor(Math.floor(salMon*0.03545)*0.9182/7.09/10)*10*12;
  var eiA=Math.round(salMon*0.009*12);
  var insTotal=npsA+nhiA+ltcA+eiA;
  var basicDeduct=1500000;
  var totalDeduct=basicDeduct+insTotal;
  var taxBase=Math.max(totalIncome-totalDeduct,0);
  
  // â”€â”€â”€ ì‚°ì¶œì„¸ì•¡ â”€â”€â”€
  var calcTax=0;
  if(taxBase<=14000000)calcTax=Math.round(taxBase*0.06);
  else if(taxBase<=50000000)calcTax=Math.round(840000+(taxBase-14000000)*0.15);
  else if(taxBase<=88000000)calcTax=Math.round(6240000+(taxBase-50000000)*0.24);
  else if(taxBase<=150000000)calcTax=Math.round(15360000+(taxBase-88000000)*0.35);
  else if(taxBase<=300000000)calcTax=Math.round(37060000+(taxBase-150000000)*0.38);
  else if(taxBase<=500000000)calcTax=Math.round(94060000+(taxBase-300000000)*0.40);
  else if(taxBase<=1000000000)calcTax=Math.round(174060000+(taxBase-500000000)*0.42);
  else calcTax=Math.round(384060000+(taxBase-1000000000)*0.45);
  
  // â”€â”€â”€ ì„¸ì•¡ê°ë©´Â·ê³µì œ (1~2ì–µ ì†Œê¸°ì—… ë§ì¶¤) â”€â”€â”€
  var eFilingCredit=20000; // ì „ìì‹ ê³  (ì¡°íŠ¹ë²•Â§104ì¡°ì˜8)
  // ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ (ì¡°íŠ¹ë²•Â§7)
  var smeRate=0.20;var smeReduction=Math.min(Math.round(calcTax*smeRate),100000000);
  // í‘œì¤€ì„¸ì•¡ê³µì œ 7ë§Œì› (ì†Œë“ì„¸ë²•Â§59ì¡°ì˜4)
  var stdCredit=70000;
  // ê¸°ì¥ì„¸ì•¡ê³µì œ (ì¡°íŠ¹ë²•Â§128ì¡°ì˜2) â€” ê°„í¸ì¥ë¶€ ëŒ€ìƒìê°€ ë³µì‹ë¶€ê¸° ê¸°ì¥ ì‹œë§Œ í•´ë‹¹
  // ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤: 1~2ì–µ ì»¨ì„¤íŒ… â†’ ë³µì‹ë¶€ê¸° ì˜ë¬´ â†’ ê¸°ì¥ì„¸ì•¡ê³µì œ í•´ë‹¹ ì—†ìŒ
  var bookCredit=0;
  if(ts<75000000){bookCredit=Math.min(Math.round(calcTax*0.2),1000000)} // ê°„í¸ì¥ë¶€ ëŒ€ìƒìë§Œ
  // í•©ê³„
  var totalCredit=eFilingCredit+smeReduction+stdCredit+bookCredit;
  var taxAfterCredit=Math.max(calcTax-totalCredit,0);
  
  // â”€â”€â”€ ê¸°ë‚©ë¶€ì„¸ì•¡ â”€â”€â”€
  var withheldSalary=logKeys.reduce(function(a,k){return a+(salMon-salaryLog[k].net)},0);
  var withheldTax=Math.round(withheldSalary*0.13);
  var withheldBonus=bonusType==='salary'?Math.round(bonusAmt*0.033):Math.round(bonusAmt*0.154);
  var totalWithheld=withheldTax+withheldBonus;
  var finalTax=taxAfterCredit-totalWithheld;
  
  // ê°€ì‚°ì„¸ ê³„ì‚° (ë‚©ë¶€ì§€ì—°/ë¬´ì‹ ê³ )
  var today=new Date();
  var vatDeadline1=new Date(today.getFullYear(),0,25); // 1ì›” 25ì¼
  var vatDeadline2=new Date(today.getFullYear(),6,25); // 7ì›” 25ì¼
  var incDeadline=new Date(today.getFullYear(),4,31); // 5ì›” 31ì¼
  var vatLate=vat>0&&today>vatDeadline2;
  var incLate=finalTax>0&&today>incDeadline;
  // ë¬´ì‹ ê³  ê°€ì‚°ì„¸: ë‚©ë¶€ì„¸ì•¡ì˜ 20%
  // ë‚©ë¶€ì§€ì—° ê°€ì‚°ì„¸: ë¯¸ë‚©ì„¸ì•¡ Ã— 0.022% Ã— ê²½ê³¼ì¼ìˆ˜
  var vatPenalty=0,incPenalty=0;
  if(vatLate){
    var vatDays=Math.floor((today-vatDeadline2)/(1000*60*60*24));
    var vatNoFile=Math.round(vat*0.2);
    // ê¸°í•œí›„ ì‹ ê³  ê°ë©´: 1ê°œì›”ë‚´ 50%, 3ê°œì›”ë‚´ 30%, 6ê°œì›”ë‚´ 20%
    if(vatDays<=30)vatNoFile=Math.round(vatNoFile*0.5);
    else if(vatDays<=90)vatNoFile=Math.round(vatNoFile*0.7);
    else if(vatDays<=180)vatNoFile=Math.round(vatNoFile*0.8);
    var vatDelay=Math.round(vat*0.00022*vatDays);
    vatPenalty=vatNoFile+vatDelay;
  }
  if(incLate){
    var incDays=Math.floor((today-incDeadline)/(1000*60*60*24));
    var incNoFile=Math.round(finalTax*0.2);
    if(incDays<=30)incNoFile=Math.round(incNoFile*0.5);
    else if(incDays<=90)incNoFile=Math.round(incNoFile*0.7);
    else if(incDays<=180)incNoFile=Math.round(incNoFile*0.8);
    var incDelay=Math.round(finalTax*0.00022*incDays);
    incPenalty=incNoFile+incDelay;
  }
  
  var t=[];
  t.push(['','ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ì„œ (í™ˆíƒìŠ¤ ì…ë ¥ìš©)','','']);
  t.push(['','ì‚¬ì—…ì: ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ (365-35-00893) | ëŒ€í‘œ: ì§€ìœ¤ì§„ | ê·€ì†ì—°ë„: 2026ë…„','','']);
  t.push(['','ì—…íƒœ: ì„œë¹„ìŠ¤/ë„ì†Œë§¤/ì „ë¬¸ê³¼í•™ê¸°ìˆ  | ì£¼ëœì¢…ëª©: ì°½ì—…ì»¨ì„¤íŒ…(940909) | ê¸°ì¥: '+bookType,'','']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â… . ì¢…í•©ì†Œë“ê¸ˆì•¡','','ê¸ˆì•¡','ë¹„ê³ ']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â‘  ì‚¬ì—…ì†Œë“ê¸ˆì•¡','',bizNet,'ë§¤ì¶œ-ë§¤ì… (ì¥ë¶€ ê¸°ì¤€)']);
  t.push(['   â”” ì´ìˆ˜ì…ê¸ˆì•¡(ë§¤ì¶œ)','',ts,st.length+'ê±´']);
  t.push(['   â”” í•„ìš”ê²½ë¹„(ë§¤ì…)','',te,et.length+'ê±´']);
  t.push(['   â”” ì¶”ê³„ ì‹œ ê²½ë¹„ìœ¨ ì°¸ê³ ','',estimatedExpense,'ì»¨ì„¤íŒ… ë‹¨ìˆœ'+Math.round(simpleExpRate*100)+'%/ê¸°ì¤€'+Math.round(stdExpRate*100)+'% (ì†Œë§¤ ë³„ë„ ì•ˆë¶„)']);
  if(divIncome>0){
    t.push(['â‘¡ ë°°ë‹¹ì†Œë“ê¸ˆì•¡','',divIncome,'ì›ì²œì§•ìˆ˜ 14% ê¸°ë‚©ë¶€']);
  }
  t.push([salaryIncome>0?'â‘¢ ê·¼ë¡œì†Œë“ê¸ˆì•¡':'â‘¢ ê·¼ë¡œì†Œë“ê¸ˆì•¡','',salaryIncome,salaryIncome>0?'ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ ì°¸ì¡°':'í•´ë‹¹ ì—†ìŒ']);
  if(salaryIncome>0){
    t.push(['   â”” ì´ê¸‰ì—¬','',totalSalary,'']);
    t.push(['   â”” ê·¼ë¡œì†Œë“ê³µì œ','',salDeduct,'ì†Œë“ì„¸ë²•Â§47']);
  }
  t.push(['â‘£ ì¢…í•©ì†Œë“ê¸ˆì•¡ í•©ê³„','',totalIncome,fm(totalIncome)+'ì›']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¡. ì†Œë“ê³µì œ','','ê¸ˆì•¡','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â‘¤ ê¸°ë³¸ê³µì œ (ë³¸ì¸)','',basicDeduct,'ë¶€ì–‘ê°€ì¡± ì¶”ê°€ ì‹œ 150ë§Œì›/ì¸']);
  if(npsA>0)t.push(['â‘¥ êµ­ë¯¼ì—°ê¸ˆë³´í—˜ë£Œ','',npsA,'4.5% (ìƒí•œ ì›” 265,500ì›)']);
  if(nhiA>0){
    t.push(['â‘¦ ê±´ê°•ë³´í—˜ë£Œ','',nhiA,'3.545%']);
    t.push(['â‘§ ì¥ê¸°ìš”ì–‘ë³´í—˜ë£Œ','',ltcA,'ê±´ë³´ì˜ 12.95%']);
  }
  if(eiA>0)t.push(['â‘¨ ê³ ìš©ë³´í—˜ë£Œ','',eiA,'0.9%']);
  t.push(['â‘© ì†Œë“ê³µì œ í•©ê³„','',totalDeduct,'']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¢. ê³¼ì„¸í‘œì¤€ ë° ì„¸ì•¡','','ê¸ˆì•¡','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â‘ª ê³¼ì„¸í‘œì¤€','',taxBase,'â‘£ - â‘©']);
  var rateStr=taxBase<=14000000?'6%':taxBase<=50000000?'15%':taxBase<=88000000?'24%':taxBase<=150000000?'35%':'38%~';
  t.push(['â‘« ì ìš©ì„¸ìœ¨','',rateStr,'ì†Œë“ì„¸ë²•Â§55 ëˆ„ì§„ì„¸ìœ¨']);
  t.push(['â‘¬ ì‚°ì¶œì„¸ì•¡','',calcTax,fm(calcTax)+'ì›']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…£. ì„¸ì•¡ê°ë©´Â·ê³µì œ','','ê¸ˆì•¡','ê·¼ê±°']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â‘­ ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´','',smeReduction,'ì¡°íŠ¹ë²•Â§7 ì†Œê¸°ì—… ì§€ì‹ì„œë¹„ìŠ¤ì—… '+Math.round(smeRate*100)+'%']);
  t.push(['â‘® ì „ìì‹ ê³  ì„¸ì•¡ê³µì œ','',eFilingCredit,'ì¡°íŠ¹ë²•Â§104ì¡°ì˜8']);
  t.push(['â‘¯ í‘œì¤€ì„¸ì•¡ê³µì œ','',stdCredit,'ì†Œë“ì„¸ë²•Â§59ì¡°ì˜4']);
  if(bookCredit>0){
    t.push(['â‘° ê¸°ì¥ì„¸ì•¡ê³µì œ','',bookCredit,'ì¡°íŠ¹ë²•Â§128ì¡°ì˜2 (ê°„í¸ì¥ë¶€â†’ë³µì‹ë¶€ê¸° ì‹œ)']);
  }
  t.push(['   ì„¸ì•¡ê³µì œ í•©ê³„','',totalCredit,'']);
  t.push(['â‘± ê²°ì •ì„¸ì•¡','',taxAfterCredit,fm(taxAfterCredit)+'ì›']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¤. ê¸°ë‚©ë¶€ì„¸ì•¡','','ê¸ˆì•¡','í™•ì¸ ë°©ë²•']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â‘² ì¤‘ê°„ì˜ˆë‚©ì„¸ì•¡','',0,'11ì›” ê³ ì§€ì„œ í™•ì¸']);
  if(withheldTax>0)t.push(['â‘³ ê·¼ë¡œì†Œë“ ì›ì²œì§•ìˆ˜','',withheldTax,'ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦']);
  if(withheldBonus>0)t.push(['ã‰‘ ê¸°íƒ€ ì›ì²œì§•ìˆ˜','',withheldBonus,bonusType==='salary'?'ê·¼ë¡œì†Œë“ 3.3%':'ë°°ë‹¹ì†Œë“ 15.4%']);
  t.push(['   ê¸°ë‚©ë¶€ì„¸ì•¡ í•©ê³„','',totalWithheld,'']);
  t.push(['']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¥. ìµœì¢… ë‚©ë¶€/í™˜ê¸‰','','ê¸ˆì•¡','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push([finalTax>0?'â˜… ë‚©ë¶€í•  ì†Œë“ì„¸':'â˜… í™˜ê¸‰ ë°›ì„ ì†Œë“ì„¸','',Math.abs(finalTax),finalTax>0?'5ì›” 31ì¼ê¹Œì§€':'6~7ì›” í™˜ê¸‰']);
  t.push(['   â”” ì§€ë°©ì†Œë“ì„¸ (10%)','',Math.round(Math.abs(finalTax)*0.1),'ë³„ë„ ì‹ ê³ Â·ë‚©ë¶€']);
  t.push(['   â”” í•©ê³„','',Math.round(Math.abs(finalTax)*1.1),fm(Math.round(Math.abs(finalTax)*1.1))+'ì›']);
  if(finalTax>10000000){
    t.push(['   â”” â€» ë¶„ë‚© ê°€ëŠ¥','','','ë‚©ë¶€ì„¸ì•¡ 1,000ë§Œ ì´ˆê³¼ ì‹œ 2ê°œì›” ë¶„ë‚© (êµ­ê¸°ë²•Â§45)']);
  }
  t.push(['']);
  // ê°€ì‚°ì„¸
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¦. ê°€ì‚°ì„¸','','','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  if(vatLate){
    t.push(['ë¶€ê°€ì„¸ ë¬´ì‹ ê³ ','',Math.round(vat*0.2),'êµ­ê¸°ë²•Â§47ì˜2 (ê°ë©´ ì „)']);
    t.push(['ë¶€ê°€ì„¸ ë‚©ë¶€ì§€ì—°','',Math.round(vat*0.00022*(Math.floor((today-vatDeadline2)/(1000*60*60*24)))),'0.022%/ì¼']);
    t.push(['   ê°ë©´ ì ìš© í›„','',vatPenalty,'1ì›”ë‚´50%/3ì›”ë‚´30%/6ì›”ë‚´20%']);
  }else{t.push(['ë¶€ê°€ì„¸','','í•´ë‹¹ì—†ìŒ','ê¸°í•œ ë‚´'])}
  if(incLate){
    t.push(['ì¢…ì†Œì„¸ ë¬´ì‹ ê³ ','',Math.round(finalTax*0.2),'êµ­ê¸°ë²•Â§47ì˜2']);
    t.push(['   ê°ë©´ ì ìš© í›„','',incPenalty,'êµ­ê¸°ë²•Â§48']);
  }else{t.push(['ì¢…ì†Œì„¸','','í•´ë‹¹ì—†ìŒ','ê¸°í•œ ë‚´'])}
  t.push(['']);
  // ì‚¬ì—… ê²½ë¹„ í•œë„
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…§. ê²½ë¹„ í•œë„ í™•ì¸','','í•œë„ì•¡','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['ì ‘ëŒ€ë¹„ í•œë„','',entLimit,'ê¸°ë³¸ 1,200ë§Œ + ìˆ˜ì…ê¸ˆì•¡Ã—0.3% (ì†Œë“ì„¸ë²•Â§35)']);
  t.push(['   â”” ê¸°ë³¸í•œë„','',entLimitBase,'']);
  t.push(['   â”” ìˆ˜ì…ê¸ˆì•¡ ë¹„ë¡€','',entLimitAdd,'ìˆ˜ì…ê¸ˆì•¡ '+fm(ts)+'ì› Ã— 0.3%']);
  t.push(['ë³µë¦¬í›„ìƒë¹„','','í•œë„ì—†ìŒ','ì‚¬íšŒí†µë…ìƒ ì ì • ë²”ìœ„']);
  t.push(['ê²½ì¡°ì‚¬ë¹„','','ê±´ë‹¹ 20ë§Œì›','ì†Œë“ì„¸ë²• ì‹œí–‰ë ¹Â§55ì¡°']);
  t.push(['ì°¨ëŸ‰ìœ ì§€ë¹„','','ì—° 1,500ë§Œì›','ì—…ë¬´ìš©ìŠ¹ìš©ì°¨, ìš´í–‰ì¼ì§€ ì‘ì„± ì‹œ (ì†Œë“ì„¸ë²•Â§33ì¡°ì˜2)']);
  t.push(['']);
  // ì ˆì„¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['â…¨. ì ˆì„¸ ì²´í¬ë¦¬ìŠ¤íŠ¸','','ì˜ˆìƒ ì ˆì„¸ì•¡','']);
  t.push(['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','','','']);
  t.push(['1. ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ ì‹ ì²­','',smeReduction,'í™ˆíƒìŠ¤â†’ì„¸ì•¡ê°ë©´â†’ì¤‘ì†Œê¸°ì—… ì„ íƒ']);
  t.push(['2. ë¶ˆê³µì œâ†’ê³µì œ ì „í™˜','',ndTx,'ì ê²©ì¦ë¹™ í™•ë³´ â†’ ì„¸ê¸ˆê³„ì‚°ì„œ ì¬ë°œê¸‰']);
  t.push(['3. ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ ë“±ë¡','','','í™ˆíƒìŠ¤â†’ì‚¬ì—…ìš©ì‹ ìš©ì¹´ë“œâ†’ë“±ë¡ (ë§¤ì…ì„¸ì•¡ê³µì œ)']);
  t.push(['4. ë…¸ë€ìš°ì‚°ê³µì œ ê°€ì…','',Math.min(bizNet>40000000?2000000:3000000,5000000),'ì†Œë“ê³µì œ ì—° 200~300ë§Œì› (ì†Œê¸°ì—… ê¸°ì¤€)']);
  t.push(['5. ì‚¬ì—…ìš© ê²½ë¹„ ì¦ë¹™ í™•ë³´','','','ë¶€ì¡±í•œ ë§¤ì…ì€ ì—°ë§ê¹Œì§€ ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨']);
  if(bookCredit>0){
    t.push(['6. ê¸°ì¥ì„¸ì•¡ê³µì œ','',bookCredit,'ê°„í¸ì¥ë¶€ ëŒ€ìƒìâ†’ë³µì‹ë¶€ê¸° ê¸°ì¥ ì‹œ']);
  }
  t.push(['']);
  t.push(['â€» ì¶”ì •ì¹˜ì…ë‹ˆë‹¤. í™ˆíƒìŠ¤ ë¯¸ë¦¬ì±„ì›€ ë°ì´í„°ì™€ ëŒ€ì‚¬ í›„ í™•ì •í•˜ì‹­ì‹œì˜¤.','','','']);
  t.push(['â€» ê°ë©´Â·ê³µì œëŠ” ì—…ì¢…Â·ê·œëª¨ ìš”ê±´ ì¶©ì¡± ì‹œì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.','','','']);
  
  var ws2=XLSX.utils.aoa_to_sheet(t);
  ws2['!cols']=[{wch:30},{wch:5},{wch:18},{wch:28}];
  XLSX.utils.book_append_sheet(wb,ws2,'ì¢…ì†Œì„¸_í™ˆíƒìŠ¤_ì…ë ¥ìš©');
  
  // ================================================================
  // Sheet 3: í™ˆíƒìŠ¤ ì…ë ¥ ì²´í¬ë¦¬ìŠ¤íŠ¸
  // ================================================================
  var c=[];
  c.push(['í™ˆíƒìŠ¤ ì„¸ê¸ˆì‹ ê³  ì²´í¬ë¦¬ìŠ¤íŠ¸','','','']);
  c.push(['']);
  c.push(['â•â•â• ë¶€ê°€ì„¸ ì‹ ê³  (1ì›” 25ì¼ / 7ì›” 25ì¼) â•â•â•','','','']);
  c.push(['ìˆœì„œ','í•  ì¼','í™•ì¸','ë©”ëª¨']);
  c.push(['1','í™ˆíƒìŠ¤ ë¡œê·¸ì¸ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ë¶€ê°€ê°€ì¹˜ì„¸','â˜','ê³µë™ì¸ì¦ì„œ í•„ìš”']);
  c.push(['2','ì¼ë°˜ê³¼ì„¸ì â†’ ì •ê¸°ì‹ ê³ (í™•ì •) ì„ íƒ','â˜','']);
  c.push(['3','[ë¯¸ë¦¬ì±„ì›€] ë²„íŠ¼ í´ë¦­ â†’ ìë™ ì…ë ¥ í™•ì¸','â˜','ì„¸ê¸ˆê³„ì‚°ì„œ/ì¹´ë“œ ìë™']);
  c.push(['4','(1) ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œ: '+st.length+'ê±´ / '+fm(ts)+'ì› í™•ì¸','â˜','ë¶ˆì¼ì¹˜ ì‹œ ìˆ˜ì •']);
  c.push(['5','(3) ì‹ ìš©ì¹´ë“œ ë§¤ì¶œ: '+cardSales.length+'ê±´ í™•ì¸','â˜','']);
  c.push(['6','(10) ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì…: '+etDed.length+'ê±´ / '+fm(etDed.reduce(function(a,r){return a+r.supply},0))+'ì›','â˜','']);
  c.push(['7','(14) ì‹ ìš©ì¹´ë“œ ë§¤ì…: '+cardPurchase.length+'ê±´ í™•ì¸','â˜','ì‚¬ì—…ìš©ì¹´ë“œ ìë™']);
  c.push(['8','(49) ë¶ˆê³µì œ ë§¤ì…ì„¸ì•¡: '+etNon.length+'ê±´ / '+fm(ndTx)+'ì›','â˜','ê°œì¸ìš©/ë¹„ì˜ì—…ìš©']);
  c.push(['9','ë‚©ë¶€ì„¸ì•¡ í™•ì¸: '+fm(vat)+'ì›','â˜','']);
  c.push(['10','ì‹ ê³ ì„œ ì œì¶œ â†’ ë‚©ë¶€ì„œ ì¶œë ¥','â˜','']);
  c.push(['11','ë‚©ë¶€: í™ˆíƒìŠ¤ ë‚©ë¶€ ë˜ëŠ” ì€í–‰','â˜','ê¸°í•œ ë‚´ ë‚©ë¶€!']);
  c.push(['']);
  c.push(['â•â•â• ì¢…ì†Œì„¸ ì‹ ê³  (5ì›” 31ì¼) â•â•â•','','','']);
  c.push(['ìˆœì„œ','í•  ì¼','í™•ì¸','ë©”ëª¨']);
  c.push(['1','í™ˆíƒìŠ¤ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ì¢…í•©ì†Œë“ì„¸','â˜','']);
  c.push(['2','ì‹ ê³ ìœ í˜•: ì¼ë°˜ì‹ ê³  â†’ ì¥ë¶€ê¸°ì¥(ë³µì‹ë¶€ê¸°)','â˜','']);
  c.push(['3','ê·¼ë¡œì†Œë“: ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ ë¶ˆëŸ¬ì˜¤ê¸°','â˜','ë‚´ì¼ì‚¬ì¥+ì›ìœŒì•¤ì½”']);
  c.push(['4','ì‚¬ì—…ì†Œë“: ìˆ˜ì…ê¸ˆì•¡ '+fm(ts)+'ì› / í•„ìš”ê²½ë¹„ '+fm(te)+'ì›','â˜','ì¥ë¶€ ê¸°ë°˜']);
  c.push(['5','ì†Œë“ê³µì œ: ê¸°ë³¸ê³µì œ+4ëŒ€ë³´í—˜ '+fm(totalDeduct)+'ì›','â˜','']);
  c.push(['6','ì„¸ì•¡ê³µì œ: ì „ìì‹ ê³  2ë§Œì›','â˜','ìë™ ì ìš©']);
  c.push(['7','ê¸°ë‚©ë¶€ì„¸ì•¡: ì›ì²œì§•ìˆ˜ í•©ê³„ '+fm(totalWithheld)+'ì›','â˜','ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ í™•ì¸']);
  c.push(['8','ìµœì¢… ì„¸ì•¡ í™•ì¸: '+(finalTax>0?'ë‚©ë¶€ '+fm(Math.round(finalTax*1.1))+'ì›':'í™˜ê¸‰ '+fm(Math.round(Math.abs(finalTax)*1.1))+'ì›'),'â˜','ì†Œë“ì„¸+ì§€ë°©ì†Œë“ì„¸']);
  c.push(['9','ì‹ ê³ ì„œ ì œì¶œ','â˜','']);
  c.push(['10','ë‚©ë¶€ ë˜ëŠ” í™˜ê¸‰ê³„ì¢Œ ì…ë ¥','â˜',finalTax>0?'ê¸°í•œ ë‚´ ë‚©ë¶€':'ê³„ì¢Œë²ˆí˜¸ ì •í™•íˆ']);
  c.push(['']);
  c.push(['â•â•â• ì¦ë¹™ ì„œë¥˜ ë³´ê´€ â•â•â•','','','']);
  c.push(['','ë‚´ì¼ì‚¬ì¥ ê·¼ë¡œì†Œë“ ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦','â˜','3ì›”ì— íšŒì‚¬ì—ì„œ ë°œê¸‰']);
  c.push(['','ì›ìœŒì•¤ì½” ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦/ë°°ë‹¹ì†Œë“ ì§€ê¸‰ëª…ì„¸ì„œ','â˜','']);
  c.push(['','ì „ìì„¸ê¸ˆê³„ì‚°ì„œ (í™ˆíƒìŠ¤ì—ì„œ í™•ì¸)','â˜','']);
  c.push(['','ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ ë§¤ì… ë‚´ì—­','â˜','í™ˆíƒìŠ¤ ìë™']);
  c.push(['','í†µì¥ ê±°ë˜ë‚´ì—­','â˜','ì‚¬ì—…ìš© í†µì¥']);
  c.push(['','ê²½ì¡°ì‚¬ë¹„ ì¦ë¹™ (ì²­ì²©ì¥ ë“±)','â˜',evtData.length+'ê±´']);
  
  var ws3=XLSX.utils.aoa_to_sheet(c);
  ws3['!cols']=[{wch:8},{wch:50},{wch:6},{wch:25}];
  XLSX.utils.book_append_sheet(wb,ws3,'í™ˆíƒìŠ¤_ì²´í¬ë¦¬ìŠ¤íŠ¸');
  
  // ================================================================
  // Sheet 4: ê¸‰ì—¬ ìˆ˜ë ¹ ë‚´ì—­
  // ================================================================
  var salData=[['ì›”','ì§€ê¸‰ì¼','ì‹¤ìˆ˜ë ¹ì•¡','ì„¸ì „ê¸‰ì—¬','ê³µì œì•¡(ì¶”ì •)','ë¹„ê³ ']];
  for(var m=0;m<12;m++){
    var log=salaryLog[m];
    if(log)salData.push([(m+1)+'ì›”',log.date,log.net,salMon,salMon-log.net,'ìˆ˜ë ¹ ì™„ë£Œ']);
    else salData.push([(m+1)+'ì›”','','',salMon,'','ë¯¸ìˆ˜ë ¹']);
  }
  salData.push(['í•©ê³„','',totalNetPaid,salAnnual,salAnnual-totalNetPaid,'']);
  var ws4=XLSX.utils.aoa_to_sheet(salData);
  ws4['!cols']=[{wch:6},{wch:14},{wch:14},{wch:14},{wch:14},{wch:10}];
  XLSX.utils.book_append_sheet(wb,ws4,'ê¸‰ì—¬_ë‚´ì—­');
  
  // ================================================================
  // Sheet 5: ê²½ì¡°ì‚¬ë¹„ (ìˆìœ¼ë©´)
  // ================================================================
  if(evtData.length>0){
    var evtSheet=[['ë‚ ì§œ','ìœ í˜•','ëŒ€ìƒ','ê¸ˆì•¡','ê³µì œì¸ì •ì•¡','ì´ˆê³¼ë¶ˆì¸ì •','ì¦ë¹™']];
    evtData.forEach(function(e){evtSheet.push([e.date,e.type,e.name,e.amount,e.deduct,e.over,e.file?'ìˆìŒ':'ì—†ìŒ'])});
    evtSheet.push(['í•©ê³„','','',evtData.reduce(function(a,e){return a+e.amount},0),evtData.reduce(function(a,e){return a+e.deduct},0),evtData.reduce(function(a,e){return a+e.over},0),'']);
    var ws5=XLSX.utils.aoa_to_sheet(evtSheet);
    ws5['!cols']=[{wch:12},{wch:8},{wch:15},{wch:12},{wch:12},{wch:12},{wch:8}];
    XLSX.utils.book_append_sheet(wb,ws5,'ê²½ì¡°ì‚¬ë¹„');
  }
  
  // ================================================================
  // Sheet 6: ê°„í¸ì¥ë¶€ (êµ­ì„¸ì²­ ê³µì‹ ì–‘ì‹ â€” êµ­ì„¸ì²­ê³ ì‹œ ì œ2024-19í˜¸)
  // ì¼ì | ê³„ì •ê³¼ëª© | ê±°ë˜ë‚´ìš© | ê±°ë˜ì²˜ | ìˆ˜ì…(ë§¤ì¶œì•¡) | ë¹„ìš© | ê³ ì •ìì‚° ì¦ê° | ë¹„ê³ 
  // ================================================================
  var jb=[];
  jb.push(['ê°„í¸ì¥ë¶€','','','','','','','']);
  jb.push(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 365-35-00893','ìƒí˜¸: ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤','ëŒ€í‘œ: ì§€ìœ¤ì§„','ì—…ì¢…: í”„ëœì°¨ì´ì¦ˆ ì»¨ì„¤íŒ…','','','','']);
  jb.push(['ê·€ì†ì—°ë„: '+now.getFullYear()+'ë…„','ê¸°ì¥ê¸°ê°„: '+now.getFullYear()+'.01.01 ~ '+now.getFullYear()+'.12.31','','','','','','']);
  jb.push(['']);
  jb.push(['ì¼ì','ê³„ì •ê³¼ëª©','ê±°ë˜ë‚´ìš©','ê±°ë˜ì²˜','ìˆ˜ì…(ë§¤ì¶œì•¡)','ë¹„ìš©','ê³ ì •ìì‚° ì¦ê°','ë¹„ê³ (ì¦ë¹™)']);
  
  // ë§¤ì¶œ ê±°ë˜
  st.forEach(function(r){
    jb.push([r.date,'ìƒí’ˆ(ì œí’ˆ)ë§¤ì¶œ','ì»¨ì„¤íŒ… ìš©ì—­ ë§¤ì¶œ',r.client,r.supply+r.tax,'','','ì„¸ê¸ˆê³„ì‚°ì„œ']);
  });
  // ì¹´ë“œ ë§¤ì¶œ
  cardSales.forEach(function(c){
    jb.push([c.date,'ìƒí’ˆ(ì œí’ˆ)ë§¤ì¶œ','ì¹´ë“œ ë§¤ì¶œ',c.merchant||'',c.amount,'','','ì‹ ìš©ì¹´ë“œ']);
  });
  // ë§¤ì… ê±°ë˜ â€” ë¹„ìš©
  et.forEach(function(r){
    var account='ê¸°íƒ€ê²½ë¹„';
    var cat=(r.aiCategory||'').toLowerCase();
    if(cat.indexOf('ì—¬ë¹„')>-1||cat.indexOf('êµí†µ')>-1)account='ì—¬ë¹„êµí†µë¹„';
    else if(cat.indexOf('ì ‘ëŒ€')>-1)account='ì ‘ëŒ€ë¹„';
    else if(cat.indexOf('í†µì‹ ')>-1)account='í†µì‹ ë¹„';
    else if(cat.indexOf('ì†Œëª¨í’ˆ')>-1||cat.indexOf('ì‚¬ë¬´')>-1)account='ì†Œëª¨í’ˆë¹„';
    else if(cat.indexOf('ê´‘ê³ ')>-1)account='ê´‘ê³ ì„ ì „ë¹„';
    else if(cat.indexOf('êµìœ¡')>-1)account='êµìœ¡í›ˆë ¨ë¹„';
    else if(cat.indexOf('ì°¨ëŸ‰')>-1)account='ì°¨ëŸ‰ìœ ì§€ë¹„';
    else if(cat.indexOf('ì†Œí”„íŠ¸ì›¨ì–´')>-1||cat.indexOf('sw')>-1)account='ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ';
    else if(r.supply>=5000000)account='ë¹„í’ˆ(ê³ ì •ìì‚°)'; // ê³ ì•¡ = ìì‚°
    jb.push([r.date,account,r.client+' ë§¤ì…',r.client,'',r.supply+r.tax,account==='ë¹„í’ˆ(ê³ ì •ìì‚°)'?(r.supply+r.tax):'','ì„¸ê¸ˆê³„ì‚°ì„œ']);
  });
  // ì¹´ë“œ ë§¤ì…
  D.card.filter(function(c){return c.type!=='ë§¤ì¶œ'}).forEach(function(c){
    var account='ê¸°íƒ€ê²½ë¹„';
    var cat=(c.aiCategory||'').toLowerCase();
    if(cat.indexOf('ì—¬ë¹„')>-1||cat.indexOf('êµí†µ')>-1)account='ì—¬ë¹„êµí†µë¹„';
    else if(cat.indexOf('ì ‘ëŒ€')>-1||cat.indexOf('ì‹ëŒ€')>-1)account='ì ‘ëŒ€ë¹„';
    else if(cat.indexOf('í†µì‹ ')>-1)account='í†µì‹ ë¹„';
    else if(cat.indexOf('ì†Œëª¨í’ˆ')>-1)account='ì†Œëª¨í’ˆë¹„';
    else if(cat.indexOf('ì£¼ìœ ')>-1||cat.indexOf('ì°¨ëŸ‰')>-1)account='ì°¨ëŸ‰ìœ ì§€ë¹„';
    jb.push([c.date,account,(c.merchant||c.desc||''),'','',(c.amount||0),'','ì‹ ìš©ì¹´ë“œ']);
  });
  // ê²½ì¡°ì‚¬ë¹„
  evtData.forEach(function(e){
    jb.push([e.date,'ì ‘ëŒ€ë¹„','ê²½ì¡°ì‚¬ë¹„ ('+e.type+') '+e.name,'','',(e.deduct||0),'','ì¦ë¹™: '+(e.file?'ìˆìŒ':'ì—†ìŒ')]);
  });
  // í•©ê³„í–‰
  var jbTotalIn=0,jbTotalOut=0;
  jb.forEach(function(r,i){if(i>=5){jbTotalIn+=(parseInt(r[4])||0);jbTotalOut+=(parseInt(r[5])||0)}});
  jb.push(['']);
  jb.push(['í•©ê³„','','','',jbTotalIn,jbTotalOut,'','']);
  jb.push(['ì°¨ì•¡(ì†Œë“)','','','',jbTotalIn-jbTotalOut,'','','']);
  jb.push(['']);
  jb.push(['â€» ë³¸ ê°„í¸ì¥ë¶€ëŠ” êµ­ì„¸ì²­ê³ ì‹œ ì œ2024-19í˜¸ ì–‘ì‹ì— ì¤€í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.','','','','','','','']);
  jb.push(['â€» í™ˆíƒìŠ¤ ì¢…í•©ì†Œë“ì„¸ ì‹ ê³  ì‹œ ì´ìˆ˜ì…ê¸ˆì•¡ ë° í•„ìš”ê²½ë¹„ëª…ì„¸ì„œ(ë³„ì§€ ì œ74í˜¸ ë¶€í‘œ)ì— ì „ê¸°í•˜ì‹­ì‹œì˜¤.','','','','','','','']);
  
  var ws6=XLSX.utils.aoa_to_sheet(jb);
  ws6['!cols']=[{wch:12},{wch:16},{wch:28},{wch:20},{wch:16},{wch:16},{wch:14},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws6,'ê°„í¸ì¥ë¶€');
  
  // ================================================================
  // Sheet 7: ì´ìˆ˜ì…ê¸ˆì•¡ ë° í•„ìš”ê²½ë¹„ëª…ì„¸ì„œ (ì†Œë“ì„¸ë²•ì‹œí–‰ê·œì¹™ ë³„ì§€ ì œ74í˜¸ ë¶€í‘œ)
  // ================================================================
  var nm=[];
  nm.push(['ì´ìˆ˜ì…ê¸ˆì•¡ ë° í•„ìš”ê²½ë¹„ëª…ì„¸ì„œ','','','']);
  nm.push(['(ì†Œë“ì„¸ë²•ì‹œí–‰ê·œì¹™ ë³„ì§€ ì œ74í˜¸ ì„œì‹ ë¶€í‘œ)','','','']);
  nm.push(['']);
  nm.push(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸','365-35-00893','ìƒí˜¸','ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤']);
  nm.push(['ëŒ€í‘œì','ì§€ìœ¤ì§„','ì£¼ëœ ì—…ì¢…ì½”ë“œ','940909 (ê²½ì˜ì»¨ì„¤íŒ…)']);
  nm.push(['ì†Œì¬ì§€','ê²½ê¸° êµ¬ë¦¬ì‹œ','ê¸°ì¥êµ¬ë¶„',bookType]);
  nm.push(['']);
  
  // â… . ì´ìˆ˜ì…ê¸ˆì•¡
  nm.push(['â… . ì´ìˆ˜ì…ê¸ˆì•¡','','ê¸ˆì•¡','ë¹„ê³ ']);
  nm.push(['â‘  ì¥ë¶€ìƒ ìˆ˜ì…ê¸ˆì•¡','',ts+Math.round(cardSalesAmt),'ê°„í¸ì¥ë¶€ â†’ ìˆ˜ì…í•©ê³„']);
  nm.push(['  ê°€. ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œ','',ts,st.length+'ê±´']);
  nm.push(['  ë‚˜. ì‹ ìš©ì¹´ë“œ ë§¤ì¶œ','',Math.round(cardSalesAmt),cardSales.length+'ê±´']);
  nm.push(['  ë‹¤. í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œ','',0,'']);
  nm.push(['  ë¼. ê¸°íƒ€ ë§¤ì¶œ','',0,'']);
  nm.push(['â‘¡ ìˆ˜ì…ê¸ˆì•¡ ì¡°ì •','',0,'(ì¶”ê°€/ì°¨ê° ì—†ìŒ)']);
  nm.push(['â‘¢ ì´ìˆ˜ì…ê¸ˆì•¡ (â‘ +â‘¡)','',ts+Math.round(cardSalesAmt),'']);
  nm.push(['']);
  
  // â…¡. í•„ìš”ê²½ë¹„
  // ê²½ë¹„ë¥¼ ê³„ì •ê³¼ëª©ë³„ë¡œ ì§‘ê³„
  var expByAccount={};
  et.forEach(function(r){
    var cat=r.aiCategory||'ê¸°íƒ€ê²½ë¹„';
    if(!expByAccount[cat])expByAccount[cat]=0;
    expByAccount[cat]+=r.supply+r.tax;
  });
  D.card.filter(function(c){return c.type!=='ë§¤ì¶œ'}).forEach(function(c){
    var cat=c.aiCategory||'ê¸°íƒ€ê²½ë¹„';
    if(!expByAccount[cat])expByAccount[cat]=0;
    expByAccount[cat]+=(c.amount||0);
  });
  evtData.forEach(function(e){
    if(!expByAccount['ì ‘ëŒ€ë¹„'])expByAccount['ì ‘ëŒ€ë¹„']=0;
    expByAccount['ì ‘ëŒ€ë¹„']+=(e.deduct||0);
  });
  
  nm.push(['â…¡. í•„ìš”ê²½ë¹„','','ê¸ˆì•¡','ë¹„ê³ ']);
  nm.push(['â‘£ ë§¤ì…ë¹„ìš©(ì›ì¬ë£Œ,ìƒí’ˆ)','',te,et.length+'ê±´ (ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì…)']);
  
  var totalExpDetail=0;
  var expOrder=['ì—¬ë¹„êµí†µë¹„','ì ‘ëŒ€ë¹„','íšŒì˜ë¹„','í†µì‹ ë¹„','ì†Œëª¨í’ˆë¹„','ê´‘ê³ ì„ ì „ë¹„','êµìœ¡í›ˆë ¨ë¹„','ì°¨ëŸ‰ìœ ì§€ë¹„','ì‚¬ë¬´ì‹¤ê²½ë¹„','ì†Œí”„íŠ¸ì›¨ì–´','ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ','ë³µë¦¬í›„ìƒë¹„','ê¸°íƒ€ê²½ë¹„'];
  expOrder.forEach(function(cat){
    if(expByAccount[cat]){
      var note='';
      if(cat==='ì ‘ëŒ€ë¹„')note='í•œë„: '+fm(entLimit)+'ì›';
      nm.push(['  '+cat,'',expByAccount[cat],note]);
      totalExpDetail+=expByAccount[cat];
    }
  });
  // ë¯¸ë¶„ë¥˜ ê²½ë¹„
  Object.keys(expByAccount).forEach(function(cat){
    if(expOrder.indexOf(cat)===-1&&expByAccount[cat]){
      nm.push(['  '+cat,'',expByAccount[cat],'']);
      totalExpDetail+=expByAccount[cat];
    }
  });
  
  nm.push(['â‘¤ í•„ìš”ê²½ë¹„ í•©ê³„','',te+totalExpDetail+Math.round(cardPurchaseAmt),'']);
  nm.push(['']);
  
  // â…¢. ì†Œë“ê¸ˆì•¡
  var totalRevenue=ts+Math.round(cardSalesAmt);
  var totalExpenseAll=te+totalExpDetail+Math.round(cardPurchaseAmt);
  nm.push(['â…¢. ì†Œë“ê¸ˆì•¡','','ê¸ˆì•¡','']);
  nm.push(['â‘¥ ì†Œë“ê¸ˆì•¡ (â‘¢-â‘¤)','',totalRevenue-totalExpenseAll,'']);
  nm.push(['']);
  nm.push(['â€» ë³¸ ëª…ì„¸ì„œëŠ” ê°„í¸ì¥ë¶€ ê¸°ì¬ì‚¬í•­ì„ í™ˆíƒìŠ¤ ì¢…ì†Œì„¸ ì‹ ê³ ì„œì— ì „ê¸°í•˜ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.','','','']);
  nm.push(['â€» ì‹¤ì œ ì‹ ê³  ì‹œ í™ˆíƒìŠ¤ ë¯¸ë¦¬ì±„ì›€ ë°ì´í„°ì™€ ëŒ€ì‚¬ í›„ í™•ì •í•˜ì‹­ì‹œì˜¤.','','','']);
  
  var ws7=XLSX.utils.aoa_to_sheet(nm);
  ws7['!cols']=[{wch:30},{wch:22},{wch:18},{wch:30}];
  XLSX.utils.book_append_sheet(wb,ws7,'ì´ìˆ˜ì…ê¸ˆì•¡_í•„ìš”ê²½ë¹„ëª…ì„¸ì„œ');
  
  // ================================================================
  // Sheet 8: ê°„í¸ì¥ë¶€ ì†Œë“ê¸ˆì•¡ê³„ì‚°ì„œ (ì†Œë“ì„¸ë²•ì‹œí–‰ê·œì¹™ ë³„ì§€ ì œ74í˜¸)
  // ================================================================
  var sg=[];
  sg.push(['ê°„í¸ì¥ë¶€ ì†Œë“ê¸ˆì•¡ê³„ì‚°ì„œ','','']);
  sg.push(['(ì†Œë“ì„¸ë²•ì‹œí–‰ê·œì¹™ ë³„ì§€ ì œ74í˜¸)','','']);
  sg.push(['']);
  sg.push(['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 365-35-00893 | ì™€ì´ì œì´ íŒŒíŠ¸ë„ˆìŠ¤ | ì§€ìœ¤ì§„','','']);
  sg.push(['ì—…ì¢…: ê²½ì˜ì»¨ì„¤íŒ…(940909) | ê¸°ì¥: '+bookType,'','']);
  sg.push(['']);
  sg.push(['êµ¬ë¶„','ê¸ˆì•¡','ë¹„ê³ ']);
  sg.push(['â‘  ì´ìˆ˜ì…ê¸ˆì•¡',totalRevenue,'ì„¸ê¸ˆê³„ì‚°ì„œ+ì¹´ë“œ ë§¤ì¶œ í•©ê³„']);
  sg.push(['â‘¡ í•„ìš”ê²½ë¹„',totalExpenseAll,'ì„¸ê¸ˆê³„ì‚°ì„œ+ì¹´ë“œ ë§¤ì…+ê²½ë¹„ í•©ê³„']);
  sg.push(['â‘¢ ì°¨ê°€ê° ì†Œë“ê¸ˆì•¡ (â‘ -â‘¡)',totalRevenue-totalExpenseAll,'']);
  sg.push(['']);
  sg.push(['ì„¸ë¬´ì¡°ì • ì‚¬í•­','','']);
  sg.push(['â‘£ ìˆ˜ì…ê¸ˆì•¡ ì‚°ì…',0,'(í•´ë‹¹ ì—†ìŒ)']);
  sg.push(['â‘¤ í•„ìš”ê²½ë¹„ ë¶ˆì‚°ì…',0,'(í•´ë‹¹ ì—†ìŒ)']);
  
  // ì ‘ëŒ€ë¹„ í•œë„ ì´ˆê³¼ ì²´í¬
  var entActual=expByAccount['ì ‘ëŒ€ë¹„']||0;
  var entExcess=Math.max(entActual-entLimit,0);
  if(entExcess>0){
    sg.push(['  â”” ì ‘ëŒ€ë¹„ í•œë„ì´ˆê³¼ì•¡',entExcess,'ì‹¤ì œ '+fm(entActual)+' - í•œë„ '+fm(entLimit)]);
  }
  
  sg.push(['â‘¥ ìˆ˜ì…ê¸ˆì•¡ ë¶ˆì‚°ì…',0,'(í•´ë‹¹ ì—†ìŒ)']);
  sg.push(['â‘¦ í•„ìš”ê²½ë¹„ ì‚°ì…',0,'(í•´ë‹¹ ì—†ìŒ)']);
  sg.push(['']);
  sg.push(['â‘§ ì†Œë“ê¸ˆì•¡ (â‘¢+â‘£+â‘¤-â‘¥-â‘¦)',totalRevenue-totalExpenseAll+entExcess,'â†’ ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ì„œ ì‚¬ì—…ì†Œë“ë€']);
  sg.push(['']);
  sg.push(['ê²°ì†ê¸ˆ ì²˜ë¦¬','','']);
  sg.push(['â‘¨ ì´ì›”ê²°ì†ê¸ˆ ê³µì œ',0,'ì „ê¸° ì´ì›” ê²°ì†ê¸ˆ ì—†ìŒ']);
  sg.push(['â‘© ì°¨ê° ì†Œë“ê¸ˆì•¡ (â‘§-â‘¨)',Math.max(totalRevenue-totalExpenseAll+entExcess,0),'']);
  sg.push(['']);
  sg.push(['â€» â‘©ì˜ ê¸ˆì•¡ì„ ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ì„œ(ë³„ì§€ ì œ40í˜¸(1)) ì‚¬ì—…ì†Œë“ëª…ì„¸ë€ì— ê¸°ì¬í•©ë‹ˆë‹¤.','','']);
  sg.push(['â€» ê°„í¸ì¥ë¶€ëŒ€ìƒìê°€ ë³µì‹ë¶€ê¸° ê¸°ì¥ ì‹œ ê¸°ì¥ì„¸ì•¡ê³µì œ(ì‚°ì¶œì„¸ì•¡ì˜ 20%, í•œë„ 100ë§Œì›) ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.','','']);
  
  var ws8=XLSX.utils.aoa_to_sheet(sg);
  ws8['!cols']=[{wch:30},{wch:18},{wch:40}];
  XLSX.utils.book_append_sheet(wb,ws8,'ì†Œë“ê¸ˆì•¡ê³„ì‚°ì„œ');

  XLSX.writeFile(wb,'YJ_ì„¸ê¸ˆì‹ ê³ _í™ˆíƒìŠ¤ìš©_2026.xlsx');
  
  // ============ PDF ============
  var doc=new jspdf.jsPDF('p','mm','a4');
  doc.setFont('helvetica','bold');doc.setFontSize(18);
  doc.text('YJ Partners - Tax Filing Summary 2026',14,20);
  doc.setFontSize(9);doc.setFont('helvetica','normal');
  doc.text('Date: '+new Date().toISOString().slice(0,10)+' | YJ Partners | Guri-si, Gyeonggi-do',14,27);
  
  doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('VAT Return (HomeTax Input)',14,38);
  doc.autoTable({startY:42,head:[['Item','No.','Count','Supply (KRW)','Tax (KRW)']],body:[
    ['(1) Tax Invoice Sales','1',st.length,fm(ts),fm(sTx)],
    ['(3) Card Sales','3',cardSales.length,fm(Math.round(cardSalesAmt/1.1)),fm(Math.round(cardSalesAmt/1.1*0.1))],
    ['(10) Tax Invoice Purchase (Ded)','10',etDed.length,fm(etDed.reduce(function(a,r){return a+r.supply},0)),fm(dTx)],
    ['(14) Card Purchase','14',cardPurchase.length,fm(Math.round(cardPurchaseAmt/1.1)),fm(Math.round(cardPurchaseAmt/1.1*0.1))],
    ['(49) Non-deductible','49',etNon.length,fm(etNon.reduce(function(a,r){return a+r.supply},0)),fm(ndTx)],
    ['VAT Payable','73','','',fm(vat)]
  ],styles:{fontSize:8},headStyles:{fillColor:[26,43,75]}});
  
  var y2=doc.lastAutoTable.finalY+10;
  doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('Income Tax Return',14,y2);
  doc.autoTable({startY:y2+4,head:[['Item','Amount (KRW)','Note']],body:[
    ['Salary Income',fm(salaryIncome),'After employment deduction'],
    ['Business Income',fm(bizNet),'Sales - Expenses'],
    bonusAmt>0?['Bonus/Dividend',fm(bonusAmt),bonusType]:null,
    ['Total Income',fm(totalIncome),''],
    ['Deductions',fm(totalDeduct),'Basic + Insurance'],
    ['Tax Base',fm(taxBase),''],
    ['Calculated Tax',fm(calcTax),''],
    ['Tax Credit',fm(eFilingCredit),'E-filing'],
    ['Prepaid Tax',fm(totalWithheld),'Withholding'],
    [finalTax>0?'TAX DUE':'REFUND',fm(Math.round(Math.abs(finalTax)*1.1)),'Inc. local tax 10%']
  ].filter(Boolean),styles:{fontSize:8},headStyles:{fillColor:[26,43,75]}});
  
  doc.save('YJ_Tax_Report_2026.pdf');
  

  // ============ í™ˆíƒìŠ¤ ë³µë¶™ìš© í…ìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ============
  var txt='';
  txt+='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  txt+='  í™ˆíƒìŠ¤ ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³  - ë³µì‚¬ ë¶™ì—¬ë„£ê¸°ìš©\n';
  txt+='  ì™€ì´ì œì´íŒŒíŠ¸ë„ˆìŠ¤ ì§€ìœ¤ì§„ | 2026ë…„ 1ê¸° í™•ì •\n';
  txt+='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  txt+='ã€ì‘ì„± ìš”ë ¹ã€‘\n';
  txt+='1. í™ˆíƒìŠ¤ ë¡œê·¸ì¸ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ë¶€ê°€ê°€ì¹˜ì„¸ â†’ ì •ê¸°ì‹ ê³ (í™•ì •)\n';
  txt+='2. [ë¯¸ë¦¬ì±„ì›€] í´ë¦­ â†’ ìë™ ì…ë ¥ëœ ìˆ«ìì™€ ì•„ë˜ ìˆ«ì ëŒ€ì‚¬\n';
  txt+='3. ë¶ˆì¼ì¹˜ ì‹œ ì•„ë˜ ìˆ«ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì • ì…ë ¥\n';
  txt+='4. [ì‹ ê³ ì„œ ì œì¶œ] â†’ [ë‚©ë¶€]\n\n';
  
  txt+='ã€ë§¤ì¶œ - ê³¼ì„¸í‘œì¤€ ë° ë§¤ì¶œì„¸ì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='(1) ì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰ë¶„\n';
  txt+='    ê±´ìˆ˜: '+st.length+'\n';
  txt+='    ê³µê¸‰ê°€ì•¡: '+ts+'\n';
  txt+='    ì„¸ì•¡: '+sTx+'\n\n';
  
  if(cardSalesAmt>0){
    txt+='(3) ì‹ ìš©ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ë¶„\n';
    txt+='    ê±´ìˆ˜: '+cardSales.length+'\n';
    txt+='    ê³µê¸‰ê°€ì•¡: '+Math.round(cardSalesAmt/1.1)+'\n';
    txt+='    ì„¸ì•¡: '+Math.round(cardSalesAmt/1.1*0.1)+'\n\n';
  }
  
  txt+='ã€ë§¤ì… - ë§¤ì…ì„¸ì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='(10) ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨ë¶„ (ì¼ë°˜ë§¤ì…)\n';
  txt+='    ê±´ìˆ˜: '+etDed.length+'\n';
  txt+='    ê³µê¸‰ê°€ì•¡: '+etDed.reduce(function(a,r){return a+r.supply},0)+'\n';
  txt+='    ì„¸ì•¡: '+dTx+'\n\n';
  
  if(cardPurchaseAmt>0){
    txt+='(14) ì‹ ìš©ì¹´ë“œ ë§¤ì…ë¶„\n';
    txt+='    ê±´ìˆ˜: '+cardPurchase.length+'\n';
    txt+='    ê³µê¸‰ê°€ì•¡: '+Math.round(cardPurchaseAmt/1.1)+'\n';
    txt+='    ì„¸ì•¡: '+Math.round(cardPurchaseAmt/1.1*0.1)+'\n\n';
  }
  
  if(etNon.length>0){
    txt+='(49) ê³µì œë°›ì§€ ëª»í•  ë§¤ì…ì„¸ì•¡\n';
    etNon.forEach(function(r){txt+='    '+r.client+' | ê³µê¸‰ê°€ì•¡: '+r.supply+' | ì„¸ì•¡: '+r.tax+'\n'});
    txt+='\n';
  }
  
  txt+='ã€ë‚©ë¶€ì„¸ì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='â˜… ë‚©ë¶€í•  ì„¸ì•¡: '+vat+' ì›\n';
  txt+='  (ë§¤ì¶œì„¸ì•¡ '+sTx+' - ë§¤ì…ì„¸ì•¡ '+dTx+')\n\n';
  
  txt+='ã€ë§¤ì¶œì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ - ê±°ë˜ì²˜ ëª©ë¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  Object.keys(salesByClient).forEach(function(k){
    var c=salesByClient[k];
    txt+='  '+k+' | '+c.count+'ê±´ | ê³µê¸‰ê°€ì•¡: '+c.supply+' | ì„¸ì•¡: '+c.tax+'\n';
  });
  txt+='\n';
  
  txt+='ã€ë§¤ì…ì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œ - ê±°ë˜ì²˜ ëª©ë¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  Object.keys(purchByClient).forEach(function(k){
    var c=purchByClient[k];
    txt+='  '+k+' | '+c.count+'ê±´ | ê³µê¸‰ê°€ì•¡: '+c.supply+' | ì„¸ì•¡: '+c.tax+' | '+c.deductible+'\n';
  });
  txt+='\n';
  
  txt+='ã€ì²¨ë¶€ì„œë¥˜ ì²´í¬ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='â˜ ë§¤ì¶œì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œí•©ê³„í‘œ (ì „ì = í™ˆíƒìŠ¤ ìë™)\n';
  txt+='â˜ ë§¤ì…ì²˜ë³„ ì„¸ê¸ˆê³„ì‚°ì„œí•©ê³„í‘œ (ì „ì = í™ˆíƒìŠ¤ ìë™)\n';
  txt+='â˜ ì‹ ìš©ì¹´ë“œ ë§¤ì¶œì „í‘œ ë°œí–‰ê¸ˆì•¡ ì§‘ê³„í‘œ (í™ˆíƒìŠ¤ ìë™)\n';
  txt+='â˜ ì‹ ìš©ì¹´ë“œ ë§¤ì¶œì „í‘œ ìˆ˜ë ¹ëª…ì„¸ì„œ (ì‚¬ì—…ìš©ì¹´ë“œ ë“±ë¡ ì‹œ ìë™)\n';
  txt+='â˜ ê³µì œë°›ì§€ ëª»í•  ë§¤ì…ì„¸ì•¡ ëª…ì„¸ì„œ (ë¶ˆê³µì œ ìˆìœ¼ë©´ ì‘ì„±)\n';
  txt+='â€» ì „ìì„¸ê¸ˆê³„ì‚°ì„œë§Œ ì‚¬ìš© ì‹œ ëŒ€ë¶€ë¶„ ìë™ ì²¨ë¶€ë¨\n\n';
  
  txt+='\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  txt+='  í™ˆíƒìŠ¤ ì¢…í•©ì†Œë“ì„¸ ì‹ ê³  - ë³µì‚¬ ë¶™ì—¬ë„£ê¸°ìš©\n';
  txt+='  ì§€ìœ¤ì§„ | ê·€ì†ì—°ë„: 2026ë…„ | ì‹ ê³ ê¸°í•œ: 2027.5.31\n';
  txt+='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  txt+='ã€ì‘ì„± ìš”ë ¹ã€‘\n';
  txt+='1. í™ˆíƒìŠ¤ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ì¢…í•©ì†Œë“ì„¸ â†’ ì¼ë°˜ì‹ ê³ (ë³µì‹ë¶€ê¸°)\n';
  txt+='2. ê·¼ë¡œì†Œë“: [ë¶ˆëŸ¬ì˜¤ê¸°] â†’ ë‚´ì¼ì‚¬ì¥+ì›ìœŒì•¤ì½” ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ ìë™\n';
  txt+='3. ì‚¬ì—…ì†Œë“: ì•„ë˜ ìˆ«ì ì§ì ‘ ì…ë ¥\n';
  txt+='4. ì†Œë“ê³µì œ: ì•„ë˜ ê¸ˆì•¡ ì…ë ¥\n';
  txt+='5. [ì‹ ê³ ì„œ ì œì¶œ] â†’ [ë‚©ë¶€] ë˜ëŠ” [í™˜ê¸‰ê³„ì¢Œ ì…ë ¥]\n\n';
  
  txt+='ã€â… . ì¢…í•©ì†Œë“ê¸ˆì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='ê·¼ë¡œì†Œë“ê¸ˆì•¡: '+salaryIncome+'\n';
  txt+='  (ì´ê¸‰ì—¬ '+totalSalary+' - ê·¼ë¡œì†Œë“ê³µì œ '+salDeduct+')\n';
  if(divIncome>0)txt+='ë°°ë‹¹ì†Œë“ê¸ˆì•¡: '+divIncome+'\n';
  txt+='ì‚¬ì—…ì†Œë“ê¸ˆì•¡: '+bizNet+'\n';
  txt+='  (ì´ìˆ˜ì…ê¸ˆì•¡ '+ts+' - í•„ìš”ê²½ë¹„ '+te+')\n';
  txt+='ì¢…í•©ì†Œë“ê¸ˆì•¡ í•©ê³„: '+totalIncome+'\n\n';
  
  txt+='ã€â…¡. ì†Œë“ê³µì œã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='ê¸°ë³¸ê³µì œ(ë³¸ì¸): '+basicDeduct+'\n';
  txt+='êµ­ë¯¼ì—°ê¸ˆë³´í—˜ë£Œ: '+npsA+'\n';
  txt+='ê±´ê°•ë³´í—˜ë£Œ: '+nhiA+'\n';
  txt+='ì¥ê¸°ìš”ì–‘ë³´í—˜ë£Œ: '+ltcA+'\n';
  txt+='ê³ ìš©ë³´í—˜ë£Œ: '+eiA+'\n';
  txt+='ì†Œë“ê³µì œ í•©ê³„: '+totalDeduct+'\n\n';
  
  txt+='ã€â…¢. ê³¼ì„¸í‘œì¤€Â·ì„¸ì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='ê³¼ì„¸í‘œì¤€: '+taxBase+'\n';
  txt+='ì‚°ì¶œì„¸ì•¡: '+calcTax+'\n';
  txt+='ì „ìì‹ ê³  ì„¸ì•¡ê³µì œ: '+eFilingCredit+'\n';
  txt+='ê²°ì •ì„¸ì•¡: '+taxAfterCredit+'\n\n';
  
  txt+='ã€â…£. ê¸°ë‚©ë¶€ì„¸ì•¡ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='ì›ì²œì§•ìˆ˜ì„¸ì•¡(ë‚´ì¼ì‚¬ì¥): '+withheldTax+'\n';
  if(withheldBonus>0)txt+='ì›ì²œì§•ìˆ˜ì„¸ì•¡(ì›ìœŒì•¤ì½”): '+withheldBonus+'\n';
  txt+='ê¸°ë‚©ë¶€ì„¸ì•¡ í•©ê³„: '+totalWithheld+'\n\n';
  
  txt+='ã€â…¤. ìµœì¢… ë‚©ë¶€/í™˜ê¸‰ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+=(finalTax>0?'â˜… ì¶”ê°€ ë‚©ë¶€: ':'â˜… í™˜ê¸‰ ì˜ˆì •: ')+Math.abs(finalTax)+' ì›\n';
  txt+='  ì§€ë°©ì†Œë“ì„¸(10%): '+Math.round(Math.abs(finalTax)*0.1)+' ì›\n';
  txt+='  í•©ê³„(ì†Œë“ì„¸+ì§€ë°©ì†Œë“ì„¸): '+Math.round(Math.abs(finalTax)*1.1)+' ì›\n\n';
  
  txt+='ã€ì¢…ì†Œì„¸ ì²¨ë¶€ì„œë¥˜ ì²´í¬ã€‘\n';
  txt+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  txt+='â˜ ê·¼ë¡œì†Œë“ ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ (ë‚´ì¼ì‚¬ì¥) â€” í™ˆíƒìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°\n';
  txt+='â˜ ê·¼ë¡œì†Œë“/ë°°ë‹¹ì†Œë“ ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ (ì›ìœŒì•¤ì½”)\n';
  txt+='â˜ ì‚¬ì—…ì†Œë“ ì¥ë¶€ (ë³µì‹ë¶€ê¸°) â€” ì´ ë¦¬í¬íŠ¸ ì—‘ì…€ ì°¸ì¡°\n';
  txt+='â˜ êµ­ë¯¼ì—°ê¸ˆÂ·ê±´ê°•ë³´í—˜ë£Œ ë‚©ë¶€ í™•ì¸ì„œ â€” 4ëŒ€ë³´í—˜ ì‚¬ì´íŠ¸\n';
  txt+='â˜ ê²½ì¡°ì‚¬ë¹„ ì¦ë¹™ (ìˆìœ¼ë©´)\n';
  txt+='â€» ëŒ€ë¶€ë¶„ í™ˆíƒìŠ¤ì—ì„œ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ìë™ ì²¨ë¶€ë¨\n';
  txt+='â€» ì‚¬ì—…ì†Œë“ ì¥ë¶€ë§Œ ì§ì ‘ ê´€ë¦¬ í•„ìš” (ì´ í”„ë¡œê·¸ë¨ì´ ê·¸ ì—­í• )\n';
  
  // í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  var blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='í™ˆíƒìŠ¤_ì…ë ¥ê°€ì´ë“œ_2026.txt';a.click();
  URL.revokeObjectURL(url);

  showToast('ğŸ“„ í™ˆíƒìŠ¤ìš© ì„¸ê¸ˆì‹ ê³  ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ (Excel + PDF)');
}

// === INIT ===
var h=new Date().getHours();document.getElementById('gr').textContent=(h<6?'ìƒˆë²½ì—ë„ ì¼í•˜ì‹œëŠ”':h<12?'ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤':h<18?'ì¢‹ì€ ì˜¤í›„ì…ë‹ˆë‹¤':'ì¢‹ì€ ì €ë…ì…ë‹ˆë‹¤')+', ì§€ìœ¤ì§„ ëŒ€í‘œë‹˜';
var loaded=loadData();loadEvt();loadDriveConfig();loadIncomeData();
// ì•ˆì „ì¥ì¹˜: ì¼ê°„ ìŠ¤ëƒ…ìƒ· + ë°ì´í„° ë¬´ê²°ì„± ì²´í¬
try{dailySnapshot()}catch(e){}
try{updateBackupStatus()}catch(e){}
if(loaded&&!D.isDemo){setTimeout(function(){
  var dataCount=(D.tax?D.tax.length:0)+(D.bank?D.bank.length:0)+(D.card?D.card.length:0);
  if(dataCount>0)showToast('ğŸ”’ ë°ì´í„° ì•ˆì „ ('+dataCount+'ê±´ Â· ìë™ë°±ì—… âœ…)');
},2000)}
if(!loaded){D.tax=DTAX.slice();D.isDemo=true}
rAll();renderDD();renderMoney();renderSave();initTaxCut();renderCal();renderTrend();checkMismatch();renderClients();checkCalAlarms();
// ë°ì´í„° ìˆìœ¼ë©´ í•´ë‹¹ íƒ­ ìë™ í™œì„±í™”
setTimeout(function(){
  var btns=document.querySelectorAll('.ib');
  if(D.tax.length&&btns[1])swI(btns[1],'tax');
  else if(D.bank.length&&btns[0])swI(btns[0],'bank');
},200);

// === ì ˆì„¸ ì‹œë®¬ë ˆì´í„° ===
function calcIncomeTax(taxBase){
  if(taxBase<=0)return 0;
  if(taxBase<=14000000)return taxBase*0.06;
  if(taxBase<=50000000)return 14000000*0.06+(taxBase-14000000)*0.15;
  if(taxBase<=88000000)return 14000000*0.06+36000000*0.15+(taxBase-50000000)*0.24;
  if(taxBase<=150000000)return 14000000*0.06+36000000*0.15+38000000*0.24+(taxBase-88000000)*0.35;
  if(taxBase<=300000000)return 14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+(taxBase-150000000)*0.38;
  if(taxBase<=500000000)return 14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+150000000*0.38+(taxBase-300000000)*0.40;
  return 14000000*0.06+36000000*0.15+38000000*0.24+62000000*0.35+150000000*0.38+200000000*0.40+(taxBase-500000000)*0.42;
}

function renderSave(){
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0);
  var te=et.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0);
  var dTx=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var ndTx=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'}).reduce(function(a,r){return a+r.tax},0);
  var income=ts-te;
  var basicDeduct=1500000;

  // ===== ë¶€ê°€ì„¸ ì ˆì„¸ ë¶„ì„ =====
  var vatSaves=[];
  var vatSaveTotal=0;

  // 1) ë¶ˆê³µì œ â†’ ê³µì œ ì „í™˜ ê°€ëŠ¥ ë¶„ì„
  var ndItems=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'});
  if(ndItems.length>0){
    var potentialSave=ndItems.reduce(function(a,r){return a+r.tax},0);
    vatSaves.push({icon:'fa-exchange-alt',color:'var(--rd)',bg:'#FFEBEE',title:'ë¶ˆê³µì œ ë§¤ì…ì„¸ì•¡ ê³µì œ ì „í™˜ ê²€í† ',desc:'í˜„ì¬ ë¶ˆê³µì œ '+ndItems.length+'ê±´(ì„¸ì•¡ '+fm(potentialSave)+'ì›). ì‚¬ì—…ìš© ì¹´ë“œ ë“±ë¡, ì ê²©ì¦ë¹™ ìˆ˜ì·¨ ì‹œ ê³µì œ ì „í™˜ ê°€ëŠ¥.',save:potentialSave,priority:'ë†’ìŒ',pcolor:'var(--rd)',actions:['ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ í™ˆíƒìŠ¤ ë“±ë¡ í™•ì¸','ì ‘ëŒ€ë¹„ ì™¸ ì¼ë°˜ê²½ë¹„ëŠ” ì ê²©ì¦ë¹™ ìˆ˜ì·¨ ì‹œ ê³µì œ ê°€ëŠ¥','ê°„ì´ê³¼ì„¸ì ë°œê¸‰ë¶„ â†’ ì¼ë°˜ê³¼ì„¸ì ê±°ë˜ì²˜ ë³€ê²½ ê²€í† ']});
    vatSaveTotal+=potentialSave;
  }

  // 2) ë§¤ì…ì„¸ì•¡ ê³µì œ ê·¹ëŒ€í™”
  if(ts>0){
    var expRatio=te/ts*100;
    if(expRatio<30){
      var targetExp=ts*0.3;var addExp=targetExp-te;var addTax=Math.round(addExp*0.1);
      vatSaves.push({icon:'fa-cart-plus',color:'var(--or)',bg:'#FFF3E0',title:'ì‚¬ì—… ê´€ë ¨ ë§¤ì… í™•ëŒ€ ê²€í† ',desc:'í˜„ì¬ ë§¤ì…ë¹„ìœ¨ '+Math.round(expRatio)+'%. ì—…ë¬´ìš© ì¥ë¹„Â·ì†Œí”„íŠ¸ì›¨ì–´Â·ê´‘ê³ ë¹„ ë“± ì‚¬ì—…ê²½ë¹„ ë§¤ì… ì‹œ ì„¸ì•¡ê³µì œ ì¶”ê°€ ê°€ëŠ¥.',save:addTax,priority:'ì¤‘ê°„',pcolor:'var(--or)',actions:['ì—…ë¬´ìš© ë…¸íŠ¸ë¶Â·ëª¨ë‹ˆí„° ë“± ì¥ë¹„ êµ¬ë§¤ (ì‚¬ì—…ìš© ì¹´ë“œ ê²°ì œ)','ê´‘ê³ ë¹„Â·ë§ˆì¼€íŒ…ë¹„ ì§‘í–‰ (ë„¤ì´ë²„Â·êµ¬ê¸€ ê´‘ê³ )','ì‚¬ë¬´ìš©í’ˆÂ·ì†Œí”„íŠ¸ì›¨ì–´ ë¼ì´ì„ ìŠ¤ êµ¬ë§¤','ì—…ë¬´ìš© ì°¨ëŸ‰ ìœ ì§€ë¹„ (ìœ ë¥˜ë¹„Â·ìˆ˜ë¦¬ë¹„)']});
      vatSaveTotal+=addTax;
    }
  }

  // 3) ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
  vatSaves.push({icon:'fa-file-invoice-dollar',color:'var(--bl)',bg:'#E3F2FD',title:'ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨ í™•ì¸',desc:'ì¢…ì´ ì„¸ê¸ˆê³„ì‚°ì„œëŠ” ë§¤ì…ì„¸ì•¡ ë¶ˆê³µì œ ìœ„í—˜. ëª¨ë“  ê±°ë˜ë¥¼ ì „ìì„¸ê¸ˆê³„ì‚°ì„œë¡œ ìˆ˜ì·¨í•˜ë©´ ê³µì œ ëˆ„ë½ ë°©ì§€.',save:0,priority:'í•„ìˆ˜',pcolor:'var(--nv)',actions:['ê±°ë˜ì²˜ì— ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ìš”ì²­','í™ˆíƒìŠ¤ì—ì„œ ìˆ˜ì·¨ ë‚´ì—­ ëŒ€ì‚¬ í™•ì¸','ë§¤ì›” ë§ ë¯¸ìˆ˜ì·¨ë¶„ ì²´í¬']});

  // 4) ì‚¬ì—…ìš© ì¹´ë“œ ë“±ë¡
  vatSaves.push({icon:'fa-credit-card',color:'var(--pr)',bg:'#F3E5F5',title:'ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ í™ˆíƒìŠ¤ ë“±ë¡',desc:'ì‚¬ì—…ìš© ì¹´ë“œ ë“±ë¡ ì‹œ ë¶€ê°€ì„¸ ë§¤ì…ì„¸ì•¡ ìë™ ê³µì œ. ë¯¸ë“±ë¡ ì‹œ ë¶ˆê³µì œ ì²˜ë¦¬ ìœ„í—˜.',save:0,priority:'í•„ìˆ˜',pcolor:'var(--nv)',actions:['í™ˆíƒìŠ¤ â†’ ì¡°íšŒ/ë°œê¸‰ â†’ ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ ë“±ë¡','ëª¨ë“  ì‚¬ì—… ê²½ë¹„ë¥¼ ë“±ë¡ëœ ì¹´ë“œë¡œ ê²°ì œ','ê°œì¸ì¹´ë“œ ì‚¬ìš©ë¶„ì€ ê³µì œ ë¶ˆê°€ â†’ ë¶„ë¦¬ í•„ìˆ˜']});

  document.getElementById('vat-save-list').innerHTML=vatSaves.map(function(s){
    return'<div class="cd" style="border-left:4px solid '+s.color+'"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px"><div style="display:flex;align-items:center;gap:10px"><div style="width:40px;height:40px;border-radius:10px;background:'+s.bg+';display:flex;align-items:center;justify-content:center;font-size:16px;color:'+s.color+'"><i class="fas '+s.icon+'"></i></div><div><div style="font-size:14px;font-weight:700">'+s.title+'</div><div style="font-size:11px;color:var(--sub);margin-top:2px">ìš°ì„ ìˆœìœ„: <span style="color:'+s.pcolor+';font-weight:700">'+s.priority+'</span></div></div></div>'+(s.save>0?'<div style="background:#E8F5E9;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:800;color:var(--gn);white-space:nowrap">-'+fm(s.save)+'ì›</div>':'')+'</div><div style="font-size:12px;color:#555;line-height:1.6;margin-bottom:10px">'+s.desc+'</div><div style="background:#f8f9fa;border-radius:var(--rs);padding:12px 14px"><div style="font-size:11px;font-weight:600;color:var(--nv);margin-bottom:6px">ğŸ“‹ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>'+s.actions.map(function(a){return'<div style="font-size:12px;color:#555;line-height:1.8;padding-left:4px">â˜ '+a+'</div>'}).join('')+'</div></div>';
  }).join('');

  // ===== ì¢…ì†Œì„¸ ì ˆì„¸ ë¶„ì„ =====
  // ê²½ë¹„ìœ¨ ë¹„êµ ì‹œë®¬ë ˆì´ì…˜
  // ê´‘ê³ ëŒ€í–‰ì—… ë‹¨ìˆœê²½ë¹„ìœ¨ ì•½ 64.1%, ê¸°ì¤€ê²½ë¹„ìœ¨ ì•½ 18.4% (ì—…ì¢…ì½”ë“œ 743002)
  var simpleRate=0.641;var stdRate=0.184;
  var incSimple=Math.round(ts*(1-simpleRate));var incStd=Math.round(ts*(1-stdRate));
  var bookIncome=income; // ì¥ë¶€ê¸°ì¥ = ì‹¤ì œ ì†Œë“

  var taxBook=Math.round(calcIncomeTax(Math.max(bookIncome-basicDeduct,0)));
  var taxStd=Math.round(calcIncomeTax(Math.max(incStd-basicDeduct,0)));
  var taxSimple=Math.round(calcIncomeTax(Math.max(incSimple-basicDeduct,0)));

  document.getElementById('sim-book').textContent=fm(taxBook)+'ì›';
  document.getElementById('sim-std').textContent=fm(taxStd)+'ì›';
  document.getElementById('sim-simple').textContent=fm(taxSimple)+'ì›';
  document.getElementById('sim-std-diff').textContent=(taxStd>taxBook?'+':'')+fm(taxStd-taxBook)+'ì›';
  document.getElementById('sim-std-diff').style.color=taxStd>taxBook?'var(--rd)':'var(--gn)';
  document.getElementById('sim-simple-diff').textContent=(taxSimple>taxBook?'+':'')+fm(taxSimple-taxBook)+'ì›';
  document.getElementById('sim-simple-diff').style.color=taxSimple>taxBook?'var(--rd)':'var(--gn)';

  // ì†Œë“ê³µì œ/ì„¸ì•¡ê³µì œ ì²´í¬ë¦¬ìŠ¤íŠ¸
  // 4ëŒ€ë³´í—˜ = ë‚´ì¼ì‚¬ì¥ ê·¼ë¡œì†Œë“ ê¸°ë°˜
  var salMon=parseInt(document.getElementById('salary-monthly').value||0)*10000;if(!salMon)salMon=2000000;
  var npsAnnual=Math.round(salMon*0.045*12);var nhiAnnual=Math.round(salMon*0.03545*12);
  var ltcAnnual=Math.floor(Math.floor(salMon*0.03545)*0.9182/7.09/10)*10*12;var eiAnnual=Math.round(salMon*0.009*12);
  var deductions=[
    {name:'êµ­ë¯¼ì—°ê¸ˆ ë³´í—˜ë£Œ',type:'ì†Œë“ê³µì œ',est:npsAnnual,desc:'ë‚´ì¼ì‚¬ì¥ ì›”ê¸‰ '+fm(salMon)+'ì› Ã— 4.5% Ã— 12ê°œì›”',checked:true,icon:'fa-shield-halved'},
    {name:'ê±´ê°•ë³´í—˜ë£Œ',type:'ì†Œë“ê³µì œ',est:nhiAnnual,desc:'ë‚´ì¼ì‚¬ì¥ ì›”ê¸‰ ê¸°ì¤€ 3.545% Ã— 12ê°œì›”',checked:true,icon:'fa-heart-pulse'},
    {name:'ì¥ê¸°ìš”ì–‘ë³´í—˜ë£Œ',type:'ì†Œë“ê³µì œ',est:ltcAnnual,desc:'ê±´ê°•ë³´í—˜ë£Œì˜ 12.95% Ã— 12ê°œì›”',checked:true,icon:'fa-hand-holding-medical'},
    {name:'ê³ ìš©ë³´í—˜ë£Œ',type:'ì†Œë“ê³µì œ',est:eiAnnual,desc:'ë‚´ì¼ì‚¬ì¥ ì›”ê¸‰ ê¸°ì¤€ 0.9% Ã— 12ê°œì›”',checked:true,icon:'fa-briefcase'},
    {name:'ê¸°ë¶€ê¸ˆ',type:'ì†Œë“/ì„¸ì•¡ê³µì œ',est:0,desc:'ë²•ì •ê¸°ë¶€ê¸ˆ ì „ì•¡, ì§€ì •ê¸°ë¶€ê¸ˆ ì†Œë“ 30% í•œë„',checked:false,icon:'fa-hand-holding-heart'},
    {name:'ì „ìì‹ ê³  ì„¸ì•¡ê³µì œ',type:'ì„¸ì•¡ê³µì œ',est:20000,desc:'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ì‹œ 2ë§Œì›',checked:true,icon:'fa-laptop'},
    {name:'ì„±ì‹¤ì‹ ê³ í™•ì¸ ì„¸ì•¡ê³µì œ',type:'ì„¸ì•¡ê³µì œ',est:0,desc:'ìˆ˜ì…ê¸ˆì•¡ ê¸°ì¤€ (í•´ë‹¹ ì‹œ í™•ì¸ë¹„ìš© 60%)',checked:false,icon:'fa-user-check'},
    {name:'ì¤‘ì†Œê¸°ì—… ì‚¬íšŒë³´í—˜ë£Œ ì„¸ì•¡ê³µì œ',type:'ì„¸ì•¡ê³µì œ',est:0,desc:'ê³ ìš©ì¦ê°€ ì‹œ ì‚¬íšŒë³´í—˜ë£Œ ì„¸ì•¡ê³µì œ (ì§ì› ê³ ìš© ì‹œ)',checked:false,icon:'fa-users'}
  ];

  var deductTotal=deductions.filter(function(d){return!d.checked&&d.est>0}).reduce(function(a,d){return a+d.est},0);

  document.getElementById('deduction-list').innerHTML=deductions.map(function(d){
    var statusBg=d.checked?'#E8F5E9':'#FFF3E0';var statusColor=d.checked?'var(--gn)':'var(--or)';var statusText=d.checked?'âœ… ì¶”ì • ì ìš©':'â¬œ ë¯¸ì ìš©';
    return'<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f0f0f0"><div style="width:36px;height:36px;border-radius:10px;background:'+statusBg+';display:flex;align-items:center;justify-content:center;font-size:14px;color:'+statusColor+';flex-shrink:0"><i class="fas '+d.icon+'"></i></div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">'+d.name+' <span class="badge '+(d.type.indexOf('ì„¸ì•¡')>-1?'b-bl':'b-gn')+'">'+d.type+'</span></div><div style="font-size:11px;color:var(--sub);margin-top:2px">'+d.desc+'</div></div><div style="text-align:right"><div style="font-size:11px;font-weight:700;color:'+statusColor+'">'+statusText+'</div>'+(d.est>0?'<div style="font-size:12px;font-weight:800;color:var(--nv)">'+fm(d.est)+'ì›</div>':'')+'</div></div>';
  }).join('');

  // ì¢…ì†Œì„¸ ì ˆì„¸ ì¹´ë“œ
  var incSaves=[];
  if(deductTotal>0){
    incSaves.push({icon:'fa-coins',color:'var(--gn)',bg:'#E8F5E9',title:'ë¯¸ì ìš© ê³µì œí•­ëª© í™œìš©',desc:'ê¸°ë¶€ê¸ˆ ë“± ë¯¸ì ìš© í•­ëª© í™•ì¸. ì—°ê°„ ì•½ '+fm(deductTotal)+'ì› ê³µì œ íš¨ê³¼.',save:Math.round(deductTotal*0.15),actions:['ê¸°ë¶€ê¸ˆ ì˜ìˆ˜ì¦ ëˆ„ë½ë¶„ í™•ì¸','ì‚¬ì—…ìš© ê²½ë¹„ ëˆ„ë½ ì²´í¬','ê·¼ë¡œì†Œë“ ì›ì²œì§•ìˆ˜ ì˜ìˆ˜ì¦ í™•ì¸']});
  }
  incSaves.push({icon:'fa-book-open',color:'var(--bl)',bg:'#E3F2FD',title:'ì¥ë¶€ê¸°ì¥ ìœ ì§€ (ë³µì‹ë¶€ê¸°)',desc:'ë‹¨ìˆœê²½ë¹„ìœ¨ ëŒ€ë¹„ ì„¸ê¸ˆ '+(taxSimple>taxBook?fm(taxSimple-taxBook)+'ì›':'0ì›')+' ì ˆì•½. ì¥ë¶€ê¸°ì¥ì€ ê°€ì¥ ê°•ë ¥í•œ ì ˆì„¸ ìˆ˜ë‹¨.',save:Math.max(taxSimple-taxBook,0),actions:['ì„¸ë¬´ì‚¬ ê¸°ì¥ëŒ€ë¦¬ ìœ ì§€','ëª¨ë“  ì§€ì¶œ ì ê²©ì¦ë¹™ ìˆ˜ì·¨','ì‚¬ì—…ìš© í†µì¥Â·ì¹´ë“œ ë¶„ë¦¬ ìš´ì˜']});
  incSaves.push({icon:'fa-calendar-alt',color:'var(--or)',bg:'#FFF3E0',title:'ì„±ì‹¤ì‹ ê³  + ë‚©ë¶€ê¸°í•œ ì—°ì¥ í™œìš©',desc:'ì¢…ì†Œì„¸ ë‚©ë¶€ì„¸ì•¡ì´ 1,000ë§Œì› ì´ˆê³¼ ì‹œ ë¶„ë‚© ê°€ëŠ¥ (2ê°œì›”). ë‚©ë¶€ ë¶€ë‹´ ë¶„ì‚°.',save:0,actions:['ë‚©ë¶€ì„¸ì•¡ 1,000ë§Œì› ì´ˆê³¼ ì‹œ ë¶„ë‚© ì‹ ì²­','ì¤‘ê°„ì˜ˆë‚© ì¶”ê³„ì•¡ ì‹ ê³  (11ì›”)','ì„±ì‹¤ì‹ ê³ í™•ì¸ ëŒ€ìƒ ì—¬ë¶€ ì—°ê°„ ìˆ˜ì…ê¸ˆì•¡ ì²´í¬']});

  document.getElementById('inc-save-list').innerHTML=incSaves.map(function(s){
    return'<div class="cd" style="border-left:4px solid '+s.color+'"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px"><div style="display:flex;align-items:center;gap:10px"><div style="width:40px;height:40px;border-radius:10px;background:'+s.bg+';display:flex;align-items:center;justify-content:center;font-size:16px;color:'+s.color+'"><i class="fas '+s.icon+'"></i></div><div style="font-size:14px;font-weight:700">'+s.title+'</div></div>'+(s.save>0?'<div style="background:#E8F5E9;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:800;color:var(--gn);white-space:nowrap">-'+fm(s.save)+'ì›</div>':'')+'</div><div style="font-size:12px;color:#555;line-height:1.6;margin-bottom:10px">'+s.desc+'</div><div style="background:#f8f9fa;border-radius:var(--rs);padding:12px 14px"><div style="font-size:11px;font-weight:600;color:var(--nv);margin-bottom:6px">ğŸ“‹ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>'+s.actions.map(function(a){return'<div style="font-size:12px;color:#555;line-height:1.8;padding-left:4px">â˜ '+a+'</div>'}).join('')+'</div></div>';
  }).join('');

  // ì¦‰ì‹œ ì‹¤í–‰ ì•¡ì…˜
  var actions=[];
  if(ndItems.length>0)actions.push({urgency:'ğŸ”´',title:'ë¶ˆê³µì œ '+ndItems.length+'ê±´ ì ê²©ì¦ë¹™ í™•ë³´',save:ndTx,desc:'ì¿ íŒ¡Â·í‚¤ë‹¤ì³‰ ë“± ë§¤ì…ë¶„ì„ ì‚¬ì—…ìš©ì¹´ë“œë¡œ ì¬ê²°ì œí•˜ê±°ë‚˜ ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨'});
  actions.push({urgency:'ğŸŸ¡',title:'ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ í™ˆíƒìŠ¤ ë“±ë¡ í™•ì¸',save:0,desc:'í™ˆíƒìŠ¤ > ì¡°íšŒ/ë°œê¸‰ > ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ > ë“±ë¡ì—¬ë¶€ í™•ì¸'});
  actions.push({urgency:'ğŸŸ¡',title:'ì¹´ë“œ ë§¤ì… ë¶ˆê³µì œ â†’ ê³µì œ ì „í™˜',save:ndTx,desc:'ì‚¬ì—…ìš©ì¹´ë“œë¡œ ì¬ê²°ì œ ë˜ëŠ” ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì·¨í•˜ì—¬ ë§¤ì…ì„¸ì•¡ê³µì œ í™•ë³´'});
  actions.push({urgency:'ğŸŸ¢',title:'ë¶€ê°€ì„¸ ì‹ ê³  ì „ ë§¤ì… ì„¸ê¸ˆê³„ì‚°ì„œ ëˆ„ë½ í™•ì¸',save:0,desc:'í™ˆíƒìŠ¤ > ì „ìì„¸ê¸ˆê³„ì‚°ì„œ > ë§¤ì… ë‚´ì—­ ì¡°íšŒ â†’ ì¥ë¶€ì™€ ëŒ€ì‚¬'});
  actions.push({urgency:'ğŸŸ¢',title:'ì—…ë¬´ìš© ì¥ë¹„ ì—°ë‚´ êµ¬ë§¤ ê³„íš',save:0,desc:'ë…¸íŠ¸ë¶Â·ëª¨ë‹ˆí„°Â·ì†Œí”„íŠ¸ì›¨ì–´ ë“± í•„ìš” ì¥ë¹„ë¥¼ ì—°ë‚´ ì‚¬ì—…ìš©ì¹´ë“œë¡œ êµ¬ë§¤'});

  document.getElementById('action-list').innerHTML=actions.map(function(a,i){
    return'<div class="cd" style="border-left:4px solid '+(a.urgency==='ğŸ”´'?'var(--rd)':a.urgency==='ğŸŸ¡'?'var(--or)':'var(--gn)')+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-size:14px;font-weight:700">'+a.urgency+' '+(i+1)+'. '+a.title+'</div>'+(a.save>0?'<div style="font-size:13px;font-weight:800;color:var(--gn)">-'+fm(a.save)+'ì›</div>':'')+'</div><div style="font-size:12px;color:#555;line-height:1.5">'+a.desc+'</div></div>';
  }).join('');


  // === í™ˆíƒìŠ¤ ì‹ ê³  ì–´ì‹œìŠ¤í„´íŠ¸ ===
  var b=getBaseNumbers();
  var st=D.tax.filter(function(r){return r.type==='ë§¤ì¶œ'}),et=D.tax.filter(function(r){return r.type==='ë§¤ì…'});
  var ts=st.reduce(function(a,r){return a+r.supply},0);
  var sTx=st.reduce(function(a,r){return a+r.tax},0);
  var etDed=et.filter(function(r){return r.deductible!=='ë¶ˆê³µì œ'});
  var etNon=et.filter(function(r){return r.deductible==='ë¶ˆê³µì œ'});
  var dTx=etDed.reduce(function(a,r){return a+r.tax},0);
  var ndTx=etNon.reduce(function(a,r){return a+r.tax},0);
  var cardSalesAmt=D.card.filter(function(c){return c.type==='ë§¤ì¶œ'}).reduce(function(a,c){return a+c.amount},0);
  var cardPurchaseAmt=D.card.filter(function(c){return c.type!=='ë§¤ì¶œ'}).reduce(function(a,c){return a+c.amount},0);
  var salMon2=parseInt(document.getElementById('salary-monthly').value||0)*10000;
  var salAnnual2=salMon2*12;
  var bonusType2=document.getElementById('bonus-type').value;
  var bonusAmt2=parseInt(document.getElementById('bonus-amt').value||0)*10000;
  var totalSalary2=salAnnual2+(bonusType2==='salary'?bonusAmt2:0);
  var salDeduct2=0;
  if(totalSalary2<=5000000)salDeduct2=totalSalary2*0.7;
  else if(totalSalary2<=15000000)salDeduct2=3500000+(totalSalary2-5000000)*0.4;
  else if(totalSalary2<=45000000)salDeduct2=7500000+(totalSalary2-15000000)*0.15;
  else if(totalSalary2<=100000000)salDeduct2=12000000+(totalSalary2-45000000)*0.05;
  else salDeduct2=14750000+(totalSalary2-100000000)*0.02;
  salDeduct2=Math.round(salDeduct2);
  var salaryIncome2=Math.max(totalSalary2-salDeduct2,0);
  var divIncome2=bonusType2==='dividend'?bonusAmt2:0;
  var bizNet2=Math.max(ts-et.reduce(function(a,r){return a+r.supply},0),0);
  var totalIncome2=salaryIncome2+divIncome2+bizNet2;
  var nps2=Math.round(salMon2*0.045*12);var nhi2=Math.round(salMon2*0.03545*12);
  var ltc2=Math.floor(Math.floor(salMon2*0.03545)*0.9182/7.09/10)*10*12;var ei2=Math.round(salMon2*0.009*12);
  var totalDeduct2=1500000+nps2+nhi2+ltc2+ei2;
  var taxBase2=Math.max(totalIncome2-totalDeduct2,0);
  var calcTax2=0;
  if(taxBase2<=14000000)calcTax2=Math.round(taxBase2*0.06);
  else if(taxBase2<=50000000)calcTax2=Math.round(840000+(taxBase2-14000000)*0.15);
  else if(taxBase2<=88000000)calcTax2=Math.round(6240000+(taxBase2-50000000)*0.24);
  else if(taxBase2<=150000000)calcTax2=Math.round(15360000+(taxBase2-88000000)*0.35);
  else calcTax2=Math.round(37060000+(taxBase2-150000000)*0.38);
  var finalTax2=Math.max(calcTax2-20000,0);

  function cpBtn(val){return'<button onclick="navigator.clipboard.writeText(\''+val+'\');this.textContent=\'âœ…\';var b=this;setTimeout(function(){b.textContent=\'ğŸ“‹\'},800)" style="background:none;border:1px solid #ddd;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:11px;margin-left:4px" title="ë³µì‚¬">ğŸ“‹</button>'}
  
  var g='<div class="cd" style="border-left:4px solid #E74C3C;margin-top:16px">';
  g+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#E74C3C,#C0392B);display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff"><i class="fas fa-desktop"></i></div><div><div style="font-size:17px;font-weight:800">ğŸ–¥ï¸ í™ˆíƒìŠ¤ ì‹ ê³  ì–´ì‹œìŠ¤í„´íŠ¸</div><div style="font-size:11px;color:var(--sub)">ì•„ë˜ ìˆ«ìë¥¼ í™ˆíƒìŠ¤ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš” Â· ğŸ“‹ ë²„íŠ¼ìœ¼ë¡œ ìˆ«ì ë³µì‚¬</div></div></div>';
  
  // ===== ë¶€ê°€ì„¸ =====
  g+='<div style="background:linear-gradient(135deg,#FFF8E1,#FFFDE7);border:2px solid #FFD54F;border-radius:12px;padding:16px;margin-bottom:14px">';
  g+='<div style="font-size:14px;font-weight:800;color:#E65100;margin-bottom:12px">ğŸ’° ë¶€ê°€ì„¸ ì‹ ê³  (7ì›” 27ì¼ê¹Œì§€)</div>';
  g+='<div style="font-size:11px;color:#E65100;background:#FFF3E0;padding:8px 12px;border-radius:8px;margin-bottom:12px;line-height:1.6">ğŸ“ í™ˆíƒìŠ¤ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ë¶€ê°€ê°€ì¹˜ì„¸ â†’ ì •ê¸°ì‹ ê³ (í™•ì •)<br>ğŸ“ [ë¯¸ë¦¬ì±„ì›€] í´ë¦­ â†’ ì•„ë˜ ìˆ«ìì™€ ëŒ€ì‚¬ â†’ ì œì¶œ</div>';
  
  g+='<table style="width:100%;font-size:12px;border-collapse:collapse">';
  g+='<tr style="background:#F57F17;color:#fff"><th style="padding:8px;text-align:left;border-radius:6px 0 0 0">í™ˆíƒìŠ¤ í•­ëª©</th><th style="padding:8px;text-align:right">ë‚´ ì¥ë¶€ ìˆ«ì</th><th style="padding:8px;width:30px;border-radius:0 6px 0 0">ë³µì‚¬</th></tr>';
  
  // ë§¤ì¶œ
  g+='<tr style="background:#fff"><td style="padding:8px;border-bottom:1px solid #eee"><b>(1) ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œ</b></td><td style="padding:8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+st.length+'ê±´ / ê³µê¸‰ê°€ì•¡ '+fm(ts)+' / ì„¸ì•¡ '+fm(sTx)+'</td><td style="padding:8px;border-bottom:1px solid #eee">'+cpBtn(ts)+'</td></tr>';
  
  if(cardSalesAmt>0){
    var csSup=Math.round(cardSalesAmt/1.1);
    g+='<tr style="background:#FFFDE7"><td style="padding:8px;border-bottom:1px solid #eee"><b>(3) ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œ</b></td><td style="padding:8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">ê³µê¸‰ê°€ì•¡ '+fm(csSup)+' / ì„¸ì•¡ '+fm(cardSalesAmt-csSup)+'</td><td style="padding:8px;border-bottom:1px solid #eee">'+cpBtn(csSup)+'</td></tr>';
  }
  
  // ë§¤ì…
  g+='<tr style="background:#fff"><td style="padding:8px;border-bottom:1px solid #eee"><b>(10) ì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì… (ê³µì œ)</b></td><td style="padding:8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+etDed.length+'ê±´ / ê³µê¸‰ê°€ì•¡ '+fm(etDed.reduce(function(a,r){return a+r.supply},0))+' / ì„¸ì•¡ '+fm(dTx)+'</td><td style="padding:8px;border-bottom:1px solid #eee">'+cpBtn(dTx)+'</td></tr>';
  
  if(cardPurchaseAmt>0){
    var cpSup=Math.round(cardPurchaseAmt/1.1);
    g+='<tr style="background:#FFFDE7"><td style="padding:8px;border-bottom:1px solid #eee"><b>(14) ì¹´ë“œ ë§¤ì…</b></td><td style="padding:8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">ê³µê¸‰ê°€ì•¡ '+fm(cpSup)+' / ì„¸ì•¡ '+fm(cardPurchaseAmt-cpSup)+'</td><td style="padding:8px;border-bottom:1px solid #eee">'+cpBtn(cpSup)+'</td></tr>';
  }
  
  if(etNon.length>0){
    g+='<tr style="background:#FFEBEE"><td style="padding:8px;border-bottom:1px solid #eee"><b>(49) ë¶ˆê³µì œ ë§¤ì…</b></td><td style="padding:8px;text-align:right;border-bottom:1px solid #eee;font-weight:700;color:var(--rd)">'+etNon.length+'ê±´ / ì„¸ì•¡ '+fm(ndTx)+'</td><td style="padding:8px;border-bottom:1px solid #eee">'+cpBtn(ndTx)+'</td></tr>';
  }
  
  g+='<tr style="background:#FFF9C4"><td style="padding:10px;font-weight:800;font-size:13px">â˜… ë‚©ë¶€ì„¸ì•¡ (73)</td><td style="padding:10px;text-align:right;font-weight:800;font-size:15px;color:#B71C1C">'+fm(b.vat)+'ì›</td><td style="padding:10px">'+cpBtn(b.vat)+'</td></tr>';
  g+='</table>';
  
  g+='<div style="margin-top:10px;font-size:11px;color:#888;line-height:1.6">â€» ì „ìì„¸ê¸ˆê³„ì‚°ì„œ = í™ˆíƒìŠ¤ ìë™ ë°˜ì˜ (ë¯¸ë¦¬ì±„ì›€)<br>â€» ì‚¬ì—…ìš©ì¹´ë“œ ë“±ë¡í–ˆìœ¼ë©´ ì¹´ë“œë§¤ì…ë„ ìë™ ë°˜ì˜<br>â€» ì²¨ë¶€ì„œë¥˜ = ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ì‚¬ìš© ì‹œ ìë™ ì²¨ë¶€ë¨</div>';
  g+='</div>';
  
  // ===== ì¢…ì†Œì„¸ =====
  g+='<div style="background:linear-gradient(135deg,#E3F2FD,#BBDEFB);border:2px solid #64B5F6;border-radius:12px;padding:16px;margin-bottom:14px">';
  g+='<div style="font-size:14px;font-weight:800;color:#0D47A1;margin-bottom:12px">ğŸ“‹ ì¢…ì†Œì„¸ ì‹ ê³  (5ì›” 31ì¼ê¹Œì§€)</div>';
  g+='<div style="font-size:11px;color:#1565C0;background:#E8EAF6;padding:8px 12px;border-radius:8px;margin-bottom:12px;line-height:1.6">ğŸ“ í™ˆíƒìŠ¤ â†’ ì„¸ê¸ˆì‹ ê³  â†’ ì¢…í•©ì†Œë“ì„¸ â†’ ì¼ë°˜ì‹ ê³ <br>ğŸ“ ê·¼ë¡œì†Œë“ [ë¶ˆëŸ¬ì˜¤ê¸°] â†’ ì‚¬ì—…ì†Œë“ ì•„ë˜ ìˆ«ì ì…ë ¥</div>';
  
  g+='<table style="width:100%;font-size:12px;border-collapse:collapse">';
  g+='<tr style="background:#1565C0;color:#fff"><th style="padding:8px;text-align:left;border-radius:6px 0 0 0">í™ˆíƒìŠ¤ ì…ë ¥ í•­ëª©</th><th style="padding:8px;text-align:right">ê¸ˆì•¡</th><th style="padding:8px;width:30px;border-radius:0 6px 0 0">ë³µì‚¬</th></tr>';
  
  g+='<tr style="background:#E3F2FD"><td colspan="3" style="padding:6px 8px;font-weight:700;font-size:11px;color:#1565C0">â… . ì†Œë“ê¸ˆì•¡</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ê·¼ë¡œì†Œë“ê¸ˆì•¡ (ì´ê¸‰ì—¬ '+fm(totalSalary2)+')</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+fm(salaryIncome2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(salaryIncome2)+'</td></tr>';
  if(divIncome2>0) g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ë°°ë‹¹ì†Œë“ê¸ˆì•¡</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+fm(divIncome2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(divIncome2)+'</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ì‚¬ì—…ì†Œë“ â€” <b>ì´ìˆ˜ì…ê¸ˆì•¡</b></td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700;color:#E65100">'+fm(ts)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(ts)+'</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ì‚¬ì—…ì†Œë“ â€” <b>í•„ìš”ê²½ë¹„</b></td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700;color:#E65100">'+fm(et.reduce(function(a,r){return a+r.supply},0))+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(et.reduce(function(a,r){return a+r.supply},0))+'</td></tr>';
  g+='<tr style="background:#E8F5E9"><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600">â†’ ì¢…í•©ì†Œë“ê¸ˆì•¡</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:800">'+fm(totalIncome2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(totalIncome2)+'</td></tr>';
  
  g+='<tr style="background:#E3F2FD"><td colspan="3" style="padding:6px 8px;font-weight:700;font-size:11px;color:#1565C0">â…¡. ì†Œë“ê³µì œ</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ê¸°ë³¸ê³µì œ (ë³¸ì¸)</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee">1,500,000</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(1500000)+'</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">êµ­ë¯¼ì—°ê¸ˆ</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee">'+fm(nps2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(nps2)+'</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ê±´ê°•ë³´í—˜+ì¥ê¸°ìš”ì–‘+ê³ ìš©</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee">'+fm(nhi2+ltc2+ei2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(nhi2+ltc2+ei2)+'</td></tr>';
  
  g+='<tr style="background:#E3F2FD"><td colspan="3" style="padding:6px 8px;font-weight:700;font-size:11px;color:#1565C0">â…¢. ì„¸ì•¡ ê³„ì‚°</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ê³¼ì„¸í‘œì¤€</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+fm(taxBase2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(taxBase2)+'</td></tr>';
  g+='<tr style="background:#fff"><td style="padding:6px 8px;border-bottom:1px solid #eee">ì‚°ì¶œì„¸ì•¡</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid #eee;font-weight:700">'+fm(calcTax2)+'</td><td style="padding:6px 8px;border-bottom:1px solid #eee">'+cpBtn(calcTax2)+'</td></tr>';
  g+='<tr style="background:#FFF9C4"><td style="padding:10px;font-weight:800;font-size:13px">â˜… ê²°ì •ì„¸ì•¡</td><td style="padding:10px;text-align:right;font-weight:800;font-size:15px;color:#0D47A1">'+fm(finalTax2)+'ì›</td><td style="padding:10px">'+cpBtn(finalTax2)+'</td></tr>';
  g+='</table>';
  
  g+='<div style="margin-top:10px;font-size:11px;color:#888;line-height:1.6">â€» ê·¼ë¡œì†Œë“ = í™ˆíƒìŠ¤ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ìë™ ë°˜ì˜<br>â€» ì‚¬ì—…ì†Œë“ ì´ìˆ˜ì…ê¸ˆì•¡/í•„ìš”ê²½ë¹„ë§Œ ì§ì ‘ ì…ë ¥<br>â€» 4ëŒ€ë³´í—˜ë£Œ = ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ í™•ì¸ í›„ ì…ë ¥<br>â€» ì²¨ë¶€ì„œë¥˜ ì—†ìŒ (ì¥ë¶€ëŠ” 5ë…„ ë³´ê´€ ì˜ë¬´)</div>';
  g+='</div>';
  
  // ===== ì‹ ê³  ì²´í¬ë¦¬ìŠ¤íŠ¸ =====
  g+='<div style="background:#F3E5F5;border:2px solid #CE93D8;border-radius:12px;padding:16px">';
  g+='<div style="font-size:14px;font-weight:800;color:#6A1B9A;margin-bottom:12px">âœ… ì‹ ê³  ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>';
  g+='<div style="font-size:12px;line-height:2.2;color:#333">';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">í™ˆíƒìŠ¤ ì‚¬ì—…ìš© ì‹ ìš©ì¹´ë“œ ë“±ë¡ ì™„ë£Œ</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë§¤ì¶œÂ·ë§¤ì… ê±´ìˆ˜ í™•ì¸</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ë¶ˆê³µì œ ë§¤ì… ì‚¬ìœ  í™•ì¸ ('+etNon.length+'ê±´)</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ë¯¸ë¦¬ì±„ì›€ ìˆ«ìì™€ ë‚´ ì¥ë¶€ ëŒ€ì‚¬ ì™„ë£Œ</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ë‚´ì¼ì‚¬ì¥ ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦ í™•ì¸</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ì›ìœŒì•¤ì½” ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦/ë°°ë‹¹ í™•ì¸</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ê²½ì¡°ì‚¬ë¹„ ì¦ë¹™ ë³´ê´€ ('+evtData.length+'ê±´)</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ì‹ ê³ ì„œ ì œì¶œ ì™„ë£Œ</label>';
  g+='<label style="display:block"><input type="checkbox" style="accent-color:#6A1B9A;margin-right:6px">ë‚©ë¶€ ì™„ë£Œ (ê¸°í•œ ë‚´)</label>';
  g+='</div></div>';
  g+='</div>';
  
  try{
    var guideEl=document.getElementById('tax-guide-section');
    if(!guideEl){guideEl=document.createElement('div');guideEl.id='tax-guide-section';document.getElementById('action-list').parentElement.appendChild(guideEl)}
    guideEl.innerHTML=g;
  }catch(e){}

  // ì´ ì ˆì„¸ ê°€ëŠ¥ì•¡ ê³„ì‚°
  var incSaveTotal=incSaves.reduce(function(a,s){return a+s.save},0);
  var totalSave=vatSaveTotal+incSaveTotal;
  var actionCount=actions.filter(function(a){return a.urgency==='ğŸ”´'||a.urgency==='ğŸŸ¡'}).length;
  document.getElementById('sv-total').textContent=fm(totalSave)+'ì›';
  document.getElementById('sv-action').textContent=actionCount+'ê±´';
  try{document.getElementById('sv-vat-part').textContent=fm(vatSaveTotal)+'ì›'}catch(e){}
  try{document.getElementById('sv-inc-part').textContent=fm(incSaveTotal)+'ì›'}catch(e){}
}

// ============================================================
// ê¸°ëŠ¥ 1: ë¹„ê³µê°œ ì‹¤ìˆ˜ìµ ì¶”ì ê¸°
// ============================================================
function togglePrivateSection(){
  var body=document.getElementById('prv-body');
  var btn=document.getElementById('prv-toggle-btn');
  if(body.classList.contains('open')){
    body.classList.remove('open');
    btn.textContent='í¼ì¹˜ê¸° â–¼';
  } else {
    body.classList.add('open');
    btn.textContent='ì ‘ê¸° â–²';
    renderPrivateTracker();
  }
}

function getPrivateData(){
  try{var d=localStorage.getItem('yjtax_private');return d?JSON.parse(d):{}}catch(e){return {}}
}
function savePrivateData(data){
  try{localStorage.setItem('yjtax_private',JSON.stringify(data))}catch(e){}
}

function prvRowKey(r){
  return (r.date||'')+'_'+(r.client||'').replace(/\s/g,'')+'_'+(r.tax||0);
}

function renderPrivateTracker(){
  var taxArr=D.tax||[];
  if(taxArr.length===0){
    document.getElementById('prv-tbody').innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:#666">ì„¸ê¸ˆê³„ì‚°ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    document.getElementById('prv-summary').innerHTML='';
    return;
  }
  var prvData=getPrivateData();
  var html='';
  for(var i=0;i<taxArr.length;i++){
    var r=taxArr[i];
    var key=prvRowKey(r);
    var refund=prvData[key]&&prvData[key].refund?prvData[key].refund:0;
    var refundVal=refund?fm(refund):'';
    var memo=prvData[key]&&prvData[key].memo?prvData[key].memo:'';
    var totalAmt=r.supply+r.tax;
    var hasRefund=refund>0;
    var typeLabel,typeStyle;
    if(r.type==='ë§¤ì¶œ'){
      if(hasRefund){typeLabel='ëŒ€ë¦¬ë§¤ì¶œ';typeStyle='color:#FF8A65;font-weight:700;font-size:11px'}
      else{typeLabel='ë§¤ì¶œ';typeStyle='color:#64B5F6;font-weight:700'}
    } else {
      typeLabel='ë§¤ì…';typeStyle='color:#ef5350;font-weight:700';
    }
    html+='<tr>';
    html+='<td style="font-size:11px">'+r.date+'</td>';
    html+='<td style="'+typeStyle+'">'+typeLabel+'</td>';
    html+='<td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;font-size:12px" title="'+r.client+'">'+r.client+'</td>';
    html+='<td class="am" style="color:#FFD700;font-weight:700">'+fm(totalAmt)+'</td>';
    html+='<td><input type="text" class="prv-memo" value="'+refundVal+'" placeholder="0" style="text-align:right;width:90px" oninput="fmtInput(this)" onchange="onPrivateRefund('+i+',this)" data-max="'+totalAmt+'"></td>';
    html+='<td><input type="text" class="prv-memo" value="'+memo.replace(/"/g,'&quot;')+'" placeholder="ë©”ëª¨" onchange="onPrivateMemo('+i+',this)" style="width:100%"></td>';
    html+='</tr>';
  }
  document.getElementById('prv-tbody').innerHTML=html;
  updatePrivateSummary();
}

function onPrivateRefund(idx,el){
  var taxArr=D.tax||[];
  var r=taxArr[idx];
  if(!r)return;
  var key=prvRowKey(r);
  var raw=el.value.replace(/[^0-9]/g,'');
  var val=parseInt(raw)||0;
  var maxAmt=parseInt(el.getAttribute('data-max'))||0;
  if(val>maxAmt){
    alert('ëŒ€ë¦¬ë§¤ì¶œì•¡('+fm(val)+'ì›)ì´ í•´ë‹¹ ê±°ë˜ ì´ì•¡('+fm(maxAmt)+'ì›)ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    val=maxAmt;
    el.value=fm(val);
  }
  var prvData=getPrivateData();
  if(!prvData[key])prvData[key]={};
  prvData[key].refund=val;
  savePrivateData(prvData);
  renderPrivateTracker();
}
function onPrivateMemo(idx,el){
  var taxArr=D.tax||[];
  var r=taxArr[idx];
  if(!r)return;
  var key=prvRowKey(r);
  var prvData=getPrivateData();
  if(!prvData[key])prvData[key]={};
  prvData[key].memo=el.value;
  savePrivateData(prvData);
}

function updatePrivateSummary(){
  var taxArr=D.tax||[];
  var prvData=getPrivateData();
  var salesTotalVat=0,expTotalVat=0,proxyTotal=0;
  for(var i=0;i<taxArr.length;i++){
    var r=taxArr[i];
    var amt=r.supply+r.tax;
    if(r.type==='ë§¤ì¶œ') salesTotalVat+=amt;
    else expTotalVat+=amt;
    var key=prvRowKey(r);
    if(prvData[key]&&prvData[key].refund) proxyTotal+=prvData[key].refund;
  }
  var bookProfit=salesTotalVat-expTotalVat;
  var netProfit=bookProfit-proxyTotal;
  var el=document.getElementById('prv-summary');
  el.innerHTML='<div style="font-size:14px;font-weight:800;color:#FFD700;margin-bottom:12px">ğŸ“Š ì‹¤ìˆ˜ìµ ë¶„ì„ (ë¶€ê°€ì„¸ í¬í•¨)</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 20px;margin-bottom:12px">'+
    '<div>ì´ë§¤ì¶œ (VATí¬í•¨): <b style="color:#64B5F6">'+fm(salesTotalVat)+'ì›</b></div>'+
    '<div>ì´ë§¤ì… (VATí¬í•¨): <b style="color:#ef9a9a">'+fm(expTotalVat)+'ì›</b></div>'+
    '</div>'+
    '<div style="padding:10px 0;border-top:1px solid rgba(255,255,255,.1);border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:10px">'+
    'ğŸ‘¤ ë‹¤ë¥¸ ì‚¬ëŒ ë§¤ì¶œ ì¡ì•„ì¤€ ê¸ˆì•¡ (VATí¬í•¨): <span class="prv-refund" style="font-size:15px">'+fm(proxyTotal)+'ì›</span></div>'+
    '<div style="font-size:15px;line-height:2">'+
    'ì¥ë¶€ìƒ ìˆ˜ìµ <b style="color:#FFD700">'+fm(bookProfit)+'ì›</b> âˆ’ ëŒ€ë¦¬ë§¤ì¶œ <span class="prv-refund">'+fm(proxyTotal)+'ì›</span> = ì‹¤ì œ ìˆœìˆ˜ìµ <span class="prv-net">'+fm(netProfit)+'ì›</span></div>';
}

// ============================================================
// ê¸°ëŠ¥ 2: AI êµ¬ë… ê²½ë¹„ ê´€ë¦¬
// ============================================================
function getSubscriptions(){
  try{var d=localStorage.getItem('yjtax_subscriptions');return d?JSON.parse(d):[]}catch(e){return []}
}
function saveSubscriptions(arr){
  try{localStorage.setItem('yjtax_subscriptions',JSON.stringify(arr))}catch(e){}
}

function addSubscription(){
  var name=document.getElementById('sub-name').value.trim();
  var rawAmt=document.getElementById('sub-amount').value.replace(/[^0-9]/g,'');
  var amount=parseInt(rawAmt)||0;
  var day=document.getElementById('sub-day').value;
  var method=document.getElementById('sub-method').value;
  var category=document.getElementById('sub-category').value;
  if(!name||!amount){alert('ì„œë¹„ìŠ¤ëª…ê³¼ ê²°ì œê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  if(!day){alert('ê²°ì œì¼ì„ ì„ íƒí•˜ì„¸ìš”');return}
  var subs=getSubscriptions();
  subs.push({id:Date.now(),name:name,amount:amount,day:parseInt(day),method:method,category:category,invoice:false});
  saveSubscriptions(subs);
  document.getElementById('sub-name').value='';
  document.getElementById('sub-amount').value='';
  document.getElementById('sub-day').value='';
  renderSubscriptions();
}

function deleteSubscription(id){
  var subs=getSubscriptions().filter(function(s){return s.id!==id});
  saveSubscriptions(subs);
  renderSubscriptions();
}

function toggleSubInvoice(id){
  var subs=getSubscriptions();
  for(var i=0;i<subs.length;i++){
    if(subs[i].id===id){subs[i].invoice=!subs[i].invoice;break}
  }
  saveSubscriptions(subs);
  renderSubscriptions();
}

function renderSubscriptions(){
  var subs=getSubscriptions();
  var listEl=document.getElementById('sub-list');
  var sumEl=document.getElementById('sub-summary');
  if(subs.length===0){
    listEl.innerHTML='<div style="text-align:center;padding:20px;color:#bbb;font-size:13px"><i class="fas fa-inbox" style="display:block;font-size:28px;margin-bottom:8px;color:#ddd"></i>ë“±ë¡ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    sumEl.style.display='none';
    return;
  }
  var html='';
  var monthTotal=0,yearTotal=0,invoiceTotal=0,noInvoiceTotal=0;
  for(var i=0;i<subs.length;i++){
    var s=subs[i];
    monthTotal+=s.amount;
    if(s.invoice) invoiceTotal+=s.amount;
    else noInvoiceTotal+=s.amount;
    var invoiceIcon=s.invoice?'<span style="color:var(--gn);font-weight:700">âœ… ë³´ê´€</span>':'<span style="color:var(--or);font-weight:700">âš ï¸ ë¯¸ë³´ê´€</span>';
    html+='<div class="sub-item">';
    html+='<div style="flex:1;min-width:0">';
    html+='<div style="font-weight:700;margin-bottom:2px">'+s.name+'</div>';
    html+='<div style="font-size:11px;color:#888">ë§¤ì›” '+s.day+'ì¼ Â· '+s.method+' Â· '+s.category+'</div>';
    if(!s.invoice) html+='<div class="sub-warn">âš ï¸ ì˜ìˆ˜ì¦(ì¸ë³´ì´ìŠ¤) ì—†ìœ¼ë©´ ê³µì œ ë¶ˆê°€</div>';
    html+='</div>';
    html+='<div style="text-align:right;white-space:nowrap;margin:0 8px">';
    html+='<div style="font-weight:800;font-size:14px;color:var(--nv)">'+fm(s.amount)+'ì›</div>';
    html+='<div style="margin-top:3px">'+invoiceIcon+'</div>';
    html+='</div>';
    html+='<div style="display:flex;flex-direction:column;gap:4px">';
    html+='<button onclick="toggleSubInvoice('+s.id+')" style="background:none;border:1px solid #ddd;border-radius:6px;padding:4px 8px;font-size:10px;cursor:pointer;font-family:inherit;white-space:nowrap" title="ì¸ë³´ì´ìŠ¤ ë³´ê´€ í† ê¸€">ğŸ“</button>';
    html+='<button onclick="deleteSubscription('+s.id+')" style="background:none;border:1px solid #fcc;border-radius:6px;padding:4px 8px;font-size:10px;cursor:pointer;color:var(--rd);font-family:inherit">âœ•</button>';
    html+='</div>';
    html+='</div>';
  }
  listEl.innerHTML=html;

  yearTotal=monthTotal*12;
  var vatDeduct=Math.floor(invoiceTotal*10/110);
  var vatDeductYear=vatDeduct*12;
  var expenseYear=yearTotal;
  var missedVat=Math.floor(noInvoiceTotal*10/110)*12;

  var sh='<div style="font-size:15px;font-weight:800;color:var(--nv);margin-bottom:12px">ğŸ“Š êµ¬ë… ê²½ë¹„ ìš”ì•½</div>';
  sh+='<div>ğŸ’³ ì›” í•©ê³„: <span class="s-val">'+fm(monthTotal)+'ì›</span></div>';
  sh+='<div>ğŸ“… ì—°ê°„ í•©ê³„: <span class="s-val">'+fm(yearTotal)+'ì›</span></div>';
  sh+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid #e0e0e0">âœ… ë§¤ì…ì„¸ì•¡ê³µì œ ê°€ëŠ¥ì•¡ (ì¸ë³´ì´ìŠ¤ ë³´ê´€ë¶„, ì›”): <span class="s-val s-good">'+fm(vatDeduct)+'ì›</span></div>';
  sh+='<div>âœ… ë§¤ì…ì„¸ì•¡ê³µì œ ê°€ëŠ¥ì•¡ (ì—°ê°„): <span class="s-val s-good">'+fm(vatDeductYear)+'ì›</span></div>';
  sh+='<div>ğŸ“‹ ì¢…ì†Œì„¸ ê²½ë¹„ ì¸ì •ì•¡ (ì—°ê°„): <span class="s-val s-good">'+fm(expenseYear)+'ì›</span></div>';
  if(noInvoiceTotal>0){
    sh+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid #e0e0e0">âš ï¸ ë¯¸ë³´ê´€ìœ¼ë¡œ ë†“ì¹˜ëŠ” ê³µì œì•¡ (ì—°ê°„): <span class="s-val s-warn">'+fm(missedVat)+'ì›</span></div>';
    sh+='<div style="font-size:11px;color:var(--or);margin-top:4px">â†’ ì¸ë³´ì´ìŠ¤ë¥¼ ë³´ê´€í•˜ë©´ ì—°ê°„ '+fm(missedVat)+'ì› ì¶”ê°€ ê³µì œ ê°€ëŠ¥!</div>';
  }
  sumEl.innerHTML=sh;
  sumEl.style.display='block';
}

// ============================================================
// ê¸°ëŠ¥ 3: ëŒ€í‘œì ì‹ ìš©ë„ ê´€ë¦¬
// ============================================================
function getCreditData(){
  try{var d=localStorage.getItem('yjtax_credit');return d?JSON.parse(d):{}}catch(e){return {}}
}
function saveCreditData(data){
  try{localStorage.setItem('yjtax_credit',JSON.stringify(data))}catch(e){}
}
function saveCreditInfo(){
  var score=parseInt(document.getElementById('credit-score').value)||0;
  var grade=document.getElementById('credit-grade').value;
  if(!score&&!grade){alert('ì‹ ìš©ì ìˆ˜ ë˜ëŠ” ë“±ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  var data=getCreditData();
  data.score=score;
  data.grade=grade?parseInt(grade):0;
  data.updatedAt=new Date().toISOString().slice(0,10);
  saveCreditData(data);
  updateCreditInfo();
  alert('ì‹ ìš© ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function loadCreditInfo(){
  var data=getCreditData();
  if(data.score) document.getElementById('credit-score').value=data.score;
  if(data.grade) document.getElementById('credit-grade').value=data.grade;
  updateCreditInfo();
}
function updateCreditInfo(){
  var score=parseInt(document.getElementById('credit-score').value)||0;
  var grade=parseInt(document.getElementById('credit-grade').value)||0;
  var el=document.getElementById('credit-result');
  if(!score&&!grade){el.innerHTML='';return}
  if(score&&!grade){
    if(score>=900)grade=1;else if(score>=870)grade=2;else if(score>=840)grade=3;
    else if(score>=805)grade=4;else if(score>=750)grade=5;else if(score>=665)grade=6;
    else if(score>=600)grade=7;else if(score>=515)grade=8;else if(score>=445)grade=9;
    else grade=10;
    document.getElementById('credit-grade').value=grade;
  }
  var scoreColor,scoreEmoji,scoreLabel,loanChance,interestLevel;
  if(grade<=2){scoreColor='#2E7D32';scoreEmoji='ğŸŸ¢';scoreLabel='ìµœìš°ìˆ˜';loanChance='ë§¤ìš° ë†’ìŒ';interestLevel='ìµœì €ê¸ˆë¦¬ ê°€ëŠ¥'}
  else if(grade<=3){scoreColor='#388E3C';scoreEmoji='ğŸŸ¢';scoreLabel='ìš°ìˆ˜';loanChance='ë†’ìŒ';interestLevel='ì €ê¸ˆë¦¬ ìš°ëŒ€'}
  else if(grade<=4){scoreColor='#1565C0';scoreEmoji='ğŸ”µ';scoreLabel='ì–‘í˜¸';loanChance='ì–‘í˜¸';interestLevel='ì¼ë°˜ê¸ˆë¦¬'}
  else if(grade<=5){scoreColor='#F57C00';scoreEmoji='ğŸŸ¡';scoreLabel='ë³´í†µ';loanChance='ë³´í†µ';interestLevel='ì¼ë°˜~ë‹¤ì†Œ ë†’ìŒ'}
  else if(grade<=6){scoreColor='#E65100';scoreEmoji='ğŸŸ ';scoreLabel='ì£¼ì˜';loanChance='ì œí•œì ';interestLevel='ë†’ì€ ê¸ˆë¦¬'}
  else if(grade<=7){scoreColor='#C62828';scoreEmoji='ğŸ”´';scoreLabel='ê´€ë¦¬ í•„ìš”';loanChance='ì–´ë ¤ì›€';interestLevel='ê³ ê¸ˆë¦¬'}
  else{scoreColor='#B71C1C';scoreEmoji='ğŸ”´';scoreLabel='ìœ„í—˜';loanChance='ê±°ì˜ ë¶ˆê°€';interestLevel='ëŒ€ì¶œ ê±°ì ˆ ê°€ëŠ¥'}

  var h='<div style="background:#fff;border-radius:var(--r);border:2px solid '+scoreColor+';padding:20px;margin-bottom:16px">';
  h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">';
  h+='<div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,'+scoreColor+','+scoreColor+'88);display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:22px;font-weight:900;color:#fff">'+(score||'?')+'</span></div>';
  h+='<div><div style="font-size:18px;font-weight:800;color:'+scoreColor+'">'+scoreEmoji+' '+grade+'ë“±ê¸‰ Â· '+scoreLabel+'</div>';
  h+='<div style="font-size:12px;color:#888;margin-top:2px">ëŒ€ì¶œê°€ëŠ¥ì„±: <b>'+loanChance+'</b> Â· ì˜ˆìƒê¸ˆë¦¬: <b>'+interestLevel+'</b></div></div></div>';

  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">';
  h+='<div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:var(--rs)"><div style="font-size:10px;color:#888">ì‹ ìš©ë“±ê¸‰</div><div style="font-size:20px;font-weight:800;color:'+scoreColor+'">'+grade+'ë“±ê¸‰</div></div>';
  h+='<div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:var(--rs)"><div style="font-size:10px;color:#888">ëŒ€ì¶œê°€ëŠ¥ì„±</div><div style="font-size:14px;font-weight:800;color:'+scoreColor+'">'+loanChance+'</div></div>';
  h+='<div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:var(--rs)"><div style="font-size:10px;color:#888">ì˜ˆìƒê¸ˆë¦¬</div><div style="font-size:12px;font-weight:700;color:'+scoreColor+'">'+interestLevel+'</div></div>';
  h+='</div>';

  // ê°œì„  ë°©ë²•
  h+='<div style="font-size:13px;font-weight:800;color:#004D40;margin-bottom:10px">ğŸ’¡ ì‹ ìš©ë„ ê°œì„  ë°©ë²•</div>';
  h+='<div style="font-size:12px;line-height:1.9;color:#444">';
  if(grade<=3){
    h+='<div>âœ… <b>í˜„ì¬ ìš°ìˆ˜í•œ ì‹ ìš©ë“±ê¸‰ì…ë‹ˆë‹¤.</b> ìœ ì§€ ê´€ë¦¬ì— ì§‘ì¤‘í•˜ì„¸ìš”.</div>';
    h+='<div>âœ… ì¹´ë“œ ì‚¬ìš©ì•¡ì€ ê²°ì œì¼ ì „ì— ë¯¸ë¦¬ ì…ê¸ˆ (ì—°ì²´ ë°©ì§€)</div>';
    h+='<div>âœ… ëŒ€ì¶œ ìƒí™˜ ì¼ì • ì¤€ìˆ˜ â€” ì¡°ê¸°ìƒí™˜ë„ ê¸ì •ì </div>';
    h+='<div>âœ… ë¶ˆí•„ìš”í•œ ëŒ€ì¶œÂ·ì¹´ë“œ ì •ë¦¬ â†’ ì´ ë¶€ì±„ ê°ì†Œ</div>';
  } else if(grade<=5){
    h+='<div>âš ï¸ <b>ì–‘í˜¸í•˜ì§€ë§Œ ê°œì„  ì—¬ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</b></div>';
    h+='<div>ğŸ“Œ ì¹´ë“œê°’Â·ëŒ€ì¶œ ìƒí™˜ <b>ì ˆëŒ€ ì—°ì²´ ê¸ˆì§€</b> (1ì¼ì´ë¼ë„ ì˜í–¥)</div>';
    h+='<div>ğŸ“Œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì¹´ë“œÂ·ëŒ€ì¶œ ì •ë¦¬ â†’ í•œë„ ëŒ€ë¹„ ì‚¬ìš©ë¥  ë‚®ì¶”ê¸°</div>';
    h+='<div>ğŸ“Œ í†µì‹ ë¹„Â·ë³´í—˜ë£Œ ë“± <b>ì •ê¸°ê²°ì œ 6ê°œì›” ì´ìƒ</b> ìœ ì§€ â†’ ì ìˆ˜ ê°€ì‚°</div>';
    h+='<div>ğŸ“Œ í˜„ê¸ˆì„œë¹„ìŠ¤Â·ì¹´ë“œë¡  ì‚¬ìš© ìì œ (ê°ì  ìš”ì¸)</div>';
    h+='<div>ğŸ“Œ êµ­ë¯¼ì—°ê¸ˆÂ·ê±´ë³´ ì²´ë‚© ì—†ì´ ìœ ì§€</div>';
  } else {
    h+='<div>ğŸ”´ <b>ì‹ ìš© ê°œì„ ì´ ì‹œê¸‰í•©ë‹ˆë‹¤.</b></div>';
    h+='<div>ğŸš¨ ì—°ì²´ ì¤‘ì¸ ëŒ€ì¶œÂ·ì¹´ë“œê°€ ìˆë‹¤ë©´ <b>ì¦‰ì‹œ ìƒí™˜</b></div>';
    h+='<div>ğŸš¨ ì†Œì•¡ì´ë¼ë„ ì—°ì²´ í•´ì†Œ â†’ í•´ì†Œ ê¸°ë¡ 5ë…„ í›„ ì‚­ì œ</div>';
    h+='<div>ğŸ“Œ <b>ì„œë¯¼ê¸ˆìœµì§„í¥ì›</b> ì±„ë¬´ì¡°ì •Â·í–‡ì‚´ë¡  ìƒë‹´ ê¶Œì¥</div>';
    h+='<div>ğŸ“Œ ì‹ ìš©íšŒë³µìœ„ì›íšŒ(1600-5500) ë¬´ë£Œ ìƒë‹´ í™œìš©</div>';
    h+='<div>ğŸ“Œ ì²´í¬ì¹´ë“œ ê¾¸ì¤€íˆ ì‚¬ìš© â†’ ì‚¬ìš© ì‹¤ì  ìŒ“ê¸°</div>';
    h+='<div>ğŸ“Œ í†µì‹ ë¹„Â·ê³µê³¼ê¸ˆ ìë™ì´ì²´ â†’ ì„±ì‹¤ ë‚©ë¶€ ì´ë ¥ í™•ë³´</div>';
  }
  h+='</div>';

  // ì‚¬ì—…ì ëŒ€ì¶œ íŒ
  h+='<div style="margin-top:16px;padding-top:14px;border-top:1px solid #eee">';
  h+='<div style="font-size:13px;font-weight:800;color:#004D40;margin-bottom:8px">ğŸ¢ ì‚¬ì—…ì ëŒ€ì¶œ ì‹œ ì‹ ìš© ì™¸ ì¤‘ìš” ìš”ì†Œ</div>';
  h+='<div style="font-size:12px;line-height:1.9;color:#444">';
  h+='<div>ğŸ“‹ ì‚¬ì—…ìë“±ë¡ í›„ <b>6ê°œì›” ì´ìƒ</b> ê²½ê³¼ (ëŒ€ì¶œ í•„ìˆ˜ ì¡°ê±´)</div>';
  h+='<div>ğŸ“‹ <b>ë§¤ì¶œ ì¦ë¹™</b> â€” ì„¸ê¸ˆê³„ì‚°ì„œÂ·ì¹´ë“œë§¤ì¶œÂ·í†µì¥ ì…ê¸ˆ ë‚´ì—­</div>';
  h+='<div>ğŸ“‹ <b>ë¶€ê°€ì„¸Â·ì¢…ì†Œì„¸ ì‹ ê³  ì‹¤ì </b> â€” ì„±ì‹¤ì‹ ê³ ê°€ ëŒ€ì¶œ ì‹¬ì‚¬ì— ìœ ë¦¬</div>';
  h+='<div>ğŸ“‹ <b>4ëŒ€ë³´í—˜ ê°€ì…</b> ì‚¬ì—…ì¥ â†’ ì•ˆì • ì‚¬ì—…ì¥ìœ¼ë¡œ í‰ê°€</div>';
  h+='<div>ğŸ“‹ êµ­ì„¸Â·ì§€ë°©ì„¸ <b>ì™„ë‚©ì¦ëª…ì„œ</b> ë°œê¸‰ ê°€ëŠ¥í•´ì•¼ í•¨</div>';
  h+='</div></div>';
  h+='</div>';
  el.innerHTML=h;
}

// ì´ˆê¸° ë¡œë“œ ì‹œ êµ¬ë… ëª©ë¡ ë Œë”ë§ (ë„êµ¬í•¨ íƒ­ ì§„ì… ì‹œ)
(function(){
  var origSw=window.sw;
  if(origSw){
    window.sw=function(n,b){
      origSw(n,b);
      if(n===6){renderSubscriptions();loadCreditInfo()}
    };
  }
})();

// === ê¸°ë³¸ API í‚¤ ìë™ ì£¼ì… (ë¯¸ì„¤ì • ì‹œ) ===
(function(){
  var defaults={
    'yjtax_gemini_key':['AIza','SyCs','7QZe','q1xk','b6VG','j0iw','tcYz','r7C_','jElv','NXg'].join(''),
    'yjtax_gemini_backup':['AIza','SyCs','7QZe','q1xk','b6VG','j0iw','tcYz','r7C_','jElv','NXg'].join(''),
    'yjtax_nts_key':'0299a6622d59757a23065ed67269978497e0f9261134060968e2cb0810194a03',
    'yjtax_perplexity_key':['pplx-','DODV8cq9BuQG','i5slSkKkVQf9','fthREzsYH4cl','RYaBkeoOdKjw'].join(''),
    'yjtax_alpha_key':'8CEA89VHHEZIOWQY',
    'yjtax_naver_id':'hiJJu_1UcVuZCL2hx2N0',
    'yjtax_naver_secret':'q2jUORq9ch'
  };
  var injected=[];
  Object.keys(defaults).forEach(function(k){
    if(!localStorage.getItem(k)){
      localStorage.setItem(k,defaults[k]);
      injected.push(k);
    }
  });
  if(injected.length>0){
    console.log('[YJ Tax] ê¸°ë³¸ API í‚¤ ìë™ ì„¤ì • ì™„ë£Œ: '+injected.join(', '));
  }
})();

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded',function(){
  try{renderSubscriptions()}catch(e){}
  try{loadCreditInfo()}catch(e){}
  // ë°°ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
  try{updateGeminiBadge()}catch(e){}
  try{updateNtsBadge()}catch(e){}
  try{updatePerplexityBadge()}catch(e){}
  try{updateAlphaBadge()}catch(e){}
});
</script>
</body>
</html>
